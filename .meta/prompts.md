
- 草坪背景不是通过缩放来适应窗口,而是游戏中只显示中间部分,游戏开始前要有一个从左到右的滑动效果显
示整体场景的动画 . 是从左滑到右，再从右滑动回中间。
- 阳光计数器的背景和金色矩形框也已经在bar5 上绘制好了,只是在正确的位置显示正确的数值即可
- 铲子和铲子槽位画在了卡片槽位上，要移到右方
- 阳光计数值的显示位置 在哪里设置 ?

## story 3.2

- 要参考 @2.2.story.md 中阳光计数器的位置计算 方式，使用相对位置方式确定卡片的位置
- 卡片还有重叠，卡片槽每个卡槽中间是有边距的，查看截图
- 卡片大于卡槽了，需要增加常量用来控制卡片显示的缩放因子。而且卡片上已经有固定的阳光值了，不需要再显示。


### correct-course

- [x] 半透明的植物图像不是跟随鼠标，是显示在将要被种植的位置，跟随鼠标的图像应该是不透明的。
- [x] 我将原图片目录备份到了 assets/imagesold， 现在的资源目录 assets 收集了完整的原版资源，请先根据 assets/properties/resources.xml 结合我们调整后的实际目录，创建我们的资源映射文件（由原来的 xml 改为yaml格式） ，并创新新的资源引用与管理模块，然后将代码原有引用旧资源的逻辑改为使用新的资源管理方式。

- [x] 教学关卡时，指向植物卡片的箭头不显示了 - 原因：GameScene.Draw() 缺少 UI 粒子渲染调用
- [x] 僵尸死亡时，头和手臂一起掉落了 - 原因：手臂掉落应在受伤时触发，而不是死亡时。手臂掉落的粒子文件是 assets/effect/particles/ZombieArm.xml 。 头掉落的是：assets/effect/particles/ZombieHead.xml
- [x] 子弹与僵尸的碰撞检测要优化 - 原因：physics_system.go 碰撞检测遗漏了 BehaviorZombieDying

- [x] 豌豆射手的动画效果之前一直不知道 anim_stem 轨道的作用，通过实际运行后，发现原版效果在攻击时，茎干的摇晃一直没停，只是头部换成了攻击轨道的动画，所以大胆猜想 anim_stem 轨道是定位茎干位移的，请尝试修复攻击时的动画效果。

- [x] 之前对 reanim 动画系统的理解和实现有偏差，请根据最新研究，修正或重构之前相关的文档、模块、测试。
最新研究请参考：@docs/reanim @cmd/render_animation_comparison/main.go

- [x] 现在僵尸的生成是根据预览时的僵尸

- [x] 日间场地 (白天/泳池/屋顶) 有天降阳光, 掉落间隔 = min{已掉落阳光数量 x 10 + 425, 950} + rand(275), 刚开局时掉落较快, 掉落 52 个之后间隔稳定在 950~1224 范围内. 蘑菇类植物需要使用咖啡豆唤醒.

- [x] level 1-4 配置了其他类型僵尸，但是出现的还全是basic类型的
- [x] level 1-1 的教学流程，种下第2个豌豆射手后，要优先显示 `ADVICE_ZOMBIE_ONSLAUGHT` `别让僵尸靠近你的房子`的文本
- [x] 樱桃炸弹的爆炸范围是半径115

- [x] 奖励动画和奖励面板切换的过程中间有一瞬间会显示出背景

- [x] 奖励动画卡包的粒子效果显示一下就消失了，要持续显示，直到移动动画开启
- [x] 优化进度条的实现逻辑 @.meta/data/progress.md
- [x] 僵尸显示正常了，但是护甲没有受损和掉落的动画效果，直接消失了。 要找到正确的受损相应的图片资源和掉落的动画，修正效果。

- [x] 参考 `cmd/verify_* ` 下的程序， 实现一个统一的验证程序，在植物选择栏要能选择所有植物，然后草坪每一行固定出现一种类型的僵尸，每个僵尸每隔两秒出现一个，以便于我们验证植物和僵尸的各种行为。还需要有快捷键能触发`除草车`、`奖励动画`.实现要完全调用业务模块，不要实现和业务模块重复的功能。

- [x] 开场动画期间，在屏幕下方居中要显示白色字黑色阴影、32号大小 `{username}的房子`

- [x] 开场动画播放后，游戏开始前要显示除草车动画效果，是从屏幕左侧开出来到达初始位置的感觉

- [x] 开场动画期间预览僵尸时，显示的僵尸类型不符合实际配置的，如果配置了特殊类型僵尸，是要显示出来的

- [x] level 1-4配置了conehead ,但预览时和最后一波时,都没有出现.非普通类僵尸预览必须保证种类的显示. 游戏中必须保证数量完全按配置显示 .

日志(文件很大): /tmp/pvz.log 

- [x] 请设计用户游戏存档系统，游戏过程中可随时存储当前进度，退出游戏后，重新进入后，可恢复游戏进度，继续游戏。游戏存档数据是否更适合使用二进制数据序列化? 
  暂停菜单不需要改,点击暂停菜单中的主菜单按钮时,就是保存进度.
  加载逻辑也是进入游戏后,点击冒险模式按钮,自动加载存档信息.因为并不能任意切换关卡。 
  再次进入游戏时,如果有存档,默认显示类似于退出对话框一样的对话框: 
  title: 继续游戏?  
  mesasge:  你想继续当前游戏还是重玩此关卡？
  按键区: 第1行两个按钮:继续和重玩关卡，第二行第一按钮: 取消

  -  epic 18 实现后,发现的问题: 对话框是在进入关卡游戏后弹出，而不是在主菜单界面点击冒险模式按钮后弹出. 按钮是两排，所以对话框应该是使用大按钮区域的样式。优先级要高于开场动画,  如果有关卡存档,就不显示开场动画，进入关卡时就要加载并显示完整的数据 .点继续后就直接开始游戏了,而不是点继续后才加载存档数据

    - 继续后, 游戏存档恢复不完整, 除草车恢复后,位置正确,但是在动画状态,应该是静止状态. 草皮没有正确显示. 教学流程没有正确显示. 阳光没有正常生成 . 
    - 继续后, 游戏存档恢复不正确, 进度条直接恢复到存档时的进度，不需要有动画效果. 教学关卡的流程恢复后，感觉恢复点不太对。
    - 在啃食坚果墙的僵尸在恢复存档后看不到了，只能看到脚下的阴影

## 5.3

- 还有2个问题，卡片会渲染在植物和僵尸上面。坚果墙一放，帽子僵尸帽子就会消失，是被攻击了吗？

## aniamtion 

/mnt/disk0/project/game/pvz/ck/pvzwine_reverse 这个项目是对原版游戏资源数据的研究与解析， 请结合测试程序，将我们之前实现的基于动画帧的动画系统，改为使用和原版游戏同样的动画系统。 解析后的资源已经放在 assets/reanim， assets/effect/reanim。


- @.meta/reanim/peashootersingle.md 这是定义文件格式的猜想,不一定完全 
正确,请参考并独立思考后,评估我们的实现是否有潜在的问题

@.meta/reanim/reanim.md  为了验证这个文档是否正确，请写一个单独的文件，按这个的说明实现2个动画场景，一个是空闲时，一个是攻击时的全身动画。
注意，是一个独立执行文件，不要基于我们之前实现的reanim模块。 这是动画定义文件 assets/effect/reanim/PeaShooterSingle.reanim.  
需要用到的第三方库要与我们项目的一致。

- 请分析定义文件中所有轨道的可见性,保存到文档中

- 在完成了这2个故事后，发现植物的动画效果还是不够通用，会不会我们的设计方向不对，比如，豌豆射手攻击时的动画效果，应该是 anim_shooting \ anim_idle \ anim_stem 共同作用的结果。现在播放时，是看不到头部的。

- 那是不是根本不需要配置, 根据动画轨道的帧能自动找到所有其他非动画轨道的相应要显示的帧.只要考虑配置好特殊轨道,比如 anim_stem这种轨道,或者可以配置不显示哪些轨道就行.比如攻击动画,选定要播放 anim_shooting\anim_idle, 播放所有在这2个动画定义的可见帧,如果有配置特殊轨道,就增加特殊轨道的效果,如果配置了不显示哪些轨道,就排除此轨道.

- @cmd/solution_attack_with_sway/main.go 根据这个验证程序的方式 , 实现完整的动画系统的效果展示程序,
  要能同屏展示所有的动画, 动画有100多个, 要考虑合理的布局和交互. 一个动画定义文件为一个展示单元, 默认展示一个动画,
  可配置修改默认展示的动画.点击后可展示这个单元中所有的动画效果, 涉及到多动画组合的,
  要能通过yaml配置文件配置和修改组合方式.
  
- *correct-course  除草车碾压僵尸的死亡动画不是普通的死亡动画,应该在死亡时使用僵尸的图片叠加
  这个动画变形轨道的数据
  data/reanim/LawnMoweredZombie.reanim 实现被压扁的效果.

- *correct-course  僵尸的行走动画需要优化，现在动画和僵尸的位移没有有效结合，
- 僵尸的行走动画是不是已经包含了移动? 我们的实际是不是又叠加了移动? 现在的感觉是僵尸在行走时同时又有一点平移的感觉,请检查.

- *correct-course .meta/reanim/僵尸移动说明.md 根据文档说明, 采用根运动（Root  Motion）法修正僵尸移动动画效果

- 每一关的奖励动画要修正逻辑: 植物或铲子移动到的目标位置应该是根据后续出现的奖励面板中要显示相应图片来确定，这样移动到目标位置后,奖励面板显示,但不再显示植物或铲子, 复用动画中最后显示的植物或铲子. 奖励面板的按钮要添加鼠标悬停时切换为手形以及发亮的效果。

- 参见：.meta/data/plant_hit_effects.md
| **坚果墙 (Wallnut)** | **粒子效果** | `assets/effect/particles/WallnutEatLarge.xml`<br>`assets/effect/particles/WallnutEatSmall.xml` | `assets/effect/particles/WallnutEatSmall.xml` 是在啃食时触发的， `assets/effect/particles/WallnutEatLarge.xml` 是在受损时更换图片时触发的。而且现在显示的位置也不对，应该是显示在啃食的接触点 |
| | **外观破损** | `assets/reanim/Wallnut_cracked1.png`<br>`assets/reanim/Wallnut_cracked2.png` | 根据生命值降低，外观会呈现轻微破损和严重破损状态。 |

在啃食时， 坚果墙就切换到 anim_blink_twitch动画，不摇摆了。 而且啃食时颜色要发亮，造成一闪一闪的效果。隔一小会儿就播放一次眨眼动画 anim_blink_twice 或anim_blink_thrice  随机选择

## 粒子效果

现在要全面支持粒子效果， 例如：僵尸的手臂掉落、头掉落的效果等等，请全面分析粒子系统的配置格式，优雅的实现粒子系统。实现方案要优先使用Ebitengine 引擎，有必要的话先使用 `mcp__deepwiki` 工具的`ask_question`方法，查阅最新的文档，以找到最正确的方法

- `assets/effect/particles`：粒子系统的配置，指定粒子的发射器、轨迹与贴图（引用 `assets/particles` 中的 PNG）
- `assets/particles`：粒子系统用的贴图素材（效果精灵）。如爆炸、烟雾、火花、雨滴、泡泡、星星等（例如 `DoomShroom_Explosion_*`, `PoolSparkly.png`, `SnowPea_*`）

- 僵尸头粒子效果和原版的表现不一样,请参考我的理解,检查实现是否不正确? .meta/particles/ZombieHead.md  
assets/effect/particles/ZombieHead.xml 从实际运行 cmd/particles/main.go 看,僵尸头没有在地面弹跳的效果

-  僵尸头粒子效果和原版的表现不一样, 掉落速度慢,头滚动少,很快就消失了，没看到反弹地面的效果.是不是我们对配置文件的字段含义理解有误?或实现有误? .meta/particles/ZombieHead.md  assets/effect/particles/ZombieHead.xml  cmd/particles/main.go

- assets/effect/particles/SodRoll.xml 中的所有字段都解析并应用到渲染中了吗? 验证粒子系统的实现， 可以使用类似 `go run cmd/particles/main.go --verbose --effect="Planting"  > /tmp/p.log 2>&1` 的命令运行，并查看日志

## 8

- 现在项目的基础功能全部实现，需要根据 @.meta/whitepaper.md 的说明一步步实现关卡， 注意说明文档是大模型生成的，有可能不准确，有和你对游戏理解不一致的地方，明确提出，和我沟通确认。

### menu

- 通过 .meta/screenshot/menu 下的所有图片, 描述主菜单界面的所有信息,以便于接下来实现这个界面和功能

- 实现 .meta/data/data.md 和 docs/main-menu-spec.md 中 主菜单界面和功能。要重点查看 assets/effect/reanim/SelectorScreen.reanim 和  assets/effect/reanim/Zombie_hand.reanim,  以确定哪些是动画定义中就实现了的场景 ,哪些是需要我们二次加工实现的. 
### level1

- @level1/ 中是本关卡中的关键截图，请参考
- 注意截图只是几个关键步骤，并不代表所有的教学文本，请根据 LawnStrings.txt 文本资源确定完整的引导过程的文本
- 计划中要根据完整的资源 @assets ，确定需要用到的背景、图片、音频、动画、粒子等，基于完整的资源分析，列出需要用到的资源清单


- 现在存在的问题：
    - ✅ **已解决** 阳光掉落的位置和间隔都是固定的 → 已添加随机性（间隔8±1秒，位置±50x/±30y像素）
    - ✅ **已解决** 第一波僵尸进入有点慢 → 僵尸生成位置从X=1100-1250调整为1000-1100，减少等待时间
    - ✅ **已解决** 最后一波僵尸的动画效果还没有显示 → 代码已实现FinalWave.reanim动画（1-1关只有1波，不触发是正常的）
    - ✅ **已解决** 去掉之前测试时添加的僵尸波次提示文本和右下角的进度显示 → 已注释掉测试UI
    - ✅ **已解决** 1-1关没有铲子，请去掉 → 教学关卡自动隐藏铲子
    - ✅ **已解决** 右上角需要添加菜单按钮 → 添加了菜单按钮显示（点击功能待实现）

    - 实现右下角正式的进度条显示 → 使用原版FlagMeter资源实现图形化进度条，进度要能反应真实的僵尸波次和进攻进度
    - 菜单按钮点击响应（需要实现暂停菜单系统）
    - 植物发射子弹时需要切换到发射子弹的动画（请在资源路径 assets 查找合适的动画效果）
    - 植物种植时，地面上有土粒飞溅的效果（请在资源路径下 assets 查找合适的动画效果）
    - 每行有效的草坪左边台阶上需要增加除草车，是最后一道防线，可以一次从左到右除草，消灭所在行的所有僵尸。（正确显示除草车，能正确触发除草车动画效果，能消灭所在行所有僵尸）
    - 进度条上的旗帜标记显示（当前只显示背景和进度填充）

- @assets/effect/particles/SodRoll.xml 应该铺草皮时土粒飞溅的效果. 添加最后一波僵尸的提示动画: 
assets/effect/reanim/FinalWave.reanim. 完善进度条显示: 1.位置 
2.正确显示当前进度,僵尸头的位置要匹配进度，僵尸头开始在右边,随着进度条移动,而且进度条要有绿色的进度显示. FlagMeter.png: 背景框和绿色进度填充,一张图有2行, 根据进度百分比从左到右裁剪显示. 绿色进度填充从右到左增长.关卡文字有黑色描边效果. 文字位置要在进度条左面的外侧.  FlagMeterLevelProgress.png（装饰条）：垂直对齐：图片的Y轴中点对齐背景框的下边沿，水平居中在背景框， FlagMeterParts.png  是3部分,1 僵尸头 2: 竖线 3: 旗帜: 
assets/images/FlagMeter.png
assets/images/FlagMeterLevelProgress.png
assets/images/FlagMeterParts.png 
3. 图片前要有当前关卡的文本显示:  关卡 1-1 , 进度条和文本显示要右对齐，可以手工配置距离右边缘的位置.  开始进攻前, 只有文本显示,开始进攻时,显示完整的文本加图片进度条,文字位置要在进度条左面的外侧， 进度条不显示时,不要占位,文本要右对齐.


### level 1-2

- 本关也没有解锁铲子
- 为什么配置了有效植物有向日葵，但是向日葵无法种植

### level 1-4

- 1-4 关卡胜利后，虽然解锁的是铲子，也需要有和前面关卡类似的奖励动画， 只是植物卡包换成铲子图片， 卡包背景的粒子效果换成 assets/effect/particles/AwardPickupArrow.xml。

## bugs

目前存在的问题：

- [x] 向日葵种植后不会自动生产阳光
- [x] 教学关卡，自动生产的阳光的位置和时间不够随机
- [x] 优化僵尸不在有效行时的进攻逻辑，根据邻近的有效行，进攻时，保持X坐标不变，自动调整僵尸的Y坐标到有效行即可，不需要有移动的动画效果。

- [x] 桃炸弹的爆炸范围要考虑在边缘网格时候的情况, 如果种植在最右边网格, 爆炸范围应该包括网格右侧的范围,现在没法炸死右侧的僵尸.
- [x] 最后一波僵尸动画显示完一遍后，又会显示一次动画的开头几帧
- [x] 植物由空闲状态转为攻击状态时，有一点点抖动的感觉
- [x] 奖励面板的植物描述文本不需要阴影效果
- [x] 僵尸胜利后要显示胜利的动画
- [x] 攻击时，子弹一次正常，一次表现为2颗重叠在一起但又有一点点偏差发射的， 应该一次只发射一颗子弹。
- [x] 阳光收集的过程动画中，阳光飞向左上角的过程不是匀速的，开始要快速，快到目标位置时要减速，到目标位置时要有缩小以达到收集到阳光池的感觉
- [x] 植物和僵尸正下方要有阴影的效果
- [x] 植物卡片选择时，鼠标点击时，如果当前卡片的阳光值不足，当前总阳光值需要有交互表现：阳光数字要红/黑闪烁
- [x] 在教学关卡，提示选择植物卡片上要有闪烁效果，而且下方的闪烁的箭头要一直显示，直到选择，鼠标悬停时要切换为手形
- [x] 教学关卡，提示种植植物时，草皮闪烁的效果是应用在渲染的整个草皮上，而不是网格
- [x] 爆炸死亡的僵尸，死亡动画要使用专用的烧焦黑化的动画
- [x] 掉落的阳光要保证不能全部或部分显示在屏幕外
- [x] 向日葵在生产阳光时，脸部会发出渐变的金色的亮光
- [x] 很多植物在被攻击时，有动画或粒子效果，请根据 reanim 和 particles 资源， 推断全部的效果并汇总

- 我们之前重构动画系统时, 由中心锚点改为了左上角锚点,现在的问题和这个改动有关系吗?

## 架构

- reanim 模块的设计和使用是否有不符合架构设计的地方？
- *correct-course 请找出 pkg/systems 下的巨婴文件, 给出优化方案, 精简不必要或过期的注释.

### 原始版本

动画锚点我们开始实现时采用中心锚点， 在某些场景会有繁琐的问题，后来重构改为左上角，发现又引起了另一些问题（不是十分确定由锚点的改变引起），总之是动画效果受到了影响，经常需要更改锚点的计算或采取额外的计算才能正常。请系统性全面的分析动画渲染的场景和问题，确定渲染锚点选择的最佳方案。

### 优化版本

**背景**
本项目的 Reanim 动画渲染系统经历了两次锚点方案调整：
- **初始方案**：采用中心锚点（center anchor）进行渲染
- **重构方案**：改为左上角锚点（top-left anchor）

**问题描述**
1. **中心锚点阶段**：在某些渲染场景下需要进行繁琐的坐标转换计算
2. **左上角锚点阶段**：重构后疑似引入新问题，动画效果异常，需要频繁调整锚点计算或添加额外的补偿逻辑才能正常显示

**不确定性**
目前不完全确定动画异常是否完全由锚点变更导致，可能存在其他潜在因素。

**需求目标**
请系统性地进行以下分析：

1. **场景梳理**：全面识别项目中所有涉及 Reanim 动画渲染的场景（植物、僵尸、粒子、UI 等）
2. **问题诊断**：分析当前左上角锚点方案在各场景下的问题根因
3. **方案对比**：评估中心锚点 vs 左上角锚点在各场景下的优劣势
4. **最佳实践**：基于 Reanim 文件格式规范和本项目架构，确定推荐的锚点方案
5. **迁移影响**：如需调整方案，评估影响范围和迁移成本

**期望输出**
- 明确的锚点选择建议（中心/左上角/混合方案）
- 每种场景下的坐标计算公式
- 需要修改的代码位置清单