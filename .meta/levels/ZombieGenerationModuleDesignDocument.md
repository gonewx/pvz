# 《植物大战僵尸》冒险模式僵尸生成模块设计文档

使用 NotebookLM 生成

## 模块版本：1.0

## 编写目的

本模块旨在基于游戏内存数据和逆向工程算法，设计一个能够精确模拟《植物大战僵尸》**冒险模式**（Adventure Mode）中僵尸生成、分行、难度动态调整及刷新计时的核心系统。

## 核心输入数据（关卡脚本格式）

开发人员需要实现一个机制，能够读取您提供的**每一关、每一波僵尸的固定生成序列**。

## 1. 关卡脚本结构定义（Yaml 格式）

为保证数据可扩展性和易读性，建议采用以下结构定义每一关的僵尸生成数据：

| 字段名称 (Key) | 数据类型 | 描述 | 示例值 |
| :--- | :--- | :--- | :--- |
| `LevelID` | String/Int | 关卡唯一标识（如 “1-1”、“1-5”） | "1-10\_Replay" |
| `Flags` | Int | 本关卡的旗帜数量 | 2, 3 (二周目 1-7/1-9) |
| `Waves` | Array | 包含所有波次数据的列表 | `[...]` |

## 2. 波次数据结构定义（Waves Element）

`Waves` 列表中的每个元素定义了一波僵尸的固定生成内容。

| 字段名称 (Key) | 数据类型 | 描述 | 示例值 |
| :--- | :--- | :--- | :--- |
| `WaveNum` | Int | 当前波次编号 (从 1 开始) | 1, 10, 20 |
| `Type` | String | 波次类型（用于区分固定脚本、额外点数或最终波） | "Fixed", "ExtraPoints", "Final" |
| `Zombies` | Array | **固定出怪列表**：指定本波次要出的僵尸种类和数量。 | `[{"ID": "PZ", "Count": 3}, {"ID": "CZ", "Count": 1}]` |
| `ExtraPoints` | Int | **额外点数**：用于需要动态点数分配的关卡（如 1-10），这些点数由程序转换为实际僵尸。 | 2, 6, 24 |
| `LaneRestriction`| Optional | 指定僵尸必须出现在哪几行（路）。| 3, 4 (仅水路) |

*注：对于 Level 1-10 这样的传送带关卡，波次数据中的 `Zombies` 列表应根据 `ExtraPoints` **动态填充**，或者由您提供的**精确序列**作为 `Zombies` 列表直接输入，从而绕过游戏内部的 `ExtraPoints` 转换算法。*

---

## 一、 模块初始化与难度设定（难度引擎）

模块在每局游戏开始时，必须初始化以下参数：

## 1. 场地环境判定（Location and Constraints）

根据关卡 ID 确定当前场景类型和边界，用于后续的僵尸**合法行判定**和**出怪类型限制**。

| 属性 | 冒险模式章节 | 关键值/限制 | 来源 |
| :--- | :--- | :--- | :--- |
| `SceneType` | 白天 (Day) / 黑夜 (Night) / 泳池 (Pool) / 雾夜 (Fog) / 屋顶 (Roof) / 月夜 (Moon) | - | |
| `RowMax` | 前院/屋顶 $5$ 行，后院 $6$ 行 | $1 \sim 5$ 或 $1 \sim 6$ | |
| `HasWater` | 泳池/雾夜场景：第 $3, 4$ 行有水路 | Boolean | |
| `HasSlope` | 屋顶场景：左 $5$ 列为斜坡 | Boolean | |
| `StartSun` | Level 1-1 首次游玩：$150$ 阳光 | Int | |

## 2. 轮数（Rounds）与级别容量（Level Cap）计算

“轮数”是难度衡量的技术指标。

**输入：** `TotalCompletedFlags` (已完成 $flag$ 数)。

**计算公式：**
$$\text{RoundNumber} = \frac{\text{TotalCompletedFlags}}{2} - 1$$

**级别容量上限 (Level Capacity Cap)：** 每一波僵尸的**级别总和**不得超过该波的级别上限。

$$\text{CapacityCap} = \text{int}(\text{int}((\text{CurrentWaveNum} + \text{RoundNumber} \times \text{WavesPerRound}) \times 0.8) / 2) + 1$$
*   **大波（第 10/20 波）**：容量上限再 $\times 2.5$ 并向零取整。

*   **实现要点**：模块需要根据 `LevelID` 和玩家的**周目状态**（一周目 $vs$ 二周目及以后）来确定 `TotalCompletedFlags`。例如，完成冒险模式一次后，Level 1-1 将包含 **两面旗帜**。

## 3. 僵尸基础数据导入 (Zombie Stats)

模块必须预先存储所有僵尸的关键属性：

| 属性 | 普僵 (0) | 路障 (2) | 铁桶 (4) | 巨人 (23) | 红眼 (32) |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **级别 (Level)** | 1 | 2 | 4 | 10 | 10 | |
| **权重 (Weight)** | $4000$ | $4000$ | $3000$ | $1500$ | $6000$ | |
| **本体血量** | $270$ | $270$ | $270$ | $3000$ | $6000$ | |
| **饰品 I 血量** | - | $370$ | $1100$ | - | - | |
| **饰品 II 血量** | - | - | - | - | - | |

## 二、 僵尸出怪序列处理模块（Script Execution）

本模块主要负责读取您的**关卡脚本输入**并进行执行。

## 1. 读取固定出怪序列

模块应按波次顺序读取 `Zombies` 列表中的数据，确定在当前波次需要生成的**僵尸种类 ID** 和 **数量**。

*   **处理特殊关卡**：对于 Level 1-5 (坚果保龄球) 和 Level 1-10 (传送带)，虽然它们在波次表格中显示为 `None` 或 `Extra points`，但您提供的固定数据应直接指示要生成的僵尸序列，以绕过这些关卡独特的内部随机分配机制。

## 2. 僵尸生成限制检查（Constraint Checks）

在生成僵尸之前，必须检查是否满足以下限制条件：

| 限制类型 | 判定规则 | 来源 |
| :--- | :--- | :--- |
| **出怪类型（准许）** | 检查当前僵尸是否在游戏的**出怪类型**（Spawn Types）列表中被设定为 `true`（准许生成）。**冒险模式固定脚本**通常会忽略部分随机选择，但应遵循场地和进度限制。 | |
| **阶数限制** | 确保僵尸的出现波数符合其**阶数**要求。例如，**一阶僵尸**（普僵、路障等）第 $1$ 波即可出现，**四阶僵尸**（白眼、红眼）至少第 $15$ 波开始出现（这个限制会根据轮数调整）。 | |
| **红眼上限** | 如果是红眼巨人，检查**已生成的红眼总数**是否达到**红眼数量上限**（初始为 $0$，轮数 $\ge 5$ 起每轮加 $1$）。 | |

## 三、 僵尸行分配模块（Lane Selection）

本模块采用复杂的**平滑权重**算法，决定僵尸出现在哪一行（路）。

## 1. 行信息初始化和更新

对于前院/屋顶的 $1 \sim 5$ 行或后院的 $1 \sim 6$ 行，初始化以下参数：

*   $Weight_i$：第 $i$ 行的权重（初始值，在冒险模式中通常设置为 $1$）。
*   $LastPicked_i$：距离上次被选取的时间（计数器）。
*   $SecondLastPicked_i$：距离上上次被选取的时间（计数器）。
*   **插入事件（某行 $j$ 出怪时）**：
    1.  如果 $Weight_i > 0$，则 $\forall i$， $LastPicked_i$ 和 $SecondLastPicked_i$ 均 $+1$。
    2.  将 $LastPicked_j$ 的值赋给 $SecondLastPicked_j$。
    3.  将 $LastPicked_j$ 设为 $0$。

## 2. 合法行判定（Legal Rows）

在尝试分配僵尸到某一行 $i$ 之前，必须检查该行对该僵尸是否合法：

*   **基本不合法条件**：行号不在 $1 \sim 6$ 之间；无草皮之地关卡外的裸地行；非泳池浓雾关卡的第 $6$ 行。
*   **特殊僵尸不合法条件**：
    *   **水路**：水路行（后院的 $3, 4$ 行）只对**潜水、海豚**、以及在水路自动转换为**鸭子救生圈僵尸** 的普僵、路障、铁桶、旗帜、气球和植物僵尸**合法**。非水路对海豚僵尸与潜水僵尸不合法。
    *   **舞王僵尸**：非后院场景下，如果上下任意一行不是草地或行号不合法，则对舞王僵尸不合法。舞王僵尸不会出现在**屋顶**。

## 3. 平滑权重计算（SmoothWeight）

针对所有**合法行**计算平滑权重 $SmoothWeight_i$：

1.  **权重占比 $WeightP_i$：**
    $$WeightP_i=\frac{Weight_i}{\sum_{j=1}^{6}Weight_j}$$

2.  **影响因子 $PLast_i$ 和 $PSecondLast_i$：**
    $$PLast_i=\frac{6\times LastPicked_i\times WeightP_i+6\times WeightP_i-3}{4}$$
    $$PSecondLast_i=\frac{SecondLastPicked_i\times WeightP_i+WeightP_i-1}{4}$$

3.  **平滑权重 $SmoothWeight_i$：**
    $$SmoothWeight_i = WeightP_i\times \min(\max(PLast_i+PSecondLast_i,0.01),100)$$ (适用于 $WeightP_i \ge 10^{-6}$ 的情况，否则为 $0$)。

## 4. 抽取行事件（Row Drawing）

*   生成一个 $[0, \sum SmoothWeight_j)$ 范围内的随机数 $RandNum$。
*   选取第一个使 $\sum_{j=1}^{i}SmoothWeight_j\ge RandNum$ 的行 $i$。
*   **推论**：如果僵尸没有可选出怪行（即所有 $Weight_i=0$），该僵尸**一定出现在第六行**。

## 四、 僵尸刷新与计时模块（Wave Timing）

本模块控制僵尸何时出现，需要处理冒险模式的固定波次和旗帜波的特殊计时。

## 1. 关卡波次总数

根据关卡 ID 和周目状态确定总波次：

*   **一周目**：Level 1-1 ($4$ 波)；Level 1-2 ($6$ 波)；Level 1-3 ($8$ 波)；Level 1-4/1-6 ($10$ 波)；Level 1-7/1-9 ($20$ 波)。
*   **二周目及以后**：所有常规关卡均为 $20$ 波（如 1-1, 1-2, 1-3, 1-4, 1-6, 1-8, 1-10），或 $30$ 波（如 1-7, 1-9）。

## 2. 刷新计时器（Refresh Countdown）

*   **开场倒计时**：除第一次选卡外，开场倒计时为 **$600$ cs**，从 $599$ 减少到 $1$ 刷出第一波。
*   **常规波次**：刷新时倒计时被设置为 $2500 + \text{rand}(600)$ cs，减少到 $1$ 刷出下一波。

## 3. 旗帜波（大波）的特殊计时（第 10/20 波）

*   **旗帜波前一波（第 9/19 波）**：刷新时，倒计时被设置为 **$4500$ cs**。
    *   **加速刷新**：如果本波刷出至少 **$401$ cs** 且倒计时大于 **$200$ cs** 时，将本波僵尸（除伴舞）全部消灭，倒计时立即设置为 **$200$ cs**。
    *   **红字警告**：倒计时减少至 $5$ 时显示红字，在 $4$ 停留 $725$ cs，红字倒计时结束后（约 $750$ cs 之后）刷出下一波。

*   **关底波次（Final Wave / 第 20 波）**：倒计时设置为 **$5500$ cs**。
    *   **结束关卡**：减少至 $0$ 时激活白字，刷出后将场上僵尸全部消灭则立即停止倒计时并激活白字。白字显示 $500$ cs 后结束本关。

## 4. 刷新激活血量机制（加速刷新）

常规波次（非大波）在 $401$ cs 后，如果**本波僵尸总血量** $\le$ **刷新激活血量**（总血量的 $0.50 \sim 0.65$ 倍），倒计时立即被设置为 **$200$ cs**。

*   **总血量计算**：$本体血量 + \text{I 类饰品血量} + 0.20 \times \text{II 类饰品血量}$。
*   **适用僵尸**：需要计算的饰品包括：路障、铁桶、橄榄球帽、雪橇车、气球、矿工帽、僵尸坚果、僵尸高坚果（I 类）；报纸、铁栅门、扶梯（II 类）。

## 五、 僵尸物理与行为模块

本模块确保生成的僵尸在游戏中行为符合**精确数据**。

## 1. 坐标与边界（Coordinates and Boundaries）

*   **坐标系**：以 Level 1-1 格子左上角为原点 $(0, 0)$。
*   **行坐标**：前院僵尸 $y$ 坐标。
*   **出生点 $x$ 坐标**：
    *   **普通波出生点**：所有其他僵尸 $780 \sim 819$。
    *   **旗帜波出生点**：所有其他僵尸 $820 \sim 859$。
    *   **特殊僵尸**：旗帜 $800$，冰车 $800 \sim 809$，巨人（白眼、红眼） $845 \sim 854$。
*   **僵尸进家判定**：
    *   普僵/路障/铁桶等：$x \le -100$。
    *   橄榄/冰车/投篮：$x \le -175$。
    *   舞王/伴舞/潜水：$x \le -130$。
    *   撑杆/巨人：$x \le -150$。

## 2. 僵尸特殊行为和动画时间（Action Timing）

模块需要集成特定僵尸的动作时间，以保证游戏机制的准确性：

| 僵尸 | 行为 | 耗时 (cs) | 来源 |
| :--- | :--- | :--- | :--- |
| **撑杆僵尸** | 起跳到落地 | $180$ cs（$1.8$ 秒） | |
| **舞王僵尸** | 滑步时间 | $300 \sim 311$ cs | |
| **蹦极僵尸** | 落地后停留时间 | $300$ cs | |
| **蹦极僵尸** | 抓取持续时间 | $63$ cs | |
| **巨人僵尸** | 开始锤击到命中 | $134$ cs | |
| **投篮僵尸** | 攻击间隔 | $300$ cs | |
