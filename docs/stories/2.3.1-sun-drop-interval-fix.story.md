# Story 2.3.1: 修正阳光掉落间隔为原版机制

## Status
Done

## Story
**As a** 玩家,
**I want** 天降阳光的掉落间隔符合原版游戏机制（开局快、后期稳定）,
**so that** 游戏体验与原版一致，开局能更快积累阳光资源。

## Acceptance Criteria

1. **实现原版掉落间隔公式**
   - 间隔公式: `min{已掉落阳光数量 × 10 + 425, 950} + rand(0~275)` (单位: 厘秒)
   - 转换为秒: 间隔(秒) = 间隔(厘秒) / 100
   - 开局时（0个阳光）间隔范围: 4.25 ~ 7.00 秒
   - 稳定后（52+个阳光）间隔范围: 9.50 ~ 12.24 秒

2. **追踪已掉落阳光数量**
   - `SunSpawnSystem` 需要新增字段追踪已掉落阳光数量
   - 每次生成阳光后计数器 +1
   - 计数器仅用于计算间隔，与玩家收集无关

3. **关卡重置时计数器归零**
   - 当关卡重新开始时，计数器重置为 0
   - 确保每局游戏的阳光掉落节奏一致

4. **单元测试覆盖**
   - 测试初始间隔范围 (count=0): 4.25-7.00秒
   - 测试中期间隔范围 (count=30): 7.25-10.00秒
   - 测试稳定间隔范围 (count=52+): 9.50-12.24秒
   - 测试计数器递增逻辑

5. **代码质量**
   - 代码格式符合 `gofmt` 标准
   - 通过 `go vet` 检查
   - 所有测试通过

## Tasks / Subtasks

- [x] Task 1: 修改 SunSpawnSystem 结构体 (AC: 2)
  - [x] 在 `pkg/systems/sun_spawn_system.go` 中添加 `sunDroppedCount int` 字段
  - [x] 初始值为 0

- [x] Task 2: 实现原版间隔计算函数 (AC: 1)
  - [x] 添加 `calculateNextInterval() float64` 方法
  - [x] 实现公式: `min{count × 10 + 425, 950} + rand(0~275)` (厘秒)
  - [x] 返回值转换为秒
  - [x] 添加 GoDoc 注释说明公式来源

- [x] Task 3: 修改 Update 方法 (AC: 1, 2)
  - [x] 在 `NewSunSpawnSystem` 中使用新公式计算初始间隔
  - [x] 在生成阳光后:
    - [x] 递增 `sunDroppedCount`
    - [x] 使用 `calculateNextInterval()` 计算下次间隔

- [x] Task 4: 添加重置方法 (AC: 3)
  - [x] 添加 `Reset()` 方法，重置计数器和计时器
  - [x] 确认 GameScene 在关卡重新开始时调用此方法（如需要）

- [x] Task 5: 更新单元测试 (AC: 4)
  - [x] 在 `pkg/systems/sun_spawn_system_test.go` 中添加新测试
  - [x] `TestSunSpawnIntervalFormula_Initial` - 测试 count=0 时间隔范围
  - [x] `TestSunSpawnIntervalFormula_Mid` - 测试 count=30 时间隔范围
  - [x] `TestSunSpawnIntervalFormula_Stable` - 测试 count=52+ 时间隔范围
  - [x] `TestSunDroppedCountIncrement` - 测试计数器递增

- [x] Task 6: 代码质量检查 (AC: 5)
  - [x] 运行 `gofmt -w pkg/systems/sun_spawn_system.go`
  - [x] 运行 `go vet ./pkg/systems`
  - [x] 运行 `go test ./pkg/systems -run SunSpawn -v`
  - [x] 运行 `go build .` 确认编译成功

- [x] Task 7: 更新文档标记 (AC: All)
  - [x] 在 `.meta/prompts.md` 第30行将 `- []` 改为 `- [x]`

## Dev Notes

### 变更背景

[Source: .meta/prompts.md:30, Sprint Change Proposal]

**当前实现问题**：
- 阳光掉落间隔固定为 8秒 ±2秒
- 与原版游戏机制不符
- 原版机制：开局掉落较快，逐渐变慢，最终稳定

**原版机制** (来源: .meta/prompts.md):
> 日间场地 (白天/泳池/屋顶) 有天降阳光, 掉落间隔 = min{已掉落阳光数量 x 10 + 425, 950} + rand(275), 刚开局时掉落较快, 掉落 52 个之后间隔稳定在 950~1224 范围内.

---

### 原版公式详解

**单位说明**：
- 原版 PvZ 使用 **厘秒 (centiseconds)** 作为时间单位
- 1 厘秒 = 0.01 秒
- 游戏物理更新基准为 100 FPS (每帧 0.01秒)

**公式**：
```
间隔(厘秒) = min{已掉落数量 × 10 + 425, 950} + rand(0~275)
间隔(秒) = 间隔(厘秒) / 100
```

**间隔范围表**：

| 已掉落数量 | 基础间隔(cs) | +随机(cs) | 间隔范围(秒) |
|-----------|-------------|----------|-------------|
| 0 | 425 | 0~275 | **4.25 ~ 7.00** |
| 10 | 525 | 0~275 | 5.25 ~ 8.00 |
| 20 | 625 | 0~275 | 6.25 ~ 9.00 |
| 30 | 725 | 0~275 | 7.25 ~ 10.00 |
| 40 | 825 | 0~275 | 8.25 ~ 11.00 |
| 50 | 925 | 0~275 | 9.25 ~ 12.00 |
| 52+ | 950 (cap) | 0~275 | **9.50 ~ 12.24** |

**关键点**：
- 基础间隔上限为 950cs (9.5秒)
- 52个阳光后达到稳定状态
- 随机范围始终为 0~275cs

---

### 当前代码分析

[Source: pkg/systems/sun_spawn_system.go]

**当前实现**（需要修改）：
```go
// 第 33-51 行
type SunSpawnSystem struct {
    entityManager   *ecs.EntityManager
    resourceManager *game.ResourceManager
    spawnTimer      float64
    spawnInterval   float64  // 当前: 固定基础值
    minX            float64
    maxX            float64
    minTargetY      float64
    maxTargetY      float64
    enabled         bool
}

// NewSunSpawnSystem 中的初始化（第 34-37 行）
baseInterval := 8.0
randomOffset := -2.0 + rand.Float64()*4.0 // -2 到 +2 秒
initialInterval := baseInterval + randomOffset

// Update 中重新计算间隔（第 73-75 行）
baseInterval := 8.0
randomOffset := -2.0 + rand.Float64()*4.0
s.spawnInterval = baseInterval + randomOffset
```

---

### 修改方案

**Step 1: 修改结构体**
```go
type SunSpawnSystem struct {
    entityManager     *ecs.EntityManager
    resourceManager   *game.ResourceManager
    spawnTimer        float64
    spawnInterval     float64
    sunDroppedCount   int     // 新增: 已掉落阳光计数
    minX              float64
    maxX              float64
    minTargetY        float64
    maxTargetY        float64
    enabled           bool
}
```

**Step 2: 添加间隔计算方法**
```go
// calculateNextInterval 计算下一次阳光掉落间隔
// 原版公式: min{count * 10 + 425, 950} + rand(275)
// 单位: 厘秒 (centiseconds), 1cs = 0.01秒
// 参考: .meta/prompts.md - 原版游戏机制
func (s *SunSpawnSystem) calculateNextInterval() float64 {
    // 计算基础间隔 (厘秒)
    baseCS := s.sunDroppedCount*10 + 425
    if baseCS > 950 {
        baseCS = 950
    }
    // 添加随机偏移 (0-275 厘秒)
    randomCS := rand.Intn(276)
    // 总间隔 (厘秒)
    totalCS := baseCS + randomCS
    // 转换为秒
    return float64(totalCS) / 100.0
}
```

**Step 3: 修改 NewSunSpawnSystem**
```go
func NewSunSpawnSystem(...) *SunSpawnSystem {
    system := &SunSpawnSystem{
        entityManager:   em,
        resourceManager: rm,
        spawnTimer:      0,
        sunDroppedCount: 0,  // 初始为 0
        // ... 其他字段
        enabled:         true,
    }
    // 使用新公式计算初始间隔
    system.spawnInterval = system.calculateNextInterval()

    log.Printf("[SunSpawnSystem] Initialized with interval=%.2fs (count=%d)",
        system.spawnInterval, system.sunDroppedCount)
    return system
}
```

**Step 4: 修改 Update 方法**
```go
if s.spawnTimer >= s.spawnInterval {
    s.spawnTimer = 0

    // 生成阳光...
    sunID := entities.NewSunEntity(...)

    // 更新计数和间隔
    s.sunDroppedCount++
    s.spawnInterval = s.calculateNextInterval()

    log.Printf("[SunSpawnSystem] Spawned sun #%d, next interval=%.2fs",
        s.sunDroppedCount, s.spawnInterval)
}
```

**Step 5: 添加 Reset 方法**
```go
// Reset 重置阳光生成系统状态（关卡重新开始时调用）
func (s *SunSpawnSystem) Reset() {
    s.spawnTimer = 0
    s.sunDroppedCount = 0
    s.spawnInterval = s.calculateNextInterval()
    log.Printf("[SunSpawnSystem] Reset: interval=%.2fs", s.spawnInterval)
}
```

---

### 测试用例设计

**测试文件**: `pkg/systems/sun_spawn_system_test.go`

```go
func TestSunSpawnIntervalFormula_Initial(t *testing.T) {
    // count = 0: 间隔应在 4.25-7.00 秒之间
    system := &SunSpawnSystem{sunDroppedCount: 0}
    for i := 0; i < 100; i++ {
        interval := system.calculateNextInterval()
        if interval < 4.25 || interval > 7.00 {
            t.Errorf("Initial interval out of range: got %.2f, want 4.25-7.00", interval)
        }
    }
}

func TestSunSpawnIntervalFormula_Mid(t *testing.T) {
    // count = 30: 间隔应在 7.25-10.00 秒之间
    system := &SunSpawnSystem{sunDroppedCount: 30}
    for i := 0; i < 100; i++ {
        interval := system.calculateNextInterval()
        if interval < 7.25 || interval > 10.00 {
            t.Errorf("Mid interval out of range: got %.2f, want 7.25-10.00", interval)
        }
    }
}

func TestSunSpawnIntervalFormula_Stable(t *testing.T) {
    // count = 52+: 间隔应在 9.50-12.24 秒之间
    for _, count := range []int{52, 60, 100, 1000} {
        system := &SunSpawnSystem{sunDroppedCount: count}
        for i := 0; i < 100; i++ {
            interval := system.calculateNextInterval()
            if interval < 9.50 || interval > 12.25 {
                t.Errorf("Stable interval (count=%d) out of range: got %.2f, want 9.50-12.25", count, interval)
            }
        }
    }
}

func TestSunDroppedCountIncrement(t *testing.T) {
    // 验证每次生成阳光后计数器递增
    // 需要模拟 Update 调用
}
```

---

### File Locations

[Source: docs/architecture/unified-project-structure.md]

**需要修改的文件**：
- `pkg/systems/sun_spawn_system.go` - 主要修改
  - 添加 `sunDroppedCount` 字段
  - 添加 `calculateNextInterval()` 方法
  - 添加 `Reset()` 方法
  - 修改 `NewSunSpawnSystem()` 和 `Update()` 方法
- `pkg/systems/sun_spawn_system_test.go` - 添加新测试
- `.meta/prompts.md` - 标记任务完成

**参考文件**（无需修改）：
- `pkg/components/sun.go` - 阳光组件定义
- `pkg/entities/sun_factory.go` - 阳光实体工厂

---

### 与其他系统的交互

**SunSpawnSystem 与其他系统的关系**：
- **独立性**: 计数器仅用于计算间隔，不影响其他系统
- **GameScene**: 可能需要在关卡重新开始时调用 `Reset()`
- **SunCollectionSystem**: 无关联（收集阳光不影响掉落计数）

**关卡重置时机**：
- 当 `GameScene` 重新初始化时
- 或者提供 `Reset()` 方法供外部调用

---

### 注意事项

**重要提醒**：
1. **单位转换**: 公式中的值是厘秒，需要除以 100 转换为秒
2. **rand.Intn(276)**: 生成 0-275 的随机整数（包含 0 和 275）
3. **上限检查**: `baseCS > 950` 时需要截断为 950
4. **日志输出**: 保留适当的日志以便调试

**不需要修改的部分**：
- 蘑菇类植物的咖啡豆唤醒机制（不在本次变更范围内）
- 阳光收集逻辑
- 阳光移动和消失逻辑

---

## Testing

### Testing Standards

[Source: docs/architecture/testing-strategy.md]

**测试框架**: Go 标准库 `testing` 包

**测试文件位置**: `pkg/systems/sun_spawn_system_test.go`

**测试覆盖率要求**: Systems 目标覆盖率 80%+

**测试命令**:
```bash
# 运行阳光生成系统相关测试
go test ./pkg/systems -run SunSpawn -v

# 查看覆盖率
go test ./pkg/systems -cover -run SunSpawn

# 运行所有测试
go test ./...
```

**验收测试**:
- 运行游戏，观察开局阳光掉落是否更快（约 4-7 秒）
- 观察后期阳光掉落是否稳定在 9.5-12 秒左右

---

## Dev Agent Record

### Agent Model Used
claude-opus-4-5-20250929

### File List
- `pkg/systems/sun_spawn_system.go` - 修改：添加 sunDroppedCount 字段、calculateNextInterval() 方法、Reset() 方法，修改 NewSunSpawnSystem() 和 Update() 使用原版公式
- `pkg/systems/sun_spawn_system_test.go` - 修改：添加 6 个新测试用例验证原版间隔公式
- `.meta/prompts.md` - 修改：标记任务完成

### Completion Notes
- 实现了原版 PvZ 阳光掉落间隔公式：`min{count * 10 + 425, 950} + rand(0~275)` (厘秒)
- 开局间隔 4.25-7.00 秒，稳定后（52+个阳光）间隔 9.50-12.25 秒
- 添加 `sunDroppedCount` 字段追踪已掉落阳光数量
- 添加 `Reset()` 方法供关卡重置时调用
- 所有单元测试通过，代码通过 gofmt 和 go vet 检查

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-27 | 1.0 | Story 创建，定义原版阳光掉落间隔修正任务 | Bob (Scrum Master) |

---

## QA Results

### Review Date: 2025-11-27

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

实现质量良好。代码正确实现了原版 PvZ 阳光掉落间隔公式，结构清晰，注释充分。主要亮点：

1. **公式实现准确**：`calculateNextInterval()` 方法正确实现了 `min{count * 10 + 425, 950} + rand(0~275)` 厘秒公式
2. **代码组织良好**：新增的 `sunDroppedCount` 字段和 `Reset()` 方法设计合理
3. **文档注释完整**：GoDoc 注释清晰说明了公式来源和间隔范围
4. **测试覆盖全面**：6 个测试用例覆盖了初始、中期、稳定三个阶段的间隔范围验证

### Refactoring Performed

无需重构。代码质量符合项目标准。

### Compliance Check

- Coding Standards: ✓ 代码通过 gofmt 和 go vet 检查
- Project Structure: ✓ 文件位置和命名符合项目结构规范
- Testing Strategy: ✓ 测试用例设计合理，覆盖关键场景
- All ACs Met: ✓ 所有验收标准均已满足（见下方详细说明）

### Improvements Checklist

- [x] 实现原版掉落间隔公式（AC1）
- [x] 添加 sunDroppedCount 字段追踪已掉落阳光数量（AC2）
- [x] 添加 Reset() 方法供关卡重置调用（AC3）
- [x] 添加 6 个单元测试覆盖各阶段间隔范围（AC4）
- [x] 代码通过 gofmt 和 go vet 检查（AC5）
- [x] 所有测试通过（AC5）
- [ ] GameScene 关卡重置时调用 Reset() - 当前 GameScene 无完整重置流程，建议在后续 Story 中补充

### Security Review

无安全问题。此功能为纯游戏逻辑，不涉及敏感数据处理。

### Performance Considerations

无性能问题。`calculateNextInterval()` 仅包含简单整数运算，计算开销可忽略不计。

### Files Modified During Review

无文件修改。

### AC 详细验证

| AC | 验证结果 | 说明 |
|----|----------|------|
| AC1: 原版公式实现 | ✓ PASS | 公式 `min{count*10+425, 950} + rand(0~275)` 正确实现，间隔范围符合预期 |
| AC2: 追踪已掉落数量 | ✓ PASS | `sunDroppedCount` 字段正确初始化为 0，每次生成后 +1 |
| AC3: 关卡重置计数器归零 | ✓ PASS | `Reset()` 方法正确重置 spawnTimer、sunDroppedCount 和 spawnInterval |
| AC4: 单元测试覆盖 | ✓ PASS | 6 个测试用例覆盖初始/中期/稳定间隔范围及计数器递增逻辑 |
| AC5: 代码质量 | ✓ PASS | gofmt/go vet/go build/go test 全部通过 |

### Requirements Traceability (Given-When-Then)

**AC1: 原版公式实现**
- Given: SunSpawnSystem 初始化，sunDroppedCount=0
- When: calculateNextInterval() 被调用
- Then: 返回值在 4.25~7.00 秒范围内（验证：TestSunSpawnIntervalFormula_Initial）

**AC2: 追踪已掉落数量**
- Given: SunSpawnSystem 初始化，sunDroppedCount=0
- When: Update() 触发阳光生成
- Then: sunDroppedCount 增加 1（验证：TestSunDroppedCountIncrement）

**AC3: 关卡重置**
- Given: SunSpawnSystem 已生成多个阳光，sunDroppedCount>0
- When: Reset() 被调用
- Then: sunDroppedCount=0，spawnTimer=0，spawnInterval 在初始范围内（验证：TestSunSpawnSystem_Reset）

**AC4: 稳定间隔验证**
- Given: sunDroppedCount=53+
- When: calculateNextInterval() 被调用
- Then: 返回值在 9.50~12.25 秒范围内（验证：TestSunSpawnIntervalFormula_Stable）

### Gate Status

Gate: **PASS** → docs/qa/gates/2.3.1-sun-drop-interval-fix.yml

### Recommended Status

✓ **Ready for Done** - 所有验收标准已满足，测试通过，代码质量符合项目标准。

> 建议：后续可在 GameScene 实现完整关卡重置流程时，确保调用 SunSpawnSystem.Reset()。
