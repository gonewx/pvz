# Story 17.8: 加速刷新机制 - 血量触发

## Status

Done

## Story

**As a** 开发者,
**I want** to implement health-triggered wave acceleration,
**so that** the game speeds up when zombies are quickly defeated, following original PvZ mechanics.

## Acceptance Criteria

1. **血量计算**:
   - 总血量 = 本体血量 + I类饰品血量 + 0.20 × II类饰品血量
   - I类饰品: 路障 370, 铁桶 1100, 橄榄球帽, 雪橇车, 气球, 矿工帽, 僵尸坚果
   - II类饰品: 报纸, 铁栅门, 扶梯

2. **刷新激活条件**:
   - 常规波次（非大波/旗帜波）
   - 本波刷出 ≥ 401 厘秒
   - 当前血量 ≤ 刷新激活血量 (总血量 × 0.50~0.65)
   - 触发后倒计时立即设为 200 厘秒

3. **血量追踪**:
   - 追踪本波所有僵尸的血量变化
   - 僵尸死亡时更新总血量

4. **配置参数**:
   - 血量触发比例可配置 (默认 0.50~0.65 随机)
   - 最小触发时间可配置 (默认 401cs)

5. **单元测试**: 覆盖率 ≥ 80%

## Tasks / Subtasks

- [x] **Task 1: 扩展 WaveTimerComponent 组件** (AC: 3)
  - [x] 在 `pkg/components/wave_timer.go` 添加血量追踪字段:
    - `WaveInitialHealthCs int` - 本波僵尸初始总血量（计算后的加权血量）
    - `WaveCurrentHealthCs int` - 本波僵尸当前总血量
    - `HealthTriggerThreshold float64` - 血量触发比例阈值（0.50~0.65）
    - `HealthAccelerationTriggered bool` - 是否已触发血量加速（防止重复触发）
  - [x] 添加 GoDoc 注释说明各字段用途

- [x] **Task 2: 扩展 zombie_stats.yaml 配置** (AC: 1)
  - [x] 在 `data/zombie_stats.yaml` 中为现有僵尸添加饰品分类字段:
    - `tier1AccessoryHealth` - I类饰品血量（已存在，确认值正确）
    - `tier2AccessoryHealth` - II类饰品血量（已存在，确认值正确）
  - [x] 验证现有配置：
    - basic: baseHealth=270, tier1=0, tier2=0
    - conehead: baseHealth=270, tier1=370, tier2=0
    - buckethead: baseHealth=270, tier1=1100, tier2=0

- [x] **Task 3: 创建血量计算工具函数** (AC: 1)
  - [x] 在 `pkg/systems/wave_timing_system.go` 添加血量计算函数:
    - `CalculateZombieEffectiveHealth(baseHealth, tier1Health, tier2Health int) int`
    - 公式: `baseHealth + tier1Health + int(float64(tier2Health) * 0.20)`
  - [x] 创建从僵尸类型获取有效血量的函数:
    - `GetZombieTypeEffectiveHealth(zombieType string) int`
    - 从 zombie_stats.yaml 配置加载数据

- [x] **Task 4: 实现波次血量追踪** (AC: 3)
  - [x] 修改 `WaveTimingSystem` 或创建辅助系统:
    - 在波次开始时计算并记录本波僵尸总血量
    - 需要从 `WaveSpawnSystem` 获取波次僵尸信息
  - [x] 添加 `InitializeWaveHealth(zombieList []ZombieSpawnInfo)` 方法:
    - 遍历波次僵尸列表，累加有效血量
    - 设置 `WaveInitialHealthCs` 和 `WaveCurrentHealthCs`
    - 随机生成 `HealthTriggerThreshold` (0.50~0.65)

- [x] **Task 5: 实现血量更新追踪** (AC: 3)
  - [x] 创建 `pkg/systems/wave_health_tracker_system.go`:
    - 订阅/轮询僵尸血量变化
    - 当僵尸受伤或死亡时更新 `WaveCurrentHealthCs`
  - [x] 或者：扩展 `WaveTimingSystem.Update()`:
    - 每帧遍历本波僵尸，计算当前总血量
    - 比较与初始血量的差值

- [x] **Task 6: 实现血量触发加速刷新** (AC: 2, 4)
  - [x] 扩展 `WaveTimingSystem.CheckAcceleratedRefresh()`:
    - 现有逻辑：检查"消灭触发"（Story 17.7 已实现）
    - 新增逻辑：检查"血量触发"
  - [x] 血量触发条件检查:
    - `!IsFlagWaveApproaching` - 非旗帜波前
    - `WaveElapsedCs > AcceleratedRefreshMinTimeCs` - 刷出 > 401cs
    - `CountdownCs > AcceleratedRefreshCountdownCs` - 倒计时 > 200cs
    - `WaveCurrentHealthCs <= WaveInitialHealthCs * HealthTriggerThreshold` - 血量达到阈值
    - `!HealthAccelerationTriggered` - 未触发过
  - [x] 触发时：`CountdownCs = 200cs`, `HealthAccelerationTriggered = true`

- [x] **Task 7: 配置参数外部化** (AC: 4)
  - [x] 在 `data/spawn_rules.yaml` 或新配置文件中添加:
    ```yaml
    healthAcceleration:
      minTriggerTimeCs: 401      # 最小刷出时间
      targetCountdownCs: 200     # 触发后倒计时
      thresholdMin: 0.50         # 血量阈值下限
      thresholdMax: 0.65         # 血量阈值上限
    ```
  - [x] 创建配置加载逻辑

- [x] **Task 8: 与 LevelSystem 集成** (AC: 2, 3)
  - [x] 修改 `pkg/systems/level_system.go`:
    - 在 `spawnWave()` 后调用 `InitializeWaveHealth()`
    - 传递波次僵尸列表信息
  - [x] 确保与现有加速刷新逻辑（消灭触发）协调工作:
    - 两种触发方式任一满足即可加速
    - 防止重复加速

- [x] **Task 9: 单元测试** (AC: 5)
  - [x] 扩展 `pkg/systems/wave_timing_system_test.go`:
    - `TestCalculateZombieEffectiveHealth` - 测试血量计算公式
    - `TestHealthAcceleration_BasicConditions` - 测试基本触发条件
    - `TestHealthAcceleration_ThresholdRange` - 测试阈值范围 (0.50~0.65)
    - `TestHealthAcceleration_NotOnFlagWave` - 测试旗帜波前不触发
    - `TestHealthAcceleration_PreventDoubleTrigger` - 测试防重复触发
    - `TestHealthAcceleration_MinTimeRequirement` - 测试 401cs 最小时间
  - [x] 创建集成测试验证血量追踪准确性
  - [x] 确保覆盖率 ≥ 80%

- [x] **Task 10: 向后兼容验证** (AC: 2)
  - [x] 验证现有关卡（1-1 至 1-4）正常运行
  - [x] 验证 Story 17.7 的消灭触发加速仍正常工作
  - [x] 运行现有测试确保无回归

## Dev Notes

### 前一故事经验 (Story 17.7)

**关键实现决策**:
- `WaveTimingSystem` 已实现消灭触发的加速刷新：`CheckAcceleratedRefresh(allZombiesCleared bool)`
- 加速刷新常量已定义：
  - `AcceleratedRefreshMinTimeCs = 401` - 最小刷出时间
  - `AcceleratedRefreshCountdownCs = 200` - 加速后倒计时
- `WaveTimerComponent` 已有 `WaveElapsedCs` 字段追踪波次已过时间
- 使用泛型 API `ecs.GetComponent[*T]()` 操作组件

**代码位置**:
- 波次计时系统: `pkg/systems/wave_timing_system.go`
- 计时器组件: `pkg/components/wave_timer.go`
- 系统集成: `pkg/systems/level_system.go`

[Source: docs/stories/17.7.flag-wave-timing.story.md#Dev Agent Record]

### 现有加速刷新实现 (Story 17.7)

```go
// CheckAcceleratedRefresh 检查并执行加速刷新（消灭触发）
// 条件：
//   - IsFlagWaveApproaching = true
//   - WaveElapsedCs > AcceleratedRefreshMinTimeCs (401)
//   - CountdownCs > AcceleratedRefreshCountdownCs (200)
//   - allZombiesCleared = true
func (s *WaveTimingSystem) CheckAcceleratedRefresh(allZombiesCleared bool) bool
```

Story 17.8 需要添加**血量触发**加速，与现有**消灭触发**并存。两种触发方式任一满足即可加速。

[Source: pkg/systems/wave_timing_system.go#CheckAcceleratedRefresh]

### 僵尸血量配置

现有 `data/zombie_stats.yaml` 已定义僵尸属性：

```yaml
zombies:
  basic:
    level: 1
    baseHealth: 270
    tier1AccessoryHealth: 0    # I类饰品
    tier2AccessoryHealth: 0    # II类饰品

  conehead:
    level: 2
    baseHealth: 270
    tier1AccessoryHealth: 370  # 路障
    tier2AccessoryHealth: 0

  buckethead:
    level: 4
    baseHealth: 270
    tier1AccessoryHealth: 1100 # 铁桶
    tier2AccessoryHealth: 0
```

**有效血量计算公式**:
```
EffectiveHealth = baseHealth + tier1AccessoryHealth + int(tier2AccessoryHealth * 0.20)
```

**示例**:
- basic: 270 + 0 + 0 = 270
- conehead: 270 + 370 + 0 = 640
- buckethead: 270 + 1100 + 0 = 1370

[Source: data/zombie_stats.yaml]

### 僵尸组件结构

僵尸血量通过以下组件存储：

```go
// pkg/components/health.go
type HealthComponent struct {
    CurrentHealth int  // 当前生命值
    MaxHealth     int  // 最大生命值
    ArmLost       bool // 手臂是否掉落
}

// pkg/components/armor.go
type ArmorComponent struct {
    CurrentArmor int // 当前护甲值（I类饰品）
    MaxArmor     int // 最大护甲值
}
```

**血量追踪策略**:
- 遍历本波所有僵尸实体（通过 `ZombieWaveStateComponent.WaveIndex` 筛选）
- 累加 `HealthComponent.CurrentHealth + ArmorComponent.CurrentArmor`
- 注意：现有实现未区分 I/II 类饰品，当前只有 I 类（路障、铁桶）

[Source: pkg/components/health.go, pkg/components/armor.go]

### 僵尸波次标记

僵尸所属波次通过 `ZombieWaveStateComponent` 标记：

```go
// pkg/components/zombie_wave_state.go
type ZombieWaveStateComponent struct {
    WaveIndex   int  // 所属波次索引（0-based）
    IsActivated bool // 是否已激活
    IndexInWave int  // 在本波中的索引
}
```

[Source: pkg/components/zombie_wave_state.go]

### 架构约束

**组件位置**: `pkg/components/`
[Source: architecture/source-tree.md#pkg/components]

**系统位置**: `pkg/systems/`
[Source: architecture/source-tree.md#pkg/systems]

**遵循原则**:
- 组件为纯数据结构，无方法 [Source: architecture/coding-standards.md#数据-行为分离]
- 系统之间零耦合，通过 EntityManager 通信 [Source: architecture/coding-standards.md#零耦合原则]
- 使用泛型 API 操作组件 [Source: CLAUDE.md#泛型API]

### 时间单位说明

原版 PvZ 使用 **厘秒 (centiseconds, cs)** 作为物理更新基准：
- 1 厘秒 = 0.01 秒
- 100 厘秒 = 1 秒
- 游戏逻辑以 100FPS 运行（固定时间步长 0.01 秒）

[Source: CLAUDE.md#原版时间步长]

### 设计决策建议

**方案 A: 扩展 WaveTimingSystem（推荐）**
- 在 `WaveTimingSystem` 中添加血量追踪逻辑
- 优点：逻辑集中，与现有加速刷新代码共存
- 缺点：需要遍历僵尸实体

**方案 B: 创建独立 WaveHealthTrackerSystem**
- 单独系统负责血量追踪
- 通过组件与 WaveTimingSystem 通信
- 优点：职责分离
- 缺点：增加系统复杂度

**推荐方案 A**：在 `WaveTimingSystem` 中扩展，因为：
1. 加速刷新逻辑已在该系统中
2. 血量触发和消灭触发需要协调工作
3. 避免系统间耦合问题

### 与 Story 17.9 的关系

Story 17.9（僵尸物理与边界 - 坐标系统）与本 Story 无直接依赖。
可并行开发。

## Testing

### 测试文件位置

- `pkg/systems/wave_timing_system_test.go` - 扩展现有测试

[Source: architecture/testing-strategy.md#测试文件位置]

### 测试框架

使用 Go 标准库 `testing` 包，不引入额外测试框架。
[Source: architecture/tech-stack.md#Testing]

### 测试策略

**单元测试重点**:
1. 血量计算公式验证（I/II类饰品权重）
2. 血量触发阈值范围（0.50~0.65）
3. 触发条件组合测试
4. 防止重复触发
5. 与消灭触发协调工作

**测试用例设计**:

```go
// 1. 血量计算公式测试
func TestCalculateZombieEffectiveHealth(t *testing.T) {
    tests := []struct {
        name   string
        base   int
        tier1  int
        tier2  int
        expect int
    }{
        {"basic", 270, 0, 0, 270},
        {"conehead", 270, 370, 0, 640},
        {"buckethead", 270, 1100, 0, 1370},
        {"with_tier2", 270, 0, 500, 370}, // 270 + 0 + 500*0.2
    }
    // ...
}

// 2. 血量触发测试
func TestHealthAcceleration_BasicTrigger(t *testing.T) {
    // Given: WaveElapsedCs > 401, CountdownCs > 200
    //        CurrentHealth <= InitialHealth * 0.50
    // When: CheckHealthAcceleratedRefresh()
    // Then: CountdownCs = 200, HealthAccelerationTriggered = true
}

// 3. 阈值范围测试
func TestHealthAcceleration_ThresholdRange(t *testing.T) {
    // Given: 多次初始化波次
    // When: 检查 HealthTriggerThreshold
    // Then: 值在 [0.50, 0.65] 范围内
}

// 4. 旗帜波前不触发测试
func TestHealthAcceleration_NotOnFlagWave(t *testing.T) {
    // Given: IsFlagWaveApproaching = true, 血量条件满足
    // When: CheckHealthAcceleratedRefresh()
    // Then: 不触发（旗帜波前使用消灭触发逻辑）
}

// 5. 防重复触发测试
func TestHealthAcceleration_PreventDoubleTrigger(t *testing.T) {
    // Given: 已触发过血量加速 (HealthAccelerationTriggered = true)
    // When: 再次检查
    // Then: 不再触发
}
```

### 覆盖率目标

- WaveTimerComponent 新增字段: ≥ 80%
- 血量计算函数: ≥ 90%
- 血量触发逻辑: ≥ 80%
- 整体: ≥ 80%

### 运行测试命令

```bash
# 运行本 Story 相关测试
go test ./pkg/systems -run TestWaveTimingSystem -v
go test ./pkg/systems -run TestHealthAcceleration -v
go test ./pkg/systems -run TestCalculateZombieEffectiveHealth -v

# 查看覆盖率
go test ./pkg/systems -run TestWaveTimingSystem -cover

# 运行所有测试确保无回归
go test ./...
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-27 | 0.1 | Initial draft creation | Bob (Scrum Master) |

---

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

- Story 17.8 相关测试全部通过 (12 个新测试用例)
- 现有关卡配置 (1-1 至 1-4) 加载测试通过
- Story 17.7 消灭触发加速测试仍然通过

### Completion Notes

**实现概述**:
1. 扩展了 `WaveTimerComponent` 添加 4 个血量追踪字段
2. 验证了 `zombie_stats.yaml` 中的僵尸饰品血量配置正确
3. 创建了血量计算工具函数 `CalculateZombieEffectiveHealth` 和 `GetZombieTypeEffectiveHealth`
4. 实现了 `InitializeWaveHealth` 方法初始化波次血量追踪
5. 实现了 `CalculateCurrentWaveHealth` 函数计算实时血量
6. 创建了 `CheckHealthAcceleratedRefresh` 方法实现血量触发加速
7. 在 `spawn_rules.yaml` 中添加了 `healthAcceleration` 配置节
8. 与 `LevelSystem` 集成，在波次激活后初始化血量追踪
9. 编写了 12 个单元测试，全部通过
10. 验证了向后兼容性，现有关卡正常运行

**关键设计决策**:
- 采用方案 A：扩展 `WaveTimingSystem` 而非创建独立系统
- 血量触发与消灭触发并存，任一满足即可加速
- 使用 `HealthAccelerationTriggered` 标志防止重复触发
- 旗帜波前使用消灭触发，常规波次使用血量触发

**测试覆盖**:
- `TestCalculateZombieEffectiveHealth` - 血量计算公式 (5 子测试)
- `TestGetZombieTypeEffectiveHealth` - 配置查询 (5 子测试)
- `TestWaveTimingSystem_InitializeWaveHealth` - 初始化测试
- `TestWaveTimingSystem_HealthAcceleration_BasicTrigger` - 基本触发
- `TestWaveTimingSystem_HealthAcceleration_ThresholdRange` - 阈值范围验证
- `TestWaveTimingSystem_HealthAcceleration_NotOnFlagWave` - 旗帜波排除
- `TestWaveTimingSystem_HealthAcceleration_PreventDoubleTrigger` - 防重复触发
- `TestWaveTimingSystem_HealthAcceleration_MinTimeRequirement` - 最小时间要求
- `TestWaveTimingSystem_HealthAcceleration_CountdownAlreadyLow` - 倒计时已低检查
- `TestCalculateCurrentWaveHealth` - 实时血量计算
- `TestWaveTimingSystem_UpdateWaveCurrentHealth` - 血量更新

### File List

**修改的文件**:
- `pkg/components/wave_timer.go` - 添加 4 个血量追踪字段
- `pkg/systems/wave_timing_system.go` - 添加血量计算函数和追踪方法
- `pkg/systems/wave_timing_system_test.go` - 添加 12 个单元测试
- `pkg/systems/level_system.go` - 添加 LevelSystem 集成代码
- `pkg/config/spawn_rules.go` - 添加 HealthAccelerationConfig 结构
- `data/spawn_rules.yaml` - 添加 healthAcceleration 配置节

**新增代码行数估算**: ~350 行
- wave_timing_system.go: ~150 行新增
- wave_timing_system_test.go: ~160 行新增
- level_system.go: ~40 行新增

---

## QA Results

### Review Date: 2025-11-27

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**整体评价: 优秀 (95/100)**

本 Story 的实现质量很高，代码遵循 ECS 架构规范，逻辑清晰，测试覆盖全面。

**架构设计 ✓**
- 采用方案 A（扩展 WaveTimingSystem）是正确的选择，保持了逻辑集中
- 血量触发与消灭触发两种加速机制协调工作良好
- 组件字段命名清晰，文档注释完善

**代码质量 ✓**
- `CalculateZombieEffectiveHealth` 和 `GetZombieTypeEffectiveHealth` 是纯函数，易于测试
- `CheckHealthAcceleratedRefresh` 条件检查顺序合理，提前返回减少嵌套
- 防重复触发标志 `HealthAccelerationTriggered` 设计正确
- 日志输出包含关键信息（血量、阈值、触发状态）

**集成质量 ✓**
- LevelSystem 正确集成血量追踪初始化
- `extractZombieSpawnInfo` 支持新旧格式兼容
- 配置验证完善，包含默认值应用

### Refactoring Performed

无需重构。代码已经达到良好的质量标准。

### Compliance Check

- Coding Standards: ✓ GoDoc 注释完整，命名规范
- Project Structure: ✓ 组件在 pkg/components，系统在 pkg/systems
- Testing Strategy: ✓ 12 个单元测试，覆盖所有核心逻辑
- All ACs Met: ✓ 全部 5 个验收标准已满足

### Improvements Checklist

- [x] 血量计算公式正确实现 (AC1)
- [x] 刷新激活条件完整 (AC2)
- [x] 血量追踪机制正常工作 (AC3)
- [x] 配置参数可外部化 (AC4)
- [x] 测试覆盖率 >= 80% (AC5)
- [x] 与 Story 17.7 消灭触发协调工作
- [ ] 未来建议：考虑从配置文件读取常量（非阻塞）

### Security Review

无安全问题。本 Story 仅涉及游戏逻辑，不涉及用户输入验证、网络通信或敏感数据处理。

### Performance Considerations

**评估: PASS**

- 血量遍历每帧执行，遍历本波僵尸实体
- 典型场景僵尸数量 < 50，性能影响可忽略
- `CalculateCurrentWaveHealth` 使用泛型 API 查询，效率可接受
- 如果未来僵尸数量显著增加，可考虑缓存优化

### Files Modified During Review

无文件修改。

### Gate Status

Gate: **PASS** → docs/qa/gates/17.8-health-triggered-acceleration.yml

### Recommended Status

✓ **Ready for Done**

所有验收标准已满足，测试全部通过，代码质量良好。建议将状态更新为 Done。

