# Story 20.4: Embed 实现 (资源加载重构)

## Status

Done

## Story

**As a** 开发者,
**I want** to embed all game resources into the executable,
**so that** the game can be distributed as a single file.

## Acceptance Criteria

1. 在项目根目录创建 `embed.go`，在 `pkg/embedded/` 创建访问包装
2. Embed 范围：`assets/` (44MB) + `data/`（排除 saves/ 和 workspaces/，约 11MB）
3. 修改 `ResourceManager.LoadImage()` 从 embed.FS 加载
4. 修改 `ResourceManager.LoadAudio()` 从 embed.FS 加载
5. 修改所有使用 `os.ReadFile()` 的 `pkg/config/*.go` 从 embed.FS 加载
6. 修改 `pkg/utils/bitmap_font.go` 从 embed.FS 加载
7. 修改 `pkg/game/lawn_strings.go` 从 embed.FS 加载
8. 游戏能正常运行，所有资源加载成功
9. 编译后生成单一可执行文件（约 55MB+）
10. 单元测试覆盖率 ≥ 80%

## Tasks / Subtasks

- [x] **Task 0: 验证前置依赖** (前置条件)
  - [x] 验证 gdata 依赖已添加：`grep "github.com/quasilyte/gdata" go.mod`
  - [x] 验证 SaveManager 已重构：`grep "gdataManager" pkg/game/save_manager.go`
  - [x] 验证 SettingsManager 存在：`ls pkg/game/settings_manager.go`
  - [x] 如果任何验证失败，停止并报告需要先完成 Story 20.1-20.3

- [x] **Task 1: 创建 embed 声明和访问包** (AC: 1, 2)
  - [x] **Step 1.1**: 在项目根目录创建 `embed.go` 文件（与 main.go 同级）
    - [x] 声明 `package main`
    - [x] 声明 `//go:embed all:assets` 嵌入 assets 目录
    - [x] 声明 `//go:embed data/reanim data/reanim_config data/levels data/particles` 嵌入 data 子目录
    - [x] 声明 `//go:embed data/reanim_config.yaml data/spawn_rules.yaml data/zombie_physics.yaml data/zombie_stats.yaml` 嵌入 data 配置文件
  - [x] **Step 1.2**: 创建 `pkg/embedded/` 目录
  - [x] **Step 1.3**: 创建 `pkg/embedded/embedded.go` 访问包装文件
    - [x] 声明 `package embedded`
    - [x] 创建包级变量 `var assetsFS, dataFS embed.FS`
    - [x] 创建 `Init(assets, data embed.FS)` 初始化函数
    - [x] 创建 `Open(path string) (fs.File, error)` 统一访问函数
    - [x] 创建 `ReadFile(path string) ([]byte, error)` 统一读取函数
    - [x] 创建 `Exists(path string) bool` 存在性检查函数
    - [x] 创建 `Glob(pattern string) ([]string, error)` 文件匹配函数
  - [x] **Step 1.4**: 在 `main.go` 的 `init()` 或 `main()` 开头调用 `embedded.Init(assetsFS, dataFS)`

- [x] **Task 2: 重构 ResourceManager 图像加载** (AC: 3)
  - [x] 修改 `LoadImage()` 方法：
    - [x] 添加 `import "github.com/gonewx/pvz/pkg/embedded"`
    - [x] 将 `os.Open(path)` 替换为 `embedded.Open(path)`
    - [x] 保持缓存逻辑不变
  - [x] 修改 `LoadImageWithAlphaMask()` 方法：
    - [x] 将 `os.Open(rgbPath)` 替换为 `embedded.Open(rgbPath)`
    - [x] 将 `os.Open(alphaPath)` 替换为 `embedded.Open(alphaPath)`
  - [x] 修改 `LoadCompositedImage()` 方法：
    - [x] 将 `os.Open(basePath)` 替换为 `embedded.Open(basePath)`
    - [x] 将 `os.Open(maskPath)` 替换为 `embedded.Open(maskPath)`

- [x] **Task 3: 重构 ResourceManager 音频加载** (AC: 4)
  - [x] 修改 `LoadAudio()` 方法：
    - [x] 将 `os.Open(path)` 替换为 `embedded.ReadFile(path)`
    - [x] 保持音频解码逻辑不变
  - [x] 修改 `LoadSoundEffect()` 方法：
    - [x] 将 `os.Open(path)` 替换为 `embedded.ReadFile(path)`

- [x] **Task 4: 重构 ResourceManager 其他加载方法** (AC: 3, 4)
  - [x] 修改 `LoadFont()` 方法：
    - [x] 将 `os.ReadFile(path)` 替换为 `embedded.ReadFile(path)`
  - [x] 修改 `LoadResourceConfig()` 方法：
    - [x] 将 `os.ReadFile(configPath)` 替换为 `embedded.ReadFile(configPath)`
  - [x] 修改 `buildResourceMap()` 方法：
    - [x] 将 `os.Stat(testPath)` 替换为 `embedded.Exists(testPath)`
  - [x] 修改 `LoadReanimResources()` 方法：
    - [x] 将 `filepath.Glob(pattern)` 替换为 `embedded.Glob(pattern)`

- [x] **Task 5: 重构 pkg/config 配置加载** (AC: 5)
  - [x] 修改 `pkg/config/level_config.go`:
    - [x] 添加 `import "github.com/gonewx/pvz/pkg/embedded"`
    - [x] 更新 `LoadLevelConfig()`：`os.ReadFile()` → `embedded.ReadFile()`
  - [x] 修改 `pkg/config/spawn_rules.go`:
    - [x] 更新 `LoadSpawnRules()`：`os.ReadFile()` → `embedded.ReadFile()`
  - [x] 修改 `pkg/config/reanim_config.go`:
    - [x] 更新 `LoadReanimConfig()`：`os.ReadFile()` → `embedded.ReadFile()`
  - [x] 修改 `pkg/config/reanim_config_manager.go`:
    - [x] 更新 `NewReanimConfigManager()`：`os.Stat()` → `embedded.ReadDir()` / `embedded.Exists()`
    - [x] 更新 `loadFromFile()`：`os.ReadFile()` → `embedded.ReadFile()`
    - [x] 更新 `loadFromDirectory()`：`filepath.Glob()` → `embedded.Glob()`
    - [x] 更新 `loadAnimationUnit()`：`os.ReadFile()` → `embedded.ReadFile()`
    - [x] 更新 `loadGlobalConfig()`：`os.Stat()` → `embedded.Exists()`，`os.ReadFile()` → `embedded.ReadFile()`
  - [x] 修改 `pkg/config/zombie_physics.go`:
    - [x] 更新 `LoadZombiePhysicsConfig()`：`os.ReadFile()` → `embedded.ReadFile()`
  - [x] 修改 `pkg/config/zombie_stats.go`:
    - [x] 更新 `LoadZombieStats()`：`os.ReadFile()` → `embedded.ReadFile()`

- [x] **Task 6: 重构 bitmap_font.go** (AC: 6)
  - [x] 修改 `pkg/utils/bitmap_font.go`:
    - [x] 添加 `import "github.com/gonewx/pvz/pkg/embedded"`
    - [x] 修改 `LoadBitmapFont()` 函数：`os.ReadFile(metaPath)` → `embedded.ReadFile(metaPath)`
    - [x] 修改 `loadImage()` 辅助函数：`os.Open(path)` → `embedded.Open(path)`
    - [x] 修改 `parseFontMeta()` 函数：`os.ReadFile(path)` → `embedded.ReadFile(path)`

- [x] **Task 7: 重构 lawn_strings.go** (AC: 7)
  - [x] 修改 `pkg/game/lawn_strings.go`:
    - [x] 添加 `import "github.com/gonewx/pvz/pkg/embedded"`
    - [x] 修改 `NewLawnStrings()`：`os.Open()` → `embedded.Open()`

- [x] **Task 8: 重构 internal 包的解析器** (AC: 3, 4)
  - [x] 修改 `internal/reanim/parser.go`:
    - [x] 添加 `import "github.com/gonewx/pvz/pkg/embedded"`
    - [x] 修改 `ParseReanimFile()`：`os.ReadFile()` → `embedded.ReadFile()`
  - [x] 修改 `internal/particle/parser.go`:
    - [x] 添加 `import "github.com/gonewx/pvz/pkg/embedded"`
    - [x] 修改 `ParseParticleXML()`：`os.ReadFile()` → `embedded.ReadFile()`

- [x] **Task 9: 编写单元测试** (AC: 10)
  - [x] 创建 `pkg/embedded/embedded_test.go`:
    - [x] 测试 `IsInitialized()` 状态检测
    - [x] 测试 `Open()` 未初始化时返回错误
    - [x] 测试 `ReadFile()` 未初始化时返回错误
    - [x] 测试 `Exists()` 未初始化时返回 false
    - [x] 测试 `Glob()` 未初始化时返回错误
    - [x] 测试无效路径前缀返回正确错误
    - [x] 测试路径规范化（移除 "./" 前缀）
    - [x] 覆盖率达到 93.2%

- [x] **Task 10: 验证与构建** (AC: 8, 9)
  - [x] 运行 `go build -o pvz_game .` 确保编译成功
  - [x] 检查编译后的可执行文件大小：69MB（符合预期 55-70MB）
  - [x] embedded 包测试覆盖率 93.2%（超过 80% 要求）
  - [x] 游戏可正常启动运行

## Dev Notes

### 前置依赖

**Story 20.1-20.3 必须已完成**：gdata 存储系统已集成，用户数据（saves/）已迁移到 gdata。

**验证步骤**（Task 0 执行）：
```bash
# 验证 gdata 依赖
grep "github.com/quasilyte/gdata" go.mod
# 预期输出：github.com/quasilyte/gdata/v2 v2.x.x

# 验证 SaveManager 已重构
grep "gdataManager" pkg/game/save_manager.go
# 预期输出：包含 gdataManager 字段

# 验证 SettingsManager 存在
ls pkg/game/settings_manager.go
# 预期输出：文件存在
```

[Source: docs/stories/20.3.save-manager-gdata-refactor.story.md]

### Go embed 关键限制

**重要**：`//go:embed` 指令只能嵌入**当前包目录及其子目录**的文件，不支持上级目录引用（如 `../assets`）。

因此，embed 声明必须放在项目根目录（与 `assets/` 和 `data/` 同级），然后通过包装函数暴露给其他包。

[Source: https://pkg.go.dev/embed - "Patterns are relative to the directory containing the source file."]

### 正确的 embed 架构

```
pvz/
├── main.go
├── embed.go          # ← embed.FS 变量声明（必须在根目录）
├── assets/           # ← 被嵌入
├── data/             # ← 被嵌入（排除 saves/ 和 workspaces/）
└── pkg/
    └── embedded/
        └── embedded.go  # ← 访问包装函数
```

### embed.go（项目根目录）

```go
// embed.go - 必须放在项目根目录
package main

import "embed"

//go:embed all:assets
var assetsFS embed.FS

//go:embed data/reanim data/reanim_config data/levels data/particles
//go:embed data/reanim_config.yaml data/spawn_rules.yaml
//go:embed data/zombie_physics.yaml data/zombie_stats.yaml
var dataFS embed.FS
```

**注意事项**：
- `//go:embed` 指令必须紧邻变量声明（中间不能有空行）
- 使用 `all:assets` 可嵌入所有文件（包括以 `.` 或 `_` 开头的文件）
- `data/saves/` 和 `data/workspaces/` 不嵌入（用户数据由 gdata 管理）

### pkg/embedded/embedded.go（访问包装）

```go
// pkg/embedded/embedded.go
package embedded

import (
    "embed"
    "fmt"
    "io/fs"
    "path/filepath"
    "strings"
)

var (
    assetsFS embed.FS
    dataFS   embed.FS
    initialized bool
)

// Init 初始化 embed.FS 变量，必须在 main() 开始时调用
func Init(assets, data embed.FS) {
    assetsFS = assets
    dataFS = data
    initialized = true
}

// Open 根据路径前缀选择正确的 embed.FS 并打开文件
func Open(path string) (fs.File, error) {
    if !initialized {
        return nil, fmt.Errorf("embedded package not initialized, call Init() first")
    }
    // 标准化路径分隔符
    path = filepath.ToSlash(path)

    if strings.HasPrefix(path, "assets/") {
        return assetsFS.Open(path)
    } else if strings.HasPrefix(path, "data/") {
        return dataFS.Open(path)
    }
    return nil, fmt.Errorf("unknown resource path prefix: %s", path)
}

// ReadFile 根据路径前缀选择正确的 embed.FS 并读取文件
func ReadFile(path string) ([]byte, error) {
    if !initialized {
        return nil, fmt.Errorf("embedded package not initialized, call Init() first")
    }
    path = filepath.ToSlash(path)

    if strings.HasPrefix(path, "assets/") {
        return fs.ReadFile(assetsFS, path)
    } else if strings.HasPrefix(path, "data/") {
        return fs.ReadFile(dataFS, path)
    }
    return nil, fmt.Errorf("unknown resource path prefix: %s", path)
}

// Exists 检查文件是否存在于 embed.FS 中
func Exists(path string) bool {
    file, err := Open(path)
    if err != nil {
        return false
    }
    file.Close()
    return true
}

// Glob 在 embed.FS 中匹配文件
func Glob(pattern string) ([]string, error) {
    if !initialized {
        return nil, fmt.Errorf("embedded package not initialized, call Init() first")
    }
    pattern = filepath.ToSlash(pattern)

    if strings.HasPrefix(pattern, "assets/") {
        return fs.Glob(assetsFS, pattern)
    } else if strings.HasPrefix(pattern, "data/") {
        return fs.Glob(dataFS, pattern)
    }
    return nil, fmt.Errorf("unknown resource path prefix: %s", pattern)
}
```

### main.go 初始化

```go
// main.go
package main

import (
    "github.com/gonewx/pvz/pkg/embedded"
    // ... 其他 import
)

func main() {
    // 初始化 embedded 包（必须在任何资源加载之前）
    embedded.Init(assetsFS, dataFS)

    // ... 其余初始化代码
}
```

### 需要修改的文件清单（精确版）

根据代码 Grep 结果，以下文件实际使用了文件系统 API：

| 文件 | 需要替换的调用 | 行号 |
|------|----------------|------|
| `pkg/game/resource_manager.go` | `os.Open()`, `os.ReadFile()`, `os.Stat()`, `filepath.Glob()` | 140, 192, 204, 311, 401, 506, 559, 821, 872, 1042, 1054 |
| `pkg/config/level_config.go` | `os.ReadFile()` | 167 |
| `pkg/config/spawn_rules.go` | `os.ReadFile()` | 49 |
| `pkg/config/reanim_config.go` | `os.ReadFile()` | 90 |
| `pkg/config/reanim_config_manager.go` | `os.Stat()`, `os.ReadFile()`, `filepath.Glob()` | 74, 90, 129, 178, 197, 199 |
| `pkg/config/zombie_physics.go` | `os.ReadFile()` | 69 |
| `pkg/config/zombie_stats.go` | `os.ReadFile()` | 34 |
| `pkg/utils/bitmap_font.go` | `os.ReadFile()`, `os.Open()` | 50, 314, 330 |
| `pkg/game/lawn_strings.go` | `os.Open()` | 35 |
| `internal/reanim/parser.go` | `os.ReadFile()` | 30 |
| `internal/particle/parser.go` | `os.ReadFile()` | 30 |

### embed.FS 路径注意事项

1. **路径格式**：embed.FS 使用正斜杠 `/`，即使在 Windows 上
2. **路径前缀**：嵌入路径保留目录结构，如 `assets/images/MainMenu.png`
3. **无 `./` 前缀**：不要使用 `./assets/...`，直接使用 `assets/...`
4. **大小写敏感**：路径区分大小写

### 可执行文件大小预估

| 组成部分 | 大小 |
|----------|------|
| assets/ 目录 | ~44 MB |
| data/ 目录（排除 saves/） | ~11 MB |
| Go 运行时 + 代码 | ~10-15 MB |
| **预估总计** | **~55-70 MB** |

[Source: docs/design/embed-and-cross-platform-storage.md#2.2]

## Testing

### 测试标准 [Source: docs/architecture/testing-strategy.md]

- **框架**: Go 标准库 `testing` 包
- **位置**: 测试文件与源文件同包，以 `_test.go` 结尾
- **覆盖率目标**: ≥ 80%

### 测试用例

| 测试函数 | 验证内容 | AC |
|----------|----------|-----|
| `TestEmbedInit` | Init() 正确初始化 FS 变量 | AC1 |
| `TestEmbedOpenAssets` | Open() 可打开 assets 目录文件 | AC1, AC2 |
| `TestEmbedOpenData` | Open() 可打开 data 目录文件 | AC1, AC2 |
| `TestEmbedReadFile` | ReadFile() 正确读取文件内容 | AC1, AC2 |
| `TestEmbedExists` | Exists() 正确检测文件存在性 | AC1, AC2 |
| `TestEmbedGlob` | Glob() 正确匹配文件 | AC1, AC2 |
| `TestEmbedOpenInvalidPath` | 无效路径返回错误 | AC1 |
| `TestEmbedNotInitialized` | 未初始化时返回错误 | AC1 |
| `TestResourceManagerLoadImage` | LoadImage() 从 embed.FS 加载成功 | AC3 |
| `TestResourceManagerLoadAudio` | LoadAudio() 从 embed.FS 加载成功 | AC4 |
| `TestConfigLoadFromEmbed` | 配置文件从 embed.FS 加载成功 | AC5 |
| `TestBitmapFontFromEmbed` | 位图字体从 embed.FS 加载成功 | AC6 |
| `TestLawnStringsFromEmbed` | LawnStrings 从 embed.FS 加载成功 | AC7 |

### 运行测试

```bash
# 运行所有测试
go test -v -cover ./pkg/...

# 运行特定包测试
go test -v -cover ./pkg/embedded/...
go test -v -cover ./pkg/game/...
go test -v -cover ./pkg/config/...
```

### 构建验证

```bash
# 构建并检查文件大小
go build -o pvz_game .
ls -lh pvz_game
# 预期输出：约 55-70 MB

# 验证游戏运行
./pvz_game
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-03 | 1.0 | 初始创建 | Bob (SM) |
| 2025-12-03 | 1.1 | 修复 PO 审查问题：修正 embed.go 路径设计、精确文件列表、添加前置依赖验证 | Bob (SM) |
| 2025-12-03 | 1.2 | PO 验证修正：修正 bitmap_font.go 行号(50,314,330)、补充 reanim_config_manager.go 遗漏调用(74,129,197行)、更新文件清单表格 | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5

### Debug Log References

无需调试日志，所有任务顺利完成。

### Completion Notes List

1. 创建 `embed.go` 在项目根目录，嵌入 `assets/` 和 `data/` 目录（排除 `saves/` 和 `workspaces/`）
2. 创建 `pkg/embedded/embedded.go` 提供统一的资源访问接口（Open, ReadFile, Exists, Glob, ReadDir, Sub, Stat）
3. 更新 `main.go` 在程序启动时调用 `embedded.Init(assetsFS, dataFS)`
4. 重构 `pkg/game/resource_manager.go` 的所有资源加载方法使用 embedded 包
5. 重构 `pkg/config/` 下所有配置加载文件使用 embedded 包
6. 重构 `pkg/utils/bitmap_font.go` 使用 embedded 包
7. 重构 `pkg/game/lawn_strings.go` 使用 embedded 包
8. 重构 `internal/reanim/parser.go` 和 `internal/particle/parser.go` 使用 embedded 包
9. 编写 `pkg/embedded/embedded_test.go` 单元测试，覆盖率 93.2%
10. 编译成功，可执行文件大小 69MB，游戏正常运行

### File List

**新增文件：**
- `embed.go` - 资源嵌入声明（项目根目录）
- `pkg/embedded/embedded.go` - 统一资源访问接口
- `pkg/embedded/embedded_test.go` - 单元测试（覆盖率 93.2%）
- `pkg/embedded/init_test.go` - 测试环境初始化辅助

**修改文件：**
- `main.go` - 添加 embedded.Init() 调用
- `pkg/game/resource_manager.go` - 使用 embedded 包加载资源
- `pkg/game/lawn_strings.go` - 使用 embedded 包
- `pkg/config/level_config.go` - 使用 embedded 包
- `pkg/config/spawn_rules.go` - 使用 embedded 包
- `pkg/config/reanim_config.go` - 使用 embedded 包
- `pkg/config/reanim_config_manager.go` - 使用 embedded 包
- `pkg/config/zombie_physics.go` - 使用 embedded 包
- `pkg/config/zombie_stats.go` - 使用 embedded 包
- `pkg/utils/bitmap_font.go` - 使用 embedded 包
- `internal/reanim/parser.go` - 使用 embedded 包
- `internal/particle/parser.go` - 使用 embedded 包

---

## QA Results

### Review Date: 2025-12-03

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

实现质量优秀。代码结构清晰，遵循了项目的架构规范和编码标准。所有 AC 都已正确实现：

1. **embed.go** - 正确放置在项目根目录，使用 `all:assets` 和分块的 `data/` 嵌入声明
2. **pkg/embedded/** - 提供了完整的访问包装接口（Open, ReadFile, Exists, Glob, ReadDir, Sub, Stat）
3. **初始化机制** - main.go 第 66 行正确调用 `embedded.Init(assetsFS, dataFS)`
4. **资源加载重构** - 所有 12 个目标文件都已正确替换为使用 embedded 包
5. **测试覆盖率** - 93.2%（超过 80% 要求）
6. **可执行文件大小** - 69MB（符合 55-70MB 预期）

### Refactoring Performed

无需重构。代码实现规范，没有发现需要改进的问题。

### Compliance Check

- Coding Standards: ✓ 遵循 Go 命名约定和项目编码规范
- Project Structure: ✓ embed.go 放置在正确位置，pkg/embedded/ 结构合理
- Testing Strategy: ✓ 测试覆盖率 93.2%，所有测试通过
- All ACs Met: ✓ 10 个验收标准全部满足

### Improvements Checklist

- [x] embed.go 正确声明嵌入资源
- [x] pkg/embedded/embedded.go 提供完整的访问接口
- [x] main.go 正确初始化 embedded 包
- [x] ResourceManager 所有加载方法已重构
- [x] pkg/config/*.go 所有配置加载已重构
- [x] pkg/utils/bitmap_font.go 已重构
- [x] pkg/game/lawn_strings.go 已重构
- [x] internal/reanim/parser.go 已重构
- [x] internal/particle/parser.go 已重构
- [x] 单元测试覆盖率达标
- [x] 构建验证通过

### Security Review

无安全问题。embed.FS 是只读的，不会引入文件系统注入风险。

### Performance Considerations

使用 embed.FS 可能略微增加启动时内存使用，但对于游戏应用属于可接受范围。运行时性能与文件系统读取相当或更优（无磁盘 I/O）。

### Files Modified During Review

无文件修改。

### Gate Status

Gate: **PASS** → docs/qa/gates/20.4-embed-resource-loading-refactor.yml

### Recommended Status

✓ Ready for Done
