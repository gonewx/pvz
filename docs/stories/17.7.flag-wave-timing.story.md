# Story 17.7: 旗帜波特殊计时与红字警告

## Status

Done

## Story

**As a** 开发者,
**I want** to implement flag wave special timing and "huge wave" warning,
**so that** the game follows original flag wave mechanics with proper timing and visual warnings.

## Acceptance Criteria

1. **旗帜波前一波（第 9/19 波）计时**:
   - 倒计时设置为 4500 厘秒 (45秒)
   - 加速刷新：刷出 401cs 后且倒计时 > 200cs，消灭本波僵尸（除伴舞）后设为 200cs

2. **红字警告**:
   - 倒计时降至 5 时显示红字 "A Huge Wave of Zombies is Approaching!"
   - 在 4 停留 725 厘秒
   - 红字倒计时结束后 (~750cs) 触发下一波

3. **最终波（第 20 波）计时**:
   - 倒计时设置为 5500 厘秒 (55秒)
   - 使用 `FinalWave.reanim` 动画显示最后一波提示

4. **UI 集成**:
   - 红字 "A Huge Wave of Zombies is Approaching!" 动画（原版样式）
   - 最终波使用 `FinalWave.reanim` 动画（由 FinalWaveWarningSystem 管理）
   - 动画包含缩放、闪烁效果

5. **单元测试**: 覆盖率 ≥ 80%

## Tasks / Subtasks

- [x] **Task 1: 扩展 WaveTimerComponent 组件** (AC: 1, 2, 3)
  - [x] 在 `pkg/components/wave_timer.go` 添加旗帜波字段:
    - `IsFlagWaveApproaching bool` - 是否正在接近旗帜波
    - `FlagWaveCountdownPhase int` - 红字警告阶段 (0=无, 5=显示红字, 4=停留)
    - `FlagWavePhaseTimeCs int` - 当前阶段已持续时间（厘秒）
    - `IsFinalWave bool` - 是否为最终波
  - [x] 添加 GoDoc 注释说明各字段用途

- [x] **Task 2: 实现旗帜波前一波特殊计时** (AC: 1)
  - [x] 在 `pkg/systems/wave_timing_system.go` 修改 `SetNextWaveCountdown()`:
    - 检测下一波是否为旗帜波（isFlag = true）
    - 如果是，设置倒计时为 4500cs 而非常规 2500+rand(600)
  - [x] 添加常量:
    - `FlagWavePrefixDelayCs = 4500` // 旗帜波前一波延迟
    - `FinalWaveDelayCs = 5500` // 最终波延迟
  - [x] 实现旗帜波判定函数 `isNextWaveFlagWave(waveIndex int) bool`

- [x] **Task 3: 实现红字警告阶段系统** (AC: 2)
  - [x] 在 `WaveTimingSystem.Update()` 中添加红字警告逻辑:
    - 当倒计时 = 5 时，进入 Phase 5（显示红字）
    - Phase 5: 设置 `FlagWaveCountdownPhase = 5`，触发红字显示
    - 当倒计时 = 4 时，进入 Phase 4（停留）
    - Phase 4: 停留 725cs (`FlagWavePhaseTimeCs` 计时)
    - 停留结束后触发下一波
  - [x] 添加常量:
    - `FlagWavePhase4DurationCs = 725` // Phase 4 停留时间
    - `FlagWarningTotalDurationCs = 750` // 红字总显示时间（约）

- [x] **Task 4: 实现最终波计时逻辑** (AC: 3)
  - [x] 在 `WaveTimingSystem` 中添加最终波处理:
    - 检测当前波是否为最终波
    - 设置倒计时为 5500cs
    - 最终波使用现有 `FinalWave.reanim` 动画系统

- [x] **Task 5: 创建红字警告 UI 系统** (AC: 4)
  - [x] 创建 `pkg/systems/flag_wave_warning_system.go`:
    - 监听 `WaveTimerComponent.FlagWaveCountdownPhase`
    - Phase 5 时创建红字动画实体
    - 管理动画生命周期（缩放、闪烁效果）
  - [x] 创建 `pkg/components/flag_wave_warning_component.go`:
    - `Text string` - 显示文本
    - `Phase int` - 当前阶段
    - `ElapsedTimeCs int` - 已显示时间
    - `Scale float64` - 当前缩放
    - `Alpha float64` - 透明度

- [x] **Task 6: UI 渲染集成** (AC: 4)
  - [x] 在 `pkg/scenes/game_scene_ui.go` 中:
    - 添加红字警告渲染方法 `drawHugeWaveWarning()`
    - 最终波使用现有 `FinalWave.reanim` 动画系统
    - 实现文本居中、缩放、闪烁效果

- [x] **Task 7: 加速刷新逻辑（旗帜波前）** (AC: 1)
  - [x] 在 `WaveTimingSystem` 中实现加速刷新:
    - 条件: 刷出 > 401cs 且倒计时 > 200cs
    - 当本波僵尸全部消灭（除伴舞）时
    - 将倒计时设为 200cs
  - [x] 添加僵尸存活检查接口（通过 GameState）
  - [x] 添加常量:
    - `AcceleratedRefreshMinTimeCs = 401` // 最小刷出时间
    - `AcceleratedRefreshCountdownCs = 200` // 加速后倒计时

- [x] **Task 8: 与 LevelSystem 集成** (AC: 1, 2, 3)
  - [x] 修改 `pkg/systems/level_system.go`:
    - 在 `checkAndSpawnWaves()` 中处理旗帜波触发
    - 更新进度条以反映旗帜波状态
    - 处理最终波完成后的游戏结束逻辑

- [x] **Task 9: 单元测试** (AC: 5)
  - [x] 扩展 `pkg/systems/wave_timing_system_test.go`:
    - 测试旗帜波前一波倒计时（4500cs）
    - 测试红字警告阶段转换（5 → 4 → 触发）
    - 测试 Phase 4 停留 725cs
    - 测试最终波倒计时（5500cs）
    - 测试加速刷新条件和触发
  - [x] 创建 `pkg/systems/flag_wave_warning_system_test.go`:
    - 测试组件创建和销毁
    - 测试动画阶段转换
  - [x] 确保覆盖率 ≥ 80%

- [x] **Task 10: 向后兼容验证** (AC: 1, 2, 3)
  - [x] 验证现有关卡（1-1 至 1-4）正常运行
  - [x] 验证无旗帜波的关卡不受影响
  - [x] 运行现有测试确保无回归

## Dev Notes

### 前一故事经验 (Story 17.6)

**关键实现决策**:
- `WaveTimingSystem` 通过 `WaveTriggered` 标志与 `LevelSystem` 通信（零耦合）
- 使用泛型 API `ecs.GetComponent[*T]()` 操作组件
- `AccumulatedCs` 字段正确处理小数部分累积
- 时间转换: `deltaCentiseconds := int(deltaTime * 100)`

**代码位置**:
- 波次计时系统: `pkg/systems/wave_timing_system.go`
- 计时器组件: `pkg/components/wave_timer.go`
- 系统集成: `pkg/systems/level_system.go` (EnableWaveTimingSystem 等方法)

[Source: docs/stories/17.6.wave-timing-system.story.md#Dev Agent Record]

### 架构约束

**组件位置**: `pkg/components/`
[Source: architecture/source-tree.md#pkg/components]

**系统位置**: `pkg/systems/`
[Source: architecture/source-tree.md#pkg/systems]

**遵循原则**:
- 组件为纯数据结构，无方法 [Source: architecture/coding-standards.md#数据-行为分离]
- 系统之间零耦合，通过 EntityManager 通信 [Source: architecture/coding-standards.md#零耦合原则]
- 使用泛型 API 操作组件 [Source: CLAUDE.md#泛型API]

### 时间单位说明

原版 PvZ 使用 **厘秒 (centiseconds, cs)** 作为物理更新基准：
- 1 厘秒 = 0.01 秒
- 100 厘秒 = 1 秒
- 游戏逻辑以 100FPS 运行（固定时间步长 0.01 秒）

[Source: CLAUDE.md#原版时间步长]

### 现有红字/白字实现

**现有 FinalWave 警告系统**:
- `FinalWaveWarningComponent` (`pkg/components/final_wave_warning_component.go`)
- `FinalWaveWarningSystem` (`pkg/systems/final_wave_warning_system.go`)
- 使用 `FinalWave.reanim` 动画资源
- 触发点: `LevelSystem.triggerFinalWaveWarning()`

**现有 UI 渲染**:
- `drawLastWaveWarning()` 在 `pkg/scenes/game_scene_ui.go`
- 显示 "A huge wave of zombies is approaching!" 文本
- 使用 `sunCounterFont` 字体

[Source: pkg/scenes/game_scene_ui.go#drawLastWaveWarning]

### 旗帜波计时逻辑详解

**旗帜波前一波（第 9/19 波）**:
```
波次触发后:
  - 设置倒计时 = 4500cs（45秒）
  - 加速刷新条件:
    - 刷出时间 > 401cs
    - 倒计时 > 200cs
    - 本波僵尸全灭（除伴舞）
  - 触发加速刷新时: 倒计时 = 200cs

红字警告阶段:
  - 倒计时 = 5cs → Phase 5: 显示红字
  - 倒计时 = 4cs → Phase 4: 停留 725cs
  - Phase 4 结束 → 触发旗帜波
```

**最终波（第 20 波）**:
```
波次触发后:
  - 设置倒计时 = 5500cs（55秒）
  - 倒计时 = 0cs → 触发最终波
  - 最终波使用 FinalWave.reanim 动画显示
```

### 关卡配置中的旗帜波

旗帜波在关卡配置中通过 `isFlag: true` 标记:
```yaml
waves:
  - waveNum: 10
    type: "Final"
    isFlag: true
    flagIndex: 1
    zombies: [...]
```

[Source: CLAUDE.md#关卡配置格式]

### 字体资源

原版字体位于 `assets/data/`:
- `DwarvenTodcraft*.png` + `.txt` - 主要游戏字体
- `HouseofTerror*.png` + `.txt` - 恐怖风格字体

红字警告推荐使用 `HouseofTerror` 系列，白字使用 `DwarvenTodcraft` 系列。

[Source: docs/font-assets.md]

### 与 Story 17.8 的关系

Story 17.8（加速刷新机制 - 血量触发）将扩展本 Story 实现的加速刷新逻辑。
本 Story 实现的加速刷新是"消灭触发"型，17.8 将添加"血量触发"型。

**设计建议**: 在本 Story 中预留加速刷新扩展点（如接口或配置参数）。

## Testing

### 测试文件位置

- `pkg/systems/wave_timing_system_test.go` - 扩展现有测试
- `pkg/systems/flag_wave_warning_system_test.go` - 新增系统测试
- `pkg/components/wave_timer_test.go` - 扩展组件测试

[Source: architecture/testing-strategy.md#测试文件位置]

### 测试框架

使用 Go 标准库 `testing` 包，不引入额外测试框架。
[Source: architecture/tech-stack.md#Testing]

### 测试策略

**单元测试重点**:
1. 旗帜波前一波倒计时设置（4500cs）
2. 红字警告阶段转换（5 → 4 → 触发）
3. Phase 4 停留时间精确控制（725cs）
4. 最终波倒计时设置（5500cs）
5. 加速刷新条件验证（401cs + 200cs 阈值）
6. 边界条件处理

**测试用例设计**:

```go
// 1. 旗帜波前一波倒计时
func TestWaveTimingSystem_FlagWavePrefixDelay(t *testing.T) {
    // Given: 下一波是旗帜波
    // When: SetNextWaveCountdown()
    // Then: CountdownCs = 4500
}

// 2. 红字警告阶段测试
func TestWaveTimingSystem_HugeWaveWarningPhases(t *testing.T) {
    // Given: CountdownCs = 6
    // When: Update() 使 CountdownCs 减到 5
    // Then: FlagWaveCountdownPhase = 5
    
    // When: Update() 使 CountdownCs 减到 4
    // Then: FlagWaveCountdownPhase = 4, 开始 725cs 计时
}

// 3. Phase 4 停留测试
func TestWaveTimingSystem_Phase4Duration(t *testing.T) {
    // Given: FlagWaveCountdownPhase = 4
    // When: Update() 累计 725cs
    // Then: 触发下一波
}

// 4. 最终波倒计时测试
func TestWaveTimingSystem_FinalWaveDelay(t *testing.T) {
    // Given: 当前波是最终波
    // When: SetNextWaveCountdown() (应为提前设置)
    // Then: CountdownCs = 5500
}

// 5. 加速刷新测试
func TestWaveTimingSystem_AcceleratedRefresh(t *testing.T) {
    // Given: 刷出 > 401cs, 倒计时 > 200cs, 本波僵尸全灭
    // When: 检查加速刷新条件
    // Then: CountdownCs = 200
}
```

### 覆盖率目标

- WaveTimerComponent 扩展字段: ≥ 80%
- WaveTimingSystem 旗帜波逻辑: ≥ 80%
- FlagWaveWarningSystem: ≥ 80%
- 整体: ≥ 80%

### 运行测试命令

```bash
# 运行本 Story 相关测试
go test ./pkg/systems -run TestWaveTimingSystem -v
go test ./pkg/systems -run TestFlagWaveWarning -v

# 查看覆盖率
go test ./pkg/systems -run TestWaveTimingSystem -cover

# 运行所有测试确保无回归
go test ./...
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-27 | 0.1 | Initial draft creation | Bob (Scrum Master) |
| 2025-11-27 | 1.0 | Implementation complete | James (Dev Agent) |

---

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5

### Debug Log References

无 - 所有测试通过，无需调试日志

### Completion Notes

- 实现了完整的旗帜波特殊计时系统（4500cs 延迟）
- 实现了红字警告阶段系统（Phase 5 → 4 → 触发，725cs 停留）
- 实现了最终波计时逻辑（5500cs 延迟）
- 创建了 FlagWaveWarningComponent 和 FlagWaveWarningSystem
- 最终波使用现有 `FinalWave.reanim` 动画系统（非文字渲染）
- 集成了 UI 渲染（drawHugeWaveWarning）
- 实现了加速刷新逻辑（401cs + 200cs 阈值）
- 与 LevelSystem 完成集成
- 单元测试覆盖率达到 ≥80%
- 向后兼容性验证通过

### File List

**新增文件:**
- `pkg/components/flag_wave_warning_component.go` - 红字警告组件
- `pkg/systems/flag_wave_warning_system.go` - 红字警告系统
- `pkg/systems/flag_wave_warning_system_test.go` - 红字警告系统测试

**修改文件:**
- `pkg/components/wave_timer.go` - 添加旗帜波字段
- `pkg/systems/wave_timing_system.go` - 添加旗帜波计时逻辑和常量
- `pkg/systems/wave_timing_system_test.go` - 添加 Story 17.7 测试用例
- `pkg/systems/level_system.go` - 集成旗帜波警告系统
- `pkg/scenes/game_scene_ui.go` - 添加 UI 渲染方法
- `pkg/scenes/game_scene.go` - 集成 UI 渲染调用

---

## QA Results

### Review Date: 2025-11-27

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**整体评价**: 实现质量优秀，符合 ECS 架构原则

**亮点**:
1. **组件设计规范**: `FlagWaveWarningComponent` 严格遵循 ECS 纯数据原则，不包含任何逻辑方法
2. **系统职责清晰**: 各系统（`FlagWaveWarningSystem`、`WaveTimingSystem`）职责单一，通过组件数据通信
3. **常量管理完善**: 所有时间常量（如 `FlagWavePrefixDelayCs = 4500`）在 `wave_timing_system.go` 中集中定义，便于维护
4. **GoDoc 注释完整**: 所有公开 API 均有详细的 GoDoc 注释，说明参数、返回值和使用场景
5. **零耦合设计**: 系统间通过 `EntityManager` 和组件状态通信，未直接调用
6. **正确使用 Reanim**: 最终波使用现有 `FinalWave.reanim` 动画系统，而非文字渲染

**代码组织**:
- 新文件放置位置正确（`pkg/components/`、`pkg/systems/`）
- 命名遵循项目约定（PascalCase 结构体，camelCase 私有成员）
- 常量命名语义清晰（如 `AcceleratedRefreshMinTimeCs`）

### Refactoring Performed

无需重构 - 代码已符合项目标准

### Compliance Check

- Coding Standards: ✓ 遵循 Go 命名约定、ECS 架构原则
- Project Structure: ✓ 文件放置位置正确
- Testing Strategy: ✓ 使用标准 `testing` 包，覆盖关键路径
- All ACs Met: ✓ 全部 5 个验收标准已满足

### Requirements Traceability

| AC# | 需求描述 | 实现位置 | 测试用例 |
|-----|---------|---------|---------|
| 1 | 旗帜波前一波倒计时 4500cs | `WaveTimingSystem.SetNextWaveCountdown()` | `TestWaveTimingSystem_FlagWavePrefixDelay` |
| 1 | 加速刷新 (401cs+200cs) | `WaveTimingSystem.CheckAcceleratedRefresh()` | `TestWaveTimingSystem_AcceleratedRefresh*` (3个测试) |
| 2 | 红字警告 Phase 5→4 | `updateFlagWaveWarningPhase()` | `TestWaveTimingSystem_HugeWaveWarningPhase5` |
| 2 | Phase 4 停留 725cs | `FlagWavePhase4DurationCs` | `TestWaveTimingSystem_Phase4Duration` |
| 3 | 最终波倒计时 5500cs | `FinalWaveDelayCs` | `TestWaveTimingSystem_FinalWaveDelay` |
| 3 | 最终波动画 | `FinalWave.reanim` (现有系统) | 运行时验证 |
| 4 | 红字 UI 渲染 | `drawHugeWaveWarning()` | 运行时验证 |
| 5 | 测试覆盖率 ≥80% | - | 全部 Story 17.7 测试通过 |

### Improvements Checklist

- [x] 组件遵循纯数据原则
- [x] 系统遵循零耦合原则
- [x] 常量命名清晰、集中管理
- [x] GoDoc 注释完整
- [x] 测试用例覆盖全部验收标准
- [x] 与 LevelSystem 正确集成
- [x] UI 渲染方法实现完整

### Security Review

不涉及安全相关功能 - N/A

### Performance Considerations

- 警告/白字系统仅在相关阶段激活，不增加常规帧开销
- 动画更新使用厘秒整数计算，避免浮点数精度问题
- 实体生命周期正确管理（创建/销毁时机明确）

### Files Modified During Review

无 - 代码已满足质量标准

### Gate Status

Gate: **PASS** → docs/qa/gates/17.7-flag-wave-timing.yml

### Recommended Status

**✓ Ready for Done**

实现完整、测试通过、符合架构规范，可以合并。

