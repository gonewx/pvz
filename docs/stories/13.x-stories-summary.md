# Epic 13 - 剩余 Story 概要 (Stories 13.2-13.5)

本文档包含 Epic 13 剩余 Story 的精简概要。每个 Story 将在实施前展开为完整文档。

---

## Story 13.2: 简化多动画播放逻辑

### Story
**As a** 游戏开发者,
**I want** 移除同步/异步模式的复杂性，统一使用轨道绑定系统,
**so that** 代码更简洁，易于维护，减少技术债务。

### 核心目标
- 移除 `GlobalFrame` 字段（被各个动画的独立帧索引取代）
- 移除 `TrackMapping` 字段（被 `TrackBindings` 取代）
- 统一帧推进逻辑（每个动画维护独立的逻辑帧）
- 向后兼容现有 API

### 关键 AC
1. 移除冗余字段（GlobalFrame, TrackMapping）
2. 重构 Update() 使用独立帧索引
3. 所有现有动画正常播放（回归测试）
4. 代码行数减少 ≥ 10%

### 技术实现
```go
// 新的组件结构
type ReanimComponent struct {
    CurrentAnimations []string              // 当前播放的动画列表
    AnimStates        map[string]*AnimState // 每个动画的独立状态
    TrackBindings     map[string]string     // 轨道绑定 (Story 13.1)

    // ❌ 移除的字段
    // GlobalFrame int
    // TrackMapping map[string]string
}

type AnimState struct {
    LogicalFrame int     // 当前逻辑帧（0-based）
    FrameCount   int     // 总逻辑帧数
    Accumulator  float64 // 帧累加器
}
```

### 预期工作量
**5-7 天**
- 重构组件结构：1 天
- 重构 Update() 逻辑：2 天
- 回归测试：2 天
- 文档更新：1 天

---

## Story 13.3: 父子偏移系统

### Story
**As a** 游戏开发者,
**I want** 实现父子轨道偏移计算，修复头部不跟随身体摆动的问题,
**so that** 植物动画更自然流畅（如豌豆射手攻击时头部跟随身体）。

### 核心目标
- 添加 `ParentTracks map[string]string` 字段（子轨道 -> 父轨道）
- 实现 `getParentOffset()` 偏移计算函数
- 在渲染时应用偏移（只在子父使用不同动画时）
- 修复豌豆射手攻击动画

### 关键 AC
1. 添加 ParentTracks 字段
2. 实现父子偏移计算逻辑
3. 豌豆射手攻击时头部跟随身体摆动
4. 支持配置父子关系（默认规则 + 手动配置）

### 技术实现
```go
type ReanimComponent struct {
    // 新增字段
    ParentTracks map[string]string // map[子轨道]父轨道
    // 例如：ParentTracks["anim_face"] = "anim_stem"
}

func getParentOffset(parentTrackName, comp) (offsetX, offsetY float64) {
    // 1. 找到父轨道控制的动画
    parentAnim := comp.TrackBindings[parentTrackName]

    // 2. 获取初始位置（第一个可见帧）
    initX, initY := getFirstVisiblePosition(parentTrackName, parentAnim)

    // 3. 获取当前位置
    currentX, currentY := getCurrentPosition(parentTrackName, parentAnim)

    // 4. 计算偏移
    offsetX = currentX - initX
    offsetY = currentY - initY
    return
}

// 渲染时应用偏移
func renderTrack(trackName) {
    x, y := getTrackPosition(trackName)

    // 检查父子关系
    if parentName, hasParent := comp.ParentTracks[trackName]; hasParent {
        childAnim := comp.TrackBindings[trackName]
        parentAnim := comp.TrackBindings[parentName]

        // 只有子父使用不同动画时才应用偏移
        if childAnim != parentAnim {
            offsetX, offsetY := getParentOffset(parentName, comp)
            x += offsetX
            y += offsetY
        }
    }

    drawPart(x, y, ...)
}
```

### 验证方式
**豌豆射手攻击测试**:
- 播放 `PlayAnimations(["anim_shooting", "anim_head_idle"])`
- 观察头部是否跟随身体摆动
- 测量头部偏移量是否正确（基于 stem 偏移）

### 预期工作量
**3-4 天**
- 添加 ParentTracks 字段：0.5 天
- 实现偏移计算：1.5 天
- 修改渲染逻辑：1 天
- 测试验证：1 天

---

## Story 13.4: 渲染系统优化

### Story
**As a** 游戏开发者,
**I want** 引入渲染缓存机制，减少重复计算,
**so that** 渲染性能提升 20%+，支持更多实体同屏显示。

### 核心目标
- 添加 `CachedRenderData []renderPartData` 字段
- 实现 `prepareRenderCache()` 缓存更新函数
- 只在帧变化时更新缓存
- 渲染时直接使用缓存数据

### 关键 AC
1. 添加渲染缓存字段
2. 实现缓存更新逻辑（只在帧变化时）
3. 修改 RenderSystem 使用缓存
4. 性能提升 ≥ 20%（基准测试）

### 技术实现
```go
type renderPartData struct {
    Img      *ebiten.Image
    Frame    reanim.Frame
    OffsetX  float64
    OffsetY  float64
}

type ReanimComponent struct {
    // 新增缓存字段
    CachedRenderData []renderPartData
    LastRenderFrame  int
}

func (rs *ReanimSystem) prepareRenderCache(comp) {
    comp.CachedRenderData = comp.CachedRenderData[:0] // 重用切片

    for _, trackName := range visualTracks {
        // 1. 找到控制该轨道的动画
        animName := comp.TrackBindings[trackName]

        // 2. 计算物理帧索引
        logicalFrame := comp.AnimStates[animName].LogicalFrame
        physicalFrame := mapLogicalToPhysical(logicalFrame, animVisibles)

        // 3. 获取帧数据
        frame := comp.MergedTracks[trackName][physicalFrame]

        // 4. 计算父子偏移（如果有）
        offsetX, offsetY := calculateParentOffset(trackName, comp)

        // 5. 加入缓存
        comp.CachedRenderData = append(comp.CachedRenderData, renderPartData{
            Img:     comp.PartImages[frame.ImagePath],
            Frame:   frame,
            OffsetX: offsetX,
            OffsetY: offsetY,
        })
    }
}

func (rs *RenderSystem) renderReanimEntity(comp) {
    // 检查缓存是否有效
    currentFrame := getCurrentLogicalFrame(comp)
    if currentFrame != comp.LastRenderFrame {
        rs.reanimSystem.prepareRenderCache(comp)
        comp.LastRenderFrame = currentFrame
    }

    // 快速渲染缓存数据
    for _, data := range comp.CachedRenderData {
        drawPart(data.Img, data.Frame, data.OffsetX, data.OffsetY)
    }
}
```

### 性能基准测试
**测试场景**:
- 100 个豌豆射手同屏（攻击动画）
- 测量平均帧时间和 FPS

**预期结果**:
- 优化前：~5ms/帧，20 FPS
- 优化后：~4ms/帧，25 FPS（提升 25%）

### 预期工作量
**2-3 天**
- 添加缓存字段：0.5 天
- 实现缓存逻辑：1 天
- 修改 RenderSystem：0.5 天
- 性能测试：0.5-1 天

---

## Story 13.5: 配置系统升级

### Story
**As a** 游戏开发者,
**I want** 通过 YAML 配置动画组合和轨道绑定,
**so that** 无需修改代码即可定义复杂动画组合，提升开发效率。

### 核心目标
- 定义 Reanim 配置文件格式（YAML schema）
- 实现 `LoadReanimConfig()` 加载函数
- 实现 `ApplyReanimConfig()` 应用函数
- 提供示例配置文件（豌豆射手、向日葵等）

### 关键 AC
1. 定义 YAML 配置格式
2. 实现配置加载和验证
3. 实现配置应用逻辑
4. 通过配置文件定义豌豆射手攻击组合（无需修改代码）

### 配置格式示例

**注**：Story 13.6 中配置已迁移为集中单文件格式。以下为 Story 13.5 的原始设计（已在 Story 13.6 中演进）：

```yaml
# Story 13.5 原始设计：data/reanim_configs/peashooter.yaml (分散配置)
# Story 13.6 实际实现：data/reanim_config.yaml (集中配置)
reanim_file: assets/effect/reanim/PeaShooterSingle.reanim

animations:
  - name: anim_idle
    display_name: 待机
  - name: anim_shooting
    display_name: 攻击
  - name: anim_head_idle
    display_name: 头部摇晃

animation_combos:
  - name: attack_with_sway
    display_name: 攻击+摇晃
    animations:
      - anim_shooting
      - anim_head_idle

    # 轨道绑定策略
    binding_strategy: auto  # auto 或 manual

    # 手动绑定（可选）
    manual_bindings:
      anim_face: anim_head_idle
      stalk_bottom: anim_shooting

    # 父子关系
    parent_tracks:
      anim_face: anim_stem

    # 隐藏轨道
    hidden_tracks:
      - anim_blink
```

### 技术实现
```go
// Config 结构
type ReanimConfig struct {
    ReanimFile      string                   `yaml:"reanim_file"`
    Animations      []AnimationDef           `yaml:"animations"`
    AnimationCombos []AnimationComboConfig   `yaml:"animation_combos"`
}

type AnimationComboConfig struct {
    Name             string            `yaml:"name"`
    DisplayName      string            `yaml:"display_name"`
    Animations       []string          `yaml:"animations"`
    BindingStrategy  string            `yaml:"binding_strategy"`
    ManualBindings   map[string]string `yaml:"manual_bindings"`
    ParentTracks     map[string]string `yaml:"parent_tracks"`
    HiddenTracks     []string          `yaml:"hidden_tracks"`
}

// 加载配置
func LoadReanimConfig(path string) (*ReanimConfig, error) {
    data, err := os.ReadFile(path)
    if err != nil {
        return nil, err
    }

    var config ReanimConfig
    if err := yaml.Unmarshal(data, &config); err != nil {
        return nil, err
    }

    return &config, nil
}

// 应用配置
func (rs *ReanimSystem) ApplyReanimConfig(entityID ecs.EntityID, config *ReanimConfig) error {
    comp, _ := ecs.GetComponent[*components.ReanimComponent](rs.entityManager, entityID)

    for _, combo := range config.AnimationCombos {
        // 设置动画
        rs.PlayAnimations(entityID, combo.Animations)

        // 设置轨道绑定
        if combo.BindingStrategy == "manual" && len(combo.ManualBindings) > 0 {
            rs.SetTrackBindings(entityID, combo.ManualBindings)
        }

        // 设置父子关系
        if len(combo.ParentTracks) > 0 {
            comp.ParentTracks = combo.ParentTracks
        }
    }

    return nil
}
```

### 预期工作量
**2-3 天**
- 定义配置格式：0.5 天
- 实现加载逻辑：1 天
- 实现应用逻辑：0.5 天
- 创建示例配置：0.5 天
- 文档更新：0.5 天

---

## Story 依赖关系

```
Story 13.1 (轨道绑定)
    ↓
Story 13.2 (简化多动画) ← 依赖 13.1
    ↓
Story 13.3 (父子偏移) ← 依赖 13.1, 13.2
    ↓
Story 13.4 (渲染优化) ← 依赖 13.1, 13.2, 13.3
    ↓
Story 13.5 (配置系统) ← 依赖 13.1, 13.2, 13.3
```

**关键路径**: 13.1 → 13.2 → 13.3 → 13.4
**可并行**: Story 13.5 可以在 13.3 完成后并行开发

---

## 总工作量估算

| Story | 描述 | 估算 | 优先级 |
|-------|------|------|--------|
| 13.1 | 轨道绑定机制 | 2-3 天 | P0 (Critical) |
| 13.2 | 简化多动画逻辑 | 5-7 天 | P0 (Critical) |
| 13.3 | 父子偏移系统 | 3-4 天 | P1 (High) |
| 13.4 | 渲染系统优化 | 2-3 天 | P1 (High) |
| 13.5 | 配置系统升级 | 2-3 天 | P2 (Medium) |
| **总计** | | **14-20 天** | |

---

## 下一步行动

**开始实施前**:
1. ✅ Epic 13 文档已创建
2. ✅ Story 13.1 详细文档已创建
3. ⏳ Story 13.2-13.5 将在实施前展开为完整文档
4. ⏳ 技术评审会议（确认架构设计）
5. ⏳ 创建回归测试套件

**实施顺序**:
1. Story 13.1 → 2. Story 13.2 → 3. Story 13.3 → 4. Story 13.4 → 5. Story 13.5

---

**文档版本**: v1.0
**创建日期**: 2025-11-07
**状态**: Planning
**下次更新**: 实施前展开为完整 Story 文档
