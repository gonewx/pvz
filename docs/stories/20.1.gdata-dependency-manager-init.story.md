# Story 20.1: gdata 依赖与 Manager 初始化

## Status

Ready

## Story

**As a** 开发者,
**I want** to integrate gdata library and initialize global Manager,
**so that** the application has cross-platform storage capability for saves and settings.

## Acceptance Criteria

1. 添加 `github.com/quasilyte/gdata/v2` 依赖到 `go.mod`
2. 在 GameState 中创建全局 `gdata.Manager` 实例
3. 应用启动时初始化 Manager，使用应用名 `pvz_newx`
4. 处理初始化错误，提供降级方案（Manager 为 nil 时游戏仍可运行）
5. 单元测试覆盖率 ≥ 80%

## Tasks / Subtasks

- [ ] **Task 1: 添加 gdata 依赖** (AC: 1)
  - [ ] 执行 `go get github.com/quasilyte/gdata/v2`
  - [ ] 验证 go.mod 已更新
  - [ ] 运行 `go mod tidy` 确保依赖完整

- [ ] **Task 2: 修改 GameState 结构** (AC: 2)
  - [ ] 在 `pkg/game/game_state.go` 中添加 `gdataManager *gdata.Manager` 字段
  - [ ] 添加 `GetGdataManager() *gdata.Manager` getter 方法
  - [ ] 添加字段注释说明用途

- [ ] **Task 3: 实现 gdata Manager 初始化** (AC: 3, 4)
  - [ ] 在 `GetGameState()` 单例初始化块中添加 gdata 初始化代码：
    ```go
    // Story 20.1: 初始化 gdata Manager（跨平台存储）
    gdataManager, err := gdata.Open(gdata.Config{
        AppName: "pvz_newx",
    })
    if err != nil {
        log.Printf("[GameState] Warning: Failed to initialize gdata Manager: %v", err)
        // 降级方案：gdataManager 为 nil，游戏继续运行
        gdataManager = nil
    }
    ```
  - [ ] 将 gdataManager 赋值给 GameState 结构体字段
  - [ ] 处理初始化错误：记录日志但不阻塞游戏启动
  - [ ] 如果初始化失败，gdataManager 设为 nil

- [ ] **Task 4: 编写单元测试** (AC: 5)
  - [ ] 创建 `pkg/game/game_state_gdata_test.go`
  - [ ] 测试 gdata Manager 正常初始化
  - [ ] 测试 GetGdataManager() 返回正确实例
  - [ ] 测试初始化失败时的降级行为

- [ ] **Task 5: 验证与文档**
  - [ ] 运行 `go test ./pkg/game/...` 确保测试通过
  - [ ] 运行 `go build` 确保编译成功
  - [ ] 运行游戏确保正常启动

## Dev Notes

### 技术背景

**gdata 库** 是专为 Ebitengine 游戏设计的跨平台存储库：
- 支持桌面端（Windows/Linux/macOS）、移动端（Android/iOS）、Web（WASM）
- 各平台存储位置遵循标准规范：
  - Windows: `%APPDATA%/pvz_newx/`
  - Linux: `~/.local/share/pvz_newx/`
  - WASM: localStorage

**Source**: [docs/design/embed-and-cross-platform-storage.md#3.1]

### gdata API 参考

```go
import "github.com/quasilyte/gdata/v2"

// 初始化
manager, err := gdata.Open(gdata.Config{
    AppName: "pvz_newx",
})

// 保存数据
err = manager.SaveObjectProp("saves", "peter", dataBytes)

// 加载数据
data, err := manager.LoadObjectProp("saves", "peter")

// 检查是否存在
exists := manager.ObjectPropExists("saves", "peter")
```

**Source**: [docs/design/embed-and-cross-platform-storage.md#6.1]

### 相关源代码树

```
pkg/game/
├── game_state.go              # 修改：添加 gdataManager 字段和初始化
├── game_state_gdata_test.go   # 新建：gdata 单元测试
├── save_manager.go            # 参考：降级方案模式（Story 8.6）
└── ...
```

### 现有代码结构

**GameState 位置**: `pkg/game/game_state.go`

GameState 使用**单例模式**，通过 `GetGameState()` 获取全局实例：

```go
// 全局单例实例（这是架构规范允许的唯一全局变量）
var globalGameState *GameState

// GetGameState 返回全局 GameState 单例
// 使用延迟初始化模式，确保整个游戏生命周期只有一个实例
func GetGameState() *GameState {
    if globalGameState == nil {
        // ... 加载 LawnStrings ...

        // Story 8.6: 初始化保存管理器
        saveManager, err := NewSaveManager("data/saves")
        if err != nil {
            log.Printf("[GameState] Warning: Failed to initialize SaveManager: %v", err)
            saveManager = nil  // 降级方案：游戏可运行但无法保存
        }

        globalGameState = &GameState{
            Sun:                50,
            plantUnlockManager: NewPlantUnlockManager(),
            saveManager:        saveManager,
            // ... 其他字段 ...
        }
    }
    return globalGameState
}
```

**GameState 结构体**（相关字段，位于第 13-59 行）：
```go
type GameState struct {
    // ... 其他字段 ...

    // Story 8.6: 关卡进度保存系统
    saveManager *SaveManager // 保存管理器（关卡进度、植物解锁、工具解锁）

    // TODO Story 20.1: 在此处添加 gdataManager 字段
    // gdataManager *gdata.Manager // 跨平台存储管理器
}
```

**Source**: `pkg/game/game_state.go:13-99`

**参考模式**: SaveManager 的降级处理（第 76-82 行）展示了正确的错误处理模式

### 降级方案

如果 gdata 初始化失败（例如权限问题或 WASM 限制）：
1. 记录警告日志
2. gdataManager 设为 nil
3. 游戏继续运行，但无法保存/加载数据
4. 后续 Story (20.2, 20.3) 需检查 gdataManager 是否为 nil

### 文件修改清单

| 文件 | 操作 |
|------|------|
| `go.mod` | 添加 gdata 依赖 |
| `pkg/game/game_state.go` | 添加 gdataManager 字段和初始化 |
| `pkg/game/game_state_gdata_test.go` | 新建测试文件 |

## Testing

### 测试标准 [Source: docs/architecture/testing-strategy.md]

- **框架**: Go 标准库 `testing` 包
- **位置**: 测试文件与源文件同包，以 `_test.go` 结尾
- **覆盖率目标**: ≥ 80%

### 测试用例

| 测试函数 | 验证内容 | AC |
|----------|----------|-----|
| `TestGdataManagerInit` | gdata Manager 正常初始化，返回非 nil 实例 | AC3 |
| `TestGetGdataManager` | getter 方法返回正确的 Manager 实例 | AC2 |
| `TestGdataManagerNilSafe` | gdataManager 为 nil 时，GetGdataManager() 不 panic | AC4 |
| `TestGameStateWithGdataFailure` | 模拟 gdata 初始化失败，验证游戏仍能启动 | AC4 |
| `TestGdataManagerAppName` | 验证使用正确的应用名 "pvz_newx" | AC3 |

### 运行测试

```bash
go test -v -cover ./pkg/game/...
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-03 | 1.0 | 初始创建 | Bob (SM) |
| 2024-12-03 | 1.1 | 修正 GameState 代码结构描述（单例模式），增强测试用例 | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used

_(待开发者填写)_

### Debug Log References

_(待开发者填写)_

### Completion Notes List

_(待开发者填写)_

### File List

_(待开发者填写)_

---

## QA Results

_(待 QA 填写)_
