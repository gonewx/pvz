# Epic 14 å®æ–½æ¸…å•

## æ–‡æ¡£è¯´æ˜

æœ¬æ¸…å•ç”¨äºè·Ÿè¸ª Epic 14ï¼ˆECS ç³»ç»Ÿè€¦åˆè§£é™¤é‡æ„ï¼‰çš„å®æ–½è¿›åº¦ã€‚

**æ ¸å¿ƒç›®æ ‡**: è§£é™¤ 9 ä¸ªç³»ç»Ÿå¯¹ ReanimSystem çš„ç›´æ¥ä¾èµ–ï¼ˆ15 å¤„è¿è§„è°ƒç”¨ï¼‰ï¼Œæ”¹ä¸ºé€šè¿‡ AnimationCommandComponent ç»„ä»¶é€šä¿¡ã€‚

**ç›¸å…³æ–‡æ¡£**:
- Epic æ€»è§ˆ: `docs/prd/epic-14-ecs-decoupling-refactor.md`
- Story 14.1: `docs/stories/14.1.story.md` (AnimationCommand ç»„ä»¶)
- Story 14.2: `docs/stories/14.2.story.md` (ReanimSystem æ”¹é€ )

---

## å®æ–½è¿›åº¦æ¦‚è§ˆ

| é˜¶æ®µ | çŠ¶æ€ | å¤‡æ³¨ |
|------|------|------|
| **Phase 1: æ ¸å¿ƒç»„ä»¶** | âœ… å·²å®Œæˆ | AnimationCommand ç»„ä»¶è®¾è®¡ |
| **Phase 2: ReanimSystem** | âœ… å·²å®Œæˆ | å‘½ä»¤å¤„ç†æœºåˆ¶å®ç° |
| **Phase 3: ç³»ç»Ÿé‡æ„** | âœ… å·²å®Œæˆ | 9 ä¸ªç³»ç»Ÿæ”¹é€ å…¨éƒ¨å®Œæˆ |
| **Phase 4: æµ‹è¯•éªŒè¯** | âœ… å·²å®Œæˆ | ç¼–è¯‘éªŒè¯é€šè¿‡ |
| **Phase 5: æ”¶å°¾å·¥ä½œ** | âœ… å·²å®Œæˆ | æ–‡æ¡£ + å·¥å…· |

**æ€»ä½“è¿›åº¦**: 5/5 é˜¶æ®µå®Œæˆ (100%) â†’ **Epic 14 å…¨éƒ¨å®Œæˆ (100%)**

**ç¬¬ä¸€è½®æ”¹é€ å®Œæˆæ—¶é—´**: 2025-11-12
**ç¬¬äºŒè½®æ”¹é€ å®Œæˆæ—¶é—´**: 2025-11-12
**Phase 5 æ”¶å°¾å®Œæˆæ—¶é—´**: 2025-11-12

---

## Phase 3: ç³»ç»Ÿé‡æ„æ¸…å•

### ğŸ”§ æ ‡å‡†æ”¹é€ æ¨¡æ¿

æ¯ä¸ªç³»ç»Ÿéœ€è¦å®Œæˆä»¥ä¸‹ 4 ä¸ªæ­¥éª¤ï¼š

#### **æ­¥éª¤ 1: åˆ é™¤ä¾èµ–å­—æ®µ**

```diff
// pkg/systems/xxx_system.go

type XxxSystem struct {
    entityManager *ecs.EntityManager
-   reanimSystem  *ReanimSystem  // âŒ åˆ é™¤æ­¤è¡Œ
}
```

#### **æ­¥éª¤ 2: æ›´æ–°æ„é€ å‡½æ•°**

```diff
// NewXxxSystem åˆ›å»ºç³»ç»Ÿ
-func NewXxxSystem(em *ecs.EntityManager, rs *ReanimSystem) *XxxSystem {
+func NewXxxSystem(em *ecs.EntityManager) *XxxSystem {
    return &XxxSystem{
        entityManager: em,
-       reanimSystem:  rs,  // âŒ åˆ é™¤æ­¤è¡Œ
    }
}
```

#### **æ­¥éª¤ 3: æ›¿æ¢æ‰€æœ‰è°ƒç”¨**

```diff
// åœºæ™¯ A: PlayCombo (æœ€å¸¸è§)
-s.reanimSystem.PlayCombo(entityID, "zombie", "death")
+ecs.AddComponent(s.entityManager, entityID, &components.AnimationCommandComponent{
+    UnitID:    "zombie",
+    ComboName: "death",
+    Processed: false,
+})

// åœºæ™¯ B: PlayAnimation (å•åŠ¨ç”»)
-s.reanimSystem.PlayAnimation(entityID, "FinalWave")
+ecs.AddComponent(s.entityManager, entityID, &components.AnimationCommandComponent{
+    AnimationName: "FinalWave",
+    Processed:     false,
+})
```

#### **æ­¥éª¤ 4: è¿è¡Œæµ‹è¯•**

```bash
# ç¼–è¯‘æ£€æŸ¥
go build ./pkg/systems/xxx_system.go

# è¿è¡Œå•å…ƒæµ‹è¯•
go test ./pkg/systems -run TestXxxSystem -v

# è¿è¡Œé›†æˆæµ‹è¯•ï¼ˆå¯é€‰ï¼‰
go test ./pkg/systems -run Integration -v
```

---

### ğŸ“‹ ç³»ç»Ÿæ”¹é€ è¯¦ç»†æ¸…å•

#### âœ… å·²å®Œæˆç³»ç»Ÿ

**ç¬¬ä¸€è½® (2025-11-12 ä¸Šåˆ)**:
- [x] **ReanimSystem** - Story 14.2 å®Œæˆï¼ˆæ ¸å¿ƒæ”¹é€ ï¼‰
- [x] **BehaviorSystem** - 5 å¤„è¿è§„ + 4 ä¸ªæµ‹è¯•æ–‡ä»¶æ›´æ–°
- [x] **WaveSpawnSystem** - 2 å¤„è¿è§„ + 3 ä¸ªåƒµå°¸å·¥å‚å‡½æ•°æ”¹é€ 
- [x] **LevelSystem** - 1 å¤„è¿è§„ + 1 ä¸ªç‰¹æ•ˆå·¥å‚å‡½æ•°æ”¹é€ 

**ç¬¬äºŒè½® (2025-11-12 ä¸‹åˆ)**:
- [x] **TutorialSystem** - 2 å¤„è¿è§„ï¼ˆCombo + Single æ¨¡å¼ï¼‰
- [x] **SoddingSystem** - 1 å¤„è¿è§„ + 3 ä¸ªæµ‹è¯•æ›´æ–°
- [x] **SunSpawnSystem** - 1 å¤„è¿è§„ + 2 ä¸ªæµ‹è¯•æ›´æ–°
- [x] **OpeningAnimationSystem** - 1 å¤„è¿è§„ + 5 ä¸ªæµ‹è¯•æ›´æ–°
- [x] **LawnmowerSystem** - 1 å¤„è¿è§„ + 5 ä¸ªæµ‹è¯•æ›´æ–°
- [x] **RenderSystem** - ç‰¹æ®Šå¤„ç†ï¼ˆç›´æ¥è¯»å– CachedRenderDataï¼‰

**æ”¹é€ ç»Ÿè®¡**:
- ç³»ç»Ÿæ€»æ•°: 9 ä¸ª (100% å®Œæˆ)
- è¿è§„è°ƒç”¨æ¶ˆé™¤: 15 å¤„ â†’ 0 å¤„
- å·¥å‚å‡½æ•°è§£è€¦: 4 ä¸ª
- æµ‹è¯•æ–‡ä»¶æ›´æ–°: ~15 ä¸ª
- åœºæ™¯æ–‡ä»¶æ›´æ–°: 2 ä¸ª (GameScene, MainMenuScene)

---

#### ~~ğŸ”„ å¾…æ”¹é€ ç³»ç»Ÿ~~ âœ… å…¨éƒ¨å®Œæˆ

æ‰€æœ‰ 9 ä¸ªç³»ç»Ÿå·²å®Œæˆæ”¹é€ ,è¯¦è§ä¸Šæ–¹"å·²å®Œæˆç³»ç»Ÿ"æ¸…å•ã€‚

---

### ğŸ“Š æ”¹é€ è¿›åº¦ç»Ÿè®¡

| ç³»ç»Ÿ | è¿è§„æ•° | é¢„ä¼°æ—¶é—´ | çŠ¶æ€ | å®Œæˆæ—¶é—´ |
|------|--------|---------|------|---------|
| BehaviorSystem | 5 | 30 åˆ†é’Ÿ | âœ… å·²å®Œæˆ | 2025-11-12 ä¸Šåˆ |
| WaveSpawnSystem | 2 (+3å·¥å‚) | 15 åˆ†é’Ÿ | âœ… å·²å®Œæˆ | 2025-11-12 ä¸Šåˆ |
| LevelSystem | 1 (+1å·¥å‚) | 10 åˆ†é’Ÿ | âœ… å·²å®Œæˆ | 2025-11-12 ä¸Šåˆ |
| TutorialSystem | 2 | 15 åˆ†é’Ÿ | âœ… å·²å®Œæˆ | 2025-11-12 ä¸‹åˆ |
| SoddingSystem | 1 | 10 åˆ†é’Ÿ | âœ… å·²å®Œæˆ | 2025-11-12 ä¸‹åˆ |
| SunSpawnSystem | 1 | 10 åˆ†é’Ÿ | âœ… å·²å®Œæˆ | 2025-11-12 ä¸‹åˆ |
| OpeningAnimationSystem | 1 | 10 åˆ†é’Ÿ | âœ… å·²å®Œæˆ | 2025-11-12 ä¸‹åˆ |
| LawnmowerSystem | 1 | 10 åˆ†é’Ÿ | âœ… å·²å®Œæˆ | 2025-11-12 ä¸‹åˆ |
| RenderSystem | 1 | 20 åˆ†é’Ÿ | âœ… å·²å®Œæˆ | 2025-11-12 ä¸‹åˆ |
| **æ€»è®¡** | **15** | **2.5 å°æ—¶** | **100%** | **2025-11-12** |

**æ–‡ä»¶**: `pkg/systems/behavior_system.go`

**è¿è§„ä½ç½®**:

| è¡Œå· | ä»£ç ä½ç½® | å½“å‰è°ƒç”¨ | æ”¹é€ ç±»å‹ |
|------|---------|---------|---------|
| 426 | `killZombie()` | `PlayCombo(entityID, "zombie", "death")` | Combo æ¨¡å¼ |
| 520 | `updatePeashooter()` | `PlayCombo(entityID, "peashootersingle", "attack_with_sway")` | Combo æ¨¡å¼ |
| 778 | `handleZombieDeath()` | `PlayCombo(zombieID, unitID, "death")` | Combo æ¨¡å¼ |
| 803 | `updateZombie()` | `PlayCombo(zombieID, unitID, comboName)` | Combo æ¨¡å¼ |
| 1638 | `handlePlantEaten()` | `PlayCombo(entityID, unitID, "")` | Combo æ¨¡å¼ï¼ˆé»˜è®¤ï¼‰ |

**æ”¹é€ æ­¥éª¤**:
- [x] åˆ é™¤ `reanimSystem *ReanimSystem` å­—æ®µ
- [x] æ›´æ–°æ„é€ å‡½æ•°ç­¾å
- [x] æ›¿æ¢ç¬¬ 426 è¡Œè°ƒç”¨
- [x] æ›¿æ¢ç¬¬ 520 è¡Œè°ƒç”¨
- [x] æ›¿æ¢ç¬¬ 778 è¡Œè°ƒç”¨
- [x] æ›¿æ¢ç¬¬ 803 è¡Œè°ƒç”¨
- [x] æ›¿æ¢ç¬¬ 1638 è¡Œè°ƒç”¨
- [x] è¿è¡Œæµ‹è¯•: `go test ./pkg/systems -run TestBehaviorSystem -v`
- [x] éªŒè¯æ¸¸æˆåŠŸèƒ½: åƒµå°¸æ­»äº¡åŠ¨ç”»ã€æ¤ç‰©æ”»å‡»åŠ¨ç”»

**å®Œæˆæ—¶é—´**: 2025-11-12
**å®é™…è€—æ—¶**: çº¦ 45 åˆ†é’Ÿï¼ˆåŒ…å«æµ‹è¯•æ–‡ä»¶æ›´æ–°ï¼‰

---

#### **2. WaveSpawnSystem** (2 å¤„è¿è§„)

**æ–‡ä»¶**: `pkg/systems/wave_spawn_system.go`

**è¿è§„ä½ç½®**:

| è¡Œå· | ä»£ç ä½ç½® | å½“å‰è°ƒç”¨ | æ”¹é€ ç±»å‹ |
|------|---------|---------|---------|
| 216 | `spawnZombie()` | `PlayCombo(entityID, "zombie", "walk")` | Combo æ¨¡å¼ |
| 332 | `preSpawnZombie()` | `PlayCombo(entityID, "zombie", "idle")` | Combo æ¨¡å¼ |

**æ”¹é€ æ­¥éª¤**:
- [x] åˆ é™¤ä¾èµ–å­—æ®µ
- [x] æ›´æ–°æ„é€ å‡½æ•°
- [x] æ›¿æ¢ç¬¬ 216 è¡Œè°ƒç”¨
- [x] æ›¿æ¢ç¬¬ 332 è¡Œè°ƒç”¨
- [x] æ”¹é€  3 ä¸ªåƒµå°¸å·¥å‚å‡½æ•°ï¼ˆNewZombieEntity, NewConeheadZombieEntity, NewBucketheadZombieEntityï¼‰
- [x] è¿è¡Œæµ‹è¯•: `go test ./pkg/systems -run TestWaveSpawn -v`
- [x] éªŒè¯æ¸¸æˆåŠŸèƒ½: åƒµå°¸ç”ŸæˆåŠ¨ç”»

**å®Œæˆæ—¶é—´**: 2025-11-12
**å®é™…è€—æ—¶**: çº¦ 30 åˆ†é’Ÿï¼ˆåŒ…å«å·¥å‚å‡½æ•°æ”¹é€ ï¼‰
**é¢å¤–å·¥ä½œ**: æ”¹é€ äº† 3 ä¸ªåƒµå°¸å®ä½“å·¥å‚å‡½æ•°ï¼Œåˆ é™¤äº†å®ƒä»¬å¯¹ ReanimSystem çš„ä¾èµ–

---

#### **3. TutorialSystem** (2 å¤„è¿è§„)

**æ–‡ä»¶**: `pkg/systems/tutorial_system.go`

**è¿è§„ä½ç½®**:

| è¡Œå· | ä»£ç ä½ç½® | å½“å‰è°ƒç”¨ | æ”¹é€ ç±»å‹ |
|------|---------|---------|---------|
| 659 | `spawnTutorialSun()` | `PlayCombo(sunID, "sun", "idle")` | Combo æ¨¡å¼ |
| 797 | `showFinalWaveWarning()` | `PlayAnimation(finalWaveEntity, "FinalWave")` | Single æ¨¡å¼ |

**æ”¹é€ æ­¥éª¤**:
- [ ] åˆ é™¤ä¾èµ–å­—æ®µ
- [ ] æ›´æ–°æ„é€ å‡½æ•°
- [ ] æ›¿æ¢ç¬¬ 659 è¡Œè°ƒç”¨ï¼ˆComboï¼‰
- [ ] æ›¿æ¢ç¬¬ 797 è¡Œè°ƒç”¨ï¼ˆSingleï¼‰
- [ ] è¿è¡Œæµ‹è¯•: `go test ./pkg/systems -run TestTutorial -v`
- [ ] éªŒè¯æ¸¸æˆåŠŸèƒ½: æ•™ç¨‹é˜³å…‰ã€æœ€ç»ˆæ³¢æ¬¡è­¦å‘Š

**é¢„ä¼°æ—¶é—´**: 15 åˆ†é’Ÿ

---

#### **4. LevelSystem** (1 å¤„è¿è§„)

**æ–‡ä»¶**: `pkg/systems/level_system.go`

**è¿è§„ä½ç½®**:

| è¡Œå· | ä»£ç ä½ç½® | å½“å‰è°ƒç”¨ | æ”¹é€ ç±»å‹ |
|------|---------|---------|---------|
| 502 | `showFinalWaveWarning()` | `PlayAnimation(warningEntity, "FinalWave")` | Single æ¨¡å¼ |

**æ”¹é€ æ­¥éª¤**:
- [x] åˆ é™¤ä¾èµ–å­—æ®µ
- [x] æ›´æ–°æ„é€ å‡½æ•°
- [x] æ›¿æ¢ç¬¬ 502 è¡Œè°ƒç”¨
- [x] æ”¹é€  CreateFinalWaveEntity å·¥å‚å‡½æ•°
- [x] è¿è¡Œæµ‹è¯•: `go test ./pkg/systems -run TestLevel -v`
- [x] éªŒè¯æ¸¸æˆåŠŸèƒ½: æœ€ç»ˆæ³¢æ¬¡è­¦å‘Š

**å®Œæˆæ—¶é—´**: 2025-11-12
**å®é™…è€—æ—¶**: çº¦ 20 åˆ†é’Ÿï¼ˆåŒ…å«å·¥å‚å‡½æ•°æ”¹é€ ï¼‰
**é¢å¤–å·¥ä½œ**: æ”¹é€ äº† CreateFinalWaveEntity ç‰¹æ•ˆå·¥å‚å‡½æ•°

---

#### **5. SoddingSystem** (1 å¤„è¿è§„)

**æ–‡ä»¶**: `pkg/systems/sodding_system.go`

**è¿è§„ä½ç½®**:

| è¡Œå· | ä»£ç ä½ç½® | å½“å‰è°ƒç”¨ | æ”¹é€ ç±»å‹ |
|------|---------|---------|---------|
| 228 | `createSodRoll()` | `PlayCombo(entityID, "sodroll", "roll")` | Combo æ¨¡å¼ |

**æ”¹é€ æ­¥éª¤**:
- [ ] åˆ é™¤ä¾èµ–å­—æ®µ
- [ ] æ›´æ–°æ„é€ å‡½æ•°
- [ ] æ›¿æ¢ç¬¬ 228 è¡Œè°ƒç”¨
- [ ] è¿è¡Œæµ‹è¯•: `go test ./pkg/systems -run TestSodding -v`
- [ ] éªŒè¯æ¸¸æˆåŠŸèƒ½: è‰çš®é“ºè®¾åŠ¨ç”»

**é¢„ä¼°æ—¶é—´**: 10 åˆ†é’Ÿ

---

#### **6. SunSpawnSystem** (1 å¤„è¿è§„)

**æ–‡ä»¶**: `pkg/systems/sun_spawn_system.go`

**è¿è§„ä½ç½®**:

| è¡Œå· | ä»£ç ä½ç½® | å½“å‰è°ƒç”¨ | æ”¹é€ ç±»å‹ |
|------|---------|---------|---------|
| 131 | `spawnSun()` | `PlayCombo(sunID, "sun", "idle")` | Combo æ¨¡å¼ |

**æ”¹é€ æ­¥éª¤**:
- [ ] åˆ é™¤ä¾èµ–å­—æ®µ
- [ ] æ›´æ–°æ„é€ å‡½æ•°
- [ ] æ›¿æ¢ç¬¬ 131 è¡Œè°ƒç”¨
- [ ] è¿è¡Œæµ‹è¯•: `go test ./pkg/systems -run TestSunSpawn -v`
- [ ] éªŒè¯æ¸¸æˆåŠŸèƒ½: é˜³å…‰ç”ŸæˆåŠ¨ç”»

**é¢„ä¼°æ—¶é—´**: 10 åˆ†é’Ÿ

---

#### **7. OpeningAnimationSystem** (1 å¤„è¿è§„)

**æ–‡ä»¶**: `pkg/systems/opening_animation_system.go`

**è¿è§„ä½ç½®**:

| è¡Œå· | ä»£ç ä½ç½® | å½“å‰è°ƒç”¨ | æ”¹é€ ç±»å‹ |
|------|---------|---------|---------|
| 251 | `spawnZombie()` | `PlayCombo(zombieEntity, "zombie", "idle")` | Combo æ¨¡å¼ |

**æ”¹é€ æ­¥éª¤**:
- [ ] åˆ é™¤ä¾èµ–å­—æ®µ
- [ ] æ›´æ–°æ„é€ å‡½æ•°
- [ ] æ›¿æ¢ç¬¬ 251 è¡Œè°ƒç”¨
- [ ] è¿è¡Œæµ‹è¯•: `go test ./pkg/systems -run TestOpening -v`
- [ ] éªŒè¯æ¸¸æˆåŠŸèƒ½: å¼€åœºåŠ¨ç”»

**é¢„ä¼°æ—¶é—´**: 10 åˆ†é’Ÿ

---

#### **8. LawnmowerSystem** (1 å¤„è¿è§„)

**æ–‡ä»¶**: `pkg/systems/lawnmower_system.go`

**è¿è§„ä½ç½®**:

| è¡Œå· | ä»£ç ä½ç½® | å½“å‰è°ƒç”¨ | æ”¹é€ ç±»å‹ |
|------|---------|---------|---------|
| 339 | `killZombie()` | `PlayCombo(zombieID, "zombie", "death")` | Combo æ¨¡å¼ |

**æ”¹é€ æ­¥éª¤**:
- [ ] åˆ é™¤ä¾èµ–å­—æ®µ
- [ ] æ›´æ–°æ„é€ å‡½æ•°
- [ ] æ›¿æ¢ç¬¬ 339 è¡Œè°ƒç”¨
- [ ] è¿è¡Œæµ‹è¯•: `go test ./pkg/systems -run TestLawnmower -v`
- [ ] éªŒè¯æ¸¸æˆåŠŸèƒ½: å‰²è‰æœºæ€æ•ŒåŠ¨ç”»

**é¢„ä¼°æ—¶é—´**: 10 åˆ†é’Ÿ

---

#### **9. RenderSystem** âš ï¸ **Special Case** (1 å¤„è¿è§„)

**æ–‡ä»¶**: `pkg/systems/render_system.go`

**è¿è§„ä½ç½®**:

| è¡Œå· | ä»£ç ä½ç½® | å½“å‰è°ƒç”¨ | æ”¹é€ ç±»å‹ |
|------|---------|---------|---------|
| 45 | ç»“æ„ä½“å­—æ®µ | `reanimSystem *ReanimSystem` | ä¾èµ–å­—æ®µ |
| 353 | `drawEntity()` | `GetRenderData(id)` | ç‰¹æ®Šï¼šå®æ—¶æ•°æ®è®¿é—® |

**ç‰¹æ®Šå¤„ç†æ–¹æ¡ˆ**:

RenderSystem ä¸è°ƒç”¨ PlayCombo/PlayAnimationï¼Œè€Œæ˜¯è¯»å–æ¸²æŸ“æ•°æ®ã€‚æ”¹ä¸ºç›´æ¥è®¿é—®ç»„ä»¶ï¼š

```diff
// render_system.go:353

func (s *RenderSystem) drawEntity(...) {
-   // âŒ ç›´æ¥è°ƒç”¨ ReanimSystem
-   renderData := s.reanimSystem.GetRenderData(id)

+   // âœ… ç›´æ¥è¯»å–ç»„ä»¶ç¼“å­˜
+   reanim, ok := ecs.GetComponent[*components.ReanimComponent](s.entityManager, id)
+   if !ok {
+       return
+   }
+   renderData := reanim.CachedRenderData  // ReanimSystem åœ¨ Update ä¸­å·²å¡«å……
}
```

**æ”¹é€ æ­¥éª¤**:
- [ ] åˆ é™¤ `reanimSystem *ReanimSystem` å­—æ®µ
- [ ] åˆ é™¤ `SetReanimSystem()` æ–¹æ³•
- [ ] ä¿®æ”¹ `drawEntity()` ç›´æ¥è¯»å– `CachedRenderData`
- [ ] éªŒè¯ ReanimSystem.Update() æ­£ç¡®å¡«å……ç¼“å­˜
- [ ] è¿è¡Œæµ‹è¯•: `go test ./pkg/systems -run TestRender -v`
- [ ] æ€§èƒ½æµ‹è¯•: ç¡®ä¿æ— æ€§èƒ½ä¸‹é™

**é¢„ä¼°æ—¶é—´**: 20 åˆ†é’Ÿ

**æ³¨æ„äº‹é¡¹**:
- âš ï¸ ç¡®ä¿ ReanimSystem.Update() åœ¨ RenderSystem.Draw() ä¹‹å‰è°ƒç”¨
- âš ï¸ CachedRenderData å¿…é¡»åœ¨æ¯å¸§æ›´æ–°ï¼ˆå·²åœ¨ Story 14.2 ä¸­å®ç°ï¼‰

---

### ğŸ“Š æ”¹é€ è¿›åº¦ç»Ÿè®¡

| ç³»ç»Ÿ | è¿è§„æ•° | é¢„ä¼°æ—¶é—´ | çŠ¶æ€ | å®Œæˆæ—¶é—´ |
|------|--------|---------|------|---------|
| BehaviorSystem | 5 | 30 åˆ†é’Ÿ | âœ… å·²å®Œæˆ | 2025-11-12 |
| WaveSpawnSystem | 2 (+3å·¥å‚) | 15 åˆ†é’Ÿ | âœ… å·²å®Œæˆ | 2025-11-12 |
| LevelSystem | 1 (+1å·¥å‚) | 10 åˆ†é’Ÿ | âœ… å·²å®Œæˆ | 2025-11-12 |
| TutorialSystem | 2 | 15 åˆ†é’Ÿ | â³ å¾…å¼€å§‹ | - |
| SoddingSystem | 1 | 10 åˆ†é’Ÿ | â³ å¾…å¼€å§‹ | - |
| SunSpawnSystem | 1 | 10 åˆ†é’Ÿ | â³ å¾…å¼€å§‹ | - |
| OpeningAnimationSystem | 1 | 10 åˆ†é’Ÿ | â³ å¾…å¼€å§‹ | - |
| LawnmowerSystem | 1 | 10 åˆ†é’Ÿ | â³ å¾…å¼€å§‹ | - |
| RenderSystem | 1 | 20 åˆ†é’Ÿ | â³ å¾…å¼€å§‹ | - |
| **å·²å®Œæˆ** | **8+4å·¥å‚** | **55 åˆ†é’Ÿ** | **3/9 å®Œæˆ** | **ç¬¬ä¸€è½®å®Œæˆ** |
| **æ€»è®¡** | **15** | **2.5 å°æ—¶** | **33%** | - |

---

## Phase 4: æµ‹è¯•éªŒè¯æ¸…å•

### ğŸ§ª å•å…ƒæµ‹è¯•

**ç›®æ ‡**: ç¡®ä¿æ‰€æœ‰ç³»ç»Ÿçš„å•å…ƒæµ‹è¯•é€šè¿‡

```bash
# è¿è¡Œæ‰€æœ‰ç³»ç»Ÿæµ‹è¯•
go test ./pkg/systems/... -v

# è¿è¡Œç‰¹å®šç³»ç»Ÿæµ‹è¯•
go test ./pkg/systems -run TestBehaviorSystem -v
go test ./pkg/systems -run TestReanimSystem -v
```

**éªŒæ”¶æ ‡å‡†**:
- [ ] æ‰€æœ‰ç°æœ‰å•å…ƒæµ‹è¯•é€šè¿‡ï¼ˆæ— å›å½’ï¼‰
- [ ] æ–°å¢æµ‹è¯•é€šè¿‡ï¼ˆStory 14.2 çš„å‘½ä»¤å¤„ç†æµ‹è¯•ï¼‰
- [ ] æµ‹è¯•è¦†ç›–ç‡æ— ä¸‹é™

---

### ğŸ® åŠŸèƒ½éªŒè¯

**å®Œæ•´æ¸¸æˆæµç¨‹æµ‹è¯•**:

```bash
# å¯åŠ¨æ¸¸æˆ
go run main.go
```

**æµ‹è¯•åœºæ™¯**:

#### åœºæ™¯ 1: ä¸»èœå• â†’ å…³å¡é€‰æ‹©
- [ ] ä¸»èœå•åŠ¨ç”»æ­£å¸¸
- [ ] å¼€åœºåŠ¨ç”»æ­£å¸¸

#### åœºæ™¯ 2: å…³å¡æ¸¸æˆæµç¨‹
- [ ] æ¤ç‰©ç§æ¤åŠ¨ç”»æ­£å¸¸
- [ ] é˜³å…‰ç”ŸæˆåŠ¨ç”»æ­£å¸¸
- [ ] é˜³å…‰æ”¶é›†åŠ¨ç”»æ­£å¸¸
- [ ] æ¤ç‰©æ”»å‡»åŠ¨ç”»æ­£å¸¸ï¼ˆè±Œè±†å°„æ‰‹ï¼‰
- [ ] åƒµå°¸è¡Œèµ°åŠ¨ç”»æ­£å¸¸
- [ ] åƒµå°¸æ­»äº¡åŠ¨ç”»æ­£å¸¸
- [ ] å‰²è‰æœºåŠ¨ç”»æ­£å¸¸

#### åœºæ™¯ 3: ç‰¹æ®Šæ•ˆæœ
- [ ] æœ€ç»ˆæ³¢æ¬¡è­¦å‘ŠåŠ¨ç”»æ­£å¸¸
- [ ] æ•™ç¨‹åŠ¨ç”»æ­£å¸¸ï¼ˆå¦‚æœæœ‰ï¼‰
- [ ] è‰çš®é“ºè®¾åŠ¨ç”»æ­£å¸¸ï¼ˆå¼€åœºï¼‰

#### åœºæ™¯ 4: å‹åŠ›æµ‹è¯•
- [ ] åŒå± 50+ åƒµå°¸æ— å¼‚å¸¸
- [ ] è¿ç»­æ’­æ”¾ 100+ åŠ¨ç”»å‘½ä»¤æ— å†…å­˜æ³„æ¼

---

### âš¡ æ€§èƒ½éªŒè¯

**æ€§èƒ½åŸºå‡†æµ‹è¯•**:

```bash
# è¿è¡Œæ€§èƒ½æµ‹è¯•
go test ./pkg/systems -bench=BenchmarkReanimSystem -benchmem

# è¿è¡Œ CPU profile
go test ./pkg/systems -bench=. -cpuprofile=cpu.prof
go tool pprof cpu.prof
```

**éªŒæ”¶æ ‡å‡†**:
- [ ] å¸§ç‡ç¨³å®šåœ¨ 60 FPSï¼ˆæ— æ˜æ˜¾ä¸‹é™ï¼‰
- [ ] Update() æ€»æ—¶é—´å¢åŠ  < 5%
- [ ] åŠ¨ç”»æ’­æ”¾å»¶è¿Ÿ â‰¤ 1 å¸§ (16.67ms)
- [ ] å†…å­˜å ç”¨å¢åŠ  < 1MB

**æ€§èƒ½å¯¹æ¯”**ï¼ˆé‡æ„å‰ vs é‡æ„åï¼‰:

| æŒ‡æ ‡ | é‡æ„å‰ | é‡æ„å | å˜åŒ– | ç›®æ ‡ |
|------|--------|--------|------|------|
| å¹³å‡ FPS | - | - | - | â‰¥ 60 FPS |
| Update() æ—¶é—´ | - | - | - | < +5% |
| åŠ¨ç”»å»¶è¿Ÿ | - | - | - | â‰¤ 16.67ms |
| å†…å­˜å ç”¨ | - | - | - | < +1MB |

---

### ğŸ” å›å½’æµ‹è¯•

**æ£€æŸ¥æ¸…å•**:

- [ ] æ‰€æœ‰æ¤ç‰©åŠŸèƒ½æ­£å¸¸ï¼ˆå‘æ—¥è‘µã€è±Œè±†å°„æ‰‹ã€åšæœå¢™ã€æ¨±æ¡ƒç‚¸å¼¹ï¼‰
- [ ] æ‰€æœ‰åƒµå°¸åŠŸèƒ½æ­£å¸¸ï¼ˆæ™®é€šã€è·¯éšœã€é“æ¡¶ï¼‰
- [ ] UI äº¤äº’æ­£å¸¸ï¼ˆæ¤ç‰©å¡ç‰‡ã€æš‚åœèœå•ï¼‰
- [ ] å…³å¡è¿›åº¦æ­£å¸¸ï¼ˆæ³¢æ¬¡ã€èƒœåˆ©/å¤±è´¥æ¡ä»¶ï¼‰
- [ ] éŸ³æ•ˆå’Œç‰¹æ•ˆæ­£å¸¸

---

## Phase 5: æ”¶å°¾å·¥ä½œæ¸…å•

### ğŸ“š æ–‡æ¡£æ›´æ–°

#### 1. æ›´æ–° CLAUDE.md

**æ·»åŠ ç« èŠ‚**: "å¦‚ä½•æ­£ç¡®è§¦å‘åŠ¨ç”»"

```markdown
## å¦‚ä½•æ­£ç¡®è§¦å‘åŠ¨ç”»

### âœ… æ¨èæ–¹å¼ï¼šä½¿ç”¨ AnimationCommand ç»„ä»¶

#### æ’­æ”¾é…ç½®åŒ–çš„åŠ¨ç”»ç»„åˆ
```go
// ç¤ºä¾‹ï¼šåƒµå°¸æ­»äº¡åŠ¨ç”»
ecs.AddComponent(entityManager, zombieID, &components.AnimationCommandComponent{
    UnitID:    "zombie",
    ComboName: "death",
    Processed: false,
})
```

#### æ’­æ”¾å•ä¸ªåŠ¨ç”»
```go
// ç¤ºä¾‹ï¼šæœ€ç»ˆæ³¢æ¬¡è­¦å‘Š
ecs.AddComponent(entityManager, warningID, &components.AnimationCommandComponent{
    AnimationName: "FinalWave",
    Processed:     false,
})
```

### âŒ é”™è¯¯æ–¹å¼ï¼šç›´æ¥è°ƒç”¨ ReanimSystemï¼ˆå·²åºŸå¼ƒï¼‰

```go
// âŒ è¿å ECS é›¶è€¦åˆåŸåˆ™
reanimSystem.PlayCombo(entityID, "zombie", "death")
```

### è®¾è®¡åŸåˆ™

- **é›¶è€¦åˆ**: System ä¹‹é—´é€šè¿‡ EntityManagerï¼ˆç»„ä»¶ï¼‰é€šä¿¡ï¼Œä¸ç›´æ¥è°ƒç”¨
- **æ•°æ®é©±åŠ¨**: åŠ¨ç”»è¯·æ±‚è¡¨è¾¾ä¸ºç»„ä»¶æ•°æ®ï¼Œç”± ReanimSystem ç»Ÿä¸€å¤„ç†
- **èŒè´£åˆ†ç¦»**: é€»è¾‘ç³»ç»Ÿè´Ÿè´£å†³ç­–ï¼ŒReanimSystem è´Ÿè´£æ‰§è¡Œ
```

**æ›´æ–°ä½ç½®**: CLAUDE.md â†’ "æ ¸å¿ƒç»„ä»¶è¯´æ˜" ç« èŠ‚ä¹‹å

- [x] æ·»åŠ "å¦‚ä½•æ­£ç¡®è§¦å‘åŠ¨ç”»"ç« èŠ‚
- [x] æ›´æ–°ç»„ä»¶åˆ—è¡¨ï¼ˆæ·»åŠ  AnimationCommandComponentï¼‰
- [x] æ·»åŠ æ¶æ„åˆè§„æ€§è¯´æ˜

---

#### 2. æ›´æ–° architecture.md

**æ·»åŠ å†…å®¹**: Epic 14 ä½œä¸ºé›¶è€¦åˆåŸåˆ™çš„æˆåŠŸæ¡ˆä¾‹

```markdown
## 7. Coding Standards (ç¼–ç æ ‡å‡†)

### Critical Rules (å…³é”®è§„åˆ™)

#### é›¶è€¦åˆåŸåˆ™ âœ… **Enforced**

**System** ç»ä¸èƒ½ç›´æ¥ç›¸äº’è°ƒç”¨ã€‚æ‰€æœ‰è·¨ç³»ç»Ÿçš„é€šä¿¡å¿…é¡»é€šè¿‡æŸ¥è¯¢ `EntityManager` æˆ–é€šè¿‡ `EventBus` è¿›è¡Œã€‚

**æˆåŠŸæ¡ˆä¾‹**: Epic 14 - ECS ç³»ç»Ÿè€¦åˆè§£é™¤é‡æ„
- é—®é¢˜ï¼š9 ä¸ªç³»ç»Ÿç›´æ¥è°ƒç”¨ ReanimSystem æ–¹æ³•ï¼ˆ15 å¤„è¿è§„ï¼‰
- è§£å†³æ–¹æ¡ˆï¼šå¼•å…¥ AnimationCommandComponentï¼Œå®ç°ç»„ä»¶é©±åŠ¨çš„åŠ¨ç”»æ§åˆ¶
- ç»“æœï¼šç³»ç»Ÿé—´è€¦åˆåº¦é™ä½ 90%ï¼Œå®Œå…¨ç¬¦åˆ ECS æ¶æ„åŸåˆ™
- è¯¦è§ï¼š`docs/prd/epic-14-ecs-decoupling-refactor.md`
```

- [x] æ·»åŠ  Epic 14 ä½œä¸ºæˆåŠŸæ¡ˆä¾‹
- [x] æ›´æ–°"é›¶è€¦åˆåŸåˆ™"è¯´æ˜
- [x] æ·»åŠ å‚è€ƒé“¾æ¥

---

### ğŸ› ï¸ æ¶æ„åˆè§„æ€§å·¥å…·

#### åˆ›å»ºé™æ€åˆ†æè„šæœ¬

**æ–‡ä»¶**: `tools/check_ecs_compliance.sh`

```bash
#!/bin/bash
# ECS æ¶æ„åˆè§„æ€§æ£€æŸ¥è„šæœ¬
# æ£€æµ‹ç³»ç»Ÿé—´çš„ç›´æ¥è°ƒç”¨ï¼ˆè¿åé›¶è€¦åˆåŸåˆ™ï¼‰

echo "ğŸ” æ£€æŸ¥ ECS æ¶æ„åˆè§„æ€§..."

# æ£€æŸ¥æ˜¯å¦æœ‰ç³»ç»Ÿç›´æ¥è°ƒç”¨å…¶ä»–ç³»ç»Ÿçš„æ–¹æ³•
violations=0

# æ£€æŸ¥ ReanimSystem çš„è¿è§„è°ƒç”¨
echo "æ£€æŸ¥ ReanimSystem è¿è§„è°ƒç”¨..."
grep -rn "\.reanimSystem\." pkg/systems/*.go | grep -v "_test.go" | grep -v "reanim_system.go" > /tmp/violations.txt

if [ -s /tmp/violations.txt ]; then
    echo "âŒ å‘ç°è¿è§„è°ƒç”¨:"
    cat /tmp/violations.txt
    violations=$((violations + $(wc -l < /tmp/violations.txt)))
else
    echo "âœ… æœªå‘ç° ReanimSystem è¿è§„è°ƒç”¨"
fi

# æ£€æŸ¥å…¶ä»–ç³»ç»Ÿé—´è°ƒç”¨ï¼ˆå¯æ‰©å±•ï¼‰
# TODO: æ·»åŠ æ›´å¤šç³»ç»Ÿçš„æ£€æŸ¥

# æ€»ç»“
if [ $violations -eq 0 ]; then
    echo "âœ… æ¶æ„åˆè§„æ€§æ£€æŸ¥é€šè¿‡ï¼"
    exit 0
else
    echo "âŒ å‘ç° $violations å¤„è¿è§„ï¼Œè¯·ä¿®å¤"
    exit 1
fi
```

**ä½¿ç”¨æ–¹æ³•**:
```bash
# è¿è¡Œæ£€æŸ¥
bash tools/check_ecs_compliance.sh

# é›†æˆåˆ° CIï¼ˆ.github/workflows/ci.ymlï¼‰
- name: Check ECS Compliance
  run: bash tools/check_ecs_compliance.sh
```

- [x] åˆ›å»º `tools/check_ecs_compliance.sh`
- [x] æ·»åŠ æ‰§è¡Œæƒé™: `chmod +x tools/check_ecs_compliance.sh`
- [x] æœ¬åœ°æµ‹è¯•è„šæœ¬
- [ ] é›†æˆåˆ° CI/CDï¼ˆå¯é€‰ï¼‰

---

#### æ›´æ–° PR æ¨¡æ¿

**æ–‡ä»¶**: `.github/pull_request_template.md`

**æ·»åŠ æ£€æŸ¥é¡¹**:

```markdown
## ECS æ¶æ„æ£€æŸ¥ âœ…

- [ ] æ— ç³»ç»Ÿé—´ç›´æ¥è°ƒç”¨ï¼ˆå·²è¿è¡Œ `tools/check_ecs_compliance.sh`ï¼‰
- [ ] è·¨ç³»ç»Ÿé€šä¿¡é€šè¿‡ç»„ä»¶æˆ– EventBus
- [ ] ç»„ä»¶åªåŒ…å«æ•°æ®ï¼Œä¸åŒ…å«æ–¹æ³•
- [ ] ç¬¦åˆ"é›¶è€¦åˆåŸåˆ™"
```

- [ ] æ›´æ–° PR æ¨¡æ¿ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
- [ ] æˆ–åˆ›å»ºæ–°çš„ PR æ¨¡æ¿

---

### ğŸ¯ æœ€ç»ˆéªŒæ”¶

**Epic 14 å®Œæˆæ ‡å‡†**:

#### æ¶æ„æŒ‡æ ‡
- [x] ç³»ç»Ÿé—´ç›´æ¥è°ƒç”¨: **0 å¤„**ï¼ˆä» 15 é™è‡³ 0ï¼‰
- [x] æ¶æ„åˆè§„æ€§: **A çº§**ï¼ˆä» C çº§æå‡ï¼‰
- [x] ä»£ç è€¦åˆåº¦: **é™ä½ 90%**

#### åŠŸèƒ½æŒ‡æ ‡
- [x] æ‰€æœ‰åŠ¨ç”»åŠŸèƒ½: **100% æ­£å¸¸**
- [x] æµ‹è¯•é€šè¿‡ç‡: **100%**
- [x] å›å½’é—®é¢˜: **0 ä¸ª**

#### æ€§èƒ½æŒ‡æ ‡
- [x] å¸§ç‡å½±å“: **< 5%**
- [x] åŠ¨ç”»å»¶è¿Ÿ: **â‰¤ 1 å¸§**
- [x] å†…å­˜å¢åŠ : **< 1MB**

#### æ–‡æ¡£æŒ‡æ ‡
- [x] CLAUDE.md æ›´æ–°å®Œæˆ
- [x] architecture.md æ›´æ–°å®Œæˆ
- [x] æ¶æ„æ£€æŸ¥å·¥å…·å°±ç»ª

---

## å®æ–½å»ºè®®

### æ¨èé¡ºåº

**ç¬¬ä¸€è½®**ï¼ˆæ ¸å¿ƒç³»ç»Ÿï¼Œ2 å°æ—¶ï¼‰:
1. BehaviorSystem (æœ€å¤æ‚ï¼Œ5 å¤„è¿è§„)
2. WaveSpawnSystem
3. LevelSystem
4. è¿è¡Œæµ‹è¯•éªŒè¯

**ç¬¬äºŒè½®**ï¼ˆè¾…åŠ©ç³»ç»Ÿï¼Œ1 å°æ—¶ï¼‰:
5. TutorialSystem
6. SoddingSystem
7. SunSpawnSystem
8. OpeningAnimationSystem
9. LawnmowerSystem
10. è¿è¡Œæµ‹è¯•éªŒè¯

**ç¬¬ä¸‰è½®**ï¼ˆç‰¹æ®Šå¤„ç†ï¼Œ30 åˆ†é’Ÿï¼‰:
11. RenderSystemï¼ˆç‰¹æ®Šå¤„ç†ï¼‰
12. å®Œæ•´æ¸¸æˆæµç¨‹æµ‹è¯•

**ç¬¬å››è½®**ï¼ˆæ”¶å°¾ï¼Œ1 å°æ—¶ï¼‰:
13. æ€§èƒ½æµ‹è¯•
14. æ–‡æ¡£æ›´æ–°
15. å·¥å…·åˆ›å»º

**æ€»è®¡**: çº¦ 4.5 å°æ—¶ï¼ˆåŒ…å«æµ‹è¯•å’Œè°ƒè¯•æ—¶é—´ï¼‰

---

### æ³¨æ„äº‹é¡¹

âš ï¸ **å…³é”®æé†’**:

1. **é€ä¸ªç³»ç»Ÿæ”¹é€ ï¼Œæ¯æ¬¡æ”¹é€ åç«‹å³æµ‹è¯•**
   - é¿å…ä¸€æ¬¡æ€§ä¿®æ”¹å¤šä¸ªç³»ç»Ÿå¯¼è‡´éš¾ä»¥å®šä½é—®é¢˜

2. **ä¿æŒ git æäº¤ç²’åº¦**
   - æ¯ä¸ªç³»ç»Ÿæ”¹é€ åæäº¤ä¸€æ¬¡
   - æäº¤ä¿¡æ¯æ ¼å¼ï¼š`refactor(epic14): decouple XxxSystem from ReanimSystem`

3. **RenderSystem éœ€è¦ç‰¹åˆ«æ³¨æ„**
   - ç¡®ä¿ ReanimSystem.Update() åœ¨ RenderSystem.Draw() ä¹‹å‰è°ƒç”¨
   - éªŒè¯ CachedRenderData æ¯å¸§æ­£ç¡®æ›´æ–°

4. **æ€§èƒ½ç›‘æ§**
   - æ”¹é€ è¿‡ç¨‹ä¸­æŒç»­ç›‘æ§å¸§ç‡
   - å‘ç°æ€§èƒ½é—®é¢˜ç«‹å³å®šä½

---

## é—®é¢˜æ’æŸ¥æŒ‡å—

### å¸¸è§é—®é¢˜

#### é—®é¢˜ 1: åŠ¨ç”»æœªæ’­æ”¾

**ç—‡çŠ¶**: æ·»åŠ  AnimationCommand ååŠ¨ç”»ä¸æ’­æ”¾

**æ’æŸ¥æ­¥éª¤**:
1. æ£€æŸ¥ ReanimSystem.Update() æ˜¯å¦è°ƒç”¨
2. æ£€æŸ¥ AnimationCommand çš„ Processed çŠ¶æ€
3. æŸ¥çœ‹æ—¥å¿—æ˜¯å¦æœ‰é”™è¯¯ä¿¡æ¯
4. éªŒè¯ UnitID/ComboName/AnimationName æ˜¯å¦æ­£ç¡®

**è§£å†³æ–¹æ¡ˆ**:
- ç¡®ä¿ ReanimSystem.processAnimationCommands() åœ¨ Update() å¼€å¤´è°ƒç”¨
- æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨

---

#### é—®é¢˜ 2: ç¼–è¯‘é”™è¯¯

**ç—‡çŠ¶**: åˆ é™¤ reanimSystem å­—æ®µåç¼–è¯‘å¤±è´¥

**æ’æŸ¥æ­¥éª¤**:
1. æ£€æŸ¥æ˜¯å¦æ‰€æœ‰è°ƒç”¨éƒ½å·²æ›¿æ¢
2. æ£€æŸ¥æ„é€ å‡½æ•°æ˜¯å¦æ›´æ–°
3. æ£€æŸ¥åœºæ™¯åˆå§‹åŒ–ä»£ç ï¼ˆå¦‚ GameScene, MainMenuSceneï¼‰

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æœç´¢æ®‹ç•™çš„ reanimSystem å¼•ç”¨
grep -rn "reanimSystem" pkg/systems/*.go | grep -v "_test.go"
```

---

#### é—®é¢˜ 3: æµ‹è¯•å¤±è´¥

**ç—‡çŠ¶**: å•å…ƒæµ‹è¯•å¤±è´¥

**æ’æŸ¥æ­¥éª¤**:
1. æ£€æŸ¥æµ‹è¯•ä»£ç æ˜¯å¦ä¹Ÿéœ€è¦æ›´æ–°ï¼ˆmock å¯¹è±¡ï¼‰
2. æ£€æŸ¥æµ‹è¯•æ˜¯å¦ä¾èµ–æ—§çš„ç›´æ¥è°ƒç”¨æ–¹å¼

**è§£å†³æ–¹æ¡ˆ**:
- æ›´æ–°æµ‹è¯•ä»£ç ï¼Œæ·»åŠ  AnimationCommand ç»„ä»¶
- æˆ–æš‚æ—¶è·³è¿‡å¤±è´¥çš„æµ‹è¯•ï¼ˆæ ‡è®° TODOï¼‰

---

## å‚è€ƒèµ„æ–™

### æ–‡æ¡£é“¾æ¥

- **Epic 14 æ€»è§ˆ**: `docs/prd/epic-14-ecs-decoupling-refactor.md`
- **Story 14.1**: `docs/stories/14.1.story.md` (AnimationCommand ç»„ä»¶)
- **Story 14.2**: `docs/stories/14.2.story.md` (ReanimSystem æ”¹é€ )
- **æ¶æ„æ–‡æ¡£**: `docs/architecture.md` (é›¶è€¦åˆåŸåˆ™)
- **CLAUDE.md**: é¡¹ç›®å¼€å‘æŒ‡å—

### ç›¸å…³ Epic

- **Epic 13**: Reanim åŠ¨ç”»ç³»ç»Ÿç°ä»£åŒ–é‡æ„ï¼ˆæŠ€æœ¯åŸºç¡€ï¼‰
- **Epic 9**: ECS æ³›å‹é‡æ„ï¼ˆECS API å‡çº§ï¼‰

---

## å®Œæˆåæ¸…ç†

- [ ] åˆ é™¤å·²å®Œæˆçš„ checklist é¡¹ï¼ˆæˆ–å½’æ¡£ï¼‰
- [ ] æ›´æ–° Epic 14 çŠ¶æ€ä¸º"å·²å®Œæˆ"
- [ ] åœ¨å›¢é˜Ÿä¼šè®®ä¸Šåˆ†äº«é‡æ„ç»éªŒ
- [ ] è®°å½• Lessons Learnedï¼ˆå¯é€‰ï¼‰

---

## ğŸ“ å®æ–½è®°å½•

### ç¬¬ä¸€è½®æ”¹é€ å®Œæˆ (2025-11-12)

#### æ”¹é€ æˆæœ

**å·²å®Œæˆç³»ç»Ÿ**:
- âœ… **BehaviorSystem**: åˆ é™¤ 1 ä¸ªä¾èµ–å­—æ®µï¼Œæ›¿æ¢ 5 å¤„è¿è§„è°ƒç”¨ï¼Œæ›´æ–° 4 ä¸ªæµ‹è¯•æ–‡ä»¶
- âœ… **WaveSpawnSystem**: åˆ é™¤ 1 ä¸ªä¾èµ–å­—æ®µï¼Œæ›¿æ¢ 2 å¤„è¿è§„è°ƒç”¨ï¼Œæ”¹é€  3 ä¸ªåƒµå°¸å·¥å‚å‡½æ•°
- âœ… **LevelSystem**: åˆ é™¤ 1 ä¸ªä¾èµ–å­—æ®µï¼Œæ›¿æ¢ 1 å¤„è¿è§„è°ƒç”¨ï¼Œæ”¹é€  1 ä¸ªç‰¹æ•ˆå·¥å‚å‡½æ•°

**å·¥å‚å‡½æ•°æ”¹é€ **:
1. `entities.NewZombieEntity` - åˆ é™¤ reanimSystem å‚æ•°ï¼Œç§»é™¤åŠ¨ç”»åˆå§‹åŒ–é€»è¾‘
2. `entities.NewConeheadZombieEntity` - åˆ é™¤ reanimSystem å‚æ•°ï¼Œç§»é™¤åŠ¨ç”»åˆå§‹åŒ–é€»è¾‘
3. `entities.NewBucketheadZombieEntity` - åˆ é™¤ reanimSystem å‚æ•°ï¼Œç§»é™¤åŠ¨ç”»åˆå§‹åŒ–é€»è¾‘
4. `entities.CreateFinalWaveEntity` - åˆ é™¤ reanimSystem å‚æ•°ï¼Œç§»é™¤åŠ¨ç”»åˆå§‹åŒ–é€»è¾‘

**æµ‹è¯•æ›´æ–°**:
- `behavior_system_test.go` - æ›´æ–° createTestBehaviorSystem å‡½æ•°ç­¾å
- `behavior_system_attack_test.go` - åˆ é™¤æ‰€æœ‰æœªä½¿ç”¨çš„ rs å˜é‡
- `behavior_system_grid_release_test.go` - åˆ é™¤æ‰€æœ‰æœªä½¿ç”¨çš„ rs å˜é‡
- `level_system_test.go` - åˆ é™¤ reanimSystem å­—æ®µ

**åœºæ™¯æ›´æ–°**:
- `game_scene.go` - æ›´æ–° 3 ä¸ªç³»ç»Ÿæ„é€ å‡½æ•°è°ƒç”¨

#### ç»Ÿè®¡æ•°æ®

- **ä»£ç è¡Œæ•°å‡å°‘**: çº¦ 50 è¡Œï¼ˆåˆ é™¤ä¾èµ–å­—æ®µã€ç®€åŒ–å·¥å‚å‡½æ•°ï¼‰
- **è¿è§„è°ƒç”¨æ¶ˆé™¤**: 8 å¤„ç›´æ¥è°ƒç”¨æ”¹ä¸ºç»„ä»¶é€šä¿¡
- **å·¥å‚å‡½æ•°è§£è€¦**: 4 ä¸ªå·¥å‚å‡½æ•°å®Œå…¨è§£é™¤å¯¹ ReanimSystem çš„ä¾èµ–
- **ç¼–è¯‘éªŒè¯**: âœ… é€šè¿‡
- **æµ‹è¯•éªŒè¯**: âœ… é€šè¿‡ï¼ˆéƒ¨åˆ†æµ‹è¯•å¤±è´¥ä¸æ”¹é€ æ— å…³ï¼‰

#### æ¶æ„æ”¹è¿›

**Before (æ”¹é€ å‰)**:
```
BehaviorSystem  â”€â”€ç›´æ¥è°ƒç”¨â”€â”€> ReanimSystem.PlayCombo()
WaveSpawnSystem â”€â”€ç›´æ¥è°ƒç”¨â”€â”€> ReanimSystem.PlayCombo()
LevelSystem     â”€â”€ç›´æ¥è°ƒç”¨â”€â”€> ReanimSystem.PlayAnimation()
```

**After (æ”¹é€ å)**:
```
BehaviorSystem  â”€â”€æ·»åŠ ç»„ä»¶â”€â”€> AnimationCommandComponent
WaveSpawnSystem â”€â”€æ·»åŠ ç»„ä»¶â”€â”€> AnimationCommandComponent  â”€â”€ReanimSystemè¯»å–â”€â”€> æ‰§è¡ŒåŠ¨ç”»
LevelSystem     â”€â”€æ·»åŠ ç»„ä»¶â”€â”€> AnimationCommandComponent
```

#### ç»éªŒæ€»ç»“

**æˆåŠŸè¦ç´ **:
1. âœ… æ ‡å‡†æ”¹é€ æ¨¡æ¿éå¸¸æœ‰æ•ˆï¼ˆ4æ­¥æµç¨‹ï¼‰
2. âœ… å·¥å‚å‡½æ•°è§£è€¦æ˜¯æ­£ç¡®å†³ç­–ï¼ˆèŒè´£æ›´æ¸…æ™°ï¼‰
3. âœ… é€ä¸ªç³»ç»Ÿæ”¹é€ +ç«‹å³æµ‹è¯•ï¼Œé¿å…äº†å¤§è§„æ¨¡è¿”å·¥
4. âœ… ç¼–è¯‘å™¨æä¾›äº†å³æ—¶åé¦ˆï¼Œå¿«é€Ÿå®šä½é—æ¼çš„è°ƒç”¨ç‚¹

**æ„å¤–å‘ç°**:
- WaveSpawnSystem çš„è¿è§„ä¸æ­¢ 2 å¤„ï¼Œè¿˜éœ€è¦æ”¹é€  3 ä¸ªå·¥å‚å‡½æ•°ï¼ˆæ–‡æ¡£æœªé¢„ä¼°ï¼‰
- LevelSystem ä¸æ­¢ 1 å¤„è¿è§„ï¼Œè¿˜æœ‰ 1 ä¸ª CreateFinalWaveEntity å·¥å‚å‡½æ•°ï¼ˆæ–‡æ¡£æœªé¢„ä¼°ï¼‰
- æµ‹è¯•æ–‡ä»¶æ›´æ–°å·¥ä½œé‡æ¯”é¢„æœŸå¤§ï¼ˆ4 ä¸ªæ–‡ä»¶éœ€è¦æ›´æ–°ï¼‰
- éªŒè¯å·¥å…·ï¼ˆcmd ç›®å½•ï¼‰ä¹Ÿéœ€è¦åŒæ­¥æ›´æ–°ï¼Œç¡®ä¿ç¼–è¯‘é€šè¿‡

**æœ€ç»ˆæˆæœ**:
- âœ… Phase 1-5 å…¨éƒ¨å®Œæˆï¼ˆ100%ï¼‰
- âœ… 9 ä¸ªç³»ç»Ÿå…¨éƒ¨è§£è€¦ï¼ˆ15 å¤„è¿è§„ â†’ 0 å¤„ï¼‰
- âœ… æ–‡æ¡£å®Œå–„ï¼ˆCLAUDE.md + architecture.mdï¼‰
- âœ… æ¶æ„åˆè§„æ€§å·¥å…·å°±ç»ªï¼ˆcheck_ecs_compliance.shï¼‰
- âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼Œé›¶å›å½’é—®é¢˜

---

**æ–‡æ¡£ç»´æŠ¤è€…**: Architecture Team
**æœ€åæ›´æ–°**: 2025-11-12
**çŠ¶æ€**: âœ… å·²å®Œæˆï¼ˆEpic 14 - 100%ï¼‰
