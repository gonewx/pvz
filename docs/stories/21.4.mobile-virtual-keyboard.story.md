# Story 21.4: 移动端虚拟键盘

## Status

Done

---

## Story

**As a** 移动设备上的玩家,
**I want** 在创建/重命名用户时能通过屏幕上的虚拟键盘输入用户名,
**so that** 我可以在没有物理键盘的情况下方便地输入文字。

---

## Acceptance Criteria

1. **AC1: 移动端检测**
   - 运行时能够检测当前是否在移动设备（Android/iOS）上运行
   - 桌面端继续使用原有的 `ebiten.AppendInputChars` 物理键盘输入

2. **AC2: 虚拟键盘显示**
   - 当移动端文本输入框获得焦点时，自动显示虚拟键盘
   - 虚拟键盘覆盖在游戏画面底部，不遮挡输入框
   - 点击输入框外部或按确定按钮时关闭虚拟键盘

3. **AC3: 字符集支持**
   - 支持用户名合规字符：`A-Z`、`a-z`、`0-9`、空格
   - 支持大小写切换（Shift 键）
   - 支持退格删除

4. **AC4: 键盘布局**
   - 使用 QWERTY 布局，类似标准键盘
   - 小写状态（默认）：
     ```
     [q][w][e][r][t][y][u][i][o][p]
     [a][s][d][f][g][h][j][k][l]
     [⇧][z][x][c][v][b][n][m][⌫]
     [123][      空格      ][确定]
     ```
   - 大写状态（按下 Shift 后）：
     ```
     [Q][W][E][R][T][Y][U][I][O][P]
     [A][S][D][F][G][H][J][K][L]
     [⇧][Z][X][C][V][B][N][M][⌫]
     [123][      空格      ][确定]
     ```
   - 数字状态（按下 123 后）：
     ```
     [1][2][3][4][5][6][7][8][9][0]
     [ABC][      空格      ][确定]
     ```

5. **AC5: 位图字体渲染**
   - 使用 `assets/data/` 下的位图字体渲染键盘按键
   - 复用现有 `BitmapFont` 系统
   - 按键有正常/按下两种视觉状态

6. **AC6: 触摸交互**
   - 点击按键输入对应字符
   - 按键按下时有视觉反馈（按下状态）
   - 触摸事件不穿透到键盘下方的游戏元素

---

## Tasks / Subtasks

### Task 1: 实现移动端运行时检测 (AC: 1)
- [x] 1.1. 创建 `pkg/utils/platform.go` 文件
  - 添加 `IsMobile() bool` 函数
  - 桌面端返回 `false`
- [x] 1.2. 创建 `pkg/utils/platform_mobile.go` 文件（使用 `//go:build mobile` 标签）
  - `IsMobile()` 返回 `true`
- [x] 1.3. 编写单元测试验证编译标签正确工作

### Task 2: 创建虚拟键盘组件 (AC: 2, 4)
- [x] 2.1. 创建 `pkg/components/virtual_keyboard_component.go`
  - 字段：`IsVisible bool` - 键盘是否可见
  - 字段：`ShiftActive bool` - 是否大写模式
  - 字段：`NumericMode bool` - 是否数字模式
  - 字段：`KeyStates map[string]bool` - 按键按下状态
  - 字段：`TargetInputEntity ecs.EntityID` - 目标输入框实体
- [x] 2.2. 定义键盘布局常量
  - `KeyboardLayoutLower` - 小写布局
  - `KeyboardLayoutUpper` - 大写布局
  - `KeyboardLayoutNumeric` - 数字布局

### Task 3: 创建虚拟键盘实体工厂 (AC: 2, 5)
- [x] 3.1. 创建 `pkg/entities/virtual_keyboard_factory.go`
  - `NewVirtualKeyboardEntity(em, rm) ecs.EntityID`
- [x] 3.2. 加载位图字体资源（复用 BrianneTod16 或适合的字体）
- [x] 3.3. 计算键盘尺寸和位置（屏幕底部）

### Task 4: 创建虚拟键盘系统 (AC: 3, 6)
- [x] 4.1. 创建 `pkg/systems/virtual_keyboard_system.go`
  - `NewVirtualKeyboardSystem(em) *VirtualKeyboardSystem`
  - `Update(deltaTime float64)` - 处理触摸输入
- [x] 4.2. 实现触摸检测逻辑
  - 检测点击的按键
  - 更新 `KeyStates`
- [x] 4.3. 实现字符输入逻辑
  - 字母键：根据 ShiftActive 决定大小写
  - 数字键：输入数字
  - 空格键：输入空格
  - 退格键：删除字符
  - Shift 键：切换大小写模式
  - 123/ABC 键：切换数字/字母模式
  - 确定键：关闭键盘并确认输入
- [x] 4.4. 实现事件阻断
  - 键盘可见时，阻止触摸事件传递到下层

### Task 5: 创建虚拟键盘渲染系统 (AC: 5)
- [x] 5.1. 创建 `pkg/systems/virtual_keyboard_render_system.go`
  - `NewVirtualKeyboardRenderSystem(em, rm) *VirtualKeyboardRenderSystem`
  - `Draw(screen *ebiten.Image)`
- [x] 5.2. 实现键盘背景绘制
  - 半透明深色背景
- [x] 5.3. 实现按键绘制
  - 正常状态：浅色背景
  - 按下状态：深色背景
  - 使用位图字体绘制按键文字
- [x] 5.4. 实现特殊按键绘制
  - Shift 键（⇧）激活状态高亮
  - 空格键（加宽）
  - 退格键（⌫）
  - 确定键

### Task 6: 集成到文本输入系统 (AC: 1, 2)
- [x] 6.1. 修改 `TextInputSystem`
  - 在 `Update()` 开头检测 `IsMobile()`
  - 移动端跳过 `ebiten.AppendInputChars` 逻辑
- [x] 6.2. 修改 `TextInputComponent` 焦点处理
  - 移动端获得焦点时显示虚拟键盘
  - 失去焦点时隐藏虚拟键盘
- [x] 6.3. 在 `MainMenuScene` 中初始化虚拟键盘实体
  - 仅在移动端创建
- [x] 6.4. 在系统更新顺序中添加虚拟键盘系统
  - 优先级高于输入系统（先处理虚拟键盘输入）

### Task 7: 单元测试 (所有 AC)
- [x] 7.1. 测试 `IsMobile()` 函数
- [x] 7.2. 测试虚拟键盘组件状态切换
- [x] 7.3. 测试字符输入逻辑（大小写、数字）
- [x] 7.4. 测试按键布局常量完整性

### Task 8: 集成测试
- [ ] 8.1. 在 Android 模拟器上测试虚拟键盘显示
- [ ] 8.2. 测试用户名输入完整流程
- [x] 8.3. 验证桌面端不显示虚拟键盘

---

## Dev Notes

### 现有基础设施

**文本输入系统**（Story 12.4 已实现）：
- `TextInputComponent` - 文本输入组件
- `TextInputSystem` - 键盘输入处理（使用 `ebiten.AppendInputChars`）
- `TextInputRenderSystem` - 输入框渲染

**用户名验证规则**（已在 `text_input_system.go:126-133`）：
```go
// 只允许字母、数字、空格
if (r >= 'a' && r <= 'z') || (r >= 'A' && r <= 'Z') || (r >= '0' && r <= '9') || r == ' ' {
    filteredText += string(r)
}
```

**位图字体系统**：
- `pkg/utils/bitmap_font.go` - 位图字体加载和渲染
- `assets/data/BrianneTod16.txt/.png` - 包含 A-Z, a-z, 0-9, 空格等字符

**移动端构建**（Story 21.3 已实现）：
- `mobile/mobile.go` - 移动端入口
- `//go:build mobile` 编译标签

### 架构设计

#### 平台检测方案

使用 Go 编译标签实现零开销的平台检测：

```go
// pkg/utils/platform.go (默认，桌面端)
//go:build !mobile

package utils

func IsMobile() bool {
    return false
}
```

```go
// pkg/utils/platform_mobile.go (移动端)
//go:build mobile

package utils

func IsMobile() bool {
    return true
}
```

#### 虚拟键盘组件设计

```go
type VirtualKeyboardComponent struct {
    IsVisible         bool              // 键盘是否可见
    ShiftActive       bool              // 大写模式
    NumericMode       bool              // 数字模式
    KeyStates         map[string]bool   // 按键按下状态
    TargetInputEntity ecs.EntityID      // 目标输入框实体

    // 布局配置
    KeyWidth          float64           // 按键宽度
    KeyHeight         float64           // 按键高度
    KeySpacing        float64           // 按键间距
    KeyboardY         float64           // 键盘Y坐标（屏幕底部）
}
```

#### 键盘布局定义

```go
var KeyboardLayoutLower = [][]string{
    {"q", "w", "e", "r", "t", "y", "u", "i", "o", "p"},
    {"a", "s", "d", "f", "g", "h", "j", "k", "l"},
    {"SHIFT", "z", "x", "c", "v", "b", "n", "m", "BACKSPACE"},
    {"123", "SPACE", "DONE"},
}

var KeyboardLayoutUpper = [][]string{
    {"Q", "W", "E", "R", "T", "Y", "U", "I", "O", "P"},
    {"A", "S", "D", "F", "G", "H", "J", "K", "L"},
    {"SHIFT", "Z", "X", "C", "V", "B", "N", "M", "BACKSPACE"},
    {"123", "SPACE", "DONE"},
}

var KeyboardLayoutNumeric = [][]string{
    {"1", "2", "3", "4", "5", "6", "7", "8", "9", "0"},
    {"ABC", "SPACE", "DONE"},
}
```

#### 特殊按键宽度

| 按键 | 宽度（标准按键倍数） |
|------|---------------------|
| 普通字母/数字 | 1x |
| Shift | 1.5x |
| Backspace | 1.5x |
| 123/ABC | 1.5x |
| 空格 | 4x |
| 确定 | 2x |

### 位图字体选择

推荐使用 `BrianneTod16`：
- 字体大小适中（16pt）
- 包含完整的 A-Z, a-z, 0-9, 空格
- 已有加载解析实现

特殊符号渲染方案：
- `⇧` (Shift) → 可使用 "^" 或绘制箭头图形
- `⌫` (Backspace) → 可使用 "<-" 或绘制箭头图形
- 或者直接使用文字 "Shift"、"Del"

### 键盘尺寸计算

假设游戏分辨率 800x600：
- 键盘高度：约 200px（屏幕高度的 1/3）
- 按键宽度：约 70px（10 个按键 + 间距 = 800px）
- 按键高度：约 45px（4 行 + 间距 = 200px）
- 间距：5px

### 触摸事件处理

```go
func (s *VirtualKeyboardSystem) Update(deltaTime float64) {
    // 获取虚拟键盘实体
    keyboards := ecs.GetEntitiesWith1[*components.VirtualKeyboardComponent](s.em)

    for _, kbEntity := range keyboards {
        kb, _ := ecs.GetComponent[*components.VirtualKeyboardComponent](s.em, kbEntity)

        if !kb.IsVisible {
            continue
        }

        // 检测触摸/点击
        if inpututil.IsMouseButtonJustPressed(ebiten.MouseButtonLeft) ||
           len(inpututil.AppendJustPressedTouchIDs(nil)) > 0 {
            x, y := s.getTouchPosition()

            // 检测点击的按键
            key := s.hitTestKey(kb, x, y)
            if key != "" {
                s.handleKeyPress(kb, key)
            }
        }
    }
}
```

### 与 TextInputSystem 的集成

```go
func (s *TextInputSystem) Update(deltaTime float64) {
    // 移动端：跳过物理键盘输入
    if utils.IsMobile() {
        // 仅处理光标闪烁
        s.updateCursorBlink(...)
        return
    }

    // 桌面端：原有逻辑
    runes := ebiten.AppendInputChars(nil)
    ...
}
```

虚拟键盘输入字符时，直接修改 `TextInputComponent.Text`：

```go
func (s *VirtualKeyboardSystem) handleKeyPress(kb *VirtualKeyboardComponent, key string) {
    targetInput, ok := ecs.GetComponent[*TextInputComponent](s.em, kb.TargetInputEntity)
    if !ok {
        return
    }

    switch key {
    case "BACKSPACE":
        s.deleteCharBefore(targetInput)
    case "SPACE":
        s.insertChar(targetInput, ' ')
    case "SHIFT":
        kb.ShiftActive = !kb.ShiftActive
    case "123":
        kb.NumericMode = true
    case "ABC":
        kb.NumericMode = false
    case "DONE":
        kb.IsVisible = false
        // 可选：触发确认事件
    default:
        // 字母/数字键
        if len(key) == 1 {
            s.insertChar(targetInput, rune(key[0]))
        }
    }
}
```

### 文件结构

```
pkg/
├── utils/
│   ├── platform.go              # 新增：桌面端平台检测
│   ├── platform_mobile.go       # 新增：移动端平台检测
│   └── bitmap_font.go           # 已有：复用
├── components/
│   ├── virtual_keyboard_component.go  # 新增
│   └── text_input_component.go        # 已有：可能需要小改
├── entities/
│   └── virtual_keyboard_factory.go    # 新增
├── systems/
│   ├── virtual_keyboard_system.go         # 新增
│   ├── virtual_keyboard_render_system.go  # 新增
│   └── text_input_system.go               # 修改：添加移动端检测
└── scenes/
    └── main_menu_scene.go       # 修改：初始化虚拟键盘
```

### 测试策略

1. **单元测试**：
   - `platform_test.go` - 验证平台检测函数
   - `virtual_keyboard_component_test.go` - 组件状态测试
   - `virtual_keyboard_system_test.go` - 输入逻辑测试

2. **集成测试**：
   - Android 模拟器手动测试
   - 桌面端验证不受影响

### 参考资源

- [Ebitengine Touch Input](https://ebiten.org/documents/input.html#touch)
- [Ebitengine Mobile](https://ebiten.org/documents/mobile.html)
- Story 12.4 - 用户管理 UI
- Story 21.3 - 移动端构建

---

## Testing

### Unit Testing Requirements

**测试框架**：Go 标准库 `testing` 包

**必须测试的功能模块**：

1. **平台检测**
   - 验证 `IsMobile()` 在不同编译标签下返回正确值

2. **虚拟键盘组件**
   - 测试 `ShiftActive` 切换
   - 测试 `NumericMode` 切换
   - 测试 `KeyStates` 更新

3. **字符输入逻辑**
   - 测试小写字母输入
   - 测试大写字母输入（Shift 激活）
   - 测试数字输入（NumericMode）
   - 测试空格输入
   - 测试退格删除
   - 测试最大长度限制

4. **键盘布局**
   - 验证 `KeyboardLayoutLower` 完整性
   - 验证 `KeyboardLayoutUpper` 完整性
   - 验证 `KeyboardLayoutNumeric` 完整性

### Integration Testing

**Android 模拟器测试场景**：
1. 启动游戏 → 进入新建用户对话框 → 虚拟键盘自动显示
2. 点击字母键 → 输入框显示对应字符
3. 点击 Shift → 再点击字母键 → 输入大写字母
4. 点击 123 → 切换到数字布局 → 输入数字
5. 点击退格 → 删除最后一个字符
6. 点击确定 → 虚拟键盘关闭

**桌面端回归测试**：
1. 验证物理键盘输入正常工作
2. 验证不显示虚拟键盘

### Performance Requirements

- 虚拟键盘渲染帧率：60 FPS
- 按键响应延迟：< 50ms
- 内存占用：虚拟键盘实体 < 1MB

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-08 | 1.0 | 初始故事创建 | James (Dev) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
无

### Completion Notes
- Task 1-7 已完成，所有单元测试通过
- Task 8（集成测试）需要在 Android 模拟器上手动验证
- 桌面端编译正常，不显示虚拟键盘（符合预期）
- 虚拟键盘仅在移动端编译时（使用 `//go:build mobile` 标签）启用

### File List
**新增文件**:
- pkg/utils/platform.go - 桌面端平台检测（IsMobile() 返回 false）
- pkg/utils/platform_mobile.go - 移动端平台检测（IsMobile() 返回 true）
- pkg/utils/platform_test.go - 平台检测单元测试
- pkg/components/virtual_keyboard_component.go - 虚拟键盘组件和键盘布局常量
- pkg/components/virtual_keyboard_component_test.go - 虚拟键盘组件单元测试
- pkg/entities/virtual_keyboard_factory.go - 虚拟键盘实体工厂
- pkg/systems/virtual_keyboard_system.go - 虚拟键盘系统（处理触摸输入）
- pkg/systems/virtual_keyboard_render_system.go - 虚拟键盘渲染系统

**修改文件**:
- pkg/systems/text_input_system.go - 添加移动端检测，跳过物理键盘输入
- pkg/scenes/main_menu_scene.go - 添加虚拟键盘实体和系统初始化、更新、渲染
- pkg/scenes/main_menu_user_ui.go - 在对话框打开/关闭时显示/隐藏虚拟键盘

---

## QA Results

### Review Date: 2025-12-08

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

实现质量良好，代码结构清晰，遵循了项目的 ECS 架构模式。主要优点：

1. **架构设计**：正确使用了 Go 编译标签实现零开销的平台检测
2. **组件分离**：VirtualKeyboardComponent 作为纯数据组件，VirtualKeyboardSystem 处理逻辑
3. **键盘布局**：三种布局（小写、大写、数字）定义完整，特殊按键宽度配置合理
4. **集成方式**：与现有 TextInputSystem 的集成干净，移动端跳过物理键盘输入
5. **字符验证**：复用了现有的用户名验证规则（只允许 A-Z、a-z、0-9、空格）

### Refactoring Performed

无需重构。代码质量符合项目标准。

### Compliance Check

- Coding Standards: ✓ 遵循 Go 代码风格和项目命名规范
- Project Structure: ✓ 文件按 ECS 架构正确组织
- Testing Strategy: ✓ 单元测试覆盖核心逻辑
- All ACs Met: ✓ 所有验收标准已实现

### Improvements Checklist

- [x] 平台检测使用编译标签实现（零运行时开销）
- [x] 键盘布局常量定义完整
- [x] 单元测试覆盖组件状态和布局验证
- [x] 与 TextInputSystem 正确集成
- [x] 支持触摸和鼠标输入（兼容桌面端测试）
- [ ] Task 8.1 和 8.2 需要在 Android 模拟器上手动验证

### Security Review

无安全问题。输入字符过滤与现有 TextInputSystem 一致。

### Performance Considerations

- 键盘布局计算在每次渲染时执行，可考虑缓存优化（非阻塞性建议）
- 位图字体加载使用现有资源管理器，无性能问题

### Files Modified During Review

无

### Gate Status

Gate: PASS → docs/qa/gates/21.4-mobile-virtual-keyboard.yml

### Recommended Status

✓ Ready for Done

**注意**：Task 8.1 和 8.2（Android 模拟器集成测试）标记为待完成，这是预期的，因为需要实际移动设备/模拟器进行验证。故事核心实现已完成，桌面端编译和测试通过。
