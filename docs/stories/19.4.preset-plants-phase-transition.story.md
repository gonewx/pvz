# Story 19.4: 预设植物与阶段转场

## Status

Done

## Story

**As a** 玩��,
**I want** 在关卡加载时看到预先放置的植物，并在铲除所有植物后平滑过渡到保龄球阶段,
**so that** 我能体验到完整的关卡叙事流程，理解铲子教学和保龄球玩法之间的剧情衔接。

## Acceptance Criteria

1. **关卡加载后正确生成预设植物**
   - 在草坪上自动生成 3 株豌豆射手
   - 植物位置与规范一致：(行2, 列6), (行3, 列8), (行4, 列7)
   - 预设植物具有完整的组件（PlantComponent, ReanimComponent 等）
   - 预设植物播放正常的 idle 动画

2. **关卡配置扩展支持预设植物**
   - `LevelConfig` 新增 `PresetPlants` 字段
   - 支持配置任意数量和类型的预设植物
   - 向后兼容：旧关卡配置无需修改

3. **移除所有预设植物后触发转场**
   - 系统监控预设植物数量
   - 当所有预设植物被移除时，触发转场序列
   - 转场前确保强引导模式正确关闭

4. **播放戴夫"惊喜"对话**
   - 转场时 Dave 重新出现
   - 播放对话: "CRAZY_DAVE_2407" (Ok goody, now for the surprise...)
   - 播放对话: "CRAZY_DAVE_2408" (We're going BOWLING!)
   - 对话结束后 Dave 消失

5. **传送带从上方滑入**
   - 传送带 UI 从屏幕上方滑入到目标位置
   - 滑入动画持续约 0.5 秒
   - 传送带到位后开始生成卡片
   - 铲子槽始终保持显示（保龄球阶段仍可使用铲子）

6. **红线正确绘制**
   - 在第 3 列和第 4 列之间绘制红线
   - 使用 `Wallnut_bowlingstripe.png` 资源
   - 红线作为视觉提示，不阻挡游戏逻辑
   - 红线在整个保龄球阶段持续显示

7. **单元测试**: 覆盖率 ≥ 80%

## Tasks / Subtasks

### Task 1: 扩展关卡配置结构 (AC: 2)

- [x] 修改 `pkg/config/level_config.go`
  - [x] 新增 `PresetPlant` 结构体定义
    - `Type string` - 植物类型 (如 "peashooter")
    - `Row int` - 行号 (1-5)
    - `Col int` - 列号 (1-9)
  - [x] 在 `LevelConfig` 中新增 `PresetPlants []PresetPlant` 字段
  - [x] 更新 `applyDefaults()` 和 `validateLevelConfig()` 函数
- [x] 创建 Level 1-5 配置文件 `data/levels/level-1-5.yaml`
  - [x] 配置 `presetPlants` 字段
  - [x] 配置 `phases` 字段（阶段 1: shovel_tutorial, 阶段 2: bowling）
  - [x] 配置 `specialRules: "bowling"` 标识

### Task 2: 实现预设植物生成逻辑 (AC: 1)

- [x] 修改 `pkg/scenes/game_scene_init.go`
  - [x] 新增 `spawnPresetPlants()` 方法
    - [x] 遍历 `LevelConfig.PresetPlants`
    - [x] 调用 `NewPlantEntity()` 创建植物实体
    - [x] 使用正确的行列坐标（注意：配置使用 1-based，代码使用 0-based）
  - [x] 在关卡初始化流程中调用 `spawnPresetPlants()`
  - [x] 添加日志记录预设植物生成情况
- [x] 编写单元测试验证预设植物生成

### Task 3: 创建阶段管理组件 (AC: 3, 4, 5, 6)

- [x] 创建 `pkg/components/level_phase_component.go`
  - [x] `CurrentPhase int` - 当前阶段编号（1 = 铲子教学，2 = 保龄球）
  - [x] `PhaseState string` - 阶段状态 ("active", "transitioning", "completed")
  - [x] `TransitionProgress float64` - 转场动画进度 (0.0-1.0)
  - [x] `ConveyorBeltY float64` - 传送带当前 Y 位置
  - [x] `ShowRedLine bool` - 是否显示红线

### Task 4: 创建阶段转场系统 (AC: 3, 4, 5, 6)

- [x] 创建 `pkg/systems/level_phase_system.go`
  - [x] `NewLevelPhaseSystem(em, gs, rm)` 构造函数
  - [x] `Update(dt float64)` 更新方法
    - [x] 监控阶段状态
    - [x] 处理转场动画进度
  - [x] `StartPhaseTransition(from, to int)` 启动转场
  - [x] `updateConveyorBeltSlideIn(dt)` 更新传送带滑入
  - [x] `IsInPhase(phase int) bool` 查询当前阶段

### Task 5: 实现转场序列 (AC: 3, 4, 5, 6)

- [x] 在 `LevelPhaseSystem` 中实现转场序列
  - [x] 步骤 1: 关闭强引导模式
  - [x] 步骤 2: 触发 Dave "惊喜"对话
    - [x] 创建 Dave 实体，配置对话 keys: ["CRAZY_DAVE_2407", "CRAZY_DAVE_2408"]
    - [x] 设置 `OnCompleteCallback` 继续转场
  - [x] 步骤 3: 传送带滑入动画 (0.5s)
  - [x] 步骤 4: 显示红线
  - [x] 步骤 5: 启动保龄球阶段（激活 WaveSpawnSystem）

### Task 6: 集成转场回调 (AC: 3)

- [x] 修改 `pkg/scenes/game_scene.go`
  - [x] 在初始化 `GuidedTutorialSystem` 后设置转场回调
    ```go
    guidedTutorialSystem.SetTransitionCallback(func() {
        levelPhaseSystem.StartPhaseTransition(1, 2)
    })
    ```
  - [x] 初始化 `LevelPhaseSystem`
  - [x] 在 `Update()` 中调用 `levelPhaseSystem.Update(dt)`

### Task 7: 实现红线绘制 (AC: 6)

- [x] 修改 `pkg/scenes/game_scene_effects.go` 创建专用渲染函数
  - [x] 加载 `Wallnut_bowlingstripe.png` 资源
  - [x] 在 `Draw()` 中绘制红线
    - [x] 计算红线 X 位置：第 3 列和第 4 列之间
    - [x] 仅在 `ShowRedLine == true` 时绘制
  - [x] 红线渲染层级：在草坪之上，植物之下
- [x] 在 `pkg/config/layout_config.go` 中添加红线位置常量

### Task 8: 添加配置常量 (AC: 5, 6)

- [x] 在 `pkg/config/layout_config.go` 中添加常量
  ```go
  // 阶段转场配置
  const (
      // PhaseTransitionConveyorSlideDuration 传送带滑入时长（秒）
      PhaseTransitionConveyorSlideDuration = 0.5

      // ConveyorBeltStartY 传送带起始 Y 位置（屏幕外）
      ConveyorBeltStartY = -100.0

      // ConveyorBeltTargetY 传送带目标 Y 位置
      ConveyorBeltTargetY = 10.0

      // BowlingRedLineColumn 红线位置（第 3 列和第 4 列之间）
      BowlingRedLineColumn = 3
  )
  ```

### Task 9: 单元测试 (AC: 7)

- [x] 创建 `pkg/config/level_config_test.go` 补充测试
  - [x] 测试 PresetPlants 字段解析
  - [x] 测试验证逻辑（无效行列、无效植物类型）
- [x] 创建 `pkg/components/level_phase_component_test.go`
- [x] 创建 `pkg/systems/level_phase_system_test.go`
  - [x] 测试阶段转场触发
  - [x] 测试淡出/滑入动画进度
  - [x] 测试转场序列顺序

## Dev Notes

### 架构上下文

本 Story 是 Epic 19 的第四个 Story，实现预设植物机制和阶段转场逻辑。依赖于：
- **Story 19.1**: 疯狂戴夫对话系统（转场时需要播放 Dave 对话）
- **Story 19.2**: 铲子交互系统（预设植物需要能被铲除）
- **Story 19.3**: 强引导教学系统（转场时需要关闭强引导模式）

该系统将在 Level 1-5 中协调铲子教学阶段和保龄球阶段之间的平滑过渡。

[Source: docs/prd/epic-19-level-1-5-bowling.md#Story 19.4]

### 前置故事依赖

**Story 19.1: 疯狂戴夫对话系统** (已完成)
- `DaveDialogueComponent` 和 `DaveDialogueSystem` 已实现
- `OnCompleteCallback` 回调机制可用于转场序列控制
- Dave 实体可通过 `entities.NewCrazyDaveEntity()` 创建

**Story 19.2: 铲子交互系统** (已完成)
- 铲子功能完整，可移除植物
- `ShovelStateProvider` 接口可获取铲子状态

**Story 19.3: 强引导教学系统** (已完成)
- `GuidedTutorialSystem.SetTransitionCallback()` 可设置转场回调
- `GuidedTutorialSystem.SetActive(false)` 可关闭强引导模式
- 当 Plant_Count == 0 时自动触发转场回调

[Source: docs/stories/19.1-19.3]

### 预设植物配置格式

**level-1-5.yaml 示例**:
```yaml
id: "1-5"
name: "坚果保龄球"
description: "铲子教学 + 保龄球迷你游戏"

sceneType: "day"
rowMax: 5
flags: 0

# 预设植物（铲子教学阶段）
presetPlants:
  - type: "peashooter"
    row: 2  # 1-based 行号
    col: 6  # 1-based 列号
  - type: "peashooter"
    row: 3
    col: 8
  - type: "peashooter"
    row: 4
    col: 7

# 特殊规则
specialRules: "bowling"

# 初始阳光设为 0（保龄球模式不使用阳光）
initialSun: 0
```

[Source: .meta/levels/level1-5.md#初始场景配置]

### 转场序列时序图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        阶段 1 → 阶段 2 转场序列                          │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  Plant_Count == 0                                                       │
│         │                                                               │
│         ▼                                                               │
│  ┌──────────────────┐                                                   │
│  │ 1. 关闭强引导模式 │ GuidedTutorialSystem.SetActive(false)            │
│  └────────┬─────────┘                                                   │
│           ▼                                                             │
│  ┌──────────────────┐                                                   │
│  │ 2. 创建 Dave 实体 │ 对话: CRAZY_DAVE_2407, CRAZY_DAVE_2408           │
│  └────────┬─────────┘                                                   │
│           │                                                             │
│           │  (等待对话完成回调)                                          │
│           ▼                                                             │
│  ┌──────────────────┐                                                   │
│  │ 3. 传送带滑入     │ 0.5 秒动画，从屏幕上方滑入                         │
│  └────────┬─────────┘                                                   │
│           ▼                                                             │
│  ┌──────────────────┐                                                   │
│  │ 4. 显示红线       │ Wallnut_bowlingstripe.png                        │
│  └────────┬─────────┘                                                   │
│           ▼                                                             │
│  ┌──────────────────┐                                                   │
│  │ 5. 激活保龄球阶段 │ 开始生成坚果卡片和僵尸                             │
│  └──────────────────┘                                                   │
│                                                                         │
│  注意: 铲子槽始终保持显示，保龄球阶段仍可使用铲子                          │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

[Source: .meta/levels/level1-5.md#转场]

### 红线位置计算

**红线 X 坐标**：位于第 3 列和第 4 列之间

```go
// 红线 X 位置（世界坐标）
redLineX := config.GridWorldStartX + float64(3) * config.CellWidth
// = 255 + 3 * 80 = 495.0

// 注意：GridWorldStartX = GridScreenStartX + GameCameraX = 35 + 220 = 255
```

红线应该覆盖整个草坪高度（5 行），从第 1 行顶部到第 5 行底部。

[Source: .meta/levels/level1-5.md#红线]

### 传送带位置参考

**传送带目标位置**：屏幕左上方，紧挨铲子槽位左边

```go
// 传送带滑入动画
// 起始 Y: 屏幕外（-100）
// 目标 Y: 与 SeedBank 对齐（约 10）

// 铲子槽位置（参考 game_scene_ui.go）
shovelX := seedBankEndX + spacing
conveyorEndX := shovelX - spacing // 传送带右边缘在铲子左边
```

具体位置常量将在 Task 9 中定义，便于后续调整。

[Source: .meta/levels/level1-5.md#传送带系统]

### 文件位置规范

| 文件 | 位置 |
|------|------|
| LevelPhaseComponent | `pkg/components/level_phase_component.go` |
| LevelPhaseSystem | `pkg/systems/level_phase_system.go` |
| 关卡配置 | `data/levels/level-1-5.yaml` |
| 配置常量 | `pkg/config/layout_config.go` |
| GameScene 修改 | `pkg/scenes/game_scene.go` |
| 测试文件 | 与源文件同目录，`_test.go` 后缀 |

[Source: docs/architecture/source-tree.md]

### 零耦合原则遵循

**系统间通信方式**：

1. **回调函数**：
   - `GuidedTutorialSystem` 通过 `SetTransitionCallback` 通知转场
   - `DaveDialogueComponent.OnCompleteCallback` 通知对话完成

2. **组件查询**：
   - `LevelPhaseSystem` 通过查询 `LevelPhaseComponent` 管理状态
   - 通过查询 `PlantComponent` 监控植物数量

3. **状态读取**：
   - UI 渲染通过读取 `LevelPhaseComponent.ShovelSlotFadeAlpha` 控制透明度

**禁止**：
- `LevelPhaseSystem` 直接调用 `GameScene` 方法
- `LevelPhaseSystem` 直接调用 `ConveyorBeltSystem` 方法
- 使用全局变量共享状态

[Source: docs/architecture/coding-standards.md#零耦合原则]

### Dave 对话 Keys

转场时需要播放的对话（需确认 LawnStrings.txt 中存在）：

| Key | 预期文本 |
|-----|---------|
| CRAZY_DAVE_2407 | "Ok goody, now for the surprise..." |
| CRAZY_DAVE_2408 | "We're going BOWLING!" |

[Source: .meta/levels/level1-5.md#转场]

### 与 Story 19.5 的边界

**本 Story 范围**：
- 预设植物生成
- 阶段转场动画（铲子槽淡出、传送带滑入占位）
- 红线绘制
- 转场序列控制

**Story 19.5 范围**：
- 传送带完整实现（卡片队列、生成算法、拖拽交互）
- 传送带渲染细节（背景、传动动画）

本 Story 中传送带滑入动画仅实现位置变化，传送带的完整功能将在 Story 19.5 中实现。

[Source: docs/prd/epic-19-level-1-5-bowling.md#Story 19.5]

## Testing

### 测试文件位置

- `pkg/config/level_config_test.go` (补充)
- `pkg/components/level_phase_component_test.go`
- `pkg/systems/level_phase_system_test.go`

### 关键测试场景

**1. 预设植物配置解析测试**:
```go
func TestLevelConfig_PresetPlants(t *testing.T) {
    yaml := `
id: "1-5"
name: "Test Level"
presetPlants:
  - type: "peashooter"
    row: 2
    col: 6
waves:
  - waveNum: 1
    type: "Fixed"
    zombies:
      - type: "basic"
        lanes: [1]
        count: 1
`
    config, err := parseYAML(yaml)
    assert.NoError(t, err)
    assert.Len(t, config.PresetPlants, 1)
    assert.Equal(t, "peashooter", config.PresetPlants[0].Type)
    assert.Equal(t, 2, config.PresetPlants[0].Row)
    assert.Equal(t, 6, config.PresetPlants[0].Col)
}
```

**2. 阶段转场触发测试**:
```go
func TestLevelPhaseSystem_PhaseTransition(t *testing.T) {
    em := ecs.NewEntityManager()
    system := createTestLevelPhaseSystem(em)

    // 初始状态：阶段 1
    assert.True(t, system.IsInPhase(1))

    // 触发转场
    system.StartPhaseTransition(1, 2)

    // 验证进入转场状态
    phaseComp := getPhaseComponent(em)
    assert.Equal(t, "transitioning", phaseComp.PhaseState)
}
```

**3. 传送带滑入动画测试**:
```go
func TestLevelPhaseSystem_ConveyorSlideIn(t *testing.T) {
    em := ecs.NewEntityManager()
    system := createTestLevelPhaseSystem(em)

    phaseComp := getPhaseComponent(em)
    initialY := phaseComp.ConveyorBeltY
    assert.Equal(t, config.ConveyorBeltStartY, initialY)

    // 触发滑入
    system.startConveyorSlideIn()
    system.Update(0.25) // 50% 进度

    // 验证 Y 位置变化
    expectedY := config.ConveyorBeltStartY +
        (config.ConveyorBeltTargetY - config.ConveyorBeltStartY) * 0.5
    assert.InDelta(t, expectedY, phaseComp.ConveyorBeltY, 5.0)
}
```

**4. 转场序列完整性测试**:
```go
func TestLevelPhaseSystem_TransitionSequence(t *testing.T) {
    em := ecs.NewEntityManager()
    system := createTestLevelPhaseSystemWithMockDave(em)

    transitionComplete := false
    system.SetOnTransitionComplete(func() {
        transitionComplete = true
    })

    // 触发转场
    system.StartPhaseTransition(1, 2)

    // 模拟完整转场序列
    system.mockDaveDialogueComplete()

    // 更新足够时间完成所有动画
    for i := 0; i < 100; i++ {
        system.Update(0.016)
    }

    // 验证转场完成
    assert.True(t, transitionComplete)
    assert.True(t, system.IsInPhase(2))

    phaseComp := getPhaseComponent(em)
    assert.True(t, phaseComp.ShowRedLine)
}
```

### 测试命令

```bash
# 运行配置测试
go test ./pkg/config -v -run TestLevelConfig_PresetPlants

# 运行组件测试
go test ./pkg/components -v -run TestLevelPhase

# 运行系统测试
go test ./pkg/systems -v -run TestLevelPhaseSystem

# 查看覆盖率
go test ./pkg/config ./pkg/components ./pkg/systems -cover -run "LevelPhase|PresetPlants"
```

[Source: docs/architecture/testing-strategy.md]

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-02 | 0.1 | Initial story creation | Bob (Scrum Master Agent) |
| 2025-12-02 | 0.2 | 移除铲子槽隐藏需求：铲子槽在保龄球阶段始终保持显示 | Sarah (PO Agent) |
| 2025-12-02 | 1.0 | Story 实现完成，所有任务通过测试 | James (Dev Agent) |
| 2025-12-03 | 1.1 | QA修复：Dave 对话 keys 从不存在的 CRAZY_DAVE_2407/2408 修正为 CRAZY_DAVE_2410/2411；红线在 Dave 说第二句对话时同步显示而非对话结束后 | James (Dev Agent) |

---

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### File List

**新建文件:**
| 文件 | 描述 |
|------|------|
| `pkg/components/level_phase_component.go` | 阶段管理组件，存储阶段状态、转场进度等 |
| `pkg/systems/level_phase_system.go` | 阶段转场系统，实现 5 步转场序列 |
| `data/levels/level-1-5.yaml` | Level 1-5 关卡配置文件 |
| `pkg/components/level_phase_component_test.go` | 组件单元测试 (8 个测试用例) |
| `pkg/systems/level_phase_system_test.go` | 系统单元测试 (10 个测试用例) |

**修改文件:**
| 文件 | 变更描述 |
|------|----------|
| `pkg/config/level_config.go` | 添加 `PresetPlant` 结构体和验证逻辑 |
| `pkg/config/layout_config.go` | 添加转场配置常量 (传送带滑入时长、红线位置等) |
| `pkg/scenes/game_scene.go` | 添加 `levelPhaseSystem` 字段、`bowlingRedLine` 图像字段、初始化和集成逻辑 |
| `pkg/scenes/game_scene_init.go` | 添加 `spawnPresetPlants()` 方法 |
| `pkg/scenes/game_scene_effects.go` | 添加 `drawBowlingRedLine()` 方法 |
| `pkg/scenes/game_scene_resources.go` | 添加红线资源加载 |
| `pkg/config/level_config_test.go` | 添加 PresetPlant 验证测试 (3 个测试用例) |

### Debug Log References

- `[LevelPhaseSystem] Initialized (Entity ID: X), starting at Phase 1`
- `[LevelPhaseSystem] Starting phase transition: 1 -> 2`
- `[LevelPhaseSystem] Step 1: Disabling guided tutorial mode`
- `[LevelPhaseSystem] Step 2: Creating Dave dialogue for transition`
- `[LevelPhaseSystem] Step 3: Starting conveyor belt slide-in animation`
- `[LevelPhaseSystem] Step 4: Showing red line`
- `[LevelPhaseSystem] Step 5: Activating bowling phase`
- `[LevelPhaseSystem] Phase transition completed! Now in Phase 2`
- `[GameScene] spawnPresetPlants: spawned X preset plants`

### Completion Notes

1. **架构设计**: 遵循零耦合原则，`LevelPhaseSystem` 通过回调函数与外部系统通信
   - `onDisableGuidedTutorial` - 关闭强引导模式
   - `onActivateBowling` - 激活保龄球阶段
   - `onTransitionComplete` - 转场完成通知

2. **nil 安全处理**: 在 `createTransitionDaveDialogue` 中添加了 `resourceLoader == nil` 检查，确保测试环境下不会 panic

3. **坐标转换**: 配置文件使用 1-based 坐标，代码内部使用 0-based 坐标，在 `spawnPresetPlants()` 中进行转换

4. **测试覆盖**: 所有 21 个测试用例通过
   - 组件测试: 8 个用例 (常量、初始化、状态转换、传送带、红线、回调等)
   - 系统测试: 10 个用例 (创建、阶段检查、转场、回调、动画、完成等)
   - 配置测试: 3 个用例 (验证、解析、结构体)

---

## QA Results

### Review Date: 2025-12-02

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**整体评估：优秀**

Story 19.4 的实现质量很高，严格遵循了项目的 ECS 架构规范和零耦合原则。代码结构清晰，测试覆盖完整，所有 21 个测试用例通过。

**架构亮点：**
1. **LevelPhaseComponent** - 纯数据组件，无方法，符合 ECS 规范
2. **LevelPhaseSystem** - 通过回调函数（`onDisableGuidedTutorial`, `onActivateBowling`, `onTransitionComplete`）与外部系统通信，完美遵循零耦合原则
3. **状态机设计** - 5 步转场序列清晰，每步有明确的职责
4. **nil 安全** - `resourceLoader == nil` 检查确保测试环境下不会 panic

**代码质量：**
- 所有常量集中在 `layout_config.go`，便于调整
- 1-based 到 0-based 坐标转换正确处理
- 错误处理和日志记录完善
- 注释解释了"为什么"而非"什么时候"

### Refactoring Performed

无需重构。代码质量已符合项目标准。

### Compliance Check

- Coding Standards: ✓ 遵循 Go 命名约定和 ECS 规范
- Project Structure: ✓ 文件位置正确（组件/系统/配置分离）
- Testing Strategy: ✓ 组件测试 8 个、系统测试 10 个、配置测试 3 个
- All ACs Met: ✓ 所有 7 个验收标准已实现

### Improvements Checklist

- [x] PresetPlant 结构体和验证逻辑 (AC 2)
- [x] spawnPresetPlants() 实现 (AC 1)
- [x] LevelPhaseComponent 阶段状态管理 (AC 3)
- [x] LevelPhaseSystem 转场序列 (AC 3, 4, 5, 6)
- [x] Dave 对话集成 (AC 4)
- [x] 传送带滑入动画 (AC 5)
- [x] 红线绘制 (AC 6)
- [x] 单元测试覆盖 (AC 7)

### Security Review

无安全风险。此功能不涉及用户输入、网络通信或敏感数据处理。

### Performance Considerations

- **传送带动画**：使用 easeOutQuad 缓动函数，每帧仅做简单数学运算，性能开销可忽略
- **红线绘制**：仅在 `ShouldShowRedLine() == true` 时绘制，避免不必要的渲染
- **预设植物生成**：一次性初始化，不影响游戏运行时性能

### Files Modified During Review

无文件修改。

### Gate Status

Gate: **PASS** → docs/qa/gates/19.4-preset-plants-phase-transition.yml

### Recommended Status

✓ **Ready for Done**

所有验收标准已满足，测试通过，代码质量优秀。Story 可标记为 Done。
