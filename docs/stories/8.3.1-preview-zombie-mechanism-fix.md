# Story 8.3.1: 开场动画预览僵尸机制修正

## Status
Done

## Story
**As a** 玩家,
**I want** 在开场动画中看到的僵尸预告是独立的展示实体，而非实际关卡僵尸,
**so that** 游戏体验符合原版设计规范，预览僵尸仅作为"情报侦察"功能，不会与实际游戏逻辑产生混淆。

## Acceptance Criteria

1. **预览僵尸独立生成**
   - 开场动画镜头右移完成后，生成独立的预览僵尸实体
   - 预览僵尸类型从 `LevelConfig.Waves` 配置中推导（去重）
   - 预览僵尸数量基于关卡难度自动计算或使用配置值

2. **预览僵尸正确展示**
   - 预览僵尸随机分布在屏幕右侧区域（X: 1050-1250, Y: 按行分布）
   - 预览僵尸播放 idle 动画，不移动、不攻击
   - 预览僵尸使用 `BehaviorZombiePreview` 行为类型

3. **预览僵尸正确清理**
   - 镜头返回草坪后，所有预览僵尸实体被销毁
   - 跳过开场动画时（ESC/Space），预览僵尸也被正确清理
   - 清理后内存正确释放

4. **实际关卡僵尸延迟生成**
   - 实际关卡僵尸在开场动画完成后才预生成
   - 实际关卡僵尸与预览僵尸完全独立，无共享实体

5. **单元测试覆盖**
   - 更新 `opening_animation_system_test.go` 测试用例
   - 覆盖预览僵尸生成、清理、跳过场景
   - 测试覆盖率达到 85%+

## Tasks / Subtasks

### Task 1: 修改 OpeningAnimationSystem 恢复预览僵尸逻辑 (AC: 1, 2, 3)

- [x] 修改 `updateCameraMoveRightState()` 方法
  - [x] 恢复调用 `spawnPreviewZombies(openingComp)`
  - [x] 移除注释 "不再生成预览僵尸"
- [x] 修改 `updateGameStartState()` 方法
  - [x] 恢复调用 `clearPreviewZombies(openingComp)`
  - [x] 移除注释 "不再需要清理预览僵尸"
- [x] 修改 `Skip()` 方法
  - [x] 恢复调用 `clearPreviewZombies(openingComp)`
- [x] 验证 `spawnPreviewZombies()` 方法逻辑
  - [x] 确认从 Waves 配置推导僵尸类型
  - [x] 确认随机分布位置逻辑
  - [x] 确认使用 `BehaviorZombiePreview` 行为类型
- [x] 验证 `clearPreviewZombies()` 方法逻辑
  - [x] 确认正确销毁所有预览僵尸实体
  - [x] 确认清空 `ZombieEntities` 列表

### Task 2: 修改 GameScene 调整僵尸预生成时机 (AC: 4)

- [x] 在 `GameScene` 结构体中添加 `zombiesPreSpawned bool` 字段
- [x] 修改 `Update()` 方法
  - [x] 在开场动画完成后检查 `zombiesPreSpawned` 标志
  - [x] 首次检测到开场完成时调用 `PreSpawnAllWaves()`
  - [x] 设置 `zombiesPreSpawned = true`
  - [x] 添加日志输出
- [x] 确保无开场动画的关卡（如 1-1 教学关卡）仍能正确预生成僵尸

### Task 3: 可选增强 - 预览僵尸数量配置 (AC: 1)

- [x] 在 `LevelConfig` 中添加 `PreviewZombieCount int` 字段（可选）
- [x] 在 `applyDefaults()` 中设置默认值逻辑
- [x] 修改 `spawnPreviewZombies()` 使用配置或自动计算数量
  - [x] 简单关卡（≤2波）：3 只预览僵尸
  - [x] 中等关卡（3-5波）：5 只预览僵尸
  - [x] 困难关卡（>5波）：8 只预览僵尸

### Task 4: 更新单元测试 (AC: 5)

- [x] 更新 `opening_animation_system_test.go`
  - [x] 添加/更新 `TestOpeningAnimationSystem_SpawnPreviewZombies` 测试
  - [x] 添加/更新 `TestOpeningAnimationSystem_ClearPreviewZombies` 测试
  - [x] 添加/更新 `TestOpeningAnimationSystem_SkipClearsZombies` 测试
  - [x] 验证预览僵尸与实际僵尸独立
- [x] 运行测试确保覆盖率达到 85%+
  ```bash
  go test ./pkg/systems -run TestOpeningAnimationSystem -v -cover
  ```

### Task 5: 手动验证 (AC: 1, 2, 3, 4)

- [x] 使用 `cmd/verify_opening/` 验证开场动画
  ```bash
  go run cmd/verify_opening/main.go --level=1-2 --verbose
  ```
- [x] 验证预览僵尸正确生成和展示
- [x] 验证镜头返回后预览僵尸被清理
- [x] 验证跳过开场（ESC/Space）时预览僵尸被清理
- [x] 验证实际游戏开始后僵尸正常生成和激活
- [x] 运行完整游戏测试 1-2 关卡

## Dev Notes

### 规范参考

**文档**: `.meta/levels/Core_Mechanics_and_Level_Design_Spec.md`

**核心规则**:
1. **僵尸种类**: 从关卡配置的僵尸池中抽取（简化方案：从 Waves 推导）
2. **僵尸数量**: 基于难度可视化参数，不等于实际僵尸总数
3. **站位**: 随机分布在屏幕右侧，按 Y 轴排序渲染
4. **预览僵尸销毁**: 镜头返回后销毁，不会变成实际进攻僵尸
5. **实际僵尸**: 由波次管理器重新生成，与预览僵尸无关

### 现有代码位置

**主要修改文件**:
- `pkg/systems/opening_animation_system.go` - 预览僵尸生成/清理逻辑
- `pkg/scenes/game_scene.go` - 僵尸预生成时机控制
- `pkg/config/level_config.go` - 可选：预览数量配置

**相关方法**:
- `spawnPreviewZombies()` - 已存在，需要恢复调用
- `clearPreviewZombies()` - 已存在，需要恢复调用
- `getUniqueZombieTypes()` - 已存在，从 Waves 推导僵尸类型

### 关键常量

```go
// pkg/config/layout_config.go
ZombieSpawnMinX = 1050.0  // 僵尸生成最小X坐标
ZombieSpawnMaxX = 1250.0  // 僵尸生成最大X坐标
OpeningZombiePreviewX = 1200.0  // 开场预览位置（已废弃，使用范围）
```

### Story 8.3 遗留信息

**当前实现问题**:
- 代码注释明确表示 "不再生成预览僵尸"
- 直接复用 WaveSpawnSystem 预生成的关卡僵尸
- 这与 Story 8.3 文档描述不符

**需要恢复的逻辑**:
- `updateCameraMoveRightState()`: 调用 `spawnPreviewZombies()`
- `updateGameStartState()`: 调用 `clearPreviewZombies()`
- `Skip()`: 调用 `clearPreviewZombies()`

### ECS 架构约束

[Source: docs/architecture/coding-standards.md]

- **零耦合原则**: OpeningAnimationSystem 不直接调用 WaveSpawnSystem
- **组件驱动**: 预览僵尸使用独立的 BehaviorType
- **泛型 API**: 使用 `ecs.GetComponent[T]()` 和 `ecs.AddComponent()`

## Testing

### Testing Standards

[Source: docs/architecture/testing-strategy.md]

**测试框架**: Go 标准库 `testing` 包

**测试文件位置**: `pkg/systems/opening_animation_system_test.go`

**覆盖率目标**: 85%+

**测试命令**:
```bash
# 运行开场动画系统测试
go test ./pkg/systems -run TestOpeningAnimationSystem -v

# 查看覆盖率
go test ./pkg/systems -run TestOpeningAnimationSystem -cover

# 生成覆盖率报告
go test ./pkg/systems -coverprofile=coverage.out -run TestOpeningAnimationSystem
go tool cover -html=coverage.out
```

**验证程序**:
```bash
# 使用专用验证程序测试开场动画
go run cmd/verify_opening/main.go --level=1-2 --verbose
```

### 测试用例清单

| 测试名称 | 验证内容 |
|---------|---------|
| `TestSpawnPreviewZombies_GeneratesCorrectTypes` | 预览僵尸类型从 Waves 正确推导 |
| `TestSpawnPreviewZombies_RandomPosition` | 预览僵尸位置随机分布 |
| `TestSpawnPreviewZombies_IdleBehavior` | 预览僵尸使用 Preview 行为类型 |
| `TestClearPreviewZombies_DestroysAll` | 所有预览僵尸被正确销毁 |
| `TestClearPreviewZombies_ClearsList` | ZombieEntities 列表被清空 |
| `TestSkip_ClearsPreviewZombies` | 跳过时预览僵尸被清理 |
| `TestStateMachine_SpawnsOnShowZombies` | showZombies 状态生成预览僵尸 |
| `TestStateMachine_ClearsOnGameStart` | gameStart 状态清理预览僵尸 |

## Change Log

| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2025-11-25 | 1.0 | Story 8.3.1 初始创建，基于 Correct Course 变更提案 | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
- 测试运行日志: `go test ./pkg/systems -run TestOpeningAnimationSystem -v -cover`
- 构建验证: `go build .` - 成功

### Completion Notes List
1. 恢复了 `spawnPreviewZombies()` 和 `clearPreviewZombies()` 的调用
2. 修复了 `getUniqueZombieTypes()` 以支持新旧两种波次配置格式（ZombieGroup 和 ZombieSpawn）
3. 添加了 `calculatePreviewZombieCount()` 方法实现基于难度的自动计算
4. 在 `LevelConfig` 中添加了 `PreviewZombieCount` 配置字段
5. 修改了 `GameScene` 延迟僵尸预生成直到开场动画完成
6. 更新了测试用例，覆盖预览僵尸生成、清理、跳过等场景
7. 修复了测试中的问题：EntityManager 没有 HasEntity 方法，改用 GetComponent 检查

### File List
**修改的文件**:
- `pkg/systems/opening_animation_system.go` - 恢复预览僵尸生成/清理逻辑
- `pkg/scenes/game_scene.go` - 僵尸预生成时机控制
- `pkg/config/level_config.go` - 添加 PreviewZombieCount 字段
- `pkg/systems/opening_animation_system_test.go` - 更新单元测试

## QA Results

### Review Date: 2025-11-25

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

实现质量良好，代码结构清晰，符合 ECS 架构规范。主要评估：

1. **架构设计** ✓
   - 预览僵尸与实际关卡僵尸完全独立（AC4 满足）
   - 使用 `BehaviorZombiePreview` 行为类型正确隔离预览僵尸逻辑
   - `zombiesPreSpawned` 标志正确控制预生成时机

2. **代码质量** ✓
   - 函数职责单一（`spawnPreviewZombies`、`clearPreviewZombies`、`calculatePreviewZombieCount`）
   - 注释清晰，标注了 Story 8.3.1 修改点
   - 支持新旧两种波次配置格式（`ZombieGroup` 和 `ZombieSpawn`）

3. **潜在改进点**
   - `rand.Seed(time.Now().UnixNano())` 在 Go 1.20+ 中已废弃，但在 Go 1.25 中仍然有效
   - `zombieTypeToBehaviorType()` 方法未被使用（测试覆盖率 0%），建议清理

### Refactoring Performed

无重构。代码质量符合标准，无需修改。

### Compliance Check

- Coding Standards: ✓ 符合项目编码规范
- Project Structure: ✓ 文件位置正确
- Testing Strategy: ✓ 测试用例覆盖所有 AC
- All ACs Met: ✓ 所有验收标准已实现

### Improvements Checklist

- [x] 预览僵尸独立生成逻辑恢复 (opening_animation_system.go:139)
- [x] 预览僵尸清理逻辑恢复 (opening_animation_system.go:176, 360)
- [x] 基于难度的预览数量计算 (opening_animation_system.go:274-290)
- [x] 僵尸预生成延迟到开场动画完成 (game_scene.go:567-572)
- [x] 测试用例全面覆盖
- [ ] 考虑移除未使用的 `zombieTypeToBehaviorType()` 方法（低优先级）

### Security Review

无安全问题。预览僵尸仅用于展示，不参与游戏逻辑。

### Performance Considerations

无性能问题。预览僵尸数量有限（最多8只），生成和清理操作开销可忽略。

### Files Modified During Review

无修改。

### Gate Status

Gate: **PASS** → docs/qa/gates/8.3.1-preview-zombie-mechanism-fix.yml
Quality Score: 95

### Recommended Status

✓ Ready for Done

Story 实现完整，所有验收标准已满足，测试覆盖充分。建议将状态更新为 Done。
