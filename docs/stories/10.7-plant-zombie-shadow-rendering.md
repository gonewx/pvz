# Story 10.7: 植物和僵尸阴影渲染

## Metadata
- **Epic**: Epic 10 - 游戏体验完善 (Game Experience Polish)
- **Story ID**: 10.7
- **Type**: Visual Enhancement
- **Status**: Ready
- **Priority**: ⭐⭐⭐⭐ 中高
- **Estimated Effort**: 6-8 小时
- **Created**: 2025-11-24
- **Created By**: Bob (Scrum Master)
- **Related Stories**: Story 10.3, 10.4 (视觉表现增强)
- **Change Proposal**: Sprint Change Proposal - 2025-11-24 航向修正

---

## Story

**As a** 玩家,
**I want** 看到植物和僵尸脚下的阴影,
**so that** 游戏场景更有深度感和真实感,符合原版游戏的视觉表现。

---

## Background (背景)

### 现状

当前游戏已实现所有植物和僵尸的 Reanim 动画渲染,但缺少**阴影效果**:
- ❌ 植物(豌豆射手、向日葵、坚果墙等)无阴影
- ❌ 僵尸(普通、路障、铁桶)无阴影
- ⚠️ 场景缺少深度感,实体看起来"浮"在草坪上

### 原版机制

根据原版 PVZ 视觉效果:

**阴影特性**:
1. **形状**: 椭圆形,压扁的圆形
2. **位置**: 实体脚下正中心,贴地渲染
3. **大小**: 根据实体类型自适应
   - 豌豆射手: 小圆 (~30x15 像素)
   - 向日葵: 中圆 (~35x18 像素)
   - 坚果墙: 大圆 (~50x25 像素)
   - 僵尸: 中圆 (~40x20 像素)
4. **透明度**: 60-70% (半透明黑色,Alpha 约 0.6-0.7)
5. **渲染层级**: 在草坪上方,实体下方

**关键资源**:
- ⚠️ `assets/images/effects/shadow_ellipse.png` - 需确认存在
- 或使用代码绘制椭圆形阴影

---

## Acceptance Criteria (验收标准)

### 功能需求

1. **植物阴影渲染** (P0)
   - 所有植物实体脚下渲染椭圆形阴影
   - 阴影使用原版阴影贴图或代码绘制的椭圆
   - 阴影不跟随动画帧变化,位置固定在实体锚点正下方

2. **僵尸阴影渲染** (P0)
   - 所有僵尸实体脚下渲染椭圆形阴影
   - 僵尸移动时,阴影跟随移动 (基于 `PositionComponent`)
   - 僵尸死亡后,阴影消失 (实体被删除)

3. **阴影大小自适应** (P0)
   - 不同实体类型有不同的阴影大小
   - 配置示例:
     ```go
     // pkg/config/shadow_config.go
     var ShadowSizes = map[string]ShadowSize{
         "peashooter":  {Width: 30, Height: 15},
         "sunflower":   {Width: 35, Height: 18},
         "wallnut":     {Width: 50, Height: 25},
         "zombie":      {Width: 40, Height: 20},
         "zombie_cone": {Width: 40, Height: 20},
     }
     ```

4. **阴影透明度** (P0)
   - 阴影透明度为 60-70% (Alpha = 0.65 ± 0.05)
   - 半透明黑色 (RGB: 0, 0, 0, Alpha: 165)
   - 不随光照或时间变化

5. **渲染层级正确** (P0)
   - 阴影渲染在**实体下方一层**
   - 渲染顺序: 草坪 → 阴影 → 植物/僵尸 → UI
   - 阴影不遮挡植物本体,不被草坪遮挡

6. **阴影位置精确** (P1)
   - 阴影中心点 = 实体的 `PositionComponent` (X, Y)
   - 或根据实体的 `CenterOffset` 微调 (如僵尸脚底)
   - 阴影不偏移或晃动

### 性能需求

7. **性能测试** (P0)
   - 50 个植物 + 20 个僵尸同屏,阴影渲染保持 **60 FPS**
   - 阴影渲染使用批量渲染优化 (一次 DrawImage 调用绘制多个阴影)
   - 性能影响 < **5 FPS** (相比无阴影时)

8. **内存管理** (P1)
   - 阴影组件复用现有 `ShadowComponent` (如存在)
   - 阴影贴图只加载一次,所有实体共享
   - 实体删除时,阴影自动清理 (无内存泄漏)

### 质量需求

9. **视觉还原度** (P0)
   - 与原版 PVZ 对比,阴影大小相似度 ≥ **90%**
   - 阴影透明度误差 ≤ **10%**
   - 阴影位置居中,无明显偏移

10. **代码质量** (P0)
    - 单元测试覆盖率 ≥ **80%** (阴影组件、渲染逻辑)
    - 代码符合 `CLAUDE.md` 编码规范 (ECS 零耦合原则)
    - 无新增 Linter 警告

11. **兼容性** (P0)
    - 不影响现有渲染系统 (`RenderSystem`, `ReanimSystem`)
    - 不破坏其他视觉效果 (粒子、动画)
    - 可通过配置开关禁用阴影 (调试用)

---

## Tasks / Subtasks (任务分解)

### Phase 1: 准备与设计 (1 小时)

- [ ] **Task 1.1**: 检查阴影资源
  - [ ] 查找 `assets/images/effects/shadow_*.png`
  - [ ] 如无资源,准备代码绘制椭圆方案
  - [ ] 确定阴影尺寸规范 (宽高比 2:1)

- [ ] **Task 1.2**: 设计 `ShadowComponent` 数据结构
  - [ ] 定义字段: `Width float64`, `Height float64`, `Alpha float32`
  - [ ] 设计默认值: Alpha = 0.65
  - [ ] 编写 GoDoc 注释
  - **输出**: `pkg/components/shadow_component.go`

- [ ] **Task 1.3**: 设计阴影渲染策略
  - [ ] 确定在 `RenderSystem` 中新增 `drawShadows()` 方法
  - [ ] 或新建 `ShadowRenderSystem` (独立系统)
  - [ ] 规划渲染顺序和批量优化
  - **输出**: 设计文档或代码注释

### Phase 2: 核心实现 (3-4 小时)

- [ ] **Task 2.1**: 创建 `ShadowComponent` 组件
  - [ ] 实现组件结构体
  - [ ] 添加辅助方法 (如 `GetSize()`, `GetAlpha()`)
  - [ ] 单元测试 (边界条件)
  - **文件**: `pkg/components/shadow_component.go`

- [ ] **Task 2.2**: 创建阴影配置
  - [ ] 创建 `pkg/config/shadow_config.go`
  - [ ] 定义 `ShadowSizes map[string]ShadowSize`
  - [ ] 包含所有植物和僵尸类型的阴影尺寸
  - [ ] 提供默认值函数 `GetDefaultShadowSize(entityType string)`
  - **文件**: `pkg/config/shadow_config.go`

- [ ] **Task 2.3**: 加载或生成阴影贴图
  - [ ] **方案 A**: 加载 `shadow_ellipse.png` (如存在)
  - [ ] **方案 B**: 代码绘制椭圆阴影贴图
    ```go
    // 使用 Ebitengine 的 DrawImage API 绘制椭圆
    shadowImage := ebiten.NewImage(width, height)
    // 填充半透明黑色椭圆
    ```
  - [ ] 在 `ResourceManager` 中缓存阴影贴图
  - **文件**: `pkg/game/resource_manager.go`

- [ ] **Task 2.4**: 为植物和僵尸实体添加 `ShadowComponent`
  - [ ] 修改所有实体工厂函数 (植物和僵尸)
  - [ ] 根据实体类型从配置读取阴影尺寸
  - [ ] 添加 `ShadowComponent{Width: w, Height: h, Alpha: 0.65}`
  - **文件**:
    - `pkg/entities/plant_factory.go` (豌豆射手、向日葵、坚果墙等)
    - `pkg/entities/zombie_factory.go` (普通、路障、铁桶僵尸等)

- [ ] **Task 2.5**: 实现阴影渲染逻辑
  - [ ] 在 `RenderSystem.Draw()` 中添加 `drawShadows()` 调用
  - [ ] 实现 `drawShadows(screen *ebiten.Image)`:
    1. 查询所有拥有 `PositionComponent` 和 `ShadowComponent` 的实体
    2. 按 Y 坐标排序 (保证渲染顺序)
    3. 批量渲染阴影:
       - 位置: `(pos.X - width/2, pos.Y - height/2)` (居中)
       - 应用 Alpha: `op.ColorScale.ScaleAlpha(shadow.Alpha)`
       - 绘制阴影贴图
  - [ ] 单元测试 (模拟渲染,验证调用次数和参数)
  - **文件**: `pkg/systems/render_system.go`

### Phase 3: 优化与调整 (1-2 小时)

- [ ] **Task 3.1**: 批量渲染优化
  - [ ] 使用单次 `DrawTriangles` 批量绘制所有阴影
  - [ ] 构建顶点数组 (所有阴影的矩形)
  - [ ] 测量性能提升 (对比逐个 DrawImage)
  - **可选**: 如性能达标,保持简单实现

- [ ] **Task 3.2**: 阴影位置微调
  - [ ] 根据 `CenterOffset` 调整阴影位置 (如僵尸脚底偏移)
  - [ ] 配置示例:
    ```go
    ShadowOffsets = map[string]OffsetY{
        "zombie": -10, // 阴影向下偏移 10px (脚底)
    }
    ```
  - [ ] 视觉验证 (阴影对齐实体脚底)

- [ ] **Task 3.3**: 渲染层级验证
  - [ ] 手动测试:阴影不遮挡植物本体
  - [ ] 手动测试:阴影不被草坪遮挡
  - [ ] 调整 `drawShadows()` 调用顺序 (在 drawPlants/Zombies 之前)

### Phase 4: 测试与验证 (1-2 小时)

- [ ] **Task 4.1**: 单元测试
  - [ ] `shadow_component_test.go` - 组件逻辑测试
  - [ ] `render_system_test.go` - 阴影渲染逻辑测试
  - [ ] 边界条件: Alpha 0, 1, 超出范围
  - [ ] 目标覆盖率: ≥ 80%

- [ ] **Task 4.2**: 集成测试
  - [ ] 关卡 1-1: 种植多个植物,验证阴影显示
  - [ ] 关卡 1-4: 大量植物 + 僵尸,验证阴影正常
  - [ ] 检查点:
    - ✅ 所有植物和僵尸有阴影
    - ✅ 阴影大小正确
    - ✅ 阴影位置居中
    - ✅ 阴影透明度正确

- [ ] **Task 4.3**: 性能测试
  - [ ] 创建测试场景: 50 植物 + 20 僵尸
  - [ ] 监控 FPS (使用 `ebiten.CurrentFPS()`)
  - [ ] 验证: 平均 FPS ≥ 60, 性能下降 < 5 FPS
  - [ ] 性能优化 (如需要):
    - 批量渲染 (DrawTriangles)
    - 预计算阴影顶点
    - 阴影贴图缓存

- [ ] **Task 4.4**: 视觉验证
  - [ ] 截图对比原版 PVZ:
    - 豌豆射手阴影大小
    - 僵尸阴影位置
    - 阴影透明度
  - [ ] 测量误差:
    - 大小误差 ≤ 10%
    - 透明度误差 ≤ 10%
  - [ ] 如有偏差,调整配置或渲染参数

- [ ] **Task 4.5**: 回归测试
  - [ ] 运行 `go test ./...` 确保无破坏
  - [ ] 验证现有功能正常:
    - ✅ 植物种植、攻击正常
    - ✅ 僵尸移动、死亡正常
    - ✅ 粒子效果正常
    - ✅ 动画播放正常

---

## Technical Implementation (技术实现细节)

### 核心数据结构

```go
// pkg/components/shadow_component.go

// ShadowComponent 阴影组件
// 存储实体的阴影渲染参数
type ShadowComponent struct {
    // Width 阴影宽度 (像素)
    Width float64

    // Height 阴影高度 (像素)
    Height float64

    // Alpha 阴影透明度 (0.0-1.0)
    // 典型值: 0.65 (65% 透明度)
    Alpha float32

    // OffsetY 阴影垂直偏移 (像素)
    // 用于微调阴影位置,使其对齐实体脚底
    // 默认: 0
    OffsetY float64
}
```

### 阴影配置

```go
// pkg/config/shadow_config.go

type ShadowSize struct {
    Width  float64
    Height float64
}

// ShadowSizes 各类型实体的阴影尺寸
var ShadowSizes = map[string]ShadowSize{
    // 植物
    "peashooter":  {Width: 30, Height: 15},
    "sunflower":   {Width: 35, Height: 18},
    "wallnut":     {Width: 50, Height: 25},
    "cherrybomb":  {Width: 40, Height: 20},
    "repeater":    {Width: 30, Height: 15},
    "snowpea":     {Width: 30, Height: 15},

    // 僵尸
    "zombie":      {Width: 40, Height: 20},
    "zombie_cone": {Width: 40, Height: 20},
    "zombie_bucket": {Width: 40, Height: 20},
    "zombie_pole": {Width: 45, Height: 22},
}

// DefaultShadowSize 默认阴影尺寸 (未配置时使用)
var DefaultShadowSize = ShadowSize{Width: 35, Height: 18}

// GetShadowSize 获取指定类型实体的阴影尺寸
func GetShadowSize(entityType string) ShadowSize {
    if size, ok := ShadowSizes[entityType]; ok {
        return size
    }
    return DefaultShadowSize
}
```

### 阴影渲染算法

```go
// pkg/systems/render_system.go

func (s *RenderSystem) drawShadows(screen *ebiten.Image) {
    // 1. 查询所有拥有阴影的实体
    entities := ecs.GetEntitiesWith2[
        *components.PositionComponent,
        *components.ShadowComponent,
    ](s.entityManager)

    // 2. 按 Y 坐标排序 (保证渲染顺序)
    sort.Slice(entities, func(i, j int) bool {
        posI, _ := ecs.GetComponent[*components.PositionComponent](s.entityManager, entities[i])
        posJ, _ := ecs.GetComponent[*components.PositionComponent](s.entityManager, entities[j])
        return posI.Y < posJ.Y
    })

    // 3. 批量渲染阴影
    shadowImage := s.resourceManager.GetImage("shadow_ellipse") // 共享贴图
    for _, entity := range entities {
        pos, _ := ecs.GetComponent[*components.PositionComponent](s.entityManager, entity)
        shadow, _ := ecs.GetComponent[*components.ShadowComponent](s.entityManager, entity)

        // 计算阴影位置 (居中)
        shadowX := pos.X - shadow.Width/2
        shadowY := pos.Y - shadow.Height/2 + shadow.OffsetY

        // 应用变换和透明度
        op := &ebiten.DrawImageOptions{}
        op.GeoM.Scale(shadow.Width/shadowImage.Bounds().Dx(), shadow.Height/shadowImage.Bounds().Dy())
        op.GeoM.Translate(shadowX, shadowY)
        op.ColorScale.ScaleAlpha(shadow.Alpha)

        // 绘制阴影
        screen.DrawImage(shadowImage, op)
    }
}

// Draw 主渲染函数
func (s *RenderSystem) Draw(screen *ebiten.Image) {
    // ... 绘制草坪 ...

    // 渲染阴影层 (在实体下方)
    s.drawShadows(screen)

    // ... 绘制植物、僵尸、UI ...
}
```

---

## Success Criteria Summary (成功标准总结)

| 类别 | 标准 | 验证方法 |
|------|------|---------|
| **功能** | 植物和僵尸阴影正常显示 | 集成测试 + 视觉验证 |
| **功能** | 阴影大小自适应实体类型 | 配置验证 + 截图对比 |
| **功能** | 阴影透明度 65% ± 5% | 代码检查 + 视觉验证 |
| **性能** | 50 植物 + 20 僵尸, 60 FPS | 性能测试 |
| **性能** | 性能影响 < 5 FPS | 对比测试 (有/无阴影) |
| **质量** | 单元测试覆盖率 ≥ 80% | `go test -cover` |
| **质量** | 无 Linter 警告 | `golangci-lint run` |
| **兼容性** | 现有功能无回归 | 回归测试 |

---

## Dependencies (依赖)

### 前置依赖
- ✅ Epic 1-9 已完成 (ECS 框架、渲染系统)
- ✅ `RenderSystem` 已实现
- ✅ 所有植物和僵尸实体已创建

### 资源依赖
- ⚠️ `assets/images/effects/shadow_ellipse.png` - 可选 (可代码绘制)
- ✅ 无新增外部依赖

### 系统依赖
- `RenderSystem` - 需扩展 (`drawShadows()`)
- `ResourceManager` - 需加载阴影贴图
- 所有实体工厂 - 需添加 `ShadowComponent`

---

## Risks and Mitigation (风险与缓解)

| 风险 | 可能性 | 影响 | 缓解措施 |
|------|--------|------|----------|
| 阴影贴图资源缺失 | Medium | Low | 使用代码绘制椭圆 (Ebitengine API) |
| 性能下降 > 5 FPS | Low | Medium | 批量渲染优化 (DrawTriangles) |
| 阴影位置偏移 | Medium | Low | 提供 OffsetY 配置,可微调 |
| 工作量超出预期 (>8 小时) | Low | Low | 采用 MVP: 简单椭圆,固定透明度 |

---

## Notes (备注)

### 阴影贴图方案选择

**方案 A: 使用原版阴影贴图** (推荐)
- ✅ 100% 还原原版效果
- ⚠️ 需确认资源存在

**方案 B: 代码绘制椭圆** (备选)
- ✅ 无需额外资源
- ⚠️ 需调试渐变效果 (边缘羽化)

**推荐**: 优先使用方案 A,如资源缺失则降级到方案 B

### 技术债

本 Story 采用**简化实现**:
- ✅ 固定透明度 (不随光照变化)
- ✅ 椭圆形阴影 (不考虑投影方向)
- ✅ 2D 渲染 (不使用着色器)

**未来可能的增强**:
- 根据光源方向调整阴影偏移
- 使用着色器实现软阴影 (边缘羽化)
- 根据高度调整阴影大小 (跳跃时阴影变小)

---

## Definition of Done (完成定义)

- [ ] 所有 11 个 AC 满足
- [ ] 所有 Tasks (Phase 1-4) 完成
- [ ] 单元测试覆盖率 ≥ 80%
- [ ] 集成测试通过 (关卡 1-1, 1-4)
- [ ] 性能测试通过 (60 FPS, 性能影响 < 5 FPS)
- [ ] 视觉验证通过 (大小、透明度误差 ≤ 10%)
- [ ] 回归测试通过 (`go test ./...`)
- [ ] 代码审查通过 (符合 `CLAUDE.md` 规范)
- [ ] 文档更新完成 (Epic 10 描述)
- [ ] Git commit 并 push

---

## References (参考资料)

- **变更提案**: Sprint Change Proposal - 2025-11-24 航向修正
- **Epic 10 PRD**: `docs/prd/epic-10-game-experience-polish.md`
- **RenderSystem**: `pkg/systems/render_system.go`
- **实体工厂**: `pkg/entities/plant_factory.go`, `pkg/entities/zombie_factory.go`
- **原版参考**: `.meta/prompts.md` (L142)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-24 | 1.0 | Initial story creation (基于航向修正提案) | Bob (Scrum Master) |

---

**Story Status**: Pending → Ready for Development
