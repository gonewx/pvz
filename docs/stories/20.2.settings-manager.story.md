# Story 20.2: SettingsManager 实现

## Status

Done

## Story

**As a** 玩家,
**I want** my game settings (volume, fullscreen) to be saved,
**so that** I don't need to reconfigure every time I start the game.

## Acceptance Criteria

1. 创建 `pkg/game/settings_manager.go`
2. 实现 `GameSettings` 结构（MusicVolume, SoundVolume, MusicEnabled, SoundEnabled, Fullscreen）
3. 实现 `SettingsManager` 类（Load, Save, GetSettings, SetXxx 方法）
4. 使用 gdata API 存储在 `settings/global` 路径
5. 提供 `DefaultSettings()` 返回默认值
6. 集成到 GameState
7. 单元测试覆盖率 ≥ 80%

## Tasks / Subtasks

- [x] **Task 1: 创建 GameSettings 结构** (AC: 2, 5)
  - [x] 在 `pkg/game/settings_manager.go` 中定义 `GameSettings` 结构体
  - [x] 字段：`MusicVolume float64`（0.0 ~ 1.0）
  - [x] 字段：`SoundVolume float64`（0.0 ~ 1.0）
  - [x] 字段：`MusicEnabled bool`
  - [x] 字段：`SoundEnabled bool`
  - [x] 字段：`Fullscreen bool`
  - [x] 使用 YAML tag 标记字段（与项目其他配置保持一致）
  - [x] 实现 `DefaultSettings()` 函数返回默认值

- [x] **Task 2: 实现 SettingsManager 类** (AC: 1, 3, 4)
  - [x] 定义 `SettingsManager` 结构体，包含 `gdataManager *gdata.Manager` 和 `settings *GameSettings`
  - [x] 实现 `NewSettingsManager(gdataManager *gdata.Manager) (*SettingsManager, error)` 构造函数
  - [x] 处理 gdataManager 为 nil 的降级场景（使用内存设置，无法持久化）
  - [x] 实现 `Load() error` 方法：从 gdata 加载设置，路径 `settings/global`，使用 `yaml.Unmarshal` 反序列化
  - [x] 实现 `Save() error` 方法：使用 `yaml.Marshal` 序列化后保存到 gdata
  - [x] 实现 `GetSettings() *GameSettings` 方法
  - [x] 实现 `SetMusicVolume(volume float64)` 方法（含范围校验 0.0~1.0，仅修改内存）
  - [x] 实现 `SetSoundVolume(volume float64)` 方法（含范围校验 0.0~1.0，仅修改内存）
  - [x] 实现 `SetMusicEnabled(enabled bool)` 方法（仅修改内存）
  - [x] 实现 `SetSoundEnabled(enabled bool)` 方法（仅修改内存）
  - [x] 实现 `SetFullscreen(enabled bool)` 方法（仅修改内存）
  - [x] **注意**: 所有 SetXxx 方法仅修改内存中的设置，需调用 `Save()` 方法才能持久化

- [x] **Task 3: 集成到 GameState** (AC: 6)
  - [x] 在 `GameState` 结构体中添加 `settingsManager *SettingsManager` 字段
  - [x] 在 `GetGameState()` 初始化块中创建 SettingsManager 实例（**必须在 gdataManager 初始化之后**）
  - [x] 添加 `GetSettingsManager() *SettingsManager` getter 方法
  - [x] 处理初始化失败的降级方案（settingsManager 为 nil，游戏继续运行）

- [x] **Task 4: 编写单元测试** (AC: 7)
  - [x] 创建 `pkg/game/settings_manager_test.go`
  - [x] 测试 `DefaultSettings()` 返回正确默认值
  - [x] 测试 `NewSettingsManager()` 正常初始化
  - [x] 测试 `NewSettingsManager()` 降级场景（gdataManager 为 nil）
  - [x] 测试 `Load()` 和 `Save()` 功能
  - [x] 测试 `SetMusicVolume()` 范围校验（0.0~1.0 clamp）
  - [x] 测试 `SetSoundVolume()` 范围校验
  - [x] 测试 `SetMusicEnabled/SetSoundEnabled/SetFullscreen`
  - [x] 测试 `GetSettings()` 返回正确实例

- [x] **Task 5: 验证与构建**
  - [x] 运行 `go test -v -cover ./pkg/game/...` 确保测试通过
  - [x] 确保覆盖率 ≥ 80%
  - [x] 运行 `go build` 确保编译成功
  - [x] 运行游戏确保正常启动

## Dev Notes

### 前置依赖

**Story 20.1 已完成**：gdata Manager 已在 GameState 中初始化

[Source: docs/stories/20.1.gdata-dependency-manager-init.story.md]

从 Story 20.1 的完成记录中提取的关键信息：
- gdata Manager 通过 `GetGameState().GetGdataManager()` 获取
- 如果初始化失败，`GetGdataManager()` 返回 nil
- 后续 Story 需检查 `GetGdataManager()` 返回值是否为 nil

### 技术背景

**gdata 库** 是专为 Ebitengine 游戏设计的跨平台存储库，支持：
- 桌面端（Windows/Linux/macOS）
- 移动端（Android/iOS）
- Web（WASM）

各平台存储位置：
- Windows: `%APPDATA%/pvz_newx/settings/global`
- Linux: `~/.local/share/pvz_newx/settings/global`
- WASM: localStorage

[Source: docs/design/embed-and-cross-platform-storage.md#3.1]

### gdata API 参考

```go
import "github.com/quasilyte/gdata/v2"

// 保存数据
err = manager.SaveObjectProp("settings", "global", dataBytes)

// 加载数据
data, err := manager.LoadObjectProp("settings", "global")

// 检查是否存在
exists := manager.ObjectPropExists("settings", "global")
```

[Source: docs/design/embed-and-cross-platform-storage.md#6.1]

### 数据序列化

使用 YAML 格式序列化设置数据，与项目其他配置保持一致：

```go
import "gopkg.in/yaml.v3"

// Save 方法中序列化
data, err := yaml.Marshal(sm.settings)
if err != nil {
    return fmt.Errorf("failed to marshal settings: %w", err)
}
err = sm.gdataManager.SaveObjectProp("settings", "global", data)

// Load 方法中反序列化
data, err := sm.gdataManager.LoadObjectProp("settings", "global")
if err != nil {
    // 文件不存在时使用默认设置
    sm.settings = DefaultSettings()
    return nil
}
err = yaml.Unmarshal(data, sm.settings)
```

[Source: 项目编码规范 - 使用 gopkg.in/yaml.v3]

### GameSettings 结构定义

```go
// GameSettings 全局游戏设置
// 注意：这些设置是全局的，不绑定到特定用户（与原版 PvZ 一致）
type GameSettings struct {
    // 音频设置
    MusicVolume  float64 `yaml:"musicVolume"`  // 音乐音量 0.0 ~ 1.0
    SoundVolume  float64 `yaml:"soundVolume"`  // 音效音量 0.0 ~ 1.0
    MusicEnabled bool    `yaml:"musicEnabled"` // 音乐开关
    SoundEnabled bool    `yaml:"soundEnabled"` // 音效开关

    // 显示设置
    Fullscreen bool `yaml:"fullscreen"` // 启动时是否全屏
}

// DefaultSettings 返回默认设置
func DefaultSettings() *GameSettings {
    return &GameSettings{
        MusicVolume:  0.7,
        SoundVolume:  0.8,
        MusicEnabled: true,
        SoundEnabled: true,
        Fullscreen:   false,
    }
}
```

[Source: docs/design/embed-and-cross-platform-storage.md#5.1]

### SettingsManager API 参考

```go
type SettingsManager struct {
    gdataManager *gdata.Manager
    settings     *GameSettings
}

func NewSettingsManager(gdataManager *gdata.Manager) (*SettingsManager, error)
func (sm *SettingsManager) Load() error
func (sm *SettingsManager) Save() error
func (sm *SettingsManager) GetSettings() *GameSettings
func (sm *SettingsManager) SetMusicVolume(volume float64)
func (sm *SettingsManager) SetSoundVolume(volume float64)
func (sm *SettingsManager) SetMusicEnabled(enabled bool)
func (sm *SettingsManager) SetSoundEnabled(enabled bool)
func (sm *SettingsManager) SetFullscreen(enabled bool)
```

[Source: docs/design/embed-and-cross-platform-storage.md#6.2]

### 相关源代码树

```
pkg/game/
├── game_state.go              # 修改：添加 settingsManager 字段和初始化
├── settings_manager.go        # 新建：SettingsManager 实现
├── settings_manager_test.go   # 新建：SettingsManager 单元测试
├── save_manager.go            # 参考：类似的 Manager 模式
└── ...
```

### 现有代码结构

**GameState 位置**: `pkg/game/game_state.go`

GameState 使用**单例模式**，通过 `GetGameState()` 获取全局实例。

Story 20.1 中 gdataManager 的初始化模式（可参考）：

```go
// Story 20.1: 初始化 gdata Manager（跨平台存储）
gdataManager, err := gdata.Open(gdata.Config{
    AppName: "pvz_newx",
})
if err != nil {
    log.Printf("[GameState] Warning: Failed to initialize gdata Manager: %v", err)
    // 降级方案：gdataManager 为 nil，游戏继续运行
    gdataManager = nil
}
```

[Source: pkg/game/game_state.go:90-98]

### 降级方案

如果 gdata Manager 为 nil（初始化失败或平台不支持）：
1. `NewSettingsManager()` 仍返回有效实例
2. 使用 `DefaultSettings()` 作为内存设置
3. `Save()` 返回 nil（不报错），但不持久化
4. `Load()` 返回 nil（不报错），使用默认设置
5. 游戏可正常运行，但设置不会保存

### 文件修改清单

| 文件 | 操作 |
|------|------|
| `pkg/game/settings_manager.go` | 新建：SettingsManager 实现 |
| `pkg/game/settings_manager_test.go` | 新建：单元测试 |
| `pkg/game/game_state.go` | 修改：添加 settingsManager 字段和初始化 |

## Testing

### 测试标准 [Source: docs/architecture/testing-strategy.md]

- **框架**: Go 标准库 `testing` 包
- **位置**: 测试文件与源文件同包，以 `_test.go` 结尾
- **覆盖率目标**: ≥ 80%

### 测试用例

| 测试函数 | 验证内容 | AC |
|----------|----------|-----|
| `TestDefaultSettings` | DefaultSettings() 返回正确默认值 | AC5 |
| `TestNewSettingsManager` | 正常初始化 SettingsManager | AC1, AC3 |
| `TestNewSettingsManagerNilGdata` | gdataManager 为 nil 时的降级 | AC3 |
| `TestSettingsLoadSave` | Load() 和 Save() 功能 | AC3, AC4 |
| `TestSetMusicVolumeClamp` | SetMusicVolume 范围校验 0.0~1.0 | AC3 |
| `TestSetSoundVolumeClamp` | SetSoundVolume 范围校验 0.0~1.0 | AC3 |
| `TestSetMusicEnabled` | SetMusicEnabled 功能 | AC3 |
| `TestSetSoundEnabled` | SetSoundEnabled 功能 | AC3 |
| `TestSetFullscreen` | SetFullscreen 功能 | AC3 |
| `TestGetSettings` | GetSettings() 返回正确实例 | AC3 |
| `TestGameStateSettingsManager` | GameState 集成 SettingsManager | AC6 |

### 运行测试

```bash
go test -v -cover ./pkg/game/...
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-03 | 1.0 | 初始创建 | Bob (SM) |
| 2024-12-03 | 1.1 | PO 验证通过，补充 YAML 序列化说明、SetXxx 方法行为说明、初始化顺序说明 | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5

### Debug Log References

无（所有测试一次通过）

### Completion Notes List

- 创建了 `GameSettings` 结构体，包含音量（MusicVolume, SoundVolume）、开关（MusicEnabled, SoundEnabled）和全屏（Fullscreen）设置
- 实现了 `SettingsManager`，支持通过 gdata 跨平台存储设置数据（路径 `settings/global`）
- 支持降级模式：当 gdataManager 为 nil 时，使用内存设置，不报错
- 所有 SetXxx 方法仅修改内存，需调用 Save() 持久化
- 音量值自动 clamp 到 0.0~1.0 范围
- 集成到 GameState 单例，通过 GetSettingsManager() 访问
- 14 个单元测试全部通过，settings_manager.go 覆盖率约 85%

### File List

| 文件 | 操作 | 说明 |
|------|------|------|
| `pkg/game/settings_manager.go` | 新建 | SettingsManager 和 GameSettings 实现 |
| `pkg/game/settings_manager_test.go` | 新建 | 14 个单元测试 |
| `pkg/game/game_state.go` | 修改 | 添加 settingsManager 字段、初始化和 getter |

---

## QA Results

### Story DoD Checklist

1. **Requirements Met:**
   - [x] 所有功能需求已实现（GameSettings 结构、SettingsManager 类、GameState 集成）
   - [x] 所有验收标准已满足（AC 1-7 全部完成）

2. **Coding Standards & Project Structure:**
   - [x] 遵循项目编码规范（gofmt、命名约定、GoDoc 注释）
   - [x] 文件位置正确（`pkg/game/settings_manager.go`）
   - [x] 使用项目技术栈（gopkg.in/yaml.v3、gdata/v2）
   - [x] 无 linter 错误（go vet 通过）
   - [x] 代码注释完整（每个公共函数都有 GoDoc 注释）

3. **Testing:**
   - [x] 14 个单元测试已实现
   - [x] 所有测试通过
   - [x] settings_manager.go 覆盖率约 85%（DefaultSettings 100%、SetXxx 100%、Load/Save ~77%）

4. **Functionality & Verification:**
   - [x] 构建成功（go build 无错误）
   - [x] 边缘情况已处理（nil gdataManager、音量超范围）

5. **Story Administration:**
   - [x] 所有任务已标记完成
   - [x] Dev Agent Record 已填写

6. **Dependencies, Build & Configuration:**
   - [x] 项目构建成功
   - [x] go vet 通过
   - [x] 无新依赖添加（使用已有的 gdata/v2 和 yaml.v3）

7. **Documentation:**
   - [x] 完整的 GoDoc 注释
   - [N/A] 无用户文档更新需求

### Final Confirmation

- [x] Developer Agent 确认所有适用项已完成

---

### Review Date: 2025-12-03

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**整体评价：优秀**

实现质量很高，代码清晰、结构合理、测试完善。主要优点：

1. **架构设计**：遵循项目现有的 Manager 模式（与 SaveManager 一致），降级模式设计合理
2. **代码质量**：命名规范、GoDoc 注释完整、错误处理使用 `fmt.Errorf` + `%w` 包装
3. **测试覆盖**：14 个测试用例，覆盖率约 85%，包含正常流程和边界条件

### Requirements Traceability

| AC | 验证方式 | 状态 |
|----|----------|------|
| AC1: 创建 settings_manager.go | 文件存在检查 | ✓ |
| AC2: GameSettings 结构 | 代码审查 + TestDefaultSettings | ✓ |
| AC3: SettingsManager 类 | 代码审查 + TestNewSettingsManager, TestSettingsLoadSave, TestSet* | ✓ |
| AC4: gdata API 存储路径 | 代码审查（settingsObject="settings", settingsProperty="global"）| ✓ |
| AC5: DefaultSettings() | TestDefaultSettings | ✓ |
| AC6: GameState 集成 | TestGameStateSettingsManager | ✓ |
| AC7: 覆盖率 ≥ 80% | go test -cover（~85%）| ✓ |

### Test Coverage Details

```
settings_manager.go 函数覆盖率：
- DefaultSettings:     100.0%
- NewSettingsManager:   75.0%
- Load:                 76.5%
- Save:                 66.7%
- GetSettings:         100.0%
- SetMusicVolume:      100.0%
- SetSoundVolume:      100.0%
- SetMusicEnabled:     100.0%
- SetSoundEnabled:     100.0%
- SetFullscreen:       100.0%
- clampVolume:         100.0%
```

所有 14 个测试通过，整体覆盖率约 85%，超过 AC7 要求的 80%。

### Refactoring Performed

无需重构。代码质量已达标准。

### Compliance Check

- Coding Standards: ✓ gofmt、命名约定、GoDoc 注释符合规范
- Project Structure: ✓ 文件位于 `pkg/game/`，命名符合约定
- Testing Strategy: ✓ 使用标准库 `testing`，测试文件同包，table-driven tests
- All ACs Met: ✓ 全部 7 个验收标准已满足

### Improvements Checklist

- [x] 所有功能已正确实现
- [x] 测试覆盖率达标
- [x] 降级模式正确处理
- [x] 错误处理完善

### Security Review

**状态：PASS**

- 本地设置存储，不涉及敏感数据
- 无网络通信，无外部依赖风险

### Performance Considerations

**状态：PASS**

- 简单的 YAML 序列化/反序列化
- 设置数据量小（< 1KB），无性能问题
- 使用 gdata 库的标准存储机制

### Files Modified During Review

无文件修改。

### Gate Status

Gate: **PASS** → docs/qa/gates/20.2-settings-manager.yml

### Recommended Status

✓ **Ready for Done**

代码质量优秀，测试完善，所有验收标准已满足。建议合并。
