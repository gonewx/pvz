# Story 10.8: 阳光不足交互反馈

## Metadata
- **Epic**: Epic 10 - 游戏体验完善 (Game Experience Polish)
- **Story ID**: 10.8
- **Type**: UX Enhancement
- **Status**: Pending
- **Priority**: ⭐⭐⭐ 中
- **Estimated Effort**: 4-6 小时
- **Created**: 2025-11-24
- **Created By**: Bob (Scrum Master)
- **Related Stories**: Story 3.1 (植物卡片 UI)
- **Change Proposal**: Sprint Change Proposal - 2025-11-24 航向修正

---

## Story

**As a** 玩家,
**I want** 点击阳光不足的植物卡片时看到阳光数字闪烁,
**so that** 我能立即意识到阳光不足的原因,获得明确的操作反馈。

---

## Background (背景)

### 现状

当前游戏已实现植物卡片的阳光不足**视觉状态** (卡片变暗):
- ✅ 阳光不足时,卡片显示为半透明灰色
- ✅ 点击阳光不足卡片无响应 (无法选择)

但缺少原版游戏的**交互反馈**:
- ❌ 点击阳光不足卡片时,阳光计数器无任何反应
- ❌ 玩家可能不理解为何卡片无法选择

### 原版机制

根据原版 PVZ 用户体验设计:

**阳光不足交互反馈**:
1. 玩家点击阳光不足的卡片
2. 播放"无效操作"音效 (buzzer 声)
3. **阳光计数器数字闪烁** (红色 ↔ 黑色)
4. 闪烁模式:
   - 颜色: 红色 (255, 0, 0) ↔ 黑色 (0, 0, 0)
   - 周期: 0.3 秒 (红 → 黑 → 红)
   - 持续时间: 1.0 秒 (约 3 次闪烁)
5. 闪烁期间,阳光数字其他功能正常 (数值更新、收集动画)

**关键资源**:
- ⚠️ `assets/audio/ui/buzzer.ogg` - 无效操作音效 (需确认)
- ✅ 无需新增图像资源

---

## Acceptance Criteria (验收标准)

### 功能需求

1. **触发条件检测** (P0)
   - 玩家点击阳光不足的植物卡片时触发反馈
   - 阳光不足定义: `当前阳光 < 卡片所需阳光`
   - 冷却中的卡片不触发 (冷却优先于阳光检查)

2. **阳光数字闪烁动画** (P0)
   - 闪烁颜色: 红色 (255, 0, 0) ↔ 黑色 (0, 0, 0)
   - 闪烁周期: 0.3 秒 (红 → 黑 → 红)
   - 持续时间: 1.0 秒 (约 3 次完整闪烁)
   - 使用方波切换 (非渐变,即时切换颜色)

3. **音效播放** (P1)
   - 点击阳光不足卡片时,播放"无效操作"音效
   - 音效资源: `buzzer.ogg` 或类似
   - 音量: 与其他 UI 音效一致

4. **闪烁期间功能不受影响** (P0)
   - 闪烁期间,阳光数字的其他功能正常:
     - 数值更新 (收集阳光后数字增加)
     - 收集动画 (阳光飞向计数器)
     - 文本渲染 (颜色变化,位置不变)
   - 闪烁状态可被新的"阳光不足"点击重新触发

5. **多次点击处理** (P1)
   - 玩家连续点击阳光不足卡片:
     - 每次点击重新触发闪烁 (重置计时器)
     - 音效不重复播放 (短时间内只播放一次)
   - 闪烁动画流畅,无卡顿

6. **非阳光不足卡片不受影响** (P0)
   - 点击阳光充足的卡片,阳光计数器无闪烁
   - 点击其他 UI 元素,阳光计数器无闪烁
   - 闪烁效果仅由阳光不足点击触发

### 性能需求

7. **性能测试** (P1)
   - 闪烁动画不影响帧率 (保持 60 FPS)
   - 颜色切换使用轻量级实现 (无复杂计算)
   - 音效播放无明显延迟

### 质量需求

8. **视觉还原度** (P0)
   - 闪烁周期误差 ≤ 10% (目标 0.3 秒)
   - 颜色准确 (红: #FF0000, 黑: #000000)
   - 持续时间误差 ≤ 10% (目标 1.0 秒)

9. **代码质量** (P1)
   - 单元测试覆盖率 ≥ 70%
   - 代码符合 `CLAUDE.md` 编码规范
   - 无新增 Linter 警告

10. **兼容性** (P0)
    - 不影响 `PlantCardSystem` 现有功能
    - 不影响阳光收集动画
    - 不破坏 UI 渲染系统

---

## Tasks / Subtasks (任务分解)

### Phase 1: 触发检测与状态管理 (1-2 小时)

- [ ] **Task 1.1**: 扩展 `GameState` 或创建 `SunCounterFlashComponent`
  - [ ] **方案 A**: 在 `GameState` 中添加字段:
    ```go
    SunFlashTimer    float64 // 闪烁剩余时间 (秒)
    SunFlashCycle    float64 = 0.3 // 闪烁周期
    SunFlashDuration float64 = 1.0 // 总持续时间
    ```
  - [ ] **方案 B**: 创建独立组件 `SunCounterFlashComponent` (ECS 方式)
  - [ ] 推荐方案 A (简单,无需创建实体)
  - **文件**: `pkg/game/game_state.go`

- [ ] **Task 1.2**: 修改 `InputSystem` 检测阳光不足点击
  - [ ] 在 `handlePlantCardClick()` 中添加逻辑:
    ```go
    if currentSun < plantCost {
        // 触发阳光计数器闪烁
        gameState.SunFlashTimer = gameState.SunFlashDuration
        // 播放音效
        playBuzzerSound()
        // 阻止卡片选择
        return
    }
    ```
  - [ ] 单元测试 (模拟点击,验证闪烁触发)
  - **文件**: `pkg/systems/input_system.go`

### Phase 2: 闪烁动画实现 (2-3 小时)

- [ ] **Task 2.1**: 实现闪烁颜色计算
  - [ ] 在 `UIRenderSystem` 或 `SunCounterRenderSystem` 中
  - [ ] 实现方波闪烁逻辑:
    ```go
    func getSunFlashColor(timer float64, cycle float64) color.Color {
        // 方波: timer % cycle
        phase := math.Mod(timer, cycle)
        if phase < cycle/2 {
            return color.RGBA{255, 0, 0, 255} // 红色
        } else {
            return color.RGBA{0, 0, 0, 255}   // 黑色
        }
    }
    ```
  - [ ] 单元测试 (验证颜色切换逻辑)

- [ ] **Task 2.2**: 修改阳光计数器渲染逻辑
  - [ ] 在渲染阳光数字时,检查 `gameState.SunFlashTimer > 0`
  - [ ] 如果正在闪烁:
    - 计算闪烁颜色 `flashColor = getSunFlashColor(...)`
    - 使用 `flashColor` 渲染文本 (替代默认黑色)
  - [ ] 如果未闪烁:
    - 使用默认颜色 (黑色或黄色)
  - **文件**: `pkg/systems/ui_render_system.go` 或类似

- [ ] **Task 2.3**: 更新闪烁计时器
  - [ ] 在 `GameScene.Update()` 或 `UISystem.Update()` 中
  - [ ] 如果 `gameState.SunFlashTimer > 0`:
    ```go
    gameState.SunFlashTimer -= deltaTime
    if gameState.SunFlashTimer < 0 {
        gameState.SunFlashTimer = 0 // 停止闪烁
    }
    ```
  - **文件**: `pkg/scenes/game_scene.go` 或 `pkg/systems/ui_system.go`

### Phase 3: 音效集成 (1 小时)

- [ ] **Task 3.1**: 加载无效操作音效
  - [ ] 查找 `assets/audio/ui/buzzer.ogg` (或类似名称)
  - [ ] 在 `ResourceManager` 中加载音效
  - [ ] 如无资源,使用占位符 (静音或简单提示音)
  - **文件**: `pkg/game/resource_manager.go`

- [ ] **Task 3.2**: 在 `InputSystem` 中播放音效
  - [ ] 修改 Task 1.2 的代码,添加音效播放:
    ```go
    if currentSun < plantCost {
        gameState.SunFlashTimer = gameState.SunFlashDuration
        s.audioManager.PlaySound("buzzer") // 播放音效
        return
    }
    ```
  - [ ] 实现音效防抖 (短时间内只播放一次)
  - **文件**: `pkg/systems/input_system.go`

### Phase 4: 测试与验证 (1 小时)

- [ ] **Task 4.1**: 单元测试
  - [ ] 测试 `getSunFlashColor()` 颜色切换逻辑
  - [ ] 测试闪烁计时器更新逻辑
  - [ ] 测试阳光不足触发条件
  - [ ] 目标覆盖率: ≥ 70%

- [ ] **Task 4.2**: 集成测试
  - [ ] 关卡 1-1: 阳光 < 100 时点击豌豆射手卡片
  - [ ] 验证:
    - ✅ 阳光数字闪烁 (红 ↔ 黑)
    - ✅ 闪烁持续约 1 秒
    - ✅ 播放音效
    - ✅ 卡片无法选择
  - [ ] 边界测试:
    - 连续点击 (闪烁重置)
    - 闪烁期间收集阳光 (数字更新正常)

- [ ] **Task 4.3**: 视觉验证
  - [ ] 对比原版 PVZ:
    - 闪烁周期 (使用定时器测量)
    - 闪烁颜色 (截图对比)
    - 持续时间 (录屏分析)
  - [ ] 测量误差: ≤ 10%

- [ ] **Task 4.4**: 回归测试
  - [ ] 运行 `go test ./...` 确保无破坏
  - [ ] 验证阳光收集功能正常
  - [ ] 验证植物卡片选择正常 (阳光充足时)

---

## Technical Implementation (技术实现细节)

### 闪烁状态管理

**方案**: 在 `GameState` 中添加闪烁字段

```go
// pkg/game/game_state.go

type GameState struct {
    // ... 现有字段 ...

    // SunFlashTimer 阳光计数器闪烁剩余时间 (秒)
    // 值 > 0 时触发闪烁动画, 0 时停止
    SunFlashTimer float64

    // SunFlashCycle 闪烁周期 (秒)
    // 红色 ↔ 黑色切换周期, 默认 0.3 秒
    SunFlashCycle float64

    // SunFlashDuration 闪烁总持续时间 (秒)
    // 默认 1.0 秒 (约 3 次完整闪烁)
    SunFlashDuration float64
}

// 初始化默认值
func NewGameState() *GameState {
    return &GameState{
        // ... 现有初始化 ...
        SunFlashCycle:    0.3,
        SunFlashDuration: 1.0,
    }
}

// TriggerSunFlash 触发阳光计数器闪烁
func (gs *GameState) TriggerSunFlash() {
    gs.SunFlashTimer = gs.SunFlashDuration
}
```

### 闪烁颜色计算

```go
// pkg/systems/ui_render_system.go

import (
    "image/color"
    "math"
)

// getSunFlashColor 计算闪烁颜色 (方波)
// timer: 当前闪烁时间 (从 duration 倒计时到 0)
// cycle: 闪烁周期 (秒)
// 返回: 红色或黑色
func getSunFlashColor(timer float64, cycle float64) color.Color {
    // 方波逻辑: 根据时间模除周期,确定当前相位
    phase := math.Mod(timer, cycle)

    if phase < cycle/2 {
        return color.RGBA{R: 255, G: 0, B: 0, A: 255} // 红色 (#FF0000)
    } else {
        return color.RGBA{R: 0, G: 0, B: 0, A: 255}   // 黑色 (#000000)
    }
}

// drawSunCounter 渲染阳光计数器 (扩展现有方法)
func (s *UIRenderSystem) drawSunCounter(screen *ebiten.Image) {
    sunText := fmt.Sprintf("%d", s.gameState.Sun)

    // 确定文本颜色
    var textColor color.Color
    if s.gameState.SunFlashTimer > 0 {
        // 正在闪烁: 使用闪烁颜色
        textColor = getSunFlashColor(s.gameState.SunFlashTimer, s.gameState.SunFlashCycle)
    } else {
        // 默认颜色: 黑色或黄色
        textColor = color.RGBA{R: 0, G: 0, B: 0, A: 255}
    }

    // 使用 text.Draw 渲染文本
    // ...
    op.ColorScale.ScaleWithColor(textColor) // 应用颜色
    text.Draw(screen, sunText, font, op)
}
```

### 触发逻辑

```go
// pkg/systems/input_system.go

func (s *InputSystem) handlePlantCardClick(cardIndex int) {
    // 获取卡片信息
    plantType := s.getPlantType(cardIndex)
    plantCost := s.getPlantCost(plantType)
    currentSun := s.gameState.Sun

    // 检查阳光是否充足
    if currentSun < plantCost {
        // 阳光不足: 触发闪烁和音效
        s.gameState.TriggerSunFlash()
        s.audioManager.PlaySound("buzzer") // 或 "invalid_click"

        log.Printf("[InputSystem] 阳光不足: 需要 %d, 当前 %d", plantCost, currentSun)
        return // 阻止卡片选择
    }

    // 阳光充足: 继续现有逻辑
    // ...
}
```

---

## Success Criteria Summary (成功标准总结)

| 类别 | 标准 | 验证方法 |
|------|------|---------|
| **功能** | 阳光不足点击触发闪烁 | 集成测试 |
| **功能** | 闪烁颜色正确 (红 ↔ 黑) | 视觉验证 + 截图对比 |
| **功能** | 闪烁周期 0.3秒 ± 10% | 定时器测量 |
| **功能** | 持续时间 1.0秒 ± 10% | 录屏分析 |
| **功能** | 播放无效操作音效 | 手动测试 |
| **功能** | 闪烁期间功能正常 | 集成测试 (收集阳光) |
| **性能** | 闪烁动画保持 60 FPS | 性能测试 |
| **质量** | 单元测试覆盖率 ≥ 70% | `go test -cover` |
| **兼容性** | 现有功能无回归 | 回归测试 |

---

## Dependencies (依赖)

### 前置依赖
- ✅ Story 3.1 (植物卡片 UI) - Done
- ✅ `PlantCardSystem` 已实现
- ✅ `UIRenderSystem` 已实现

### 资源依赖
- ⚠️ `assets/audio/ui/buzzer.ogg` - 无效操作音效 (可选)
- ✅ 无需新增图像资源

### 系统依赖
- `InputSystem` - 需修改 (触发检测)
- `UIRenderSystem` - 需修改 (闪烁渲染)
- `GameState` - 需扩展 (闪烁状态)

---

## Risks and Mitigation (风险与缓解)

| 风险 | 可能性 | 影响 | 缓解措施 |
|------|--------|------|----------|
| 音效资源缺失 | Medium | Low | 使用占位符音效或静音 |
| 闪烁与收集动画冲突 | Low | Medium | 分离颜色和动画逻辑 |
| 工作量超出预期 (>6 小时) | Low | Low | 采用 MVP: 仅闪烁,音效可选 |

---

## Notes (备注)

### 音效替代方案

如果项目中缺少 `buzzer.ogg`:
- **方案 A**: 使用其他 UI 音效 (如 `tap.ogg`)
- **方案 B**: 静音 (仅视觉反馈)
- **方案 C**: 使用简单的合成音 (代码生成蜂鸣声)

**推荐**: 方案 A (使用现有音效)

### 技术债

本 Story 采用**最小化实现**:
- ✅ 方波闪烁 (非正弦波渐变)
- ✅ 固定颜色 (红/黑,不考虑其他颜色)
- ✅ 简单计时器 (无复杂动画系统)

**未来可能的增强**:
- 使用动画系统管理闪烁 (更灵活)
- 支持自定义闪烁颜色和周期 (配置文件)
- 添加闪烁时的轻微抖动效果 (原版有)

---

## Definition of Done (完成定义)

- [ ] 所有 10 个 AC 满足
- [ ] 所有 Tasks (Phase 1-4) 完成
- [ ] 单元测试覆盖率 ≥ 70%
- [ ] 集成测试通过 (关卡 1-1)
- [ ] 视觉验证通过 (闪烁周期、颜色、持续时间误差 ≤ 10%)
- [ ] 回归测试通过 (`go test ./...`)
- [ ] 代码审查通过 (符合 `CLAUDE.md` 规范)
- [ ] 文档更新完成 (Epic 10 描述)
- [ ] Git commit 并 push

---

## References (参考资料)

- **变更提案**: Sprint Change Proposal - 2025-11-24 航向修正
- **Epic 10 PRD**: `docs/prd/epic-10-game-experience-polish.md`
- **InputSystem**: `pkg/systems/input_system.go`
- **UIRenderSystem**: `pkg/systems/ui_render_system.go` (或类似)
- **GameState**: `pkg/game/game_state.go`
- **原版参考**: `.meta/prompts.md` (L143)

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-24 | 1.0 | Initial story creation (基于航向修正提案) | Bob (Scrum Master) |

---

**Story Status**: Pending → Ready for Development
