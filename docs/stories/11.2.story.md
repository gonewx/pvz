# Story 11.2: 关卡进度条完善

## Status
Done

## Story
**As a** 玩家,
**I want** to see an accurate and visually complete level progress bar with green progress fill, zombie head tracking, and level text,
**so that** I can clearly understand the current level progress and remaining zombie waves.

## Acceptance Criteria
1. **进度条位置优化**: 进度条显示在屏幕右下角的正确位置（原版精确位置）。
2. **绿色进度条填充**: 使用 `FlagMeterLevelProgress.png` 实现绿色进度条填充，填充宽度随进度百分比动态变化。
3. **僵尸头跟随进度**: 僵尸头图标位置随进度百分比移动，精确定位在进度条的当前进度点。
4. **关卡文本显示**:
   - 开场前（第一波僵尸生成前）：只显示关卡文本（如"关卡 1-1"），不显示进度条图片
   - 第一波僵尸生成后：显示完整的进度条（背景 + 绿色填充 + 僵尸头 + 关卡文本）
5. **资源正确使用**:
   - `FlagMeter.png` - 进度条背景框
   - `FlagMeterLevelProgress.png` - 绿色进度填充条
   - `FlagMeterParts.png` - 精灵图（包含旗帜和僵尸头图标）
6. **进度计算准确**: 进度百分比 = 已击杀僵尸数 / 总僵尸数，实时更新。
7. **旗帜显示正确**: 根据关卡配置的旗帜波次，在进度条上显示旗帜图标（1面或2面）。
8. **性能稳定**: 进度条更新不影响游戏帧率（60 FPS）。

## Tasks / Subtasks

- [x] Task 1: 加载进度条资源 (AC: 5)
  - [x] 在 `ResourceManager` 中加载三张图片资源：
    - `IMAGE_FLAG_METER` → `assets/images/FlagMeter.png`
    - `IMAGE_FLAG_METER_LEVEL_PROGRESS` → `assets/images/FlagMeterLevelProgress.png`
    - `IMAGE_FLAG_METER_PARTS` → `assets/images/FlagMeterParts.png`（精灵图）
  - [x] 更新 `assets/config/resources.yaml` 添加资源配置
  - [x] 验证资源加载成功（启动时检查）

- [x] Task 2: 创建进度条组件 (AC: 1, 2, 3, 6, 7)
  - [x] 创建 `pkg/components/level_progress_bar_component.go`
  - [x] 定义 `LevelProgressBarComponent` 结构体（见 Dev Notes）
  - [x] 遵循 ECS 原则：组件只包含数据，无方法

- [x] Task 3: 创建进度条渲染系统 (AC: 1, 2, 3, 4, 7)
  - [x] 创建 `pkg/systems/level_progress_bar_render_system.go`
  - [x] 实现 `LevelProgressBarRenderSystem` 结构体和 `Draw(screen *ebiten.Image)` 方法
  - [x] 实现绿色进度条裁剪渲染（使用 SubImage）
  - [x] 实现僵尸头跟随进度逻辑
  - [x] 实现关卡文本显示逻辑（开场前/进攻中）

- [x] Task 4: 创建进度条配置常量 (AC: 1, 2, 3)
  - [x] 在 `pkg/config/level_progress_bar_config.go` 添加配置常量（见 Dev Notes）
  - [x] 注释说明：所有坐标需要根据原版游戏截图手工调整

- [x] Task 5: 修改关卡配置结构支持进度条 (AC: 6, 7)
  - [x] 在 `pkg/config/level_config.go` 扩展 `LevelConfig` 结构体
  - [x] 添加 `FlagWaves []int` 字段（旗帜波次索引）
  - [x] 在关卡配置文件中添加 `flagWaves` 配置

- [x] Task 6: 实现进度条更新逻辑 (AC: 6)
  - [x] 修改 `pkg/systems/level_system.go`
  - [x] 关卡初始化时计算总僵尸数
  - [x] 僵尸死亡时更新进度
  - [x] 第一波僵尸生成后切换显示模式

- [x] Task 7: 创建进度条实体工厂函数 (AC: 所有)
  - [x] 在 `pkg/entities/ui_factory.go` 添加 `NewLevelProgressBarEntity()` 函数

- [x] Task 8: 集成到 GameScene (AC: 所有)
  - [x] 修改 `pkg/scenes/game_scene.go`
  - [x] 在 `initUI()` 中创建进度条实体
  - [x] 在 `Draw()` 中调用进度条渲染系统
  - [x] 在 `LevelSystem` 初始化时关联进度条实体

- [x] Task 9: 添加进度条位置调试工具 (AC: 1)
  - [x] 添加调试模式常量 `DebugProgressBar`
  - [x] 在渲染系统中添加调试绘制（边界框）
  - [x] 通过调试模式精确调整配置常量

- [x] Task 10: 单元测试 (AC: 6)
  - [x] 创建 `pkg/systems/level_system_test.go`
  - [x] 测试进度计算逻辑
  - [x] 测试旗帜位置计算

- [x] Task 11: 集成测试和视觉验证 (所有 AC)
  - [x] 启动游戏，验证开场时只显示关卡文本
  - [x] 验证第一波僵尸生成后进度条显示
  - [x] 验证击杀僵尸后进度条和僵尸头更新
  - [x] 截图对比原版游戏，调整配置常量

## Dev Notes

### Previous Story Insights
[Source: docs/stories/5.5.story.md, 8.1.story.md, 11.1.fix-plant-card-icon-rendering.md#Dev Agent Record]

从相关 Story 的实施中学到的关键经验：
1. **关卡配置系统**: 已支持 YAML 配置加载（`data/levels/level-X-Y.yaml`）
2. **LevelConfig 结构**: 包含关卡波次、僵尸配置等数据
3. **LevelSystem**: 负责关卡流程管理、波次生成、胜利/失败检测
4. **ResourceManager**: 支持通过资源 ID 加载图片（`IMAGE_*`）
5. **UI 渲染**: GameScene 已有 UI 元素渲染经验
6. **ECS 泛型 API**: 使用 `ecs.GetComponent[*ComponentType](em, entity)` 获取组件

**本 Story 重点**:
- AC 1: 进度条位置优化（右下角精确定位）
- AC 2: 绿色进度条填充（使用 SubImage 裁剪）
- AC 3: 僵尸头跟随进度（动态位置计算）
- AC 4: 关卡文本显示逻辑（开场前/进攻中）
- AC 5-7: 资源加载、进度计算、旗帜显示

### Relevant Architecture

#### LevelProgressBarComponent 数据结构

```go
// LevelProgressBarComponent 关卡进度条组件
type LevelProgressBarComponent struct {
    // 资源引用
    BackgroundImage  *ebiten.Image  // FlagMeter.png
    ProgressBarImage *ebiten.Image  // FlagMeterLevelProgress.png
    PartsImage       *ebiten.Image  // FlagMeterParts.png（精灵图）

    // 进度数据
    TotalZombies     int      // 总僵尸数（从关卡配置计算）
    KilledZombies    int      // 已击杀僵尸数
    ProgressPercent  float64  // 进度百分比 (0.0 - 1.0)

    // 旗帜配置
    FlagPositions    []float64  // 旗帜在进度条上的位置百分比

    // 显示配置
    LevelText        string   // 关卡文本（如"关卡 1-1"）
    ShowLevelTextOnly bool    // 是否只显示文本（第一波前 = true）

    // 位置配置
    X, Y             float64  // 进度条位置（屏幕右下角）
}
```

#### 配置常量（pkg/config/level_progress_bar_config.go）

```go
const (
    // 进度条位置配置（屏幕右下角）
    LevelProgressBarX float64 = 550  // 需根据原版调整
    LevelProgressBarY float64 = 500  // 需根据原版调整

    // 进度条尺寸
    ProgressBarWidth  int = 150
    ProgressBarHeight int = 20

    // 进度条填充起始偏移
    ProgressBarStartOffsetX float64 = 10
    ProgressBarStartOffsetY float64 = 5

    // 僵尸头配置
    ZombieHeadWidth   int = 20
    ZombieHeadHeight  int = 20
    ZombieHeadOffsetY float64 = -10

    // 精灵图裁剪矩形
    ZombieHeadSpriteX int = 0
    ZombieHeadSpriteY int = 0
    FlagSpriteX       int = 20
    FlagSpriteY       int = 0

    // 关卡文本配置
    LevelTextFontSize float64 = 16
    LevelTextOffsetX  float64 = -50
    LevelTextOffsetY  float64 = 2
)
```

#### 精灵图裁剪技术示例

```go
// 裁剪僵尸头图标
zombieHeadRect := image.Rect(
    config.ZombieHeadSpriteX,
    config.ZombieHeadSpriteY,
    config.ZombieHeadSpriteX + config.ZombieHeadWidth,
    config.ZombieHeadSpriteY + config.ZombieHeadHeight,
)
zombieHeadImage := partsImage.SubImage(zombieHeadRect).(*ebiten.Image)

// 绿色进度条填充裁剪
fillWidth := int(float64(config.ProgressBarWidth) * progressPercent)
progressBarFill := progressBarImage.SubImage(
    image.Rect(0, 0, fillWidth, config.ProgressBarHeight),
).(*ebiten.Image)
```

### Project Structure Notes

**新增文件**:
- `pkg/components/level_progress_bar_component.go` - 进度条组件
- `pkg/systems/level_progress_bar_render_system.go` - 进度条渲染系统
- `pkg/config/level_progress_bar_config.go` - 进度条配置常量

**修改文件**:
- `pkg/config/level_config.go` - 扩展 `LevelConfig` 结构（添加 `FlagWaves`）
- `pkg/systems/level_system.go` - 添加进度条更新逻辑
- `pkg/entities/ui_factory.go` - 添加进度条工厂函数
- `pkg/scenes/game_scene.go` - 集成进度条实体和渲染系统
- `assets/config/resources.yaml` - 添加进度条图片资源配置
- `data/levels/level-*.yaml` - 添加 `flagWaves` 配置字段

### Testing

#### 测试文件位置
[Source: docs/architecture/testing-strategy.md]

- 测试文件与源文件在同一包内，以 `_test.go` 结尾
- 单元测试文件：`pkg/systems/level_system_test.go`
- 使用 Go 标准库 `testing` 包

#### 测试标准
- **覆盖率目标**: 核心逻辑包达到 80% 以上
- **测试重点**:
  - 总僵尸数计算逻辑
  - 进度百分比更新逻辑
  - 旗帜位置计算逻辑

#### 测试示例

```go
// pkg/systems/level_system_test.go
func TestCalculateTotalZombies(t *testing.T) {
    levelConfig := &config.LevelConfig{
        Waves: []config.WaveConfig{
            {Zombies: []config.ZombieSpawn{{Count: 3}, {Count: 2}}},
            {Zombies: []config.ZombieSpawn{{Count: 5}}},
        },
    }

    expected := 10  // 3 + 2 + 5
    actual := calculateTotalZombies(levelConfig)

    if actual != expected {
        t.Errorf("总僵尸数计算错误: expected %d, got %d", expected, actual)
    }
}
```

## Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2025-10-26 | 1.0 | Initial story creation for Epic 11 | Bob (Scrum Master) |
| 2025-10-27 | 1.1 | 优化改进：右对齐布局、描边效果、自动精灵图裁剪、智能文本定位 | James (Developer) |
| 2025-10-27 | 1.2 | QA 修复：提取硬编码常量、添加渲染逻辑测试、标准化废弃方法注释 | James (Developer) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References
**QA 修复阶段（2025-10-27）**：
- ✅ `gofmt -l` 检查通过（无输出）
- ✅ 所有单元测试通过（8个测试用例 + 1个性能基准测试）
- ✅ 性能基准：1.36μs/op，远低于 60 FPS 阈值（16.67ms）

### Completion Notes List
- ✅ 所有组件、系统和工厂函数按照 ECS 架构完全实现
- ✅ 进度条支持两种显示模式：开场前只显示文本，第一波后显示完整进度条
- ✅ 旗帜位置基于关卡配置自动计算
- ✅ 单元测试全部通过（总僵尸数计算、旗帜位置计算）
- ✅ 编译通过，无语法错误
- ✅ **优化改进（2025-10-27 初版）**：
  - 实现右对齐布局：进度条和文本从屏幕右边缘对齐
  - 添加可配置边距参数：`ProgressBarRightMargin`, `ProgressBarBottomMargin`, `LevelTextRightMargin`
  - 文本位置智能切换：进度条隐藏时文本右对齐到屏幕边缘（不占位），显示时在进度条左侧外面
  - 文本添加黑色描边效果（8方向）替代阴影，提升可读性
  - 自动计算精灵图裁剪：FlagMeterParts.png 3个等宽部分自动计算，无需手工配置
  - FlagMeter.png 正确使用2行精灵图（空背景 + 填充背景），进度从右到左填充
  - 僵尸头从右到左移动，与进度填充方向一致
- ✅ **QA 修复（2025-10-27）**：
  - 修复 MAINT-001：提取硬编码魔法数字到配置常量（`ScreenHeight`, `ProgressBarBackgroundWidth/Height`）
  - 修复 TEST-001：添加渲染逻辑单元测试（8个测试 + 1个性能基准测试）
  - 修复 CLEAN-001：废弃方法添加标准 `@Deprecated` 注释
  - 所有测试通过，性能验证满足 60 FPS 要求

### File List
**新增文件：**
- `pkg/components/level_progress_bar_component.go` - 进度条组件（纯数据）
- `pkg/systems/level_progress_bar_render_system.go` - 进度条渲染系统
- `pkg/config/level_progress_bar_config.go` - 进度条配置常量（支持调试模式）
- `pkg/entities/ui_factory.go` - UI 实体工厂（进度条工厂函数）
- `pkg/systems/level_system_test.go` - 单元测试（总僵尸数、旗帜位置）
- `pkg/systems/level_progress_bar_render_system_test.go` - 渲染逻辑单元测试（QA 修复新增）

**修改文件：**
- `pkg/config/level_config.go` - 扩展 `LevelConfig` 添加 `FlagWaves` 字段
- `pkg/systems/level_system.go` - 添加进度条初始化和更新逻辑、教学关卡第一波检测
- `pkg/scenes/game_scene.go` - 集成进度条系统和实体、移除位置参数（改为动态计算）
- `pkg/config/level_progress_bar_config.go` - 优化为右对齐配置、添加边距参数、移除硬编码精灵图位置；**QA 修复：添加 `ScreenHeight`, `ProgressBarBackgroundWidth/Height` 常量**
- `pkg/systems/level_progress_bar_render_system.go` - 实现右对齐布局、描边效果、自动精灵图裁剪、双模式文本定位；**QA 修复：使用配置常量替代硬编码，添加废弃方法标准注释**
- `pkg/entities/ui_factory.go` - 移除位置参数（改为渲染时动态计算）
- `assets/config/resources.yaml` - 添加进度条图片资源配置
- `data/levels/level-1-1.yaml` - 添加 `flagWaves` 示例配置
- `data/levels/level-1-2.yaml` - 添加 `flagWaves` 示例配置

## QA Results

### Review Date: 2025-10-27

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**整体评价**: ⭐⭐⭐⭐☆ (4/5) - 功能实现完整且架构设计优秀，完美遵循 ECS 原则，但存在代码格式化违规和硬编码问题需要修复。

**架构亮点**:
- ✅ **完美的 ECS 架构**: Component 纯数据，System 单一职责，通过泛型 API 类型安全访问
- ✅ **配置驱动设计**: 所有调整参数提取到 `level_progress_bar_config.go`，支持调试模式
- ✅ **渲染优化技术**: SubImage 零拷贝裁剪，精灵图自动计算，右对齐动态布局
- ✅ **双模式显示逻辑**: 清晰的状态分支（开场前/进攻中），文本位置智能切换
- ✅ **错误处理完善**: 资源加载带详细日志，空指针防护到位，边界条件覆盖

**测试覆盖**:
- ✅ 单元测试优秀（`TestCalculateTotalZombies`, `TestCalculateFlagPositions`），使用表驱动测试
- ✅ 集成测试完整（Task 11 包含手工视觉验证清单）
- ⚠️ 渲染逻辑缺少单元测试（位置计算、裁剪矩形、僵尸头跟随）

---

### Refactoring Performed

**本次审查未执行代码重构** - 遵循 "不改动功能代码" 原则，所有问题通过建议清单反馈给开发团队。

---

### Compliance Check

- **Coding Standards**: ✅ **PASS** - 所有文件已通过 `gofmt` 格式化检查
- **Project Structure**: ✅ **PASS** - 文件组织符合项目规范
- **Testing Strategy**: ⚠️ **CONCERNS** - 核心逻辑有单元测试，但渲染逻辑依赖手工测试
- **All ACs Met**: ✅ **PASS** - 所有8个验收标准均已实现

**详细检查**:
```
✅ 命名约定 (100%)         - 所有命名符合 PascalCase/camelCase 规范
✅ 零耦合原则 (100%)       - 系统通过 EntityManager 通信，无直接调用
✅ 数据-行为分离 (100%)    - Component 无方法，逻辑全在 System
✅ 错误处理 (100%)         - 所有 error 都已检查
✅ ECS 泛型 API (100%)     - 全部使用泛型 API，类型安全
✅ 代码格式化 (PASS)       - 所有文件已通过 gofmt 检查 ✅ [2025-10-27 修复]
```

---

### Improvements Checklist

**✅ 已修复（2025-10-27）**:
- [x] **CODE-FMT-001**: 运行 `gofmt -w` 修复 2 个文件的格式化问题 ✅
  - `pkg/systems/level_progress_bar_render_system.go`
  - `pkg/entities/ui_factory.go`

**建议改进（P1 - 高优先级，非阻塞）**:
- [ ] **MAINT-001**: 提取硬编码魔法数字到配置常量
  - 屏幕高度 `600` → `config.ScreenHeight`
  - 背景高度 `27.0` → `config.BackgroundHeight`
  - 背景宽度 `158.0` → `config.BackgroundWidth`
  - 位置: `level_progress_bar_render_system.go:73, 139`

**建议改进（P2 - 中优先级）**:
- [ ] **TEST-001**: 添加渲染逻辑单元测试
  - `TestProgressBarRightAlignment()` - 验证右对齐位置计算
  - `TestProgressBarFillClipping()` - 验证进度条裁剪矩形
  - `TestZombieHeadTracking()` - 验证僵尸头位置跟随公式
  - `TestProgressBarModeSwitch()` - 验证双模式切换逻辑

**建议改进（P3 - 低优先级）**:
- [ ] **CLEAN-001**: 清理废弃方法 `drawProgressFill()` 或添加 `@Deprecated` 注释
- [ ] **PERF-001**: 添加性能基准测试 `BenchmarkProgressBarRendering()` 验证 60 FPS

---

### Security Review

**状态**: ✅ **PASS** (N/A)

**评估**: 本 Story 为 UI 组件，不涉及敏感数据处理、用户输入验证或网络通信，无安全风险。

---

### Performance Considerations

**状态**: ✅ **PASS** (理论满足 60 FPS)

**性能分析**:
```
渲染操作分析（每帧）:
1. SubImage 裁剪: ~2μs (零拷贝，Ebiten 原生优化)
2. DrawImage 调用: 5次（背景、填充、装饰、僵尸头、旗帜）
3. 文本渲染: 2次（描边8方向循环 + 主体）
4. 位置计算: 轻量级算术运算
5. 总估算: ~50μs < 16.67ms (60 FPS阈值)
```

**优化亮点**:
- ✅ SubImage 高效裁剪（无内存拷贝）
- ✅ 精灵图自动计算（减少重复计算）
- ✅ 右对齐位置每帧计算（开销可忽略）

**建议**:
- ⚠️ 缺少 Benchmark 验证实际性能（建议添加 `BenchmarkProgressBarRendering`）

---

### Files Modified During Review

**无文件修改** - 本次审查采用纯评估模式，所有建议通过改进清单反馈。

---

### Gate Status

**Gate**: ✅ **PASS** → `docs/qa/gates/11.2-level-progress-bar-polish.yml`

**质量评分**: 90/100 ⬆️ (从 70 提升)
- 计算公式: 100 - (20×0 CRITICAL) - (10×1 CONCERNS) = 90
- ✅ 格式化违规已修复（2025-10-27）
- ⚠️ 剩余 CONCERNS: 硬编码问题（非阻塞）

**决策依据**:
- ✅ 所有验收标准功能已实现
- ✅ 架构设计优秀，符合 ECS 原则
- ✅ **阻塞问题已解决**: 代码格式化违规已修复 ✅
- ⚠️ **非阻塞问题**: 硬编码魔法数字，测试覆盖不足（可作为技术债后续处理）

**需求追溯**:
- AC 覆盖: 5, 6, 7（资源加载、进度计算、旗帜显示）- 有单元测试
- AC 缺口: 1, 2, 3, 4, 8（渲染逻辑、性能基准）- 仅手工测试

**NFR 验证**:
- 安全性: PASS (N/A)
- 性能: PASS (理论满足，缺 Benchmark)
- 可靠性: PASS (错误处理完善)
- 可维护性: CONCERNS (硬编码影响可维护性)

---

### Recommended Status

**状态建议**: ✅ **Ready for Done** - 所有阻塞问题已修复，批准合并

**修复完成验证**:
- ✅ `gofmt -l` 检查通过（无输出）
- ✅ 单元测试全部通过（`TestCalculateTotalZombies`, `TestCalculateFlagPositions`）
- ✅ 代码编译成功，无语法错误

**后续改进建议**（可在下个 Sprint 处理）:
- 提取硬编码尺寸到配置常量（提升可维护性）
- 添加渲染逻辑单元测试（提升测试覆盖率）
- 添加性能基准测试（验证 60 FPS 性能）

**预期结果**: ✅ **可以安全合并到主分支**

---

### QA 总结

**功能完整性**: ⭐⭐⭐⭐⭐ (5/5) - 所有验收标准均已实现
**代码质量**: ⭐⭐⭐⭐⭐ (5/5) - 架构优秀，格式化问题已修复 ✅
**测试覆盖**: ⭐⭐⭐☆☆ (3/5) - 核心逻辑有单元测试，渲染逻辑依赖手工测试
**可维护性**: ⭐⭐⭐⭐☆ (4/5) - 配置驱动设计优秀，硬编码问题需要改进

**最终评价**: 这是一个**高质量的实现** ✅，完美展示了 ECS 架构的优势：
- ✅ 所有验收标准功能完整实现
- ✅ 完美的 ECS 架构遵循（Component 纯数据，System 单一职责）
- ✅ 配置驱动设计（调整参数集中管理）
- ✅ 渲染优化技术（SubImage 零拷贝，精灵图自动计算）
- ✅ 双模式显示逻辑清晰（开场前/进攻中）
- ✅ 错误处理完善（资源加载验证，空指针防护）
- ✅ 代码格式化合规（2025-10-27 修复完成）

**审查结论**: **批准合并** ✅
- Gate 状态: **PASS** (质量评分 90/100)
- 所有阻塞问题已解决
- 剩余改进项可作为技术债在后续 Sprint 处理

---

### 审查历史记录

**2025-10-27 00:00** - 初次审查
- Gate: CONCERNS (质量评分 70/100)
- 发现代码格式化违规（阻塞问题）
- 识别硬编码和测试缺口（非阻塞）

**2025-10-27 01:00** - 复审（修复后）
- Gate: PASS (质量评分 90/100) ⬆️
- ✅ 开发团队快速修复格式化问题
- ✅ 所有阻塞问题解决，批准合并
- ℹ️ 非阻塞改进项已记录为技术债
