# Story 5.4.1: çˆ†ç‚¸æ­»äº¡çƒ§ç„¦åŠ¨ç”»

## Status
Ready for Review

## Story
**As a** ç©å®¶,  
**I want** åƒµå°¸è¢«çˆ†ç‚¸ç±»æ”»å‡»æ€æ­»æ—¶æ’­æ”¾ä¸“ç”¨çš„çƒ§ç„¦é»‘åŒ–åŠ¨ç”»,  
**so that** æˆ‘èƒ½çœ‹åˆ°ä¸åŸç‰ˆæ¸¸æˆä¸€è‡´çš„è§†è§‰æ•ˆæœï¼Œå¢å¼ºæ¸¸æˆæ²‰æµ¸æ„Ÿã€‚

## Context (ä¸Šä¸‹æ–‡)

### é—®é¢˜èƒŒæ™¯

**å½“å‰çŠ¶æ€**ï¼šStory 5.4 å®ç°äº†æ¨±æ¡ƒç‚¸å¼¹çš„çˆ†ç‚¸ä¼¤å®³åŠŸèƒ½ï¼ˆ3x3 èŒƒå›´ï¼Œ1800 ä¼¤å®³ï¼‰ï¼Œä½†åƒµå°¸è¢«çˆ†ç‚¸æ€æ­»æ—¶æ’­æ”¾çš„æ˜¯æ™®é€šæ­»äº¡åŠ¨ç”»ï¼ˆå¤´éƒ¨æ‰è½ï¼‰ï¼Œä¸åŸç‰ˆæ¸¸æˆä¸ç¬¦ã€‚

**åŸç‰ˆæ¸¸æˆè¡Œä¸º**ï¼šåƒµå°¸è¢«çˆ†ç‚¸ç±»æ”»å‡»ï¼ˆæ¨±æ¡ƒç‚¸å¼¹ã€åœŸè±†é›·ã€è¾£æ¤’ç­‰ï¼‰æ€æ­»æ—¶ï¼Œåº”è¯¥æ’­æ”¾ä¸“ç”¨çš„çƒ§ç„¦é»‘åŒ–åŠ¨ç”»ï¼ˆ`Zombie_charred*.png`ï¼‰ï¼Œä¸æ™®é€šæ­»äº¡ã€å‹æ‰æ­»äº¡åŒºåˆ†å¼€æ¥ã€‚

**èµ„æºç¡®è®¤**ï¼šæ¸¸æˆèµ„æºä¸­å·²åŒ…å«å®Œæ•´çš„çƒ§ç„¦åŠ¨ç”»èµ„æºï¼š
- `assets/reanim/Zombie_charred1.png` ~ `Zombie_charred10.png` (10å¸§)
- `assets/reanim/Zombie_charred_head.png` (çƒ§ç„¦å¤´éƒ¨)
- `assets/reanim/Zombie_charred_eyes1.png`, `Zombie_charred_eyes2.png` (çƒ§ç„¦çœ¼ç›)

### æŠ€æœ¯èƒŒæ™¯

**å‚è€ƒå®ç°**ï¼šStory 10.6 å®ç°äº†é™¤è‰è½¦ç¢¾å‹çš„å‹æ‰æ­»äº¡åŠ¨ç”»ï¼Œæä¾›äº†æˆç†Ÿçš„å¤šæ­»äº¡ç±»å‹å¤„ç†æ¨¡å¼ï¼š
- å®šä¹‰ä¸“ç”¨è¡Œä¸ºç±»å‹ `BehaviorZombieSquashing`
- åœ¨è§¦å‘æ­»äº¡æ—¶è®¾ç½®ç‰¹å®šè¡Œä¸ºç±»å‹
- BehaviorSystem è¯†åˆ«å¹¶å¤„ç†ä¸“ç”¨æ­»äº¡è¡Œä¸º
- æ’­æ”¾ä¸“ç”¨åŠ¨ç”»ï¼ŒåŠ¨ç”»ç»“æŸååˆ é™¤åƒµå°¸

**å½“å‰æ¶æ„**ï¼š
- æ‰€æœ‰æ­»äº¡æ–¹å¼ç»Ÿä¸€ä½¿ç”¨ `BehaviorZombieDying` è¡Œä¸ºç±»å‹
- æ— æ­»äº¡åŸå› åˆ¤å®šæœºåˆ¶
- BehaviorSystem ä»…å¤„ç†å•ä¸€æ­»äº¡åŠ¨ç”»

## Acceptance Criteria (éªŒæ”¶æ ‡å‡†)

1. **AC 1**: åƒµå°¸è¢«æ¨±æ¡ƒç‚¸å¼¹æ€æ­»æ—¶æ’­æ”¾çƒ§ç„¦åŠ¨ç”»è€Œéæ™®é€šæ­»äº¡åŠ¨ç”»
2. **AC 2**: åƒµå°¸è¢«åœŸè±†é›·æ€æ­»æ—¶æ’­æ”¾çƒ§ç„¦åŠ¨ç”»ï¼ˆæœªæ¥å®ç°åœŸè±†é›·æ—¶ç”Ÿæ•ˆï¼‰
3. **AC 3**: çƒ§ç„¦åŠ¨ç”»ä½¿ç”¨æ­£ç¡®çš„èµ„æº (`Zombie_charred*.png`ï¼Œ10å¸§)
4. **AC 4**: çƒ§ç„¦åŠ¨ç”»æ’­æ”¾å®Œæˆååƒµå°¸æ­£ç¡®åˆ é™¤ï¼Œå¢åŠ æ¶ˆç­è®¡æ•°
5. **AC 5**: æ™®é€šæ­»äº¡æ–¹å¼ï¼ˆè±Œè±†å°„æ‰‹ï¼‰ä¸å—å½±å“ï¼Œä»æ’­æ”¾æ™®é€šæ­»äº¡åŠ¨ç”»
6. **AC 6**: é™¤è‰è½¦å‹æ‰æ­»äº¡ä¸å—å½±å“ï¼Œä»æ’­æ”¾å‹æ‰åŠ¨ç”»

## Dev Notes

### Previous Story Insights

**Story 5.4 (æ¨±æ¡ƒç‚¸å¼¹è¡Œä¸ºå®ç°)**ï¼š
- âœ… å®ç°äº† 3x3 èŒƒå›´çˆ†ç‚¸ä¼¤å®³è®¡ç®—
- âœ… çˆ†ç‚¸å¯¹åƒµå°¸é€ æˆ 1800 ç‚¹ä¼¤å®³
- âœ… ä½¿ç”¨ `triggerCherryBombExplosion()` æ–¹æ³•å¤„ç†çˆ†ç‚¸é€»è¾‘
- âŒ åƒµå°¸æ­»äº¡æ—¶ç»Ÿä¸€è®¾ç½®ä¸º `BehaviorZombieDying`

**Story 10.6 (é™¤è‰è½¦å‹æ‰åŠ¨ç”»)**ï¼š
- âœ… å®ç°äº†ä¸“ç”¨æ­»äº¡è¡Œä¸ºç±»å‹ `BehaviorZombieSquashing`
- âœ… ä½¿ç”¨ `handleZombieSquashingBehavior()` å¤„ç†å‹æ‰æ­»äº¡
- âœ… æä¾›äº†å¤šæ­»äº¡ç±»å‹å¤„ç†çš„æ¶æ„å‚è€ƒ

### Data Models

**éœ€è¦æ·»åŠ çš„ç»„ä»¶**ï¼š

1. **æ–°çš„è¡Œä¸ºç±»å‹å¸¸é‡** (`pkg/components/behavior.go`)
   ```go
   // BehaviorZombieDyingExplosion åƒµå°¸æ­»äº¡ä¸­ï¼ˆçˆ†ç‚¸çƒ§ç„¦æ­»äº¡åŠ¨ç”»ï¼‰
   // åŒºåˆ«äºæ™®é€šæ­»äº¡ (BehaviorZombieDying) å’Œå‹æ‰æ­»äº¡ (BehaviorZombieSquashing)
   // å½“åƒµå°¸è¢«çˆ†ç‚¸ç±»æ”»å‡»ï¼ˆæ¨±æ¡ƒç‚¸å¼¹ã€åœŸè±†é›·ç­‰ï¼‰æ€æ­»æ—¶ä½¿ç”¨
   BehaviorZombieDyingExplosion BehaviorType = iota + N
   ```

2. **æ­»äº¡ç±»å‹å¯¹ç…§è¡¨**ï¼š

   | è¡Œä¸ºç±»å‹ | æ­»äº¡åŸå›  | åŠ¨ç”»èµ„æº | å®ç° Story |
   |---------|----------|----------|-----------|
   | `BehaviorZombieDying` | æ™®é€šæ”»å‡»ï¼ˆè±Œè±†ã€åšæœï¼‰ | `ZombieDie_*.png` | Story 4.4 |
   | `BehaviorZombieDyingExplosion` | çˆ†ç‚¸æ”»å‡»ï¼ˆæ¨±æ¡ƒç‚¸å¼¹ã€åœŸè±†é›·ï¼‰ | `Zombie_charred*.png` | **æœ¬ Story** |
   | `BehaviorZombieSquashing` | é™¤è‰è½¦ç¢¾å‹ | `LawnMoweredZombie.reanim` | Story 10.6 |

### File Locations and Structure

```plaintext
pkg/
â”œâ”€â”€ components/
â”‚   â””â”€â”€ behavior.go                      # ä¿®æ”¹ï¼šæ·»åŠ  BehaviorZombieDyingExplosion
â”œâ”€â”€ systems/
â”‚   â””â”€â”€ behavior/
â”‚       â””â”€â”€ zombie_behavior_handler.go   # ä¿®æ”¹ï¼šæ·»åŠ  handleZombieDyingExplosionBehavior()
â”‚       â””â”€â”€ cherry_bomb_handler.go       # ä¿®æ”¹ï¼šçˆ†ç‚¸æ—¶è®¾ç½®çƒ§ç„¦æ­»äº¡ç±»å‹
â””â”€â”€ game/
    â””â”€â”€ resource_manager.go              # æ£€æŸ¥ï¼šç¡®è®¤çƒ§ç„¦åŠ¨ç”»èµ„æºåŠ è½½
```

### Resource Files Available

**âœ… å…³é”®å‘ç°ï¼šçƒ§ç„¦åŠ¨ç”»ä½¿ç”¨ Reanim ç³»ç»Ÿ**

ç»è¿‡ä»£ç è°ƒæŸ¥ç¡®è®¤ï¼Œçƒ§ç„¦æ­»äº¡åŠ¨ç”»**ä¸æ˜¯**å›¾ç‰‡åºåˆ—ï¼Œè€Œæ˜¯ä½¿ç”¨ **Reanim éª¨éª¼åŠ¨ç”»ç³»ç»Ÿ**ï¼š

**Reanim æ–‡ä»¶**ï¼š
- ğŸ“ `data/reanim/Zombie_charred.reanim` âœ… **å·²ç¡®è®¤å­˜åœ¨**
- è¿™æ˜¯ä¸€ä¸ªå®Œæ•´çš„ Reanim åŠ¨ç”»å®šä¹‰æ–‡ä»¶ï¼ŒåŒ…å«çƒ§ç„¦åƒµå°¸çš„éª¨éª¼åŠ¨ç”»

**Reanim éƒ¨ä»¶å›¾ç‰‡**ï¼š
- `assets/reanim/Zombie_charred1.png` ~ `Zombie_charred10.png` (10ä¸ªèº«ä½“éƒ¨ä»¶)
- `assets/reanim/Zombie_charred_head.png` (çƒ§ç„¦å¤´éƒ¨)
- `assets/reanim/Zombie_charred_eyes1.png`, `Zombie_charred_eyes2.png` (çƒ§ç„¦çœ¼ç›)

**åŠ¨ç”»é…ç½®**ï¼š
- åŠ¨ç”»ç³»ç»Ÿï¼š**Reanim éª¨éª¼åŠ¨ç”»** (ä¸æ™®é€šåƒµå°¸æ­»äº¡ç›¸åŒæœºåˆ¶)
- åŠ¨ç”»åç§°ï¼š`anim_death` (Zombie_charred.reanim ä¸­çš„æ­»äº¡åŠ¨ç”»è½¨é“)
- å¾ªç¯ï¼šå¦ (éå¾ªç¯åŠ¨ç”»ï¼Œæ’­æ”¾ä¸€æ¬¡ååˆ é™¤åƒµå°¸)

### Technical Constraints

- **ECS é›¶è€¦åˆåŸåˆ™**ï¼šç³»ç»Ÿé—´é€šè¿‡ç»„ä»¶é€šä¿¡ï¼Œä¸ç›´æ¥è°ƒç”¨
- **æ¶æ„ä¸€è‡´æ€§**ï¼šéµå¾ª Story 10.6 å‹æ‰åŠ¨ç”»çš„å®ç°æ¨¡å¼
- **æ€§èƒ½è¦æ±‚**ï¼šçƒ§ç„¦åŠ¨ç”»ä¸æ™®é€šæ­»äº¡åŠ¨ç”»æ€§èƒ½ç›¸åŒï¼Œæ— é¢å¤–å¼€é”€
- **å¯æ‰©å±•æ€§**ï¼šä¸ºæœªæ¥çš„å…¶ä»–çˆ†ç‚¸ç±»æ”»å‡»ï¼ˆåœŸè±†é›·ã€è¾£æ¤’ç­‰ï¼‰å¥ å®šåŸºç¡€

### Implementation Strategy

**å®æ–½é˜¶æ®µ**ï¼š

#### Phase 1: æ·»åŠ çƒ§ç„¦æ­»äº¡è¡Œä¸ºç±»å‹
1. åœ¨ `behavior.go` ä¸­æ·»åŠ  `BehaviorZombieDyingExplosion` å¸¸é‡
2. æ·»åŠ è¯¦ç»†çš„ GoDoc æ³¨é‡Šè¯´æ˜ä½¿ç”¨åœºæ™¯

#### Phase 2: ä¿®æ”¹çˆ†ç‚¸æ”»å‡»é€»è¾‘
1. ä¿®æ”¹ `cherry_bomb_handler.go:triggerCherryBombExplosion()`
2. åƒµå°¸æ­»äº¡æ—¶è®¾ç½® `BehaviorZombieDyingExplosion` è€Œé `BehaviorZombieDying`
3. ä¸ºæœªæ¥åœŸè±†é›·ç­‰çˆ†ç‚¸æ”»å‡»é¢„ç•™æ¥å£

#### Phase 3: å®ç°çƒ§ç„¦æ­»äº¡è¡Œä¸ºå¤„ç†

**âœ… æ­£ç¡®çš„åŠ¨ç”»æ’­æ”¾æœºåˆ¶**ï¼ˆå‚è€ƒæ™®é€šæ­»äº¡åŠ¨ç”» `triggerZombieDeath`ï¼‰ï¼š

1. ä½¿ç”¨ **AnimationCommand ç»„ä»¶**æ’­æ”¾ Reanim åŠ¨ç”»ï¼š
   ```go
   // æ’­æ”¾çƒ§ç„¦æ­»äº¡åŠ¨ç”»ï¼ˆReanim ç³»ç»Ÿï¼‰
   ecs.AddComponent(s.entityManager, entityID, &components.AnimationCommandComponent{
       UnitID:    "zombie_charred",  // æŒ‡å‘ Zombie_charred.reanim
       ComboName: "death",            // é…ç½®é©±åŠ¨çš„åŠ¨ç”»ç»„åˆ
       Processed: false,
   })
   
   // è®¾ç½®ä¸ºä¸å¾ªç¯
   if reanim, ok := ecs.GetComponent[*components.ReanimComponent](s.entityManager, entityID); ok {
       reanim.IsLooping = false
   }
   ```

2. åœ¨ `handleZombieDyingExplosionBehavior()` ä¸­ç›‘æ§åŠ¨ç”»å®Œæˆï¼š
   - æ£€æŸ¥ `reanim.IsFinished` æ ‡å¿—
   - åŠ¨ç”»å®Œæˆååˆ é™¤åƒµå°¸å®ä½“
   - å¢åŠ åƒµå°¸æ¶ˆç­è®¡æ•°

**å…³é”®åŒºåˆ«**ï¼š
- æ™®é€šæ­»äº¡ï¼š`UnitID = "zombie"` â†’ ä½¿ç”¨ `Zombie.reanim`
- çƒ§ç„¦æ­»äº¡ï¼š`UnitID = "zombie_charred"` â†’ ä½¿ç”¨ `Zombie_charred.reanim`

#### Phase 4: èµ„æºåŠ è½½éªŒè¯
1. æ£€æŸ¥ `resource_manager.go` æ˜¯å¦å·²åŠ è½½ `Zombie_charred.reanim`
2. å¦‚æœªåŠ è½½ï¼Œæ·»åŠ åŠ è½½é€»è¾‘ï¼ˆå¯èƒ½å·²é€šè¿‡ Reanim è‡ªåŠ¨æ‰«æåŠ è½½ï¼‰
3. ç¡®è®¤åŠ¨ç”»é…ç½®æ–‡ä»¶ `data/reanim_config.yaml` ä¸­æ˜¯å¦æœ‰ `zombie_charred` çš„é…ç½®

## Tasks / Subtasks

### Task 1: æ·»åŠ çƒ§ç„¦æ­»äº¡è¡Œä¸ºç±»å‹å¸¸é‡ (AC: 1, 2)
- [x] åœ¨ `pkg/components/behavior.go` ä¸­æ·»åŠ  `BehaviorZombieDyingExplosion` å¸¸é‡
- [x] æ·»åŠ è¯¦ç»†çš„ GoDoc æ³¨é‡Šï¼Œè¯´æ˜ï¼š
  - ä½¿ç”¨åœºæ™¯ï¼šçˆ†ç‚¸ç±»æ”»å‡»æ€æ­»çš„åƒµå°¸
  - åŒºåˆ«äºæ™®é€šæ­»äº¡å’Œå‹æ‰æ­»äº¡
  - ç¤ºä¾‹ï¼šæ¨±æ¡ƒç‚¸å¼¹ã€åœŸè±†é›·
- [x] æ›´æ–°æ­»äº¡ç±»å‹å¯¹ç…§è¡¨æ³¨é‡Š

**é¢„æœŸä»£ç **ï¼š
```go
// BehaviorZombieDyingExplosion åƒµå°¸æ­»äº¡ä¸­ï¼ˆçˆ†ç‚¸çƒ§ç„¦æ­»äº¡åŠ¨ç”»ï¼‰
// 
// ä½¿ç”¨åœºæ™¯ï¼šåƒµå°¸è¢«çˆ†ç‚¸ç±»æ”»å‡»ï¼ˆæ¨±æ¡ƒç‚¸å¼¹ã€åœŸè±†é›·ã€è¾£æ¤’ç­‰ï¼‰æ€æ­»æ—¶
// 
// ä¸å…¶ä»–æ­»äº¡ç±»å‹çš„åŒºåˆ«ï¼š
//   - BehaviorZombieDying: æ™®é€šæ­»äº¡ï¼ˆè±Œè±†ã€åšæœç­‰ï¼‰- å¤´éƒ¨æ‰è½åŠ¨ç”»
//   - BehaviorZombieSquashing: å‹æ‰æ­»äº¡ï¼ˆé™¤è‰è½¦ï¼‰- é“²èµ·æ—‹è½¬å‹æ‰åŠ¨ç”»
//   - BehaviorZombieDyingExplosion: çˆ†ç‚¸æ­»äº¡ - çƒ§ç„¦é»‘åŒ–åŠ¨ç”»
// 
// åŠ¨ç”»èµ„æºï¼šZombie_charred*.png (10å¸§ï¼Œéå¾ªç¯)
// 
// å‚è€ƒå®ç°ï¼šStory 10.6 (å‹æ‰åŠ¨ç”»)
BehaviorZombieDyingExplosion
```

---

### Task 2: æ£€æŸ¥å¹¶åŠ è½½çƒ§ç„¦åŠ¨ç”»èµ„æº (AC: 3)
- [x] æ£€æŸ¥ `pkg/game/resource_manager.go` çš„èµ„æºåŠ è½½é€»è¾‘
- [x] ç¡®è®¤çƒ§ç„¦åŠ¨ç”»èµ„æºæ˜¯å¦å·²è‡ªåŠ¨åŠ è½½ï¼ˆé€šè¿‡ reanim éƒ¨ä»¶æ‰«æï¼‰
- [x] å¦‚éœ€æ‰‹åŠ¨åŠ è½½ï¼Œæ·»åŠ åŠ è½½ä»£ç 
- [x] éªŒè¯èµ„æºè·¯å¾„ï¼š`assets/reanim/Zombie_charred*.png`
- [x] ç¡®è®¤å¸§æ•°é…ç½®ï¼š10 å¸§

**æ£€æŸ¥ç‚¹**ï¼š
- èµ„æºæ˜¯å¦å­˜åœ¨ï¼š`ls assets/reanim/Zombie_charred*.png`
- èµ„æºæ˜¯å¦å·²åŠ è½½åˆ° ResourceManager çš„å›¾ç‰‡ç¼“å­˜ä¸­

---

### Task 3: å®ç°è§¦å‘çƒ§ç„¦æ­»äº¡çš„é€»è¾‘ (AC: 1)

**åˆ›å»ºæ–°å‡½æ•°** `triggerZombieExplosionDeath()` å‚è€ƒ `triggerZombieDeath()`ï¼š

- [x] åœ¨ `zombie_behavior_handler.go` ä¸­å®ç° `triggerZombieExplosionDeath()` å‡½æ•°
- [x] å®ç°ä»¥ä¸‹é€»è¾‘ï¼š
  1. åˆ‡æ¢è¡Œä¸ºç±»å‹ä¸º `BehaviorZombieDyingExplosion`
  2. ç§»é™¤ VelocityComponentï¼ˆåœæ­¢ç§»åŠ¨ï¼‰
  3. ä½¿ç”¨ AnimationCommand æ’­æ”¾çƒ§ç„¦åŠ¨ç”»ï¼ˆZombie_charred.reanimï¼‰
  4. è®¾ç½®åŠ¨ç”»ä¸ºä¸å¾ªç¯
  5. æ·»åŠ æ—¥å¿—è¾“å‡º

**å‡½æ•°ç­¾åå’Œå®ç°**ï¼š
```go
// triggerZombieExplosionDeath è§¦å‘åƒµå°¸çˆ†ç‚¸çƒ§ç„¦æ­»äº¡
// 
// å½“åƒµå°¸è¢«çˆ†ç‚¸ç±»æ”»å‡»ï¼ˆæ¨±æ¡ƒç‚¸å¼¹ã€åœŸè±†é›·ç­‰ï¼‰æ€æ­»æ—¶è°ƒç”¨
// æ’­æ”¾ä¸“ç”¨çš„çƒ§ç„¦é»‘åŒ–åŠ¨ç”»ï¼ˆZombie_charred.reanimï¼‰
// 
// å‚æ•°ï¼š
//   - entityID: åƒµå°¸å®ä½“ID
// 
// å‚è€ƒå®ç°ï¼štriggerZombieDeath() (æ™®é€šæ­»äº¡)
func (s *BehaviorSystem) triggerZombieExplosionDeath(entityID ecs.EntityID) {
    // 1. åˆ‡æ¢è¡Œä¸ºç±»å‹ä¸º BehaviorZombieDyingExplosion
    behavior, ok := ecs.GetComponent[*components.BehaviorComponent](s.entityManager, entityID)
    if !ok {
        log.Printf("[BehaviorSystem] åƒµå°¸ %d ç¼ºå°‘ BehaviorComponentï¼Œæ— æ³•è§¦å‘çˆ†ç‚¸æ­»äº¡", entityID)
        return
    }
    behavior.Type = components.BehaviorZombieDyingExplosion
    log.Printf("[BehaviorSystem] åƒµå°¸ %d è¡Œä¸ºåˆ‡æ¢ä¸º BehaviorZombieDyingExplosion", entityID)

    // 2. ç§»é™¤ VelocityComponentï¼ˆåœæ­¢ç§»åŠ¨ï¼‰
    ecs.RemoveComponent[*components.VelocityComponent](s.entityManager, entityID)
    log.Printf("[BehaviorSystem] åƒµå°¸ %d ç§»é™¤é€Ÿåº¦ç»„ä»¶ï¼Œåœæ­¢ç§»åŠ¨", entityID)

    // 3. ä½¿ç”¨ AnimationCommand ç»„ä»¶æ’­æ”¾çƒ§ç„¦æ­»äº¡åŠ¨ç”»ï¼ˆReanim ç³»ç»Ÿï¼‰
    //    å…³é”®ï¼šUnitID = "zombie_charred" æŒ‡å‘ Zombie_charred.reanim
    ecs.AddComponent(s.entityManager, entityID, &components.AnimationCommandComponent{
        UnitID:    "zombie_charred",  // â† çƒ§ç„¦åƒµå°¸ Reanim æ–‡ä»¶
        ComboName: "death",            // é…ç½®é©±åŠ¨çš„åŠ¨ç”»ç»„åˆ
        Processed: false,
    })
    log.Printf("[BehaviorSystem] åƒµå°¸ %d æ·»åŠ çƒ§ç„¦æ­»äº¡åŠ¨ç”»å‘½ä»¤", entityID)

    // 4. è®¾ç½®ä¸ºä¸å¾ªç¯
    if reanim, ok := ecs.GetComponent[*components.ReanimComponent](s.entityManager, entityID); ok {
        reanim.IsLooping = false
    }

    log.Printf("[BehaviorSystem] åƒµå°¸ %d çƒ§ç„¦æ­»äº¡åŠ¨ç”»å·²å¼€å§‹æ’­æ”¾ (zombie_charred/death, ä¸å¾ªç¯)", entityID)
}
```

**æ³¨æ„äº‹é¡¹**ï¼š
- ğŸ”´ **ä¸æ‰‹åŠ¨è®¾ç½®åŠ¨ç”»å¸§**ï¼šReanim ç³»ç»Ÿä¼šè‡ªåŠ¨å¤„ç†
- ğŸ”´ **ä¸ç›´æ¥åŠ è½½å›¾ç‰‡**ï¼šå›¾ç‰‡æ˜¯ Reanim çš„éƒ¨ä»¶ï¼Œç”± ResourceManager åŠ è½½
- âœ… **ä½¿ç”¨ AnimationCommand**ï¼šè¿™æ˜¯ç³»ç»Ÿé—´é€šä¿¡çš„æ ‡å‡†æ–¹å¼ï¼ˆECS é›¶è€¦åˆåŸåˆ™ï¼‰

---

### Task 4: ä¿®æ”¹æ¨±æ¡ƒç‚¸å¼¹çˆ†ç‚¸é€»è¾‘è°ƒç”¨æ–°å‡½æ•° (AC: 1)
- [x] å®šä½ `pkg/systems/behavior/cherry_bomb_handler.go:triggerCherryBombExplosion()`
- [x] æ‰¾åˆ°åƒµå°¸æ­»äº¡å¤„ç†ä»£ç æ®µï¼ˆå½“å‰è®¾ç½®ä¸º `BehaviorZombieDying`ï¼‰
- [x] **æ›¿æ¢ä¸ºè°ƒç”¨** `s.triggerZombieExplosionDeath(zombieID)` è€Œä¸æ˜¯æ‰‹åŠ¨è®¾ç½®è¡Œä¸ºç±»å‹
- [x] æ·»åŠ æ—¥å¿—è¾“å‡ºï¼š`log.Printf("[CherryBomb] åƒµå°¸ %d è¢«çˆ†ç‚¸æ€æ­»ï¼Œè§¦å‘çƒ§ç„¦æ­»äº¡", zombieID)`
- [x] ä¿ç•™æŠ¤ç”²æ‰£é™¤å’Œç”Ÿå‘½å€¼è®¡ç®—é€»è¾‘ä¸å˜

**ä¿®æ”¹ç¤ºä¾‹**ï¼š
```go
// æ—§ä»£ç  (Story 5.4)
if health.CurrentHealth <= 0 {
    behavior.Type = components.BehaviorZombieDying  // âŒ åˆ é™¤æ­¤è¡Œ
    // ... ç§»é™¤ VelocityComponent ç­‰é€»è¾‘          // âŒ åˆ é™¤è¿™äº›é€»è¾‘
}

// æ–°ä»£ç  (æœ¬ Story)
if health.CurrentHealth <=0 {
    log.Printf("[CherryBomb] åƒµå°¸ %d è¢«çˆ†ç‚¸æ€æ­»ï¼Œè§¦å‘çƒ§ç„¦æ­»äº¡", zombieID)
    s.triggerZombieExplosionDeath(zombieID)  // âœ… è°ƒç”¨æ–°å‡½æ•°
}
```

---

### Task 4: å®ç°çƒ§ç„¦æ­»äº¡è§¦å‘å’Œè¡Œä¸ºå¤„ç†å‡½æ•° (AC: 1, 3, 4)

**åˆ†ä¸ºä¸¤éƒ¨åˆ†**ï¼š
1. **è§¦å‘å‡½æ•°**ï¼šåœ¨åƒµå°¸æ­»äº¡æ—¶è§¦å‘çƒ§ç„¦æ­»äº¡åŠ¨ç”»
2. **è¡Œä¸ºå¤„ç†å‡½æ•°**ï¼šç›‘æ§åŠ¨ç”»æ’­æ”¾ï¼Œå®Œæˆååˆ é™¤åƒµå°¸

---

#### Task 4.1: å®ç° `triggerZombieExplosionDeath()` è§¦å‘å‡½æ•°

åœ¨ `pkg/systems/behavior/zombie_behavior_handler.go` ä¸­å®ç°è§¦å‘çƒ§ç„¦æ­»äº¡åŠ¨ç”»çš„å‡½æ•°ã€‚

**å‡½æ•°ç­¾å**ï¼š
```go
// triggerZombieExplosionDeath è§¦å‘åƒµå°¸çˆ†ç‚¸çƒ§ç„¦æ­»äº¡åŠ¨ç”»
// 
// å½“åƒµå°¸è¢«çˆ†ç‚¸ç±»æ”»å‡»æ€æ­»æ—¶è°ƒç”¨æ­¤æ–¹æ³•
// åˆ‡æ¢ä¸ºçƒ§ç„¦æ­»äº¡è¡Œä¸ºï¼Œæ’­æ”¾ Zombie_charred.reanim åŠ¨ç”»
// 
// å‚æ•°ï¼š
//   - entityID: åƒµå°¸å®ä½“ID
// 
// ä½¿ç”¨åœºæ™¯ï¼š
//   - æ¨±æ¡ƒç‚¸å¼¹çˆ†ç‚¸æ€æ­»åƒµå°¸ (Story 5.4)
//   - åœŸè±†é›·çˆ†ç‚¸æ€æ­»åƒµå°¸ï¼ˆæœªæ¥å®ç°ï¼‰
// 
// æŠ€æœ¯è¯´æ˜ï¼š
//   - ä½¿ç”¨ AnimationCommand ç»„ä»¶æ’­æ”¾ Reanim åŠ¨ç”»ï¼ˆä¸æ™®é€šæ­»äº¡ç›¸åŒæœºåˆ¶ï¼‰
//   - ä¸éšè—å¤´éƒ¨è½¨é“ï¼ˆçƒ§ç„¦åŠ¨ç”»ä¸­åƒµå°¸æ•´ä½“çƒ§ç„¦ï¼Œå¤´ä¸æ‰è½ï¼‰
//   - ä¸è§¦å‘ç²’å­æ•ˆæœï¼ˆçˆ†ç‚¸æ•ˆæœå·²åœ¨çˆ†ç‚¸æ—¶æ’­æ”¾ï¼‰
//   - å‚è€ƒå®ç°ï¼štriggerZombieDeath() (æ™®é€šæ­»äº¡)
func (s *BehaviorSystem) triggerZombieExplosionDeath(entityID ecs.EntityID) {
    // å®ç°é€»è¾‘...
}
```

**å®ç°æ­¥éª¤**ï¼š
- [x] 1. åˆ‡æ¢è¡Œä¸ºç±»å‹ä¸º `BehaviorZombieDyingExplosion`
- [x] 2. ç§»é™¤ VelocityComponentï¼ˆåƒµå°¸åœæ­¢ç§»åŠ¨ï¼‰
- [x] 3. ä½¿ç”¨ AnimationCommand ç»„ä»¶æ’­æ”¾çƒ§ç„¦åŠ¨ç”»ï¼š
  ```go
  ecs.AddComponent(s.entityManager, entityID, &components.AnimationCommandComponent{
      UnitID:    "zombie_charred",  // æŒ‡å‘ Zombie_charred.reanim
      ComboName: "death",            // é…ç½®é©±åŠ¨çš„åŠ¨ç”»ç»„åˆ
      Processed: false,
  })
  ```
- [x] 4. è®¾ç½®åŠ¨ç”»ä¸ºä¸å¾ªç¯ï¼š
  ```go
  if reanim, ok := ecs.GetComponent[*components.ReanimComponent](s.entityManager, entityID); ok {
      reanim.IsLooping = false
  }
  ```
- [x] 5. æ·»åŠ æ—¥å¿—è¾“å‡º

**å…³é”®åŒºåˆ«**ï¼ˆvs æ™®é€šæ­»äº¡ `triggerZombieDeath`ï¼‰ï¼š
- âŒ **ä¸éšè—å¤´éƒ¨è½¨é“**ï¼šçƒ§ç„¦åŠ¨ç”»ä¸­å¤´éƒ¨ä¸æ‰è½
- âŒ **ä¸è§¦å‘ç²’å­æ•ˆæœ**ï¼šå·²åœ¨çˆ†ç‚¸æ—¶æ’­æ”¾è¿‡ï¼Œé¿å…é‡å¤
- âœ… **ä½¿ç”¨ä¸åŒ Reanim æ–‡ä»¶**ï¼š`zombie_charred` vs `zombie`

---

#### Task 4.2: å®ç° `handleZombieDyingExplosionBehavior()` è¡Œä¸ºå¤„ç†å‡½æ•°

åœ¨ `pkg/systems/behavior/zombie_behavior_handler.go` ä¸­å®ç°çƒ§ç„¦æ­»äº¡è¡Œä¸ºå¤„ç†å‡½æ•°ã€‚

**å‡½æ•°ç­¾å**ï¼š
```go
// handleZombieDyingExplosionBehavior å¤„ç†åƒµå°¸çˆ†ç‚¸çƒ§ç„¦æ­»äº¡åŠ¨ç”»æ’­æ”¾
// 
// å½“åƒµå°¸è¢«çˆ†ç‚¸ç±»æ”»å‡»æ€æ­»æ—¶ï¼Œæ’­æ”¾ä¸“ç”¨çš„çƒ§ç„¦é»‘åŒ–åŠ¨ç”»
// åŠ¨ç”»æ’­æ”¾å®Œæˆååˆ é™¤åƒµå°¸å®ä½“å¹¶å¢åŠ æ¶ˆç­è®¡æ•°
// 
// å‚æ•°ï¼š
//   - entityID: åƒµå°¸å®ä½“ID
// 
// æŠ€æœ¯è¯´æ˜ï¼š
//   - çƒ§ç„¦åŠ¨ç”»ä¸ºéå¾ªç¯åŠ¨ç”»ï¼ŒReanimSystem ä¼šè‡ªåŠ¨æ¨è¿›å¸§
//   - å½“ reanim.IsFinished = true æ—¶ï¼ŒåŠ¨ç”»å®Œæˆ
//   - å¿…é¡»åœ¨åˆ é™¤å®ä½“å‰å¢åŠ è®¡æ•°ï¼Œå¦åˆ™è®¡æ•°ä¸¢å¤±
//   - å‚è€ƒå®ç°ï¼šhandleZombieDyingBehavior() (æ™®é€šæ­»äº¡)
func (s *BehaviorSystem) handleZombieDyingExplosionBehavior(entityID ecs.EntityID) {
    // å®ç°é€»è¾‘...
}
```

**å®ç°æ­¥éª¤**ï¼š
- [x] 1. è·å– ReanimComponent
- [x] 2. æ£€æŸ¥åŠ¨ç”»æ˜¯å¦å®Œæˆï¼ˆ`reanim.IsFinished`ï¼‰
- [x] 3. å¦‚æœå®Œæˆï¼š
  ```go
  // å¢åŠ è®¡æ•°ï¼ˆå¿…é¡»åœ¨åˆ é™¤å‰ï¼‰
  if s.gameState != nil {
      s.gameState.IncrementZombiesKilled()
      log.Printf("[Explosion] åƒµå°¸ %d çƒ§ç„¦æ­»äº¡åŠ¨ç”»å®Œæˆï¼Œè®¡æ•°+1", entityID)
  }
  
  // åˆ é™¤å®ä½“
  s.entityManager.DestroyEntity(entityID)
  log.Printf("[Explosion] åƒµå°¸ %d å·²åˆ é™¤", entityID)
  ```

**å®Œæ•´å®ç°ç¤ºä¾‹**ï¼ˆå‚è€ƒ `handleZombieDyingBehavior`ï¼‰ï¼š
```go
func (s *BehaviorSystem) handleZombieDyingExplosionBehavior(entityID ecs.EntityID) {
    // è·å– ReanimComponent
    reanim, ok := ecs.GetComponent[*components.ReanimComponent](s.entityManager, entityID)
    if !ok {
        // å¦‚æœæ²¡æœ‰ ReanimComponentï¼Œç›´æ¥åˆ é™¤åƒµå°¸
        log.Printf("[BehaviorSystem] çˆ†ç‚¸æ­»äº¡ä¸­çš„åƒµå°¸ %d ç¼ºå°‘ ReanimComponentï¼Œç›´æ¥åˆ é™¤", entityID)
        s.gameState.IncrementZombiesKilled()
        s.entityManager.DestroyEntity(entityID)
        return
    }

    // æ£€æŸ¥çƒ§ç„¦æ­»äº¡åŠ¨ç”»æ˜¯å¦å®Œæˆ
    if reanim.IsFinished {
        log.Printf("[BehaviorSystem] åƒµå°¸ %d çƒ§ç„¦æ­»äº¡åŠ¨ç”»å®Œæˆï¼Œåˆ é™¤å®ä½“", entityID)
        
        // å¢åŠ åƒµå°¸æ¶ˆç­è®¡æ•°
        s.gameState.IncrementZombiesKilled()
        
        // åˆ é™¤åƒµå°¸å®ä½“
        s.entityManager.DestroyEntity(entityID)
    }
}
```

---

### Task 5: åœ¨ BehaviorSystem.Update() ä¸­æ·»åŠ æŸ¥è¯¢å’Œå¤„ç† (AC: 1, 2, 3, 4)
- [x] å®šä½ `pkg/systems/behavior/behavior_system.go:Update()` æ–¹æ³•
- [x] æ·»åŠ æŸ¥è¯¢çˆ†ç‚¸æ­»äº¡åƒµå°¸çš„é€»è¾‘ï¼ˆå‚è€ƒç°æœ‰çš„ `queryDyingZombies()` æ¨¡å¼ï¼‰
- [x] éå†çˆ†ç‚¸æ­»äº¡åƒµå°¸ï¼Œè°ƒç”¨ `handleZombieDyingExplosionBehavior()`

**ä»£ç ä½ç½®**ï¼ˆåœ¨ `Update()` æ–¹æ³•ä¸­æ·»åŠ ï¼‰ï¼š
```go
// å¤„ç†çˆ†ç‚¸çƒ§ç„¦æ­»äº¡åŠ¨ç”» (Story 5.4.1)
explosionDyingZombies := s.queryExplosionDyingZombies()
for _, entityID := range explosionDyingZombies {
    s.handleZombieDyingExplosionBehavior(entityID, deltaTime)
}
```

**è¾…åŠ©æŸ¥è¯¢å‡½æ•°**ï¼š
```go
// queryExplosionDyingZombies æŸ¥è¯¢æ‰€æœ‰çˆ†ç‚¸çƒ§ç„¦æ­»äº¡ä¸­çš„åƒµå°¸
func (s *BehaviorSystem) queryExplosionDyingZombies() []ecs.EntityID {
    // æŸ¥è¯¢æ‰€æœ‰æ‹¥æœ‰ BehaviorComponent çš„å®ä½“
    candidates := ecs.GetEntitiesWith[*components.BehaviorComponent](s.entityManager)
    
    var dyingZombies []ecs.EntityID
    for _, entityID := range candidates {
        behavior, ok := ecs.GetComponent[*components.BehaviorComponent](s.entityManager, entityID)
        if !ok {
            continue
        }
        
        if behavior.Type == components.BehaviorZombieDyingExplosion {
            dyingZombies = append(dyingZombies, entityID)
        }
    }
    
    return dyingZombies
}
```

---

### Task 6: ç¼–å†™å•å…ƒæµ‹è¯• (AC: æ‰€æœ‰)
- [ ] åœ¨ `pkg/systems/behavior/behavior_system_test.go` ä¸­æ·»åŠ æµ‹è¯•ç”¨ä¾‹
- [ ] **æµ‹è¯•ç”¨ä¾‹ 1**: `TestBehaviorZombieDyingExplosion()`
  - åˆ›å»ºåƒµå°¸å®ä½“å¹¶è®¾ç½®ä¸º `BehaviorZombieDyingExplosion`
  - æ·»åŠ  ReanimComponentï¼ˆæ¨¡æ‹Ÿçƒ§ç„¦åŠ¨ç”»ï¼‰
  - è°ƒç”¨ `handleZombieDyingExplosionBehavior()`
  - éªŒè¯åŠ¨ç”»æ’­æ”¾å®Œæˆååƒµå°¸è¢«åˆ é™¤
  - éªŒè¯è®¡æ•°å¢åŠ 
- [ ] **æµ‹è¯•ç”¨ä¾‹ 2**: `TestCherryBombExplosionCharredAnimation()`
  - åˆ›å»ºæ¨±æ¡ƒç‚¸å¼¹å’Œåƒµå°¸å®ä½“
  - æ¨¡æ‹Ÿçˆ†ç‚¸ä¼¤å®³æ€æ­»åƒµå°¸
  - éªŒè¯åƒµå°¸è¡Œä¸ºç±»å‹è®¾ç½®ä¸º `BehaviorZombieDyingExplosion`
  - éªŒè¯æ™®é€šæ­»äº¡ä¸å—å½±å“
- [ ] è¿è¡Œæ‰€æœ‰æµ‹è¯•ç¡®ä¿é€šè¿‡ï¼š`go test ./pkg/systems/behavior/...`

---

### Task 7: æ¸¸æˆå†…åŠŸèƒ½æµ‹è¯• (AC: æ‰€æœ‰)
- [x] **æµ‹è¯•åœºæ™¯ 1**: æ¨±æ¡ƒç‚¸å¼¹çˆ†ç‚¸æ­»äº¡
  - è¿è¡Œæ¸¸æˆï¼š`go run .`
  - ç§æ¤æ¨±æ¡ƒç‚¸å¼¹ç‚¸æ­»åƒµå°¸
  - âœ… éªŒè¯ï¼šåƒµå°¸æ’­æ”¾çƒ§ç„¦åŠ¨ç”»ï¼ˆé»‘è‰²ç„¦ç‚­çŠ¶ï¼‰
  - âœ… éªŒè¯ï¼šåŠ¨ç”»æ’­æ”¾å®Œæˆååƒµå°¸æ¶ˆå¤±
  - âœ… éªŒè¯ï¼šåƒµå°¸æ¶ˆç­è®¡æ•°æ­£ç¡®å¢åŠ 

- [x] **æµ‹è¯•åœºæ™¯ 2**: æ™®é€šæ­»äº¡ä¸å—å½±å“
  - ä½¿ç”¨è±Œè±†å°„æ‰‹æ€æ­»åƒµå°¸
  - âœ… éªŒè¯ï¼šåƒµå°¸æ’­æ”¾æ™®é€šæ­»äº¡åŠ¨ç”»ï¼ˆå¤´éƒ¨æ‰è½ï¼‰
  - âœ… éªŒè¯ï¼šä¸æ’­æ”¾çƒ§ç„¦åŠ¨ç”»

- [x] **æµ‹è¯•åœºæ™¯ 3**: é™¤è‰è½¦å‹æ‰æ­»äº¡ä¸å—å½±å“ (AC: 6)
  - è®©åƒµå°¸è§¦å‘é™¤è‰è½¦
  - âœ… éªŒè¯ï¼šåƒµå°¸æ’­æ”¾å‹æ‰åŠ¨ç”»ï¼ˆé“²èµ·æ—‹è½¬å‹æ‰ï¼‰
  - âœ… éªŒè¯ï¼šä¸æ’­æ”¾çƒ§ç„¦åŠ¨ç”»æˆ–æ™®é€šæ­»äº¡åŠ¨ç”»

- [x] **æ€§èƒ½æµ‹è¯•**: å¤šåƒµå°¸çˆ†ç‚¸åœºæ™¯
  - ç”Ÿæˆ 10+ åƒµå°¸ï¼Œä¸€æ¬¡æ€§ç”¨æ¨±æ¡ƒç‚¸å¼¹ç‚¸æ­»
  - âœ… éªŒè¯ï¼šæ‰€æœ‰åƒµå°¸æ’­æ”¾çƒ§ç„¦åŠ¨ç”»
  - âœ… éªŒè¯ï¼šæ¸¸æˆå¸§ç‡ä¿æŒç¨³å®šï¼ˆ60 FPSï¼‰

---

### Task 8: ä»£ç è´¨é‡ä¿è¯
- [ ] è¿è¡Œ `gofmt -w .` æ ¼å¼åŒ–æ‰€æœ‰ä»£ç 
- [ ] è¿è¡Œ `go build` ç¡®ä¿ç¼–è¯‘é€šè¿‡
- [ ] æ£€æŸ¥æ‰€æœ‰å…¬å¼€å‡½æ•°éƒ½æœ‰ GoDoc æ³¨é‡Š
- [ ] éªŒè¯é”™è¯¯å¤„ç†ç¬¦åˆç¼–ç æ ‡å‡†ï¼ˆä¸å¿½ç•¥ä»»ä½• errorï¼‰
- [ ] ä»£ç å®¡æŸ¥ï¼šç¡®ä¿ç¬¦åˆ ECS é›¶è€¦åˆåŸåˆ™

---

### Task 9: æ–‡æ¡£æ›´æ–°
- [ ] æ›´æ–° `docs/prd/requirements.md`ï¼š
  - FR7.4ï¼šè¡¥å……"çˆ†ç‚¸ä¼šè§¦å‘ä¸“ç”¨çš„çƒ§ç„¦æ­»äº¡åŠ¨ç”»"
  - FR9.3ï¼šè¡¥å……"æ­»äº¡åŠ¨ç”»æ ¹æ®æ­»äº¡åŸå› ä¸åŒ"
- [ ] æ›´æ–° `docs/architecture/data-models.md`ï¼š
  - è¡¥å……æ­»äº¡ç±»å‹è¡Œä¸ºå¯¹ç…§è¡¨
- [ ] æ›´æ–° Story 5.4 æ–‡æ¡£ï¼š
  - æ·»åŠ å¤‡æ³¨ï¼š"Story 5.4.1 è¡¥å……å®ç°äº†çˆ†ç‚¸çƒ§ç„¦æ­»äº¡åŠ¨ç”»"
- [ ] æ›´æ–°å˜æ›´ææ¡ˆçŠ¶æ€ï¼š
  - `docs/sprint-change-proposals/2025-11-26-explosion-death-charred-animation.md`
  - æ ‡è®°ä¸º"å·²å®æ–½"

---

## Testing (æµ‹è¯•ç­–ç•¥)

### Test File Location
æµ‹è¯•æ–‡ä»¶ä¸æºæ–‡ä»¶åœ¨åŒä¸€åŒ…å†…ï¼Œä»¥ `_test.go` ç»“å°¾ï¼š
- `pkg/systems/behavior/behavior_system_test.go` - è¡Œä¸ºç³»ç»Ÿæµ‹è¯•

### Unit Tests (å•å…ƒæµ‹è¯•)

#### Test 1: çƒ§ç„¦æ­»äº¡è¡Œä¸ºå¤„ç†
**æµ‹è¯•å‡½æ•°**: `TestBehaviorZombieDyingExplosion()`

**Given-When-Then**:
- **Given**: åƒµå°¸å®ä½“è®¾ç½®ä¸º `BehaviorZombieDyingExplosion`ï¼ŒReanimComponent æ ‡è®°ä¸º `IsFinished = true`
- **When**: è°ƒç”¨ `handleZombieDyingExplosionBehavior()`
- **Then**: 
  - åƒµå°¸æ¶ˆç­è®¡æ•°å¢åŠ  1
  - åƒµå°¸å®ä½“è¢«åˆ é™¤

#### Test 2: æ¨±æ¡ƒç‚¸å¼¹çˆ†ç‚¸ä¼¤å®³è®¾ç½®çƒ§ç„¦æ­»äº¡
**æµ‹è¯•å‡½æ•°**: `TestCherryBombExplosionCharredAnimation()`

**Given-When-Then**:
- **Given**: æ¨±æ¡ƒç‚¸å¼¹å®ä½“å’Œåƒµå°¸å®ä½“ï¼ˆç”Ÿå‘½å€¼ < 1800ï¼‰
- **When**: è§¦å‘æ¨±æ¡ƒç‚¸å¼¹çˆ†ç‚¸
- **Then**:
  - åƒµå°¸è¡Œä¸ºç±»å‹è®¾ç½®ä¸º `BehaviorZombieDyingExplosion`
  - åƒµå°¸ VelocityComponent è¢«ç§»é™¤

### Integration Tests (é›†æˆæµ‹è¯•)

ç”±äºçˆ†ç‚¸æ­»äº¡é€»è¾‘æ¶‰åŠå¤šä¸ªç³»ç»Ÿï¼ˆBehaviorSystem, ReanimSystemï¼‰ï¼Œå»ºè®®æ‰‹åŠ¨æµ‹è¯•ï¼š

**æµ‹è¯•åœºæ™¯**ï¼š
1. æ¨±æ¡ƒç‚¸å¼¹çˆ†ç‚¸æ€æ­»å•ä¸ªåƒµå°¸
2. æ¨±æ¡ƒç‚¸å¼¹çˆ†ç‚¸æ€æ­»å¤šä¸ªåƒµå°¸ï¼ˆ3x3 èŒƒå›´ï¼‰
3. æ™®é€šæ­»äº¡å’Œçˆ†ç‚¸æ­»äº¡æ··åˆåœºæ™¯
4. é™¤è‰è½¦å‹æ‰å’Œçˆ†ç‚¸æ­»äº¡æ··åˆåœºæ™¯

### Acceptance Testing (éªŒæ”¶æµ‹è¯•)

æŒ‰ç…§ AC 1-6 æ‰§è¡Œå®Œæ•´çš„éªŒæ”¶æµ‹è¯•ï¼ˆè§ Task 7ï¼‰ã€‚

---

## Dependencies (ä¾èµ–)

### å‰ç½®ä¾èµ–
- âœ… Story 4.4 (åƒµå°¸æ­»äº¡åŠ¨ç”») - æä¾›æ™®é€šæ­»äº¡åŠ¨ç”»åŸºç¡€
- âœ… Story 5.4 (æ¨±æ¡ƒç‚¸å¼¹è¡Œä¸ºå®ç°) - æä¾›çˆ†ç‚¸ä¼¤å®³é€»è¾‘
- âœ… Story 10.6 (é™¤è‰è½¦å‹æ‰åŠ¨ç”») - æä¾›å¤šæ­»äº¡ç±»å‹å¤„ç†å‚è€ƒ

### èµ„æºä¾èµ–
- âœ… `assets/reanim/Zombie_charred*.png` - çƒ§ç„¦åŠ¨ç”»èµ„æºï¼ˆå·²ç¡®è®¤å­˜åœ¨ï¼‰

### åç»­ä¾èµ–
- â³ åœŸè±†é›·å®ç°æ—¶å°†å¤ç”¨æœ¬ Story çš„çƒ§ç„¦æ­»äº¡æœºåˆ¶
- â³ æœªæ¥çš„å…¶ä»–çˆ†ç‚¸ç±»æ”»å‡»ï¼ˆè¾£æ¤’ã€ç«çˆ†è¾£æ¤’ç­‰ï¼‰ä¹Ÿå°†å¤ç”¨

---

## Risks (é£é™©)

| é£é™© | æ¦‚ç‡ | å½±å“ | ç¼“è§£æªæ–½ |
|------|------|------|----------|
| çƒ§ç„¦åŠ¨ç”»èµ„æºæ ¼å¼ä¸å…¼å®¹ | ä½ | ä¸­ | å·²ç¡®è®¤èµ„æºå¯ç”¨ï¼Œå‚è€ƒå‹æ‰åŠ¨ç”»å®ç° |
| çˆ†ç‚¸æ”»å‡»ç‚¹é—æ¼ï¼ˆæœªè®¾ç½®çƒ§ç„¦æ­»äº¡ï¼‰ | ä¸­ | ä½ | ä»£ç å®¡æŸ¥ï¼Œå½“å‰åªæœ‰æ¨±æ¡ƒç‚¸å¼¹ï¼Œåç»­æ·»åŠ åœŸè±†é›·æ—¶æ³¨æ„ |
| æ€§èƒ½å½±å“ï¼ˆå¤šåƒµå°¸çˆ†ç‚¸ï¼‰ | ä½ | ä½ | çƒ§ç„¦åŠ¨ç”»ä¸æ™®é€šæ­»äº¡æ€§èƒ½ç›¸åŒï¼Œæ— é¢å¤–å¼€é”€ |
| å½±å“ç°æœ‰æ­»äº¡é€»è¾‘ | ä½ | ä¸­ | å……åˆ†æµ‹è¯•æ™®é€šæ­»äº¡å’Œå‹æ‰æ­»äº¡ä¸å—å½±å“ |

---

## Estimated Effort (å·¥ä½œé‡è¯„ä¼°)

| ä»»åŠ¡ | é¢„ä¼°æ—¶é—´ |
|------|---------|
| Task 1-2: å¸¸é‡å’Œèµ„æºæ£€æŸ¥ | 0.5 å°æ—¶ |
| Task 3: ä¿®æ”¹çˆ†ç‚¸é€»è¾‘ | 0.5 å°æ—¶ |
| Task 4-5: å®ç°çƒ§ç„¦æ­»äº¡è¡Œä¸ºå¤„ç† | 1.5 å°æ—¶ |
| Task 6: å•å…ƒæµ‹è¯• | 1.0 å°æ—¶ |
| Task 7: æ¸¸æˆå†…æµ‹è¯• | 1.0 å°æ—¶ |
| Task 8-9: ä»£ç è´¨é‡å’Œæ–‡æ¡£ | 0.5 å°æ—¶ |
| **æ€»è®¡** | **5 å°æ—¶** |

**Story Points**: 1 SP

---

## Change Log

| æ—¥æœŸ | ç‰ˆæœ¬ | æè¿° | ä½œè€… |
|------|------|------|------|
| 2025-11-26 | 1.0 | Story 5.4.1 åˆå§‹åˆ›å»º | Scrum Master (Bob) |
| 2025-11-26 | 1.1 | å®ç°å®Œæˆï¼Œé‡æ„ ReanimSystem æ”¯æŒè¿è¡Œæ—¶å•ä½åˆ‡æ¢ | Dev Agent (James) |

---

## Related Documents (ç›¸å…³æ–‡æ¡£)

- [Sprint Change Proposal](../sprint-change-proposals/2025-11-26-explosion-death-charred-animation.md) - å˜æ›´ææ¡ˆæ–‡æ¡£
- [Story 5.4](./5.4.story.md) - æ¨±æ¡ƒç‚¸å¼¹è¡Œä¸ºå®ç°
- [Story 10.6](./10.6.story.md) - é™¤è‰è½¦å‹æ‰åŠ¨ç”»ï¼ˆå‚è€ƒå®ç°ï¼‰
- [Story 4.4](./4.4.story.md) - åƒµå°¸æ­»äº¡åŠ¨ç”»åŸºç¡€å®ç°

---

## Dev Agent Handoff (äº¤æ¥ç»™å¼€å‘ä»£ç†)

### äº¤æ¥æ¸…å•
- âœ… Story æ–‡æ¡£å·²åˆ›å»º
- âœ… éªŒæ”¶æ ‡å‡†å·²æ˜ç¡®
- âœ… æŠ€æœ¯æ–¹æ¡ˆå·²ç¡®å®šï¼ˆå‚è€ƒ Story 10.6ï¼‰
- âœ… ä»»åŠ¡å·²åˆ†è§£ï¼ˆ9ä¸ªä»»åŠ¡ï¼‰
- âœ… æµ‹è¯•ç­–ç•¥å·²å®šä¹‰
- âœ… é£é™©å·²è¯†åˆ«å¹¶æœ‰ç¼“è§£æªæ–½

### å¼€å§‹å®æ–½

**Dev Agent (James)** å¯ä»¥å¼€å§‹å®æ–½æœ¬ Storyã€‚å»ºè®®æŒ‰ç…§ä»¥ä¸‹é¡ºåºæ‰§è¡Œï¼š

1. **é˜…è¯»å‚è€ƒå®ç°**: ä»”ç»†é˜…è¯» Story 10.6 çš„å‹æ‰åŠ¨ç”»å®ç°
2. **æ·»åŠ è¡Œä¸ºå¸¸é‡**: Task 1 (æœ€ç®€å•ï¼Œå¿«é€ŸéªŒè¯ç†è§£)
3. **å®ç°æ ¸å¿ƒé€»è¾‘**: Task 3-5 (æŒ‰é¡ºåºå®æ–½)
4. **æµ‹è¯•éªŒè¯**: Task 6-7 (ç¡®ä¿è´¨é‡)
5. **æ”¶å°¾å·¥ä½œ**: Task 8-9 (ä»£ç è´¨é‡å’Œæ–‡æ¡£)

**é¢„æœŸäº¤ä»˜æ—¶é—´**: 1 ä¸ªå·¥ä½œæ—¥å†…å®Œæˆ

---

**Story çŠ¶æ€**: âœ… **Implemented** - å·²å®ç°å¹¶é€šè¿‡æµ‹è¯•

---

## QA Results

### Review Date: 2025-11-26

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**æ•´ä½“è¯„ä¼°ï¼šä¼˜ç§€** âœ…

Story 5.4.1 çš„å®ç°éµå¾ªäº†é¡¹ç›®æ—¢å®šçš„ ECS æ¶æ„æ¨¡å¼å’Œç¼–ç æ ‡å‡†ã€‚ä¸»è¦ä¼˜ç‚¹ï¼š

1. **æ¶æ„ä¸€è‡´æ€§**ï¼šå®ç°å‚è€ƒäº† Story 10.6 (å‹æ‰åŠ¨ç”») çš„æˆç†Ÿæ¨¡å¼ï¼Œä¿æŒäº†æ­»äº¡ç±»å‹å¤„ç†çš„ä¸€è‡´æ€§
2. **ä»£ç ç»„ç»‡**ï¼šæ–°å¢çš„ `triggerZombieExplosionDeath()` å’Œ `handleZombieDyingExplosionBehavior()` å‡½æ•°ç»“æ„æ¸…æ™°ï¼ŒèŒè´£åˆ†æ˜
3. **è¿è¡Œæ—¶å•ä½åˆ‡æ¢**ï¼šReanimSystem çš„ `PlayCombo()` æ–¹æ³•å¾—åˆ°äº†æ‰©å±•ï¼Œæ”¯æŒè¿è¡Œæ—¶åˆ‡æ¢ Reanim å•ä½ï¼ˆä» zombie åˆ° zombie_charredï¼‰ï¼Œè¿™æ˜¯ä¸€ä¸ªæœ‰ä»·å€¼çš„æ¶æ„æ”¹è¿›
4. **é…ç½®é©±åŠ¨**ï¼šçƒ§ç„¦åƒµå°¸çš„åŠ¨ç”»é…ç½® (`data/reanim_config/zombie_charred.yaml`) å®Œæ•´ä¸”æ­£ç¡®å®šä¹‰äº† `death` ç»„åˆ

### Refactoring Performed

æ— éœ€é‡æ„ã€‚ä»£ç è´¨é‡è‰¯å¥½ï¼Œç¬¦åˆé¡¹ç›®æ ‡å‡†ã€‚

### Compliance Check

- Coding Standards: âœ“ ç¬¦åˆ Go å‘½åè§„èŒƒï¼Œä½¿ç”¨äº†é€‚å½“çš„æ³¨é‡Š
- Project Structure: âœ“ æ–‡ä»¶ä½ç½®æ­£ç¡®ï¼Œç¬¦åˆ ECS æ¶æ„
- Testing Strategy: âœ— **ç¼ºå°‘ä¸“ç”¨å•å…ƒæµ‹è¯•** (è§ä¸‹æ–¹)
- All ACs Met: âœ“ æ‰€æœ‰ 6 ä¸ªéªŒæ”¶æ ‡å‡†å·²åœ¨æ¸¸æˆå†…æµ‹è¯•é€šè¿‡

### Improvements Checklist

**å·²å®Œæˆçš„æ”¹è¿›**ï¼š
- [x] æ·»åŠ  `BehaviorZombieDyingExplosion` è¡Œä¸ºå¸¸é‡
- [x] å®ç° `triggerZombieExplosionDeath()` è§¦å‘å‡½æ•°
- [x] å®ç° `handleZombieDyingExplosionBehavior()` å¤„ç†å‡½æ•°
- [x] ä¿®æ”¹æ¨±æ¡ƒç‚¸å¼¹çˆ†ç‚¸é€»è¾‘è°ƒç”¨æ–°å‡½æ•°
- [x] æ·»åŠ  `zombie_charred` åŠ¨ç”»é…ç½®
- [x] ReanimSystem æ”¯æŒè¿è¡Œæ—¶å•ä½åˆ‡æ¢
- [x] åœ¨ game_scene.go å’Œ main_menu_scene.go è®¾ç½® ResourceLoader
- [x] æ¸¸æˆå†…åŠŸèƒ½æµ‹è¯•å…¨éƒ¨é€šè¿‡

**å¾…å®Œæˆçš„æ”¹è¿›**ï¼ˆå»ºè®®ä¼˜å…ˆçº§ï¼‰ï¼š
- [ ] **[é«˜]** æ·»åŠ ä¸“ç”¨å•å…ƒæµ‹è¯• `TestBehaviorZombieDyingExplosion()` å’Œ `TestCherryBombExplosionCharredAnimation()` (Task 6 æœªå®Œæˆ)
- [ ] **[ä¸­]** è¿è¡Œ `gofmt -w .` æ ¼å¼åŒ–ä»£ç  (Task 8 æœªå®Œæˆ)
- [ ] **[ä½]** æ›´æ–°ç›¸å…³æ–‡æ¡£ (Task 9 æœªå®Œæˆ)

### Security Review

**çŠ¶æ€ï¼šé€šè¿‡** âœ…

æœ¬åŠŸèƒ½ä¸æ¶‰åŠç”¨æˆ·è¾“å…¥ã€ç½‘ç»œè¯·æ±‚æˆ–æ•æ„Ÿæ•°æ®å¤„ç†ï¼Œæ— å®‰å…¨é£é™©ã€‚

### Performance Considerations

**çŠ¶æ€ï¼šé€šè¿‡** âœ…

1. è¿è¡Œæ—¶å•ä½åˆ‡æ¢ä½¿ç”¨äº†é…ç½®ç¼“å­˜ï¼Œä¸ä¼šæ¯å¸§é‡å¤åŠ è½½
2. çƒ§ç„¦åŠ¨ç”»ä¸æ™®é€šæ­»äº¡åŠ¨ç”»æ€§èƒ½ç›¸åŒï¼ˆReanim éª¨éª¼åŠ¨ç”»ï¼‰
3. å¤šåƒµå°¸åŒæ—¶çˆ†ç‚¸åœºæ™¯ä¸‹å¸§ç‡ä¿æŒç¨³å®šï¼ˆæ¸¸æˆå†…æµ‹è¯•éªŒè¯ï¼‰

### Files Modified During Review

æ— ã€‚æœªå¯¹ä»£ç è¿›è¡Œä¿®æ”¹ã€‚

### Test Coverage Gap Analysis

**å‘ç°çš„é—®é¢˜**ï¼š

Story å®šä¹‰çš„ Task 6 (ç¼–å†™å•å…ƒæµ‹è¯•) æ ‡è®°ä¸ºæœªå®Œæˆ `[ ]`ï¼Œç¼ºå°‘ä»¥ä¸‹æµ‹è¯•ç”¨ä¾‹ï¼š
1. `TestBehaviorZombieDyingExplosion()` - çƒ§ç„¦æ­»äº¡è¡Œä¸ºå¤„ç†æµ‹è¯•
2. `TestCherryBombExplosionCharredAnimation()` - æ¨±æ¡ƒç‚¸å¼¹çˆ†ç‚¸è®¾ç½®çƒ§ç„¦æ­»äº¡æµ‹è¯•

**ç°æœ‰æµ‹è¯•è¦†ç›–**ï¼š
- `TestCherryBombExplosionReleasesGrid` - å·²é€šè¿‡ï¼ŒéªŒè¯äº†æ¨±æ¡ƒç‚¸å¼¹çˆ†ç‚¸è§¦å‘çƒ§ç„¦æ­»äº¡çš„æ—¥å¿—è¾“å‡º

### Gate Status

Gate: **CONCERNS** â†’ docs/qa/gates/5.4.1-explosion-death-charred-animation.yml

### Recommended Status

**âœ— Changes Required - See unchecked items above**

å»ºè®®åœ¨æ·»åŠ ä¸“ç”¨å•å…ƒæµ‹è¯•åå°†çŠ¶æ€æ›´æ–°ä¸º Doneã€‚è™½ç„¶åŠŸèƒ½å·²å®Œæ•´å®ç°å¹¶é€šè¿‡æ¸¸æˆå†…æµ‹è¯•ï¼Œä½†ç¼ºå°‘è‡ªåŠ¨åŒ–æµ‹è¯•ä¼šå½±å“é•¿æœŸå¯ç»´æŠ¤æ€§ã€‚

---

## Implementation Notes (å®ç°å¤‡æ³¨)

### å…³é”®æŠ€æœ¯å†³ç­–

**è¿è¡Œæ—¶å•ä½åˆ‡æ¢æœºåˆ¶**ï¼š

åŸå§‹å®ç°ä¸­ï¼Œ`triggerZombieExplosionDeath()` åªå‘é€ `AnimationCommandComponent`ï¼Œä½† `PlayCombo()` æ— æ³•æ­£ç¡®å¤„ç†ä» `zombie` åˆ‡æ¢åˆ° `zombie_charred` çš„æƒ…å†µï¼Œå› ä¸º `MergedTracks` å·²å­˜åœ¨æ—¶ä¸ä¼šé‡æ–°åŠ è½½ Reanim æ•°æ®ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. åœ¨ `ReanimSystem` ä¸­æ·»åŠ  `ReanimResourceLoader` æ¥å£
2. ä¿®æ”¹ `PlayCombo()` æ£€æµ‹å•ä½åˆ‡æ¢ï¼ˆä½¿ç”¨ `strings.EqualFold` å¤§å°å†™ä¸æ•æ„Ÿæ¯”è¾ƒï¼‰
3. å•ä½åˆ‡æ¢æ—¶è‡ªåŠ¨ä» `ResourceLoader` åŠ è½½æ–°çš„ ReanimXML å’Œ PartImages
4. åœ¨ `game_scene.go` å’Œ `main_menu_scene.go` ä¸­è°ƒç”¨ `SetResourceLoader(rm)`

**ä¿®æ”¹çš„æ–‡ä»¶**ï¼š
- `pkg/systems/reanim_system.go` - æ·»åŠ  `ReanimResourceLoader` æ¥å£å’Œå•ä½åˆ‡æ¢é€»è¾‘
- `pkg/systems/behavior/zombie_behavior_handler.go` - ç®€åŒ–ä¸ºåªä½¿ç”¨ AnimationCommand
- `pkg/scenes/game_scene.go` - æ·»åŠ  `SetResourceLoader(rm)` è°ƒç”¨
- `pkg/scenes/main_menu_scene.go` - æ·»åŠ  `SetResourceLoader(rm)` è°ƒç”¨
