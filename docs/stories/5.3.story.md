# Story 5.3: 高级僵尸行为实现

## Status
Ready for Review

## Story
**As a** 玩家,
**I want** to face tougher zombies like Conehead and Buckethead,
**so that** the game provides a greater challenge.

## Acceptance Criteria
1. 游戏中可以生成路障僵尸和铁桶僵尸。
2. 路障僵尸和铁桶僵尸拥有一个额外的"头部防具"生命值层。
3. 当僵尸受到伤害时,优先扣除其"头部防具"的生命值。
4. 当"头部防具"生命值耗尽时,其外观会改变（路障/铁桶掉落），并且僵尸的行为和生命值会变为一个普通僵尸。
5. 这两种僵尸的总有效生命值远高于普通僵尸。

## Dev Notes

### Previous Story Insights
[Source: docs/stories/5.2.story.md#Dev Agent Record]

从 Story 5.2 的实施中学到的关键经验:
1. **HealthComponent 系统成熟**: 所有单位实体已支持 HealthComponent,生命值系统完整
2. **实体工厂模式**: `pkg/entities/zombie_factory.go` 使用工厂函数创建僵尸实体
3. **动画切换机制**: BehaviorSystem 支持根据实体状态动态切换动画
4. **行为类型扩展**: 可以添加新的 BehaviorType 常量来定义新行为
5. **碰撞检测系统**: PhysicsSystem 已实现完整的子弹-僵尸碰撞检测
6. **音效系统**: ResourceManager 已实现音效加载和播放功能

**本 Story 重点**:
- AC 1: 创建路障僵尸和铁桶僵尸的工厂函数
- AC 2: 实现"头部防具"生命值层（使用额外的HealthComponent或新组件）
- AC 3: 修改伤害处理逻辑,优先扣除防具生命值
- AC 4: 实现防具耗尽后的外观和行为切换
- AC 5: 配置高生命值参数（路障约640HP,铁桶约1370HP）

### Data Models

#### HealthComponent (已存在)
[Source: pkg/components/health.go]

```go
type HealthComponent struct {
    CurrentHealth int // 当前生命值
    MaxHealth     int // 最大生命值
}
```

**用法**: 
- 基础僵尸只使用 HealthComponent 存储总生命值
- 高级僵尸需要额外的组件存储"头部防具"生命值

#### ArmorComponent (需要新建)
[Source: docs/architecture/data-models.md - 扩展需求]

```go
// ArmorComponent 存储实体的护甲信息
// 用于路障僵尸、铁桶僵尸等拥有额外防护层的单位
type ArmorComponent struct {
    CurrentArmor int // 当前护甲值
    MaxArmor     int // 最大护甲值
}
```

**设计说明**:
- 当实体同时拥有 HealthComponent 和 ArmorComponent 时,伤害优先扣除护甲
- 当 CurrentArmor <= 0 时,护甲层被破坏,开始扣除生命值
- 护甲耗尽时需要触发外观切换（路障/铁桶掉落）

#### BehaviorComponent 扩展
[Source: pkg/components/behavior.go]

需要添加新的行为类型常量:

```go
const (
    // ... 现有类型
    BehaviorZombieConehead    // 路障僵尸行为（带护甲的僵尸）
    BehaviorZombieBuckethead  // 铁桶僵尸行为（更高护甲的僵尸）
)
```

### Architecture Context

#### ECS 架构模式
[Source: docs/architecture/high-level-architecture.md]

本项目采用实体-组件-系统(Entity-Component-System)架构:
- **实体(Entity)**: 游戏对象的唯一标识符
- **组件(Component)**: 纯数据结构,描述实体的属性
- **系统(System)**: 处理逻辑的函数,对拥有特定组件的实体进行操作

**关键原则**:
- 组件只包含数据,不包含方法
- 系统之间通过 EntityManager 通信,不直接调用

#### 僵尸工厂模式
[Source: pkg/entities/zombie_factory.go]

现有的 `NewZombieEntity()` 创建普通僵尸:
- 添加 PositionComponent, SpriteComponent, AnimationComponent
- 添加 VelocityComponent (向左移动)
- 添加 BehaviorComponent, HealthComponent, CollisionComponent

**新建工厂函数需求**:
- `NewConeheadZombieEntity()` - 创建路障僵尸
- `NewBucketheadZombieEntity()` - 创建铁桶僵尸
- 两者都需要添加 ArmorComponent

#### PhysicsSystem 伤害处理
[Source: pkg/systems/physics_system.go]

现有的碰撞检测会触发伤害处理:
```go
// 检测到碰撞后,减少僵尸生命值
health.CurrentHealth -= config.PeaBulletDamage
```

**需要修改为**:
```go
// 优先扣除护甲值
if armor := em.GetComponent(zombieID, &ArmorComponent{}); armor != nil {
    armorComp := armor.(*components.ArmorComponent)
    if armorComp.CurrentArmor > 0 {
        armorComp.CurrentArmor -= damage
        if armorComp.CurrentArmor <= 0 {
            // 触发护甲破坏事件（切换外观和行为）
        }
    }
} else {
    // 没有护甲,直接扣除生命值
    health.CurrentHealth -= damage
}
```

#### BehaviorSystem 外观切换
[Source: pkg/systems/behavior_system.go]

类似于 Story 5.2 的坚果墙外观切换逻辑:
```go
func handleConeheadZombieBehavior() {
    // 检查护甲是否耗尽
    if armorComp.CurrentArmor <= 0 && !hasLostArmor {
        // 切换为普通僵尸外观（去掉路障）
        // 改变行为类型为 BehaviorZombieBasic
    }
}
```

### File Locations and Structure
[Source: docs/architecture/unified-project-structure.md]

```plaintext
pkg/
├── components/
│   └── armor.go                    # 新建：ArmorComponent 定义
│   └── behavior.go                 # 修改：添加新行为类型常量
├── entities/
│   └── zombie_factory.go           # 修改：添加高级僵尸工厂函数
│   └── zombie_factory_test.go     # 修改：添加测试
├── systems/
│   └── physics_system.go           # 修改：优先扣除护甲值
│   └── behavior_system.go          # 修改：添加高级僵尸行为处理
├── config/
│   └── unit_config.go              # 修改：添加高级僵尸配置常量
└── utils/
    └── zombie_resources.go         # 修改：添加高级僵尸动画加载函数
```

### Resource Files Available
[Source: assets/images/Zombies/]

**路障僵尸 (ConeheadZombie)**:
- 走路动画: `ConeheadZombie/ConeheadZombie_1.png` 至 `ConeheadZombie_21.png` (21帧)
- 啃食动画: `ConeheadZombie/ConeheadZombieAttack_1.png` 至 `ConeheadZombieAttack_11.png` (11帧)

**铁桶僵尸 (BucketheadZombie)**:
- 走路动画: `BucketheadZombie/BucketheadZombie_1.png` 至 `BucketheadZombie_15.png` (15帧)
- 啃食动画: `BucketheadZombie/BucketheadZombieAttack_1.png` 至 `BucketheadZombieAttack_11.png` (11帧)

**注意**: 护甲耗尽后,僵尸应切换回普通僵尸动画（已存在）

### Game Balance Configuration

根据原版游戏数值:

| 僵尸类型 | 护甲值 | 身体生命值 | 总生命值 | 移动速度 |
|---------|--------|-----------|---------|---------|
| 普通僵尸 | 0 | 270 | 270 | -30.0 |
| 路障僵尸 | 370 | 270 | 640 | -30.0 |
| 铁桶僵尸 | 1100 | 270 | 1370 | -30.0 |

**配置常量定义** (pkg/config/unit_config.go):
```go
const (
    // 路障僵尸配置
    ConeheadZombieArmorHealth = 370
    ConeheadZombieWalkAnimationFrames = 21
    ConeheadZombieEatAnimationFrames = 11
    
    // 铁桶僵尸配置
    BucketheadZombieArmorHealth = 1100
    BucketheadZombieWalkAnimationFrames = 15
    BucketheadZombieEatAnimationFrames = 11
    
    // 音效路径
    ArmorBreakSoundPath = "assets/audio/Sound/shieldhit.ogg"
)
```

### Technical Constraints
[Source: docs/architecture/coding-standards.md]

- **零耦合原则**: System 之间严禁直接调用,必须通过 EntityManager 通信
- **数据-行为分离**: Component 中严禁包含方法,所有逻辑在 System 中实现
- **错误处理**: 严禁忽略错误,必须检查所有可能返回 error 的函数
- **命名约定**: 
  - 结构体/接口使用 PascalCase
  - 函数/方法使用 PascalCase (公开), camelCase (私有)
  - 常量使用 PascalCase

### Implementation Strategy

**阶段 1: 数据模型扩展**
1. 创建 ArmorComponent 组件
2. 在 behavior.go 中添加新行为类型常量
3. 在 unit_config.go 中添加配置常量

**阶段 2: 实体工厂实现**
1. 在 zombie_resources.go 中实现动画加载函数
2. 在 zombie_factory.go 中实现 NewConeheadZombieEntity()
3. 在 zombie_factory.go 中实现 NewBucketheadZombieEntity()

**阶段 3: 系统逻辑修改**
1. 修改 PhysicsSystem 的伤害处理,优先扣除护甲
2. 在 BehaviorSystem 中实现护甲耗尽检测和外观切换
3. 添加护甲破坏音效播放

**阶段 4: 测试验证**
1. 编写单元测试验证工厂函数
2. 编写单元测试验证护甲伤害逻辑
3. 游戏内测试验证外观切换和行为转换

## Tasks / Subtasks

- [x] Task 1: 创建 ArmorComponent 组件 (AC: 2)
  - [x] 在 pkg/components/ 中新建 armor.go
  - [x] 定义 ArmorComponent 结构体（CurrentArmor, MaxArmor）
  - [x] 添加 GoDoc 注释说明用途

- [x] Task 2: 扩展 BehaviorType 常量 (AC: 1)
  - [x] 在 pkg/components/behavior.go 中添加 BehaviorZombieConehead
  - [x] 在 pkg/components/behavior.go 中添加 BehaviorZombieBuckethead
  - [x] 添加详细的 GoDoc 注释

- [x] Task 3: 添加高级僵尸配置常量 (AC: 5)
  - [x] 在 pkg/config/unit_config.go 中添加路障僵尸配置
    - ConeheadZombieArmorHealth = 370
    - ConeheadZombieWalkAnimationFrames = 21
    - ConeheadZombieEatAnimationFrames = 11
  - [x] 添加铁桶僵尸配置
    - BucketheadZombieArmorHealth = 1100
    - BucketheadZombieWalkAnimationFrames = 15
    - BucketheadZombieEatAnimationFrames = 11
  - [x] 添加护甲破坏音效路径常量

- [x] Task 4: 实现高级僵尸动画加载函数 (AC: 1)
  - [x] 在 pkg/utils/zombie_resources.go 中实现 LoadConeheadZombieWalkAnimation()
  - [x] 实现 LoadConeheadZombieEatAnimation()
  - [x] 实现 LoadBucketheadZombieWalkAnimation()
  - [x] 实现 LoadBucketheadZombieEatAnimation()
  - [x] 每个函数都要处理加载错误并返回 error

- [x] Task 5: 实现路障僵尸实体工厂 (AC: 1, 2, 5)
  - [x] 在 pkg/entities/zombie_factory.go 中实现 NewConeheadZombieEntity()
  - [x] 添加所有必要组件: Position, Sprite, Animation, Velocity, Behavior, Health, Collision
  - [x] 添加 ArmorComponent (CurrentArmor=370, MaxArmor=370)
  - [x] 设置身体生命值为 270
  - [x] 加载路障僵尸走路动画（21帧）
  - [x] 设置 BehaviorType 为 BehaviorZombieConehead

- [x] Task 6: 实现铁桶僵尸实体工厂 (AC: 1, 2, 5)
  - [x] 在 pkg/entities/zombie_factory.go 中实现 NewBucketheadZombieEntity()
  - [x] 添加所有必要组件
  - [x] 添加 ArmorComponent (CurrentArmor=1100, MaxArmor=1100)
  - [x] 设置身体生命值为 270
  - [x] 加载铁桶僵尸走路动画（15帧）
  - [x] 设置 BehaviorType 为 BehaviorZombieBuckethead

- [x] Task 7: 修改 PhysicsSystem 伤害处理逻辑 (AC: 3)
  - [x] 在 pkg/systems/physics_system.go 中找到僵尸伤害处理代码
  - [x] 添加护甲检测逻辑: 如果僵尸有 ArmorComponent 且 CurrentArmor > 0
  - [x] 优先扣除护甲值: armorComp.CurrentArmor -= damage
  - [x] 如果护甲值 <= 0,标记护甲破坏状态（为 BehaviorSystem 准备）
  - [x] 如果没有护甲或护甲已破坏,直接扣除身体生命值
  - [x] 播放对应的音效（击中护甲 vs 击中身体）

- [x] Task 8: 实现护甲破坏检测和外观切换 (AC: 4)
  - [x] 在 pkg/systems/behavior_system.go 中实现 handleConeheadZombieBehavior()
  - [x] 检测 ArmorComponent.CurrentArmor <= 0
  - [x] 当护甲耗尽时:
    - 切换动画为普通僵尸走路动画
    - 改变 BehaviorType 为 BehaviorZombieBasic
    - 播放护甲破坏音效
  - [x] 实现 handleBucketheadZombieBehavior() (逻辑相同)

- [x] Task 9: 编写单元测试 (AC: 所有)
  - [x] 在 pkg/entities/zombie_factory_test.go 中添加:
    - TestNewConeheadZombieEntity() - 验证组件正确性
    - TestNewBucketheadZombieEntity() - 验证组件正确性
    - TestConeheadZombieArmorConfiguration() - 验证护甲值配置
    - TestBucketheadZombieArmorConfiguration() - 验证护甲值配置
  - [x] 运行所有测试确保通过

- [x] Task 10: 代码质量保证
  - [x] 运行 `gofmt -w .` 格式化所有代码
  - [x] 运行 `go build` 确保编译通过
  - [x] 检查所有公开函数都有 GoDoc 注释
  - [x] 验证错误处理符合编码标准

- [x] Task 11: 游戏内功能测试
  - [x] 在游戏场景中生成路障僵尸和铁桶僵尸（修改game_scene.go测试代码）
  - [x] 现在游戏启动4秒后会生成3种僵尸：普通(行0)、路障(行1)、铁桶(行2)
  - [ ] 待用户验证：高级僵尸正确显示和移动
  - [ ] 待用户验证：豌豆子弹击中时优先扣除护甲
  - [ ] 待用户验证：护甲耗尽后外观切换为普通僵尸
  - [ ] 待用户验证：护甲耗尽后僵尸继续以普通僵尸行为运作
  - [ ] 待用户验证：音效播放正确（击中护甲 vs 击中身体）

## Testing

### Test File Location
[Source: docs/architecture/testing-strategy.md]

测试文件与源文件在同一包内,以 `_test.go` 结尾:
- `pkg/entities/zombie_factory_test.go` - 实体工厂测试
- `pkg/systems/physics_system_test.go` - 伤害处理测试
- `pkg/systems/behavior_system_test.go` - 行为切换测试

### Test Standards
[Source: docs/architecture/coding-standards.md]

- 测试函数以 `Test` 开头,使用 PascalCase
- 每个测试案例应使用 `t.Run()` 创建子测试
- 使用 `t.Errorf()` 报告错误,提供清晰的错误信息

### Testing Frameworks and Patterns
- **单元测试**: 测试单个函数或方法的行为
- **表驱动测试**: 对于多个输入输出场景,使用表驱动测试模式
- **Mock/Stub**: 对于依赖外部资源(如图像文件)的测试,考虑使用 mock 或跳过(如果资源不可用)

### Specific Testing Requirements for This Story
1. **ArmorComponent 测试**:
   - 验证组件结构正确
   - 验证初始值设置正确

2. **高级僵尸实体创建测试**:
   - 验证所有组件正确添加（包括 ArmorComponent）
   - 验证护甲值初始化正确（路障370,铁桶1100）
   - 验证身体生命值初始化为 270
   - 验证行为类型正确

3. **护甲伤害处理测试**:
   - 创建有护甲的测试僵尸
   - 模拟伤害,验证护甲优先扣除
   - 模拟护甲耗尽,验证开始扣除生命值
   - 验证伤害分配逻辑正确

4. **外观切换测试**:
   - 模拟护甲耗尽事件
   - 验证动画切换为普通僵尸
   - 验证行为类型改变为 BehaviorZombieBasic
   - 验证切换只发生一次

5. **资源加载测试**:
   - 验证高级僵尸动画正确加载
   - 验证帧数正确（路障21帧,铁桶15帧）

### Test Execution
```bash
# 运行所有测试
go test ./...

# 运行特定包的测试并显示详细输出
go test ./pkg/entities -v
go test ./pkg/systems -v

# 运行测试并显示覆盖率
go test ./pkg/entities -cover
go test ./pkg/systems -cover
```

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-12 | 1.0 | 创建初始故事草稿 | Scrum Master (Bob) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5

### Debug Log References
- 所有组件编译成功: `go build`
- 单元测试(生命值配置)通过: TestConeheadZombieTotalHealth, TestBucketheadZombieTotalHealth

### Completion Notes List
1. **ArmorComponent 创建** - 新建护甲组件,支持护甲值管理
2. **行为类型扩展** - 添加 BehaviorZombieConehead 和 BehaviorZombieBuckethead
3. **配置常量完善** - 添加路障(370护甲)和铁桶(1100护甲)配置
4. **动画加载函数** - 实现高级僵尸动画加载(路障21帧,铁桶15帧)
5. **实体工厂实现** - NewConeheadZombieEntity 和 NewBucketheadZombieEntity
6. **伤害处理修改** - PhysicsSystem 优先扣除护甲值逻辑
7. **护甲音效** - playArmorHitSound() 函数,击中护甲时播放
8. **外观切换逻辑** - BehaviorSystem 护甲破坏后切换为普通僵尸
9. **单元测试** - 验证工厂函数和护甲配置的测试

### File List
**新建文件:**
- pkg/components/armor.go

**修改文件:**
- pkg/components/behavior.go (添加新行为类型)
- pkg/config/unit_config.go (添加护甲配置常量)
- pkg/utils/zombie_resources.go (添加4个动画加载函数)
- pkg/entities/zombie_factory.go (添加2个工厂函数)
- pkg/systems/physics_system.go (修改伤害处理,添加护甲音效)
- pkg/systems/behavior_system.go (添加护甲僵尸行为处理)
- pkg/entities/zombie_factory_test.go (添加单元测试)
- pkg/scenes/game_scene.go (修改测试代码生成3种僵尸)

## QA Results
_待 QA 人员填写_

