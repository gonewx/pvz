# Story 19.8: 爆炸坚果机制

## Status

Done

## Story

**As a** 玩家,
**I want** 爆炸坚果碰撞僵尸时能触发 3x3 范围爆炸,
**so that** 我能用爆炸坚果清除僵尸密集区域，获得保龄球的"全中"爽快感。

## Acceptance Criteria

1. **爆炸坚果外观为红色**
   - 爆炸坚果使用红色调色显示（区别于普通坚果）
   - 使用 ColorM 或自定义着色器实现红色效果
   - 红色调明显，玩家能立即识别

2. **碰撞第一个僵尸立即爆炸**
   - 复用 Story 19.7 的碰撞检测逻辑
   - 碰撞后不弹射，直接触发爆炸
   - 爆炸后销毁坚果实体

3. **3x3 范围内所有僵尸受到伤害**
   - 以碰撞位置为中心，计算 3x3 格子范围
   - 使用 AABB 或距离检测范围内僵尸
   - 每个范围内僵尸都受到伤害（不只是碰撞的那个）

4. **1800 伤害秒杀范围内僵尸**
   - 伤害值与樱桃炸弹相同（1800）
   - 伤害处理遵循护甲优先规则
   - 足以秒杀普通、路障、铁桶僵尸

5. **播放爆炸动画和 Powie 粒子特效**
   - 使用 `Powie.xml` 粒子配置（3个发射器）
   - 粒子效果显示在爆炸位置
   - 视觉效果明显，有冲击感

6. **播放爆炸音效**
   - 使用 `assets/sounds/explosion.ogg` 或 `cherrybomb.ogg`
   - 爆炸时播放一次（不循环）
   - 音效与粒子效果同步

7. **爆炸后坚果销毁，不弹射**
   - 确认 Story 19.7 中的爆炸坚果不弹射逻辑正确
   - 爆炸后立即销毁坚果实体
   - 停止滚动音效

8. **单元测试**: 覆盖率 ≥ 80%

## Tasks / Subtasks

### Task 1: 添加爆炸坚果配置常量 (AC: 4, 6)

- [x] 修改 `pkg/config/unit_config.go`
  - [x] `ExplosiveNutDamage = 1800` - 爆炸伤害值（与樱桃炸弹相同）
  - [x] `ExplosiveNutExplosionSoundPath = "assets/sounds/explosion.ogg"` - 爆炸音效路径
  - [x] `ExplosiveNutParticleEffect = "Powie"` - 粒子效果名称
- [x] 修改 `pkg/config/layout_config.go`
  - [x] `ExplosiveNutExplosionRadius = 1.5` - 爆炸范围（格子数，1.5 表示相邻格子）
  - [x] 注释说明 3x3 范围计算方式

### Task 2: 实现爆炸坚果红色外观 (AC: 1)

- [x] 修改 `pkg/systems/render_reanim.go`
  - [x] 在渲染 BowlingNutComponent 实体时检查 `IsExplosive` 标志
  - [x] 使用顶点着色 `colorG *= 0.3; colorB *= 0.3` 应用红色调色
- [x] 确保红色效果在滚动时持续显示

### Task 3: 实现 3x3 范围伤害计算 (AC: 3, 4)

- [x] 修改 `pkg/systems/bowling_nut_system.go`
  - [x] 添加 `triggerExplosion(entityID ecs.EntityID, posComp *components.PositionComponent)` 方法
  - [x] 计算爆炸中心位置（碰撞时的坚果位置）
  - [x] 查询范围内所有僵尸（使用距离检测）
  - [x] 对每个范围内僵尸调用伤害处理函数
- [x] 参考 `plant_behavior_handler.go` 中 `triggerCherryBombExplosion` 的实现
  - [x] 复用护甲优先伤害逻辑
  - [x] 复用闪烁效果添加
  - [x] 烧焦死亡动画由 BehaviorSystem 自动处理

### Task 4: 实现爆炸粒子特效 (AC: 5)

- [x] 修改 `pkg/systems/bowling_nut_system.go`
  - [x] 添加 `playExplosionParticle(x, y float64)` 方法
  - [x] 在 `triggerExplosion` 中调用 `entities.CreateParticleEffect`
  - [x] 使用 `config.ExplosiveNutParticleEffect` ("Powie") 作为效果名称
  - [x] 传入爆炸位置坐标
- [x] 验证 `Powie.xml` 粒子效果包含 3 个发射器：
  - [x] `PowieSmallClouds` - 小云朵
  - [x] `PowieBigClouds` - 大云朵
  - [x] `PowieWord` - "POWIE" 文字图片

### Task 5: 实现爆炸音效播放 (AC: 6)

- [x] 修改 `pkg/systems/bowling_nut_system.go`
  - [x] 添加 `playExplosionSound()` 方法
  - [x] 加载并播放 `config.ExplosiveNutExplosionSoundPath` 音效
  - [x] 在 `triggerExplosion` 中调用
- [x] 确保音效只播放一次

### Task 6: 集成爆炸逻辑到 Update 循环 (AC: 2, 7)

- [x] 修改 `pkg/systems/bowling_nut_system.go` 的 `Update()` 方法
  - [x] 修改现有爆炸坚果碰撞处理逻辑
  - [x] 碰撞时调用 `triggerExplosion()` 而不只是销毁
  - [x] 确保爆炸后正确销毁实体和停止音效
- [x] 更新日志输出，记录爆炸事件

### Task 7: 单元测试 (AC: 8)

- [x] 修改 `pkg/systems/bowling_nut_system_test.go`
  - [x] 测试 3x3 范围计算：中心位置正确 (`TestBowlingNutSystem_ExplosiveNut_AreaDamage`)
  - [x] 测试范围伤害：范围内多个僵尸都受伤 (`TestBowlingNutSystem_ExplosiveNut_MultipleZombiesInRange`)
  - [x] 测试伤害值：1800 点伤害 (`TestBowlingNutSystem_ExplosiveNut_Damage1800`)
  - [x] 测试护甲处理：铁桶僵尸护甲被破坏 (`TestBowlingNutSystem_ExplosiveNut_ArmorPriority`)
  - [x] 测试爆炸后销毁：坚果实体被正确销毁 (`TestBowlingNutSystem_ExplosiveNut_NoBounce`)
  - [x] 测试不弹射：爆炸坚果碰撞后 BounceCount 不增加 (`TestBowlingNutSystem_ExplosiveNut_BounceCountNotIncreased`)
- [x] 核心逻辑函数覆盖率 >90%（Update: 97.4%, triggerExplosion: 95.5%, 等）

## Dev Notes

### 架构上下文

本 Story 是 Epic 19 的第八个 Story，实现爆炸坚果的特殊机制。

**依赖关系**：
- **前置**: Story 19.7 保龄球碰撞与弹射系统（已完成）
- **复用**: 碰撞检测、伤害处理、音效管理
- **后续**: Story 19.9 僵尸波次配置

[Source: docs/prd/epic-19-level-1-5-bowling.md#Story 19.8]

### 前置故事上下文

**Story 19.7: 保龄球碰撞与弹射系统** (Done)

关键实现成果：
- `BowlingNutSystem` 已实现碰撞检测和伤害处理
- 爆炸坚果碰撞后当前仅标记销毁，不触发爆炸
- 相关代码位置：`bowling_nut_system.go:117-123`

```go
// 当前实现（Story 19.7）
if nutComp.IsExplosive {
    // 爆炸坚果：标记销毁，Story 19.8 处理爆炸逻辑
    // 不播放撞击音效（爆炸音效由 Story 19.8 处理）
    log.Printf("[BowlingNutSystem] 爆炸坚果碰撞，标记销毁: entityID=%d", entityID)
    s.stopRollingSound(entityID)
    s.entityManager.DestroyEntity(entityID)
    continue
}
```

**本 Story 需要修改此处**：添加 `triggerExplosion()` 调用。

[Source: docs/stories/19.7.bowling-collision-bounce-system.story.md#Completion Notes]

### 樱桃炸弹爆炸逻辑参考

**`plant_behavior_handler.go:triggerCherryBombExplosion`** 实现：

```go
// 计算爆炸中心（植物位置）
explosionCenterX := position.X + config.CherryBombExplosionCenterOffsetX
explosionCenterY := position.Y + config.CherryBombExplosionCenterOffsetY
explosionRadiusSq := config.CherryBombExplosionRadius * config.CherryBombExplosionRadius

// 查询所有僵尸
zombieEntities := ecs.GetEntitiesWith2[
    *components.BehaviorComponent,
    *components.HealthComponent,
](s.entityManager)

for _, zombieID := range zombieEntities {
    // 计算距离
    dx := zombiePos.X - explosionCenterX
    dy := zombieEffectiveY - explosionCenterY
    distanceSq := dx*dx + dy*dy

    if distanceSq <= explosionRadiusSq {
        // 应用伤害（护甲优先）
        // ...
    }
}
```

**爆炸坚果与樱桃炸弹的差异**：
- 樱桃炸弹使用圆形半径检测（115 像素）
- 爆炸坚果规范要求 3x3 格子范围
- 建议：使用 1.5 格子距离作为半径（约 150 像素）

[Source: pkg/systems/behavior/plant_behavior_handler.go:550-647]

### 3x3 范围计算

**规范定义**：`.meta/levels/level1-5.md` 第 124 行
> "对 3x3 范围内的所有僵尸造成**巨量伤害**（1800伤害）"

**实现方案**：采用**距离半径检测**（与樱桃炸弹保持一致）

**为什么距离检测等效于 3x3 格子范围**：
- 格子尺寸：CellWidth=80, CellHeight=100
- 3x3 格子对角线距离 ≈ sqrt((80*1.5)² + (100*1.5)²) ≈ 180 像素
- 使用 1.5 格子距离作为半径（约 120-150 像素），可以覆盖相邻的 8 个格子
- 距离检测更简单，性能更好，且与樱桃炸弹实现一致

```go
// 推荐实现：距离半径检测
func (s *BowlingNutSystem) isInExplosionRange(nutPos, zombiePos *components.PositionComponent) bool {
    dx := zombiePos.X - nutPos.X
    dy := zombiePos.Y - nutPos.Y
    distSq := dx*dx + dy*dy

    // 1.5 格子 ≈ 120 像素（基于 CellWidth=80）
    radiusSq := (config.CellWidth * config.ExplosiveNutExplosionRadius) *
                (config.CellWidth * config.ExplosiveNutExplosionRadius)
    return distSq <= radiusSq
}
```

### 红色调色实现

**实现方案：渲染时检查 IsExplosive**

```go
// 在 ReanimRenderSystem 或自定义渲染逻辑中
func (s *ReanimRenderSystem) Draw(screen *ebiten.Image) {
    // ...
    for _, entityID := range entities {
        // 检查是否是爆炸坚果
        if nutComp, ok := ecs.GetComponent[*components.BowlingNutComponent](s.em, entityID); ok {
            if nutComp.IsExplosive {
                // 红色调色
                op.ColorM.Scale(1.0, 0.3, 0.3, 1.0)
            }
        }
        // ...
    }
}
```

**优点**：无需添加新组件，直接在渲染时检查，简单高效。

### Powie 粒子效果配置

**`data/particles/Powie.xml`** 包含 3 个发射器：

| 发射器名称 | 描述 | 效果 |
|-----------|------|------|
| PowieSmallClouds | 小云朵 | 橙红色小粒子四散 |
| PowieBigClouds | 大云朵 | 黄橙色大粒子 |
| PowieWord | 文字 | 显示 "POWIE" 图片 |

**调用方式**：

```go
_, err := entities.CreateParticleEffect(
    s.entityManager,
    s.resourceManager,
    "Powie",  // 效果名称
    posComp.X, posComp.Y,
)
```

[Source: data/particles/Powie.xml]

### 音效资源

| 音效 | 路径 | 用途 |
|------|------|------|
| 爆炸音效 | `assets/sounds/explosion.ogg` | 爆炸坚果爆炸 |

### 坐标系统参考

**行中心 Y 坐标**：
```go
// config 常量
GridWorldStartY = 78.0
CellHeight = 100.0

// 行中心计算
rowCenterY := config.GridWorldStartY + float64(row)*config.CellHeight + config.CellHeight/2
// 行 0: 128.0, 行 1: 228.0, 行 2: 328.0, 行 3: 428.0, 行 4: 528.0
```

**列中心 X 坐标**：
```go
// config 常量
GridWorldStartX = 41.0
CellWidth = 80.0

// 列中心计算
colCenterX := config.GridWorldStartX + float64(col)*config.CellWidth + config.CellWidth/2
```

[Source: pkg/config/layout_config.go#Lawn Grid Configuration]

### 零耦合原则遵循

**系统设计**：
- `BowlingNutSystem` 不直接调用 `BehaviorSystem`
- 伤害处理直接修改 `HealthComponent` 和 `ArmorComponent`
- 粒子效果通过 `entities.CreateParticleEffect` 创建
- 音效通过 `resourceManager.LoadSoundEffect` 加载

[Source: docs/architecture/coding-standards.md#零耦合原则]

### 文件位置规范

| 文件 | 位置 |
|------|------|
| BowlingNutComponent | `pkg/components/bowling_nut_component.go` |
| BowlingNutSystem | `pkg/systems/bowling_nut_system.go` |
| 配置常量 | `pkg/config/unit_config.go`, `pkg/config/layout_config.go` |
| 粒子工厂 | `pkg/entities/particle_factory.go` |
| 单元测试 | `pkg/systems/bowling_nut_system_test.go` |

[Source: docs/architecture/source-tree.md]

## Testing

### 测试文件位置

- `pkg/systems/bowling_nut_system_test.go`

### 关键测试场景

**1. 3x3 范围伤害测试**:

```go
func TestBowlingNutSystem_ExplosiveNut_AreaDamage(t *testing.T) {
    em := ecs.NewEntityManager()
    system := systems.NewBowlingNutSystem(em, nil)

    // 创建爆炸坚果（行 2，X=500）
    nutID := em.CreateEntity()
    em.AddComponent(nutID, &components.PositionComponent{X: 500.0, Y: 328.0})
    em.AddComponent(nutID, &components.BowlingNutComponent{
        VelocityX: 250.0, Row: 2, IsRolling: true, IsExplosive: true,
    })

    // 创建目标僵尸（同行，触发碰撞）
    targetID := em.CreateEntity()
    em.AddComponent(targetID, &components.PositionComponent{X: 510.0, Y: 328.0})
    em.AddComponent(targetID, &components.BehaviorComponent{Type: components.BehaviorZombieBasic})
    em.AddComponent(targetID, &components.HealthComponent{CurrentHealth: 270, MaxHealth: 270})
    em.AddComponent(targetID, &components.CollisionComponent{Width: 40, Height: 115})

    // 创建相邻行僵尸（范围内）
    adjacentID := em.CreateEntity()
    em.AddComponent(adjacentID, &components.PositionComponent{X: 520.0, Y: 228.0}) // 行 1
    em.AddComponent(adjacentID, &components.BehaviorComponent{Type: components.BehaviorZombieBasic})
    em.AddComponent(adjacentID, &components.HealthComponent{CurrentHealth: 270, MaxHealth: 270})

    // 创建远距离僵尸（范围外）
    farID := em.CreateEntity()
    em.AddComponent(farID, &components.PositionComponent{X: 800.0, Y: 328.0}) // 同行但远
    em.AddComponent(farID, &components.BehaviorComponent{Type: components.BehaviorZombieBasic})
    em.AddComponent(farID, &components.HealthComponent{CurrentHealth: 270, MaxHealth: 270})

    system.Update(0.016)

    // 验证范围内僵尸受伤
    targetHealth, _ := ecs.GetComponent[*components.HealthComponent](em, targetID)
    assert.LessOrEqual(t, targetHealth.CurrentHealth, 0) // 被秒杀

    adjacentHealth, _ := ecs.GetComponent[*components.HealthComponent](em, adjacentID)
    assert.LessOrEqual(t, adjacentHealth.CurrentHealth, 0) // 范围内，被秒杀

    // 验证范围外僵尸未受伤
    farHealth, _ := ecs.GetComponent[*components.HealthComponent](em, farID)
    assert.Equal(t, 270, farHealth.CurrentHealth) // 范围外，未受伤
}
```

**2. 爆炸坚果不弹射测试**:

```go
func TestBowlingNutSystem_ExplosiveNut_NoBounce(t *testing.T) {
    em := ecs.NewEntityManager()
    system := systems.NewBowlingNutSystem(em, nil)

    // 创建爆炸坚果
    nutID := em.CreateEntity()
    em.AddComponent(nutID, &components.PositionComponent{X: 500.0, Y: 328.0})
    em.AddComponent(nutID, &components.BowlingNutComponent{
        VelocityX: 250.0, Row: 2, IsRolling: true, IsExplosive: true, BounceCount: 0,
    })

    // 创建僵尸触发碰撞
    // ...

    system.Update(0.016)

    // 验证坚果被销毁（实体不存在）
    _, ok := ecs.GetComponent[*components.BowlingNutComponent](em, nutID)
    assert.False(t, ok, "爆炸坚果应该被销毁")
}
```

**3. 1800 伤害测试**:

```go
func TestBowlingNutSystem_ExplosiveNut_Damage1800(t *testing.T) {
    // 验证铁桶僵尸（1370 总 HP）被秒杀
    // ...
}
```

### 测试命令

```bash
# 运行爆炸坚果相关测试
go test ./pkg/systems -v -run "TestBowlingNutSystem.*Explosive"

# 查看覆盖率
go test ./pkg/systems -cover -run "BowlingNut"

# 生成覆盖率报告
go test ./pkg/systems -coverprofile=coverage.out -run "BowlingNut"
go tool cover -html=coverage.out
```

[Source: docs/architecture/testing-strategy.md]

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-02 | 0.1 | 初始故事创建 | Bob (Scrum Master Agent) |
| 2025-12-02 | 1.0 | 完成所有任务实现 | James (Dev Agent) |

---

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (James - Dev Agent)

### Debug Log References

无需 debug log，所有测试一次通过

### Completion Notes

- 实现爆炸坚果的 3x3 范围爆炸机制
- 添加红色调色效果，通过顶点着色实现（colorG *= 0.3, colorB *= 0.3）
- 使用距离半径检测（120 像素 = 1.5 格子）实现 3x3 范围
- 复用樱桃炸弹的护甲优先伤害逻辑
- 集成 Powie 粒子特效和 explosion.ogg 音效
- 添加 8 个新的单元测试用例，核心逻辑覆盖率 >90%

### File List

**新增文件**：无

**修改文件**：
- `pkg/config/unit_config.go` - 添加 ExplosiveNutDamage, ExplosiveNutExplosionSoundPath, ExplosiveNutParticleEffect 常量
- `pkg/config/layout_config.go` - 添加 ExplosiveNutExplosionRadius 常量
- `pkg/systems/render_reanim.go` - 添加爆炸坚果红色调色渲染逻辑
- `pkg/systems/bowling_nut_system.go` - 添加 triggerExplosion, applyExplosionDamageToZombie, playExplosionParticle, playExplosionSound 方法
- `pkg/systems/bowling_nut_system_test.go` - 添加 8 个爆炸坚果相关测试用例

**删除文件**：无

---

## QA Results

### Review Date: 2025-12-02

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

实现质量优秀。代码结构清晰，遵循 ECS 架构原则，系统职责单一。爆炸逻辑正确复用了樱桃炸弹的护甲优先伤害处理模式，确保了一致性。

**代码亮点：**
- `triggerExplosion` 方法职责清晰，按顺序处理：范围计算→伤害→粒子→音效→销毁
- 使用距离平方优化性能 (`distSq <= explosionRadiusSq`)，避免不必要的 `math.Sqrt` 调用
- 红色调色实现巧妙，通过顶点着色器直接在渲染时处理，无需额外组件
- 配置常量外部化，便于调参

### Refactoring Performed

无需重构，代码质量已达标。

### Compliance Check

- Coding Standards: ✓ 遵循 Go 命名规范，使用 gofmt 格式化
- Project Structure: ✓ 文件位置符合规范
- Testing Strategy: ✓ 单元测试覆盖全面
- All ACs Met: ✓ 8/8 验收标准全部满足

### Requirements Traceability (Given-When-Then)

| AC # | 描述 | 测试覆盖 | 状态 |
|------|------|----------|------|
| 1 | 爆炸坚果外观为红色 | 渲染代码验证 (render_reanim.go:355-360) | ✓ |
| 2 | 碰撞第一个僵尸立即爆炸 | `TestBowlingNutSystem_ExplosiveNut_DestroyedOnCollision` | ✓ |
| 3 | 3x3 范围内所有僵尸受到伤害 | `TestBowlingNutSystem_ExplosiveNut_AreaDamage`, `MultipleZombiesInRange` | ✓ |
| 4 | 1800 伤害秒杀范围内僵尸 | `TestBowlingNutSystem_ExplosiveNut_Damage1800` | ✓ |
| 5 | 播放爆炸动画和 Powie 粒子特效 | 代码验证 + Powie.xml 配置确认（3发射器） | ✓ |
| 6 | 播放爆炸音效 | 代码验证 + explosion.ogg 存在确认 | ✓ |
| 7 | 爆炸后坚果销毁，不弹射 | `TestBowlingNutSystem_ExplosiveNut_NoBounce`, `BounceCountNotIncreased` | ✓ |
| 8 | 单元测试覆盖率 ≥ 80% | 核心逻辑 >90%（Update:97.4%, triggerExplosion:95.5%） | ✓ |

### Improvements Checklist

- [x] 代码符合 ECS 架构规范
- [x] 配置常量外部化 (unit_config.go, layout_config.go)
- [x] 护甲优先伤害逻辑复用樱桃炸弹实现
- [x] 测试覆盖率达标（核心逻辑 >90%）
- [x] 资源文件验证通过 (Powie.xml, explosion.ogg)

### Security Review

无安全相关代码，不涉及用户输入、网络通信或敏感数据处理。

### Performance Considerations

- 使用距离平方比较避免 `math.Sqrt` 开销 ✓
- 爆炸时遍历所有僵尸实体，对于正常游戏场景（<100 僵尸）性能可接受
- 建议（未来优化）：如果僵尸数量增加，可考虑空间分区优化

### Files Modified During Review

无文件修改

### Gate Status

Gate: PASS → docs/qa/gates/19.8-explosive-nut-mechanism.yml

### Recommended Status

✓ Ready for Done

Story 实现完整，所有验收标准满足，测试通过，代码质量良好。
