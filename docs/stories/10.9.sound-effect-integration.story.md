# Story 10.9: 音效系统集成 (Sound Effect Integration)

## Status

Draft

## Story

**As a** 玩家,
**I want** 游戏中的各种操作和事件都有相应的音效反馈,
**so that** 我能获得更沉浸的游戏体验，更好地感知游戏状态和战斗节奏。

## Acceptance Criteria

### 核心游戏流程音效 (P0 - 必须实现)

1. **关卡胜利/失败音效**
   - 关卡胜利时播放 `winmusic.ogg`
   - 关卡失败时播放 `losemusic.ogg`
   - 音效与现有 BGM 正确切换（淡出 BGM 后播放结算音乐）

2. **波次警告音效**
   - 最后一波僵尸来袭时播放 `finalwave.ogg`
   - 大波僵尸来袭时播放 `hugewave.ogg`
   - 警报音效 `siren.ogg` 或 `awooga.ogg` 配合使用

3. **割草机音效**
   - 割草机触发时播放 `lawnmower.ogg`
   - 音效持续时间与割草机移动同步

4. **僵尸音效**
   - 僵尸出现/行走时随机播放呻吟音效 `groan.ogg` ~ `groan6.ogg`
   - 僵尸死亡时播放 `splat.ogg` / `splat2.ogg` / `splat3.ogg`（随机选择）
   - 僵尸肢体脱落时播放 `limbs_pop.ogg`
   - 僵尸啃食变体音效 `chomp2.ogg`（与现有 `chomp.ogg` 轮换）

5. **游戏界面音效**
   - 暂停游戏时播放 `pause.ogg`
   - 种子槽升起时播放 `seedlift.ogg`
   - 金币收集时播放 `coin.ogg`

### 植物相关音效 (P1 - 高优先级)

6. **土豆地雷音效**
   - 土豆地雷爆炸时播放 `potato_mine.ogg`

7. **攻击植物音效**
   - 喷射蘑菇攻击时播放 `puff.ogg`
   - 大喷菇攻击时播放 `fume.ogg`
   - 寒冰射手攻击/冰冻效果时播放 `snow_pea_sparkles.ogg`
   - 冰冻僵尸效果播放 `frozen.ogg`

8. **植物种植/生长音效**
   - 植物生长完成（如土豆地雷成熟）时播放 `plantgrow.ogg`

### 护甲/碰撞音效 (P1 - 高优先级)

9. **护甲击中音效**
   - 击中路障僵尸时播放 `shieldhit.ogg`（路障/铁桶）
   - 击中铁桶僵尸时播放 `shieldhit2.ogg`（变体）
   - 当前配置路径需修正: `assets/audio/Sound/` → `assets/sounds/`

10. **碰撞/撞击音效**
    - 硬物碰撞时播放 `bonk.ogg`

### 环境/特效音效 (P2 - 中优先级)

11. **墓碑相关音效**
    - 墓碑颤动预警时播放 `gravestone_rumble.ogg`
    - 僵尸从墓碑出土时播放 `dirt_rise.ogg`

12. **雷电效果音效**
    - 雷电效果时播放 `thunder.ogg`

### 配置修复 (P0 - 必须修复)

13. **音效路径统一**
    - 修正所有 `assets/audio/Sound/` 路径为 `assets/sounds/`
    - 验证所有配置的音效文件存在

14. **单元测试**
    - 音效配置测试覆盖率 ≥ 80%
    - 测试所有音效路径有效性

## Tasks / Subtasks

### Task 1: 修复音效路径配置 (AC: 13)
- [ ] 1.1 修改 `pkg/config/unit_config.go` 中所有音效路径
  - `ZombieHitSoundPath`: `assets/audio/Sound/tap.ogg` → `assets/sounds/tap.ogg`
  - `ArmorBreakSoundPath`: `assets/audio/Sound/shieldhit.ogg` → `assets/sounds/shieldhit.ogg`
  - `ZombieEatingSoundPath`: `assets/audio/Sound/chomp.ogg` → `assets/sounds/chomp.ogg`
  - `CherryBombExplodeSoundPath`: `assets/audio/Sound/cherrybomb.ogg` → `assets/sounds/cherrybomb.ogg`
- [ ] 1.2 验证所有音效文件存在
- [ ] 1.3 运行游戏验证现有音效正常播放

### Task 2: 实现关卡结算音效 (AC: 1)
- [ ] 2.1 在 `pkg/config/` 添加音效路径常量
  - `LevelWinMusicPath = "assets/sounds/winmusic.ogg"`
  - `LevelLoseMusicPath = "assets/sounds/losemusic.ogg"`
- [ ] 2.2 修改 `LevelSystem` 在胜利/失败时播放对应音效
- [ ] 2.3 实现 BGM 淡出后播放结算音乐的逻辑
- [ ] 2.4 编写单元测试

### Task 3: 实现波次警告音效 (AC: 2)
- [ ] 3.1 添加音效路径常量
  - `FinalWaveSoundPath = "assets/sounds/finalwave.ogg"`
  - `HugeWaveSoundPath = "assets/sounds/hugewave.ogg"`
  - `SirenSoundPath = "assets/sounds/siren.ogg"`
- [ ] 3.2 修改 `WaveTimingSystem` 或 `FlagWaveSystem` 播放警告音效
- [ ] 3.3 编写单元测试

### Task 4: 实现割草机音效 (AC: 3)
- [ ] 4.1 添加音效路径常量
  - `LawnmowerSoundPath = "assets/sounds/lawnmower.ogg"`
- [ ] 4.2 修改 `LawnmowerSystem` 在触发时播放音效
- [ ] 4.3 处理音效播放与割草机移动的同步
- [ ] 4.4 编写单元测试

### Task 5: 实现僵尸音效系统 (AC: 4)
- [ ] 5.1 添加僵尸音效路径常量
  - `ZombieGroanSounds = []string{"assets/sounds/groan.ogg", ..., "assets/sounds/groan6.ogg"}`
  - `ZombieSplatSounds = []string{"assets/sounds/splat.ogg", "assets/sounds/splat2.ogg", "assets/sounds/splat3.ogg"}`
  - `ZombieLimbsPopSoundPath = "assets/sounds/limbs_pop.ogg"`
  - `ZombieChompAltSoundPath = "assets/sounds/chomp2.ogg"`
- [ ] 5.2 实现僵尸呻吟音效（随机间隔播放）
- [ ] 5.3 修改僵尸死亡逻辑播放 splat 音效
- [ ] 5.4 修改僵尸啃食逻辑轮换使用 chomp/chomp2
- [ ] 5.5 编写单元测试

### Task 6: 实现游戏界面音效 (AC: 5)
- [ ] 6.1 添加音效路径常量
  - `PauseSoundPath = "assets/sounds/pause.ogg"`
  - `SeedLiftSoundPath = "assets/sounds/seedlift.ogg"`
  - `CoinSoundPath = "assets/sounds/coin.ogg"`
- [ ] 6.2 修改暂停菜单系统播放暂停音效
- [ ] 6.3 修改种子槽系统播放升起音效
- [ ] 6.4 实现金币收集音效（如有金币系统）
- [ ] 6.5 编写单元测试

### Task 7: 实现植物相关音效 (AC: 6, 7, 8)
- [ ] 7.1 添加植物音效路径常量
  - `PotatoMineExplodeSoundPath = "assets/sounds/potato_mine.ogg"`
  - `PuffShroomAttackSoundPath = "assets/sounds/puff.ogg"`
  - `FumeShroomAttackSoundPath = "assets/sounds/fume.ogg"`
  - `SnowPeaAttackSoundPath = "assets/sounds/snow_pea_sparkles.ogg"`
  - `FrozenEffectSoundPath = "assets/sounds/frozen.ogg"`
  - `PlantGrowSoundPath = "assets/sounds/plantgrow.ogg"`
- [ ] 7.2 修改土豆地雷行为处理器播放爆炸音效
- [ ] 7.3 修改各攻击植物行为处理器播放攻击音效
- [ ] 7.4 实现植物生长完成音效
- [ ] 7.5 编写单元测试

### Task 8: 实现护甲击中音效 (AC: 9, 10)
- [ ] 8.1 添加护甲击中音效路径常量
  - `ShieldHit2SoundPath = "assets/sounds/shieldhit2.ogg"`
  - `BonkSoundPath = "assets/sounds/bonk.ogg"`
- [ ] 8.2 修改 `PhysicsSystem` 根据僵尸类型播放不同击中音效
- [ ] 8.3 编写单元测试

### Task 9: 实现环境/特效音效 (AC: 11, 12)
- [ ] 9.1 添加环境音效路径常量
  - `GravestoneRumbleSoundPath = "assets/sounds/gravestone_rumble.ogg"`
  - `DirtRiseSoundPath = "assets/sounds/dirt_rise.ogg"`
  - `ThunderSoundPath = "assets/sounds/thunder.ogg"`
- [ ] 9.2 修改墓碑相关系统播放音效（如有实现）
- [ ] 9.3 编写单元测试

### Task 10: 编写综合测试 (AC: 14)
- [ ] 10.1 编写音效配置路径有效性测试
- [ ] 10.2 编写音效加载测试
- [ ] 10.3 确保测试覆盖率 ≥ 80%

## Dev Notes

### 现有音效系统架构

**音效加载方法** [Source: pkg/game/resource_manager.go]
```go
// LoadSoundEffect 加载一次性音效（不循环）
func (rm *ResourceManager) LoadSoundEffect(path string) (*audio.Player, error)

// 使用示例:
player, err := rm.LoadSoundEffect("assets/sounds/buttonclick.ogg")
if err == nil {
    player.Play()
}
```

**已使用的音效** [Source: 代码搜索]
- `buttonclick.ogg` - 按钮点击
- `gravebutton.ogg` - 墓碑按钮
- `readysetplant.ogg` - Ready Set Plant 语音
- `shovel.ogg` - 铲子使用
- `points.ogg` - 阳光收集
- `plant.ogg` - 种植
- `buzzer.ogg` - 阳光不足警告
- `bowling.ogg` - 保龄球滚动
- `bowlingimpact.ogg` / `bowlingimpact2.ogg` - 保龄球撞击
- `explosion.ogg` - 爆炸坚果

### 音效路径配置模式

**配置常量位置** [Source: pkg/config/unit_config.go]
```go
// 音效路径常量定义在 Audio Configuration 区域
const (
    ZombieHitSoundPath = "assets/sounds/tap.ogg"
    // ...
)
```

### 关键修复点

1. **路径不一致问题**:
   - 部分配置使用 `assets/audio/Sound/` (不存在)
   - 应统一为 `assets/sounds/`

2. **音效随机化**:
   - 僵尸呻吟、死亡等音效应从多个变体中随机选择
   - 使用 `rand.Intn()` 实现随机选择

3. **音效冷却机制**:
   - 避免同一音效过于频繁播放
   - 可设置最小播放间隔（如 0.5 秒）

### 相关文件位置

- 音效资源目录: `assets/sounds/`
- 配置常量: `pkg/config/unit_config.go`
- 资源管理器: `pkg/game/resource_manager.go`
- 关卡系统: `pkg/systems/level_system.go`
- 波次系统: `pkg/systems/wave_timing_system.go`
- 割草机系统: `pkg/systems/lawnmower_system.go`
- 行为处理器: `pkg/systems/behavior/`
- 物理系统: `pkg/systems/physics_system.go`

### Testing

**测试文件位置**: `pkg/config/unit_config_test.go`, `pkg/systems/*_test.go`

**测试标准**:
- 使用 Go 标准测试框架
- 测试文件与源文件同目录
- 覆盖率目标 ≥ 80%

**测试重点**:
1. 音效路径配置有效性测试
2. 音效加载成功测试
3. 音效播放逻辑测试（使用 mock）

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-02 | 1.0 | 初始 Story 创建 | SM Agent (Bob) |

---

## 附录: 完整音效资源清单

### 音效分类汇总 (共 157 个文件)

| 分类 | 数量 | 本 Story 覆盖 |
|------|------|---------------|
| 植物相关 | ~25 | ✅ 部分 |
| 僵尸相关 | ~35 | ✅ 核心 |
| 游戏系统 | ~20 | ✅ 核心 |
| UI/交互 | ~15 | ✅ 部分 |
| 环境/特效 | ~20 | ✅ 部分 |
| 角色/载具 | ~30 | ❌ 未覆盖 |
| 加载界面 | ~2 | ❌ 未覆盖 |

**后续 Story 建议**:
- Story 10.10: 完整植物音效系统（窝瓜、火爆辣椒、玉米投手等）
- Story 10.11: 特殊僵尸音效系统（报纸、撑杆、小丑、舞王等）
- Story 10.12: 戴夫语音系统
