# Story 6.5: Reanim 渲染系统修复（技术债务清理）

## Status
To Do

## Story
**As a** 开发者,
**I want** to fix the Reanim rendering system based on correct understanding of the format,
**so that** all animations render correctly with original PVZ quality (complete body, smooth movement, proper parent-child hierarchy).

## 背景

在实现 Story 10.3（植物攻击动画）时，测试发现 Reanim 动画渲染存在严重问题。经过深入研究和数据分析（5 个 Reanim 文件，87 个轨道），发现之前对 Reanim 格式的理解存在三个重大偏差，导致：

**问题表现**：
- ❌ 豌豆射手攻击时只显示头部，身体消失
- ❌ 头部不随身体摆动（僵硬）
- ❌ 向日葵等植物可能无法正确渲染（100% 混合轨道）

**根本原因**：
1. **误区 1**：f 值理解错误 - 未区分混合轨道（76%）和动画定义轨道（23%）
2. **误区 2**：缺少双动画叠加 - 攻击时只播放 anim_shooting，身体静止
3. **误区 3**：忽略父子层级 - 头部不随身体摆动

**参考文档**：
- `docs/qa/sprint-change-proposal-reanim-system-fix.md` - 完整的变更提案
- `docs/reanim/reanim-fix-guide.md` - 详细的修复指南
- `docs/reanim/reanim-format-guide.md` - 正确的格式理解
- `docs/reanim/reanim-hybrid-track-discovery.md` - 混合轨道发现

## Acceptance Criteria

### 功能验收
1. **豌豆射手动画修复**：
   - 攻击时显示完整身体（叶子、茎干、头部）
   - 头部随身体一起摆动（不僵硬）
   - 眨眼动画正常显示
   - 射击动画流畅自然

2. **向日葵动画修复**：
   - 正确渲染所有部件（100% 混合轨道验证）
   - 待机动画流畅
   - 开花效果正确

3. **所有实体验证**：
   - 除草车动画正常
   - 僵尸动画正常
   - 坚果墙动画正常

4. **对比测试通过**：
   - 运行 `cmd/render_animation_comparison/main.go`
   - 右侧画布（双动画模式）效果符合预期
   - 与原版游戏效果一致

### 性能验收
5. 游戏运行稳定在 60 FPS
6. 渲染时间无明显增加（< 5ms/frame）

### 代码质量
7. 所有单元测试通过
8. 代码符合编码规范（gofmt, golangci-lint）
9. 代码注释完整，说明关键逻辑

### 文档更新
10. 更新 `docs/architecture/core-systems.md` 中的动画系统说明
11. 更新 `CLAUDE.md` 中的系统层级图和 Reanim 使用指南

## Tasks / Subtasks

### 阶段 1: 修复帧继承机制（1 天）✅ 简单

**目标**：实现正确的帧累积继承逻辑

- [ ] **Task 1.1**: 实现 `buildMergedTracks` 函数 (AC: 1, 2, 3)
  - [ ] 在 `pkg/systems/reanim_system.go` 中实现 `buildMergedTracks()` 方法
  - [ ] 累积变量：X, Y, ScaleX, ScaleY, SkewX, SkewY, FrameNum, ImagePath
  - [ ] 对每个物理帧索引，从前一帧继承 nil 值
  - [ ] 生成标准帧数组（standardFrameCount），所有帧都有完整数据
  - [ ] 存储在 `ReanimComponent.MergedTracks` 中

- [ ] **Task 1.2**: 修改 PlayAnimation 使用合并轨道 (AC: 1, 2, 3)
  - [ ] 在 `PlayAnimation()` 中调用 `buildMergedTracks()`
  - [ ] 将合并后的轨道存储在组件中
  - [ ] 更新所有访问帧数据的代码，使用 `MergedTracks` 而非原始 `Tracks`

- [ ] **Task 1.3**: 单元测试 (AC: 7)
  - [ ] 测试空帧正确继承前一帧的值
  - [ ] 测试部分空帧（只有 X，继承 Y）
  - [ ] 测试 ImagePath 继承

- [ ] **Task 1.4**: 验证 (AC: 1, 2)
  - [ ] 运行游戏，检查动画是否仍然播放
  - [ ] 使用调试日志验证所有帧都有完整数据

**参考**：`docs/reanim/reanim-fix-guide.md` 第 4.1 节

---

### 阶段 2: 修复 f 值判断逻辑（1-2 天）🔥 关键

**目标**：区分混合轨道和动画定义轨道，实现正确的渲染判断

- [ ] **Task 2.1**: 添加轨道类型识别函数 (AC: 1, 2, 3)
  - [ ] 在 `pkg/systems/render_system.go` 中添加 `isAnimationDefinitionTrack()` 函数
  - [ ] 硬编码动画定义轨道列表：`anim_idle`, `anim_shooting`, `anim_head_idle`, `anim_full_idle`
  - [ ] 在 `pkg/systems/render_system.go` 中添加 `isLogicalTrack()` 函数
  - [ ] 硬编码逻辑轨道列表：`anim_stem`, `_ground`

- [ ] **Task 2.2**: 构建时间窗口映射 (AC: 1)
  - [ ] 在 `ReanimComponent` 中添加 `AnimVisibles map[string][]int` 字段
  - [ ] 在 `pkg/systems/reanim_system.go` 中实现 `buildAnimVisibles()` 函数
  - [ ] 为每个动画定义轨道构建时间窗口数组（0=可见，-1=隐藏）
  - [ ] 在 `PlayAnimation()` 中构建并存储时间窗口

- [ ] **Task 2.3**: 修改渲染判断逻辑 (AC: 1, 2, 3) 🔥
  - [ ] 在 `pkg/systems/render_system.go` 中删除或注释旧的 f=-1 检查代码（第 377-387 行）
  - [ ] 实现新的 `shouldRenderTrack()` 函数：
    ```go
    1. 跳过动画定义轨道（无图片）
    2. 跳过逻辑轨道（无图片）
    3. 检查当前动画的时间窗口
    4. 检查是否有图片
    ```
  - [ ] 在渲染循环中使用新的判断逻辑

- [ ] **Task 2.4**: 移除 VisibleTracks 白名单机制 (AC: 1)
  - [ ] 从 `ReanimComponent` 中删除 `VisibleTracks` 字段（标记为 Deprecated）
  - [ ] 删除相关的白名单初始化代码

- [ ] **Task 2.5**: 单元测试 (AC: 7)
  - [ ] 测试动画定义轨道不被渲染
  - [ ] 测试逻辑轨道不被渲染
  - [ ] 测试时间窗口正确控制部件显示

- [ ] **Task 2.6**: 验证 (AC: 1, 2, 3)
  - [ ] 运行游戏，验证豌豆射手待机动画显示完整身体
  - [ ] 验证豌豆射手攻击动画仍然显示完整身体（不再只有头部）✅ 关键验收点
  - [ ] 验证向日葵正确渲染（100% 混合轨道）

**参考**：`docs/reanim/reanim-fix-guide.md` 第 4.2, 4.3 节

---

### 阶段 3: 实现双动画叠加（1-2 天）🔥 关键

**目标**：攻击时同时播放 anim_idle（身体）+ anim_shooting（头部）

- [ ] **Task 3.1**: 添加双动画支持字段 (AC: 1)
  - [ ] 在 `pkg/components/reanim_component.go` 中添加字段：
    ```go
    IsBlending          bool     // 是否在混合两个动画
    PrimaryAnimation    string   // 主动画（如 anim_idle）
    SecondaryAnimation  string   // 次动画（如 anim_shooting）
    ```

- [ ] **Task 3.2**: 定义头部轨道归属 (AC: 1)
  - [ ] 在 `pkg/systems/reanim_system.go` 中添加 `headTracks` 映射
  - [ ] 包含：`anim_face`, `idle_mouth`, `anim_blink`, `idle_shoot_blink`, `anim_sprout`
  - [ ] 实现 `isHeadTrack()` 函数

- [ ] **Task 3.3**: 修改 PlayAnimation 支持混合模式 (AC: 1) 🔥
  - [ ] 修改 `ReanimSystem.PlayAnimation()` 方法：
    ```go
    if animName == "anim_shooting" {
        // 启用混合模式
        reanimComp.IsBlending = true
        reanimComp.PrimaryAnimation = "anim_idle"      // 身体
        reanimComp.SecondaryAnimation = "anim_shooting" // 头部
    } else {
        // 单一模式
        reanimComp.IsBlending = false
        reanimComp.PrimaryAnimation = animName
    }
    ```
  - [ ] 为两个动画都构建时间窗口

- [ ] **Task 3.4**: 实现双动画渲染逻辑 (AC: 1) 🔥
  - [ ] 在 `pkg/systems/render_system.go` 中实现 `drawBlendedAnimation()` 方法
  - [ ] 获取两个动画的物理帧：
    ```go
    primaryPhysicalFrame := idleVisibleFrames[logicalFrame % len(idleVisibleFrames)]
    secondaryPhysicalFrame := shootingVisibleFrames[logicalFrame]
    ```
  - [ ] 遍历轨道，根据是否为头部轨道选择物理帧
  - [ ] 修改 `DrawReanimEntity()` 检查 `IsBlending` 并调用对应方法

- [ ] **Task 3.5**: 单元测试 (AC: 7)
  - [ ] 测试 PlayAnimation("anim_shooting") 启用混合模式
  - [ ] 测试头部轨道使用 secondary 物理帧
  - [ ] 测试身体轨道使用 primary 物理帧

- [ ] **Task 3.6**: 验证 (AC: 1)
  - [ ] 运行游戏，验证豌豆射手攻击时身体继续摆动 ✅ 关键验收点
  - [ ] 验证头部做射击动作
  - [ ] 验证两个动画同步流畅

**参考**：`docs/reanim/reanim-fix-guide.md` 第 4.4 节

---

### 阶段 4: 实现 anim_stem 父子层级（1 天）🔥 关键

**目标**：头部继承 anim_stem 偏移，随身体摆动

- [ ] **Task 4.1**: 实现 getStemOffset 函数 (AC: 1)
  - [ ] 在 `pkg/systems/render_system.go` 中实现 `getStemOffset()` 方法
  - [ ] 定义 anim_stem 初始位置常量（从 reanim 文件提取）：
    ```go
    const stemInitX = 37.6
    const stemInitY = 48.7
    ```
  - [ ] 计算当前帧与初始位置的偏移量

- [ ] **Task 4.2**: 应用偏移到头部部件 (AC: 1) 🔥
  - [ ] 在 `drawBlendedAnimation()` 中获取 stem 偏移
  - [ ] 对头部轨道，叠加 stem 偏移到部件位置：
    ```go
    if isHeadTrack(trackName) {
        x := *mergedFrame.X + stemOffsetX
        y := *mergedFrame.Y + stemOffsetY
        mergedFrame.X = &x
        mergedFrame.Y = &y
    }
    ```

- [ ] **Task 4.3**: 添加配置常量 (AC: 11)
  - [ ] 在 `pkg/config/constants.go` 中添加：
    ```go
    const (
        ReanimStemInitX = 37.6
        ReanimStemInitY = 48.7
    )
    ```
  - [ ] 更新 getStemOffset 使用配置常量

- [ ] **Task 4.4**: 单元测试 (AC: 7)
  - [ ] 测试 getStemOffset 计算正确
  - [ ] 测试头部位置包含 stem 偏移

- [ ] **Task 4.5**: 验证 (AC: 1, 4)
  - [ ] 运行游戏，验证豌豆射手攻击时头部随身体摆动 ✅ 关键验收点
  - [ ] 验证摆动幅度与身体一致
  - [ ] 运行对比测试程序，验证右侧画布效果正确

**参考**：`docs/reanim/reanim-fix-guide.md` 第 4.4 节

---

### 阶段 5: 清理和优化（0.5 天）✅ 简单

**目标**：清理代码，添加配置和日志

- [ ] **Task 5.1**: 清理废弃代码 (AC: 8)
  - [ ] 确认 `VisibleTracks` 字段已标记为 Deprecated
  - [ ] 确认 `AnimLayer`, `BaseAnimName`, `OverlayAnims` 已标记为 Deprecated
  - [ ] 添加注释说明不应使用这些字段

- [ ] **Task 5.2**: 添加配置支持 (AC: 11)
  - [ ] 在 `pkg/config/constants.go` 中添加动画定义轨道列表
  - [ ] 在 `pkg/config/constants.go` 中添加头部轨道列表
  - [ ] 更新系统代码使用配置常量

- [ ] **Task 5.3**: 添加调试日志 (AC: 9)
  - [ ] 在混合模式启用时输出日志
  - [ ] 在 stem 偏移计算时输出日志（可选，仅开发模式）
  - [ ] 添加 `--verbose` 参数控制

- [ ] **Task 5.4**: 代码格式化和 Lint (AC: 8)
  - [ ] 运行 `gofmt -w .`
  - [ ] 运行 `golangci-lint run`
  - [ ] 修复所有警告

**参考**：`docs/reanim/reanim-fix-guide.md` 第 5 节

---

### 阶段 6: 测试验证（2-3 天）

**目标**：全面测试所有修复

- [ ] **Task 6.1**: 单元测试 (AC: 7)
  - [ ] 确保所有新增代码有单元测试
  - [ ] 测试覆盖率 ≥ 80%
  - [ ] 所有测试通过

- [ ] **Task 6.2**: 对比测试 (AC: 4)
  - [ ] 运行 `go run cmd/render_animation_comparison/main.go --verbose`
  - [ ] 验证右侧画布（双动画模式）效果符合预期：
    - [ ] 身体完整显示
    - [ ] 头部随身体摆动
    - [ ] 眨眼动画出现
  - [ ] 截图保存验证结果

- [ ] **Task 6.3**: 集成测试 - 豌豆射手 (AC: 1)
  - [ ] 待机动画：完整身体，轻微摆动
  - [ ] 攻击动画：身体继续摆动，头部射击
  - [ ] 头部随身体摆动（不僵硬）
  - [ ] 眨眼动画正常

- [ ] **Task 6.4**: 集成测试 - 向日葵 (AC: 2)
  - [ ] 待机动画流畅
  - [ ] 所有部件正确显示（100% 混合轨道）
  - [ ] 开花效果正确

- [ ] **Task 6.5**: 集成测试 - 其他实体 (AC: 3)
  - [ ] 除草车动画正常
  - [ ] 僵尸行走/攻击动画正常
  - [ ] 坚果墙动画正常

- [ ] **Task 6.6**: 回归测试 (AC: 5, 6)
  - [ ] 运行完整关卡流程
  - [ ] 验证游戏稳定在 60 FPS
  - [ ] 使用性能分析工具检查渲染时间
  - [ ] 验证无明显性能下降

- [ ] **Task 6.7**: 动画切换测试
  - [ ] 待机 → 攻击 → 待机切换流畅
  - [ ] 无部件消失或闪烁
  - [ ] 无跳帧

**参考**：`docs/reanim/reanim-fix-guide.md` 第 7 节

---

### 阶段 7: 文档更新（0.5 天）

**目标**：更新项目文档

- [ ] **Task 7.1**: 更新 Architecture Document (AC: 10)
  - [ ] 修改 `docs/architecture/core-systems.md`
  - [ ] 更新 AnimationSystem → ReanimSystem 说明
  - [ ] 添加 Reanim 渲染规则说明

- [ ] **Task 7.2**: 更新 CLAUDE.md (AC: 11)
  - [ ] 更新系统层级图（删除 AnimationSystem）
  - [ ] 添加 Reanim 使用指南：
    - 混合轨道机制
    - 双动画叠加
    - 父子层级关系
  - [ ] 添加常见误区说明

- [ ] **Task 7.3**: 更新代码注释 (AC: 9)
  - [ ] 在关键函数添加详细注释
  - [ ] 说明为什么使用双动画叠加
  - [ ] 说明 f 值的正确理解

- [ ] **Task 7.4**: 更新 Story 状态
  - [ ] 更新本 Story 状态为 "Done"
  - [ ] 更新 Epic 6 状态（如果所有 Story 完成）
  - [ ] 记录实施时间和遇到的问题

---

## Definition of Done

- [ ] ✅ 所有验收标准通过（AC 1-11）
- [ ] ✅ 所有任务清单完成
- [ ] ✅ 豌豆射手攻击动画完整且流畅
- [ ] ✅ 向日葵动画正确渲染
- [ ] ✅ 对比测试程序验证通过
- [ ] ✅ 性能稳定在 60 FPS
- [ ] ✅ 单元测试覆盖率 ≥ 80%
- [ ] ✅ 代码符合编码规范
- [ ] ✅ 文档已更新
- [ ] ✅ 无编译错误或警告

---

## Dev Notes

### 修复优先级

本 Story 是 **🔴 高优先级技术债务清理**，原因：
1. 阻塞 Epic 8（第一章关卡实现）
2. 阻塞 Epic 10（游戏体验完善）
3. 影响所有使用 Reanim 的实体
4. 越晚修复，回归测试成本越高

### 实施策略

**分阶段修复**：
- 每个阶段完成后立即验证
- 使用测试程序对比验证
- 创建 git tag 作为回滚点

**关键阶段**：
- 阶段 2（f 值判断）- 最关键，解决身体消失问题
- 阶段 3（双动画叠加）- 最关键，解决身体静止问题
- 阶段 4（父子层级）- 最关键，解决头部僵硬问题

### 技术要点

#### 1. 混合轨道机制（76% 的轨道）
混合轨道同时具有：
- ✅ 图片资源（可以渲染）
- ✅ f 值控制（自我控制可见性）
- ✅ 变换数据（独立运动）

**关键**：混合轨道通过**自己的 f 值**控制自己的可见性，不依赖动画定义轨道。

#### 2. 双动画叠加机制
攻击时：
- 身体部件（叶子、茎干）使用 `anim_idle` 的物理帧
- 头部部件（脸、嘴巴）使用 `anim_shooting` 的物理帧
- 两个动画独立推进，视觉上叠加

**关键**：身体和头部使用不同的物理帧索引。

#### 3. 父子层级关系
头部部件的最终位置：
```
头部位置 = 头部自身位置 + anim_stem 偏移
```

**关键**：anim_stem 在 `anim_idle` 中摆动，在 `anim_shooting` 中静止。

### 验证工具

**对比测试程序**：`cmd/render_animation_comparison/main.go`

三种渲染模式：
- **左侧**：严格遵守 f=-1（错误，只显示头部）
- **中间**：忽略部件 f=-1（部分正确，头部不摆动）
- **右侧**：双动画叠加（正确，完整且头部摆动）✅

**使用方法**：
```bash
go run cmd/render_animation_comparison/main.go --verbose
```

### 回滚计划

**回滚点**：
- 每个阶段完成后创建 git tag（如 `story-6.5-stage-2`）
- 如果某阶段导致严重问题，回滚到前一阶段
- 回滚时间：< 5 分钟

**触发条件**：
- 严重 Bug 且无法快速修复（> 2 小时）
- 性能严重下降（< 30 FPS）
- 影响其他功能正常运行

### 参考资料

**研究文档**：
- `docs/qa/sprint-change-proposal-reanim-system-fix.md` - 完整变更提案
- `docs/reanim/reanim-fix-guide.md` - 详细修复指南（必读）
- `docs/reanim/reanim-format-guide.md` - 正确格式理解
- `docs/reanim/reanim-hybrid-track-discovery.md` - 混合轨道发现

**Epic 定义**：
- `docs/prd/epic-6-animation-system-migration.md`

**数据支持**：
- 分析了 5 个 Reanim 文件（SunFlower, Wallnut, Squash, Zombie, PeaShooter）
- 87 个轨道，66 个（76%）是混合轨道
- SunFlower 100% 使用混合轨道

### 预期收益

**修复后效果**：
- ✅ 豌豆射手攻击动画完整且流畅
- ✅ 向日葵正确渲染（100% 混合轨道验证）
- ✅ 所有动画达到原版游戏标准
- ✅ 解锁 Epic 8 和 Epic 10
- ✅ 消除技术债务

**工作量**：
- 实施时间：5-8 个工作日
- 测试时间：2-3 个工作日
- 总计：7-11 个工作日

---

## Change Log

### 2025-10-30
- **Created**: 初始创建 Story 6.5
- **Status**: To Do
- **Related**: Sprint Change Proposal `docs/qa/sprint-change-proposal-reanim-system-fix.md`
