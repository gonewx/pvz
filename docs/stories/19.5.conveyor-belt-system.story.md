# Story 19.5: 传送带系统

## Status

Ready for Review

## Story

**As a** 玩家,
**I want** 在保龄球阶段看到传送带自动生成坚果卡片，并能将卡片拖放到草坪上,
**so that** 我能享受传送带驱动的保龄球玩法，不再依赖阳光系统进行植物种植。

## Acceptance Criteria

1. **传送带显示在正确位置（铲子槽左侧）**
   - 传送带 UI 紧挨铲子槽位左边
   - 与种子栏上对齐（Y = 10）
   - 宽度容纳 10 张卡片槽位

2. **传动动画流畅（6行交错）**
   - 使用 `ConveyorBelt.png`（6行纹理）
   - 6 行交错滚动，模拟履带效果
   - 动画循环流畅，无跳帧

3. **最多容纳 10 张卡片**
   - 传送带卡片队列最大容量为 10
   - 卡片从右侧滑入，向左侧堆积
   - 超出容量时暂停生成新卡片

4. **卡片按权重生成（普通85%、爆炸15%）**
   - 普通坚果权重 85%
   - 爆炸坚果权重 15%
   - 时间间隔驱动，传送带未满时自动生成

5. **拖拽卡片可放置到红线左侧**
   - 选中卡片后显示预览效果
   - 仅允许放置到红线左侧（第 1-3 列）
   - 放置后立即触发坚果实体生成

6. **红线右侧放置时显示提示**
   - 拖拽到红线右侧时显示提示文字
   - 使用 [ADVICE_NOT_PASSED_LINE] 文本 key
   - 提示后取消放置，卡片返回传送带

7. **最终波强制生成 2-3 个爆炸坚果**
   - 检测到最终波时触发特殊生成逻辑
   - 强制插入 2-3 个爆炸坚果卡片
   - 确保玩家有清场能力

8. **单元测试**: 覆盖率 ≥ 80%

## Tasks / Subtasks

### Task 1: 创建传送带组件 (AC: 1, 3)

- [x] 创建 `pkg/components/conveyor_belt_component.go`
  - [x] `Cards []ConveyorCard` - 卡片队列
  - [x] `Capacity int` - 最大容量（默认 10）
  - [x] `ScrollOffset float64` - 传动动画偏移量
  - [x] `IsActive bool` - 是否激活
  - [x] `GenerationTimer float64` - 卡片生成计时器
  - [x] `GenerationInterval float64` - 卡片生成间隔（秒）
- [x] 定义 `ConveyorCard` 结构
  - [x] `CardType string` - 卡片类型 ("wallnut_bowling", "explode_o_nut")
  - [x] `SlideProgress float64` - 滑入动画进度
  - [x] `SlotIndex int` - 在传送带上的槽位索引

### Task 2: 创建传送带系统 (AC: 2, 3, 4, 7)

- [x] 创建 `pkg/systems/conveyor_belt_system.go`
  - [x] `NewConveyorBeltSystem(em, gs, rm)` 构造函数
  - [x] `Update(dt float64)` 更新方法
    - [x] 更新传动动画 `updateBeltAnimation(dt)`
    - [x] 更新卡片生成 `updateCardGeneration(dt)`
    - [x] 更新卡片滑入动画 `updateCardSlideIn(dt)`
  - [x] `generateCard()` 按权重生成卡片
  - [x] `OnFinalWave()` 最终波特殊处理
  - [x] `GetCardAtPosition(x, y)` 获取点击位置的卡片
  - [x] `RemoveCard(index)` 移除并返回卡片

### Task 3: 实现卡片生成算法 (AC: 4, 7)

- [x] 实现权重随机算法
  - [x] 定义卡片池配置结构
  - [x] 普通坚果权重 85、爆炸坚果权重 15
  - [x] 使用 `rand.Intn(100)` 确定卡片类型
- [x] 实现最终波强制生成
  - [x] 检测最终波触发信号
  - [x] 插入 2-3 个爆炸坚果到队列前端
  - [x] 日志记录特殊生成事件

### Task 4: 传送带 UI 渲染 (AC: 1, 2)

- [x] 修改 `pkg/scenes/game_scene.go`
  - [x] 添加 `conveyorBeltBackdrop *ebiten.Image` 字段
  - [x] 添加 `conveyorBelt *ebiten.Image` 字段（6行纹理）
- [x] 创建 `pkg/scenes/game_scene_conveyor.go`
  - [x] `drawConveyorBelt(screen)` 绘制传送带背景和传动动画
  - [x] `drawConveyorCards(screen)` 绘制传送带上的卡片
  - [x] 实现 6 行交错滚动效果
- [x] 在 `pkg/config/layout_config.go` 添加常量
  - [x] `ConveyorBeltX` - 传送带 X 位置（动态计算）
  - [x] `ConveyorBeltWidth` - 传送带宽度
  - [x] `ConveyorCardWidth` - 卡片宽度
  - [x] `ConveyorCardSpacing` - 卡片间距
  - [x] `ConveyorBeltAnimSpeed` - 传动动画速度

### Task 5: 卡片拖拽交互 (AC: 5, 6)

- [x] 修改 `pkg/scenes/game_scene_conveyor.go`（而非 game_scene_input.go）
  - [x] 添加传送带卡片点击检测
  - [x] 实现卡片选中状态管理
  - [x] 实现拖拽预览显示
- [x] 实现放置限制逻辑
  - [x] 获取放置目标列号
  - [x] 检查是否在红线左侧（列 < 3）
  - [x] 超出范围时显示提示文字（占位逻辑）
- [x] 连接坚果实体创建（Story 19.6 实现）
  - [x] 放置成功后调用 `NewBowlingNutEntity()`
  - [x] 本 Story 先用占位逻辑（仅日志）

### Task 6: 扩展关卡配置 (AC: 4)

- [x] 修改 `pkg/config/level_config.go`
  - [x] 添加 `ConveyorBeltConfig` 结构体
    - [x] `Enabled bool`
    - [x] `Capacity int`
    - [x] `CardPool []CardPoolEntry`
    - [x] `GenerationInterval float64`
  - [x] 添加 `CardPoolEntry` 结构体
    - [x] `Type string`
    - [x] `Weight int`
- [x] 更新 `data/levels/level-1-5.yaml`
  - [x] 添加 `conveyorBelt` 配置块

### Task 7: 传送带激活集成 (AC: 1)

- [x] 修改 `pkg/scenes/game_scene.go`
  - [x] 初始化 `ConveyorBeltSystem`
  - [x] 在 `Update()` 中调用系统更新
  - [x] 在 `Draw()` 中调用渲染方法
- [x] 连接阶段转场回调
  - [x] `LevelPhaseSystem.SetOnActivateBowling()` 中激活传送带
  - [x] 设置 `ConveyorBeltComponent.IsActive = true`

### Task 8: 单元测试 (AC: 8)

- [x] 创建 `pkg/components/conveyor_belt_component_test.go`
  - [x] 测试组件初始化
  - [x] 测试卡片队列操作
- [x] 创建 `pkg/systems/conveyor_belt_system_test.go`
  - [x] 测试卡片生成权重分布
  - [x] 测试容量限制
  - [x] 测试最终波强制生成
  - [x] 测试传动动画进度
- [ ] 修改 `pkg/config/level_config_test.go`
  - [ ] 测试 ConveyorBeltConfig 解析（可选，配置验证已在主代码中实现）

## Dev Notes

### 架构上下文

本 Story 是 Epic 19 的第五个 Story，实现传送带系统的完整功能。依赖于：
- **Story 19.4**: 阶段转场系统（传送带在转场完成后激活）

后续依赖于本 Story 的功能：
- **Story 19.6**: 保龄球坚果实体与滚动（传送带卡片放置后创建坚果实体）

[Source: docs/prd/epic-19-level-1-5-bowling.md#Story 19.5]

### 前置故事依赖

**Story 19.4: 预设植物与阶段转场** (已完成)
- `LevelPhaseSystem` 已实现，包含 `SetOnActivateBowling()` 回调
- `LevelPhaseComponent.ConveyorBeltVisible` 控制传送带可见性
- `LevelPhaseComponent.ConveyorBeltY` 控制传送带 Y 位置（滑入动画）
- 传送带滑入动画已在 Story 19.4 中实现（位置占位）

[Source: docs/stories/19.4.preset-plants-phase-transition.story.md]

### 传送带布局规范

**传送带位置**（屏幕坐标）：

```
┌─────────────────────────────────────────────────────────────┐
│  ┌─────────────────────┐ ┌─────┐ ┌──────┐                   │
│  │    传送带 (10槽)     │ │铲子 │ │ 菜单 │                   │
│  └─────────────────────┘ └─────┘ └──────┘                   │
│                                                              │
│  X: 根据铲子位置反推                                          │
│  Y: ConveyorBeltTargetY (10.0)                               │
│  Width: 10 * CardWidth + 边框                                 │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

**位置计算**：
```go
// 铲子 X 位置（已在 game_scene_ui.go 中计算）
shovelX := SeedBankX + seedBankWidth + ShovelGapFromSeedBank

// 传送带右边缘 = 铲子左边缘
conveyorEndX := shovelX

// 传送带 X 位置
conveyorBeltX := conveyorEndX - ConveyorBeltWidth

// 传送带 Y 位置（由 LevelPhaseComponent.ConveyorBeltY 控制）
conveyorBeltY := levelPhaseComp.ConveyorBeltY
```

[Source: .meta/levels/level1-5.md#传送带系统]

### 传动动画实现

**资源说明**：
- `ConveyorBelt.png` 是 6 行的 sprite sheet
- 每行是传送带的一个滚动帧
- 6 行交错显示，模拟履带滚动效果

**动画逻辑**：
```go
// 传动动画帧偏移（6行交错）
// 偶数行向左滚动，奇数行向右滚动（模拟履带）
for row := 0; row < 6; row++ {
    offset := scrollOffset
    if row % 2 == 1 {
        offset = -scrollOffset // 奇数行反向
    }
    // 绘制该行，应用水平偏移
    drawBeltRow(screen, row, offset)
}
```

[Source: assets/config/resources.yaml - IMAGE_CONVEYORBELT]

### 卡片生成算法

**权重随机实现**：
```go
// 卡片池配置
type CardPoolEntry struct {
    Type   string // "wallnut_bowling" 或 "explode_o_nut"
    Weight int    // 权重值
}

// 默认卡片池
defaultCardPool := []CardPoolEntry{
    {Type: "wallnut_bowling", Weight: 85},
    {Type: "explode_o_nut", Weight: 15},
}

// 生成卡片
func (s *ConveyorBeltSystem) generateCard() string {
    totalWeight := 0
    for _, entry := range s.cardPool {
        totalWeight += entry.Weight
    }
    
    roll := rand.Intn(totalWeight)
    cumulative := 0
    for _, entry := range s.cardPool {
        cumulative += entry.Weight
        if roll < cumulative {
            return entry.Type
        }
    }
    return s.cardPool[0].Type // fallback
}
```

[Source: .meta/levels/level1-5.md#传送带逻辑]

### 红线放置限制

**红线位置**：第 3 列和第 4 列之间

```go
// 红线 X 坐标（世界坐标）
redLineX := config.GridWorldStartX + float64(config.BowlingRedLineColumn) * config.CellWidth
// = 255 + 3 * 80 = 495.0

// 放置检查
func isPlacementValid(worldX float64) bool {
    col := int((worldX - config.GridWorldStartX) / config.CellWidth)
    return col < config.BowlingRedLineColumn // col < 3，即只能放在第 0、1、2 列
}
```

**无效放置处理**：
- 显示提示文字 `[ADVICE_NOT_PASSED_LINE]`
- 取消放置操作
- 卡片保留在传送带上

[Source: .meta/levels/level1-5.md#操作交互]

### 最终波特殊处理

**触发条件**：
- 检测到 `WaveSpawnSystem` 进入最终波状态
- 或接收到最终波事件信号

**处理逻辑**：
```go
func (s *ConveyorBeltSystem) OnFinalWave() {
    // 强制插入 2-3 个爆炸坚果
    count := 2 + rand.Intn(2) // 2 或 3
    for i := 0; i < count; i++ {
        s.insertCardToFront("explode_o_nut")
    }
    log.Printf("[ConveyorBeltSystem] Final wave: inserted %d explode-o-nuts", count)
}
```

[Source: .meta/levels/level1-5.md#最终波]

### 文件位置规范

| 文件 | 位置 |
|------|------|
| ConveyorBeltComponent | `pkg/components/conveyor_belt_component.go` |
| ConveyorBeltSystem | `pkg/systems/conveyor_belt_system.go` |
| 传送带渲染 | `pkg/scenes/game_scene_conveyor.go` |
| 布局常量 | `pkg/config/layout_config.go` |
| 关卡配置扩展 | `pkg/config/level_config.go` |
| 测试文件 | 与源文件同目录，`_test.go` 后缀 |

[Source: docs/architecture/source-tree.md]

### 与相邻 Story 的边界

**Story 19.4 已实现**：
- 传送带滑入动画（位置变化）
- `ConveyorBeltVisible`、`ConveyorBeltY` 状态管理
- 红线绘制

**本 Story 实现**：
- 传送带完整 UI（背景 + 传动动画）
- 卡片队列管理
- 卡片生成算法
- 拖拽交互逻辑
- 放置限制检查

**Story 19.6 将实现**：
- 保龄球坚果实体工厂
- 坚果滚动物理
- 坚果动画播放

本 Story 在卡片放置成功后，调用 Story 19.6 的坚果实体创建函数。在 19.6 未完成前，使用占位日志。

[Source: docs/prd/epic-19-level-1-5-bowling.md]

### 零耦合原则遵循

**系统间通信方式**：

1. **回调函数**：
   - `LevelPhaseSystem.SetOnActivateBowling()` 激活传送带
   - `WaveSpawnSystem` 通过事件通知最终波

2. **组件查询**：
   - `ConveyorBeltSystem` 通过查询 `ConveyorBeltComponent` 管理状态
   - 通过查询 `LevelPhaseComponent` 获取传送带可见性

3. **实体创建**：
   - 放置卡片后调用实体工厂函数创建坚果实体
   - 不直接调用其他系统方法

**禁止**：
- `ConveyorBeltSystem` 直接调用 `GameScene` 方法
- `ConveyorBeltSystem` 直接调用 `WaveSpawnSystem` 方法
- 使用全局变量共享状态

[Source: docs/architecture/coding-standards.md#零耦合原则]

### 卡片类型与坚果映射

| 卡片类型 | 坚果实体 | 描述 |
|---------|---------|------|
| `wallnut_bowling` | BowlingWallnut | 普通保龄球坚果（可弹射）|
| `explode_o_nut` | ExplodeONut | 爆炸坚果（3x3 范围爆炸）|

卡片图标资源将复用现有的 `packet_plants.png` 或创建专用的保龄球卡片图标。

[Source: .meta/levels/level1-5.md#卡片池]

### 资源引用

**图片资源**：
- `IMAGE_CONVEYORBELT_BACKDROP` - 传送带背景
- `IMAGE_CONVEYORBELT` - 传送带传动动画（6行）
- 卡片图标资源（待确认）

**配置常量建议值**：
```go
// 传送带配置
const (
    ConveyorBeltWidth = 450.0          // 传送带宽度
    ConveyorCardWidth = 40.0           // 卡片宽度
    ConveyorCardSpacing = 5.0          // 卡片间距
    ConveyorBeltAnimSpeed = 50.0       // 传动动画速度（像素/秒）
    ConveyorCardGenerationInterval = 3.0 // 卡片生成间隔（秒）
)
```

[Source: assets/config/resources.yaml]

## Testing

### 测试文件位置

- `pkg/components/conveyor_belt_component_test.go`
- `pkg/systems/conveyor_belt_system_test.go`
- `pkg/config/level_config_test.go` (补充)

### 关键测试场景

**1. 卡片生成权重测试**:
```go
func TestConveyorBeltSystem_CardGeneration(t *testing.T) {
    system := createTestConveyorBeltSystem()
    
    // 生成大量卡片统计分布
    wallnutCount := 0
    explodeCount := 0
    total := 10000
    
    for i := 0; i < total; i++ {
        cardType := system.generateCard()
        if cardType == "wallnut_bowling" {
            wallnutCount++
        } else {
            explodeCount++
        }
    }
    
    // 验证分布接近 85/15（允许 5% 误差）
    wallnutRatio := float64(wallnutCount) / float64(total)
    assert.InDelta(t, 0.85, wallnutRatio, 0.05)
}
```

**2. 容量限制测试**:
```go
func TestConveyorBeltSystem_CapacityLimit(t *testing.T) {
    em := ecs.NewEntityManager()
    system := createTestConveyorBeltSystem(em)
    
    // 填满传送带
    for i := 0; i < 10; i++ {
        system.addCard("wallnut_bowling")
    }
    
    beltComp := getConveyorBeltComponent(em)
    assert.Len(t, beltComp.Cards, 10)
    
    // 尝试添加第 11 张卡片（应该失败）
    added := system.addCard("wallnut_bowling")
    assert.False(t, added)
    assert.Len(t, beltComp.Cards, 10)
}
```

**3. 最终波强制生成测试**:
```go
func TestConveyorBeltSystem_FinalWave(t *testing.T) {
    em := ecs.NewEntityManager()
    system := createTestConveyorBeltSystem(em)
    
    // 添加 5 张普通坚果
    for i := 0; i < 5; i++ {
        system.addCard("wallnut_bowling")
    }
    
    // 触发最终波
    system.OnFinalWave()
    
    beltComp := getConveyorBeltComponent(em)
    
    // 验证前 2-3 张是爆炸坚果
    explodeCount := 0
    for i := 0; i < 3 && i < len(beltComp.Cards); i++ {
        if beltComp.Cards[i].CardType == "explode_o_nut" {
            explodeCount++
        }
    }
    assert.GreaterOrEqual(t, explodeCount, 2)
}
```

**4. 放置限制测试**:
```go
func TestConveyorBeltSystem_PlacementRestriction(t *testing.T) {
    system := createTestConveyorBeltSystem()
    
    // 红线左侧（有效）
    assert.True(t, system.isPlacementValid(300.0))  // 第 0 列
    assert.True(t, system.isPlacementValid(380.0))  // 第 1 列
    assert.True(t, system.isPlacementValid(460.0))  // 第 2 列
    
    // 红线右侧（无效）
    assert.False(t, system.isPlacementValid(540.0)) // 第 3 列
    assert.False(t, system.isPlacementValid(620.0)) // 第 4 列
}
```

### 测试命令

```bash
# 运行组件测试
go test ./pkg/components -v -run TestConveyorBelt

# 运行系统测试
go test ./pkg/systems -v -run TestConveyorBeltSystem

# 运行配置测试
go test ./pkg/config -v -run TestConveyorBeltConfig

# 查看覆盖率
go test ./pkg/components ./pkg/systems ./pkg/config -cover -run "ConveyorBelt"
```

[Source: docs/architecture/testing-strategy.md]

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-02 | 0.1 | Initial story creation | Bob (Scrum Master Agent) |

---

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5

### Debug Log References

- 组件测试: `go test ./pkg/components -v -run "ConveyorBelt"` - 全部通过
- 系统测试: `go test ./pkg/systems -v -run "ConveyorBelt"` - 全部通过
- 编译验证: `go build ./...` - 无错误

### Completion Notes

1. **传送带组件** (`conveyor_belt_component.go`)
   - 实现了 `ConveyorBeltComponent` 和 `ConveyorCard` 结构
   - 包含容量、生成计时器、选中状态等字段
   - 提供 `IsFull()`, `IsEmpty()`, `CardCount()` 辅助方法

2. **传送带系统** (`conveyor_belt_system.go`)
   - 实现了完整的卡片生成算法（权重随机）
   - 支持最终波特殊处理（插入2-3个爆炸坚果）
   - 支持从关卡配置读取卡片池和生成间隔

3. **UI 渲染** (`game_scene_conveyor.go`)
   - 绘制传送带背景和传动动画（6行交错滚动）
   - 绘制卡片（临时使用颜色区分，后续 Story 19.6 添加图标）
   - 实现卡片选中预览和拖拽效果

4. **交互逻辑**
   - 点击传送带卡片进行选中
   - 拖拽到草坪放置（限制红线左侧）
   - 红线右侧放置时取消选中（提示逻辑为占位）

5. **关卡配置扩展**
   - 添加了 `ConveyorBeltConfig` 和 `CardPoolEntry` 结构
   - 更新了 `level-1-5.yaml` 配置

6. **测试覆盖**
   - 组件测试: 5 个测试用例
   - 系统测试: 10 个测试用例
   - 权重分布测试验证 85%/15% 比例

### File List

**新增文件:**
- `pkg/components/conveyor_belt_component.go` - 传送带组件
- `pkg/components/conveyor_belt_component_test.go` - 组件测试
- `pkg/systems/conveyor_belt_system.go` - 传送带系统
- `pkg/systems/conveyor_belt_system_test.go` - 系统测试
- `pkg/scenes/game_scene_conveyor.go` - UI 渲染和交互

**修改文件:**
- `pkg/scenes/game_scene.go` - 添加传送带系统初始化和集成
- `pkg/scenes/game_scene_resources.go` - 加载传送带图片资源
- `pkg/config/layout_config.go` - 添加传送带布局常量
- `pkg/config/level_config.go` - 添加 ConveyorBeltConfig 结构
- `data/levels/level-1-5.yaml` - 添加传送带配置

---

## QA Results

(To be filled by QA Agent)
