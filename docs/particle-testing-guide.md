# 粒子效果测试指南

## 问题分析

### 粒子效果与原版的差异

经过代码审查，粒子系统的实现是**完整且正确的**：

1. ✅ **多发射器支持**：`PeaSplat.xml` 包含2个发射器
   - `PeaSplat`：核心溅射印记（1个静态粒子）
   - `PeaSplatBits`：动态飞溅碎屑（6-10个粒子，带重力和摩擦力）

2. ✅ **正确创建**：`particle_factory.go` (Story 7.4) 已修复，会创建所有发射器

3. ✅ **正确渲染**：`RenderSystem.DrawParticles()` 支持批量渲染和混合模式

### 可能的差异原因

1. **生命周期短**：粒子只存在 0.2 秒，可能不够明显
2. **视觉对比**：需要与原版并排对比才能发现细微差异
3. **参数调优**：可能需要微调 XML 配置参数

## 新增测试功能

### 键盘快捷键

在游戏场景中，现在可以使用以下快捷键直接生成粒子效果，无需通过攻击触发：

| 键盘 | 粒子效果 | 说明 |
|------|---------|------|
| **P** | `PeaSplat` | 豌豆击中溅射效果（2个发射器） |
| **B** | `BossExplosion` | Boss爆炸效果 |
| **A** | `Award` | 奖励光效 |

### 使用方法

1. 运行游戏：`go run .` 或 `./pvz-test`
2. 进入游戏场景（点击"开始游戏"）
3. 将鼠标移动到想要生成粒子效果的位置
4. 按下对应的快捷键（P/B/A）
5. 粒子效果将在鼠标位置生成

### 测试建议

#### 测试豌豆溅射效果 (P 键)

1. **对比子弹击中**：
   - 种植豌豆射手，让它攻击僵尸
   - 观察子弹击中时的粒子效果
   - 按 P 键在同一位置手动生成
   - 对比两者是否一致

2. **观察双发射器效果**：
   - 核心印记（1个）：绿色污渍，0.2秒内淡出
   - 飞溅碎屑（6-10个）：向四周飞溅，旋转下落

3. **检查物理效果**：
   - 碎屑应该有重力（向下落）
   - 碎屑应该有摩擦力（减速）
   - 碎屑应该自旋（-200到200度/秒）

#### 测试爆炸效果 (B 键)

1. 在草坪上多次按 B 键
2. 观察爆炸粒子的飞溅范围
3. 检查加法混合模式（发光效果）

#### 测试奖励光效 (A 键)

1. 收集阳光时的粒子效果
2. 按 A 键手动生成对比

## 调试技巧

### 查看详细日志

运行时启用详细日志：
```bash
go run . --verbose
```

日志会显示：
- 粒子配置加载（发射器数量）
- 粒子实体创建（位置、生命周期）
- 粒子渲染（数量、批次）

### 使用粒子查看器工具

对于更专业的粒子效果调试，使用专门的查看器：
```bash
go run cmd/particles/main.go --filter=Pea --verbose
```

查看器功能：
- 浏览所有粒子效果
- 实时生成预览
- 自动播放模式
- 搜索过滤

## 性能监控

### 粒子数量监控

游戏会在日志中显示：
```
[RenderSystem] DrawParticles: 找到 15 个粒子实体
```

### 性能目标

根据 Story 7.3 性能测试：
- ✅ 1000 粒子渲染：0.22ms（目标 <3ms）
- ✅ 顶点数组复用：预分配 4000 顶点
- ✅ 批量渲染：按混合模式分组

## 原版对比要点

### PeaSplat 效果特征（原版）

根据 `.meta/particles/PeaSplat.md` 文档：

**核心印记 (PeaSplat)**：
- 1个粒子，随机朝向
- 4种形状可选（`ImageFrames=4`）
- 生命周期 0.2 秒
- 从 90% 不透明度淡出到完全透明
- 尺寸从 40%-60% 增长到 80%-120%

**飞溅碎屑 (PeaSplatBits)**：
- 6-10 个粒子，360° 随机发射
- 3种形状可选（`ImageFrames=3`）
- 初始速度 150 像素/秒
- 旋转速度 -200 到 200 度/秒
- 受重力影响（Y轴加速度 10）
- 受摩擦力影响（生命周期 40% 后 0.1 摩擦）
- 生命周期 0.2 秒，后 20% 淡出

### 对比清单

- [ ] 核心印记是否可见（绿色污渍）
- [ ] 碎屑数量是否在 6-10 个范围
- [ ] 碎屑是否向四周飞溅（360°）
- [ ] 碎屑是否旋转
- [ ] 碎屑是否下落（重力）
- [ ] 碎屑是否减速（摩擦力）
- [ ] 生命周期是否约 0.2 秒
- [ ] 淡出效果是否正确

## 已知问题和限制

### 无需修复（设计决策）

1. **短生命周期**：粒子只存在 0.2 秒是原版设计，不是 bug
2. **简单图形**：使用简单的精灵图而非复杂特效
3. **固定参数**：XML 配置是原版数据，不应随意修改

### 可能的改进方向

如果效果确实不满意，可以考虑：

1. **调整生命周期**：修改 XML 的 `ParticleDuration` 参数
2. **增加粒子数量**：修改 `SpawnMinActive` 参数
3. **调整物理参数**：修改重力和摩擦力数值
4. **更换图片**：使用更高质量的粒子纹理

**注意**：任何修改都应该有明确的理由和记录。

## 代码位置

### 相关文件

- **输入处理**：`pkg/systems/input_system.go` (第 75-115 行)
- **UI 提示**：`pkg/scenes/game_scene.go` (第 670-698 行)
- **粒子工厂**：`pkg/entities/particle_factory.go`
- **粒子系统**：`pkg/systems/particle_system.go`
- **渲染系统**：`pkg/systems/render_system.go` (DrawParticles)
- **碰撞触发**：`pkg/systems/physics_system.go` (第 164-178 行)

### 配置文件

- **PeaSplat 配置**：`data/particles/PeaSplat.xml`
- **资源配置**：`assets/config/resources.yaml` (粒子图片映射)

## 移除测试功能

如果不再需要测试功能，可以：

1. 删除 `input_system.go` 中的键盘检测代码（第 75-115 行）
2. 删除 `game_scene.go` 中的 `drawParticleTestInstructions` 方法
3. 删除 `game_scene.go` 中的调用（第 534 行）

或者保留代码，使用 `--verbose` 标志控制是否显示测试说明。

## 总结

粒子系统的实现是**完整且正确的**，包括：
- ✅ 多发射器支持
- ✅ 物理效果（重力、摩擦力）
- ✅ 动画插值（透明度、缩放、旋转）
- ✅ 高性能批量渲染

新增的测试功能可以帮助你：
- 快速对比粒子效果
- 调试参数配置
- 验证物理模拟

如果效果确实与原版有差异，最可能的原因是：
1. 视觉感知（0.2秒太快）
2. 图片资源差异
3. 参数需要微调

请使用测试功能仔细对比，并提供具体的差异描述！

