# Sprint Change Proposal: 原版进度条机制实现

## 文档信息

| 字段 | 值 |
|------|---|
| 提案日期 | 2025-11-28 |
| 提案人 | Bob (Scrum Master) |
| 影响 Epic | Epic 11: 关卡 UI 增强 |
| 新增 Story | Story 11.5: 原版进度条机制实现 |
| 状态 | 待批准 |

---

## 1. 问题识别摘要

### 触发原因

用户提供了原版 PvZ 进度条机制的详细规格文档 (`.meta/data/progress.md`)，发现当前 Story 11.2 的实现是**简化版本**，与原版机制有根本差距。

### 核心问题

当前进度条实现使用简单的 `击杀僵尸数 / 总僵尸数` 计算进度，而原版 PvZ 使用复杂的**双段式 + 双层追踪**机制：

| 功能点 | 当前实现 | 原版需求 |
|-------|---------|---------|
| 进度条结构 | 单一 0%-100% | 双段式（红字波段 + 普通波段） |
| 进度计算 | 击杀百分比 | 时间进度 vs 血量削减取最大值 |
| 红字波处理 | 无独立处理 | 红字波刷新时立即 +12 |
| 进度上限 | 限制 ≤1.0 | 允许超过右端点，下波回退 |
| 显示平滑 | 直接显示 | 虚拟→现实双层追踪 |

### 需求来源

`.meta/data/progress.md` 文档定义了原版进度条的 6 点核心机制：

1. 进度条总长 150，分为红字波段（每波 12）和普通波段（126 for 无尽）
2. 红字波刷新时立即 +12
3. 普通波段按波次平均分配，使用左端点/右端点计算
4. "当前波进度"取时间进度和血量削减进度的最大值
5. 进度可超过右端点（如"炸两炮"），下波刷新后会回退
6. 虚拟进度条→现实进度条的平滑追踪机制（落后 1-6 格每 20cs 前进，落后 7+ 每 5cs 前进）

---

## 2. Epic 影响摘要

### 当前 Epic 状态

**Epic 11: 关卡 UI 增强**

| Story | 状态 | 影响 |
|-------|------|------|
| Story 11.1 | ✅ Done | 无影响 |
| Story 11.2 | ✅ Done | 需要增强（不回滚） |
| Story 11.3 | (待确认) | 无影响 |
| Story 11.4 | (待确认) | 无影响 |
| **Story 11.5** | **新增** | 原版进度条机制实现 |

### 决策

- ✅ **保留 Story 11.2** - 渲染系统和 UI 布局正确，无需回滚
- ✅ **新增 Story 11.5** - 实现原版进度计算逻辑
- ❌ 不需要新增 Epic

---

## 3. 文档调整需求

### 需要更新的文件

| 文件 | 变更类型 | 描述 |
|------|---------|------|
| `docs/prd/epic-11-level-ui-enhancement.md` | 更新 | 添加 Story 11.5 引用 |
| `docs/stories/11.5.story.md` | 新增 | Story 11.5 详细文档 |

### 需要修改的代码文件

| 文件 | 变更类型 | 描述 |
|------|---------|------|
| `pkg/components/level_progress_bar_component.go` | 重大修改 | 扩展数据结构支持原版机制 |
| `pkg/systems/level_system.go` | 重大修改 | 实现原版进度计算逻辑 |
| `pkg/config/level_progress_bar_config.go` | 扩展 | 添加原版进度条常量 |
| `pkg/systems/level_progress_bar_render_system.go` | 修改 | 适配新进度值 |
| `pkg/game/game_state.go` | 可能扩展 | 添加游戏时钟计数器（如需要） |

---

## 4. 推荐前进路径

### 选择方案

**方案 1: 直接增强** ✅ 已选择

理由：
1. Story 11.2 的渲染系统和 UI 布局是正确的，无需回滚
2. 主要是进度**计算逻辑**需要重构，不影响渲染层
3. 组件数据结构扩展是向后兼容的
4. 一次性完整实现，避免分阶段的集成复杂度

### 风险评估

| 风险 | 级别 | 缓解措施 |
|------|------|---------|
| 血量追踪实现复杂 | 中 | 利用现有 HealthComponent，通过 System 查询计算 |
| 游戏时钟精度 | 低 | 使用厘秒 (cs) 计数器，与原版一致 |
| 进度回退逻辑 | 低 | 虚拟进度允许超过 1.0，现实进度平滑追踪 |

---

## 5. PRD MVP 影响

### 影响范围

- ✅ **核心 MVP 目标不变** - 进度条功能已存在，这是精度增强
- ✅ **无范围削减** - 完整实现原版 6 点机制
- ✅ **向后兼容** - 现有关卡配置无需修改

### 优先级调整

Story 11.5 优先级：**⭐⭐⭐⭐ 高**
- 进度条是玩家获取关卡进度的唯一途径
- 原版机制实现提升游戏还原度

---

## 6. 高层行动计划

### Story 11.5: 原版进度条机制实现

#### 任务分解

| # | 任务 | 对应需求点 | 复杂度 | 依赖 |
|---|------|-----------|-------|------|
| T1 | 扩展 `LevelProgressBarComponent` 数据结构 | 全部 | 中 | - |
| T2 | 实现双段式进度条分配（红字波 + 普通波） | 1, 2, 3 | 中 | T1 |
| T3 | 实现双重进度计算（时间进度 vs 血量削减取最大值） | 4 | 高 | T1, T2 |
| T4 | 允许进度超过右端点并支持回退 | 5 | 低 | T3 |
| T5 | 实现虚拟/现实双层进度条平滑追踪 | 6 | 高 | T4 |
| T6 | 添加游戏时钟计数器（厘秒单位） | 6 | 低 | - |
| T7 | 更新渲染系统适配新进度值 | 全部 | 低 | T5 |
| T8 | 单元测试 | 全部 | 中 | T1-T7 |

#### 新增数据结构设计

```go
// LevelProgressBarComponent 扩展字段
type LevelProgressBarComponent struct {
    // === 现有字段（保留）===
    BackgroundImage  *ebiten.Image
    ProgressBarImage *ebiten.Image
    PartsImage       *ebiten.Image
    FlagPositions    []float64
    LevelText        string
    ShowLevelTextOnly bool
    X, Y             float64

    // === 原版机制新增字段 ===

    // 进度条结构配置
    TotalProgressLength   int     // 进度条总长度 (150)
    FlagSegmentLength     int     // 红字波段长度 (每波12)
    NormalSegmentBase     int     // 普通波段基础长度 (126 for 无尽)

    // 波次追踪
    TotalWaves            int     // 总波次数
    CurrentWaveNum        int     // 当前波次号 (从1开始)
    FlagWaveCount         int     // 已完成的红字波数量

    // 时间进度追踪
    WaveStartTime         float64 // 本波开始时间
    WaveInitialDelay      float64 // 本波初始刷新倒计时

    // 血量削减进度追踪
    WaveInitialHealth     float64 // 本波僵尸初始总血量
    WaveCurrentHealth     float64 // 本波僵尸当前总血量
    WaveRequiredDamage    float64 // 本波激活所需削减血量

    // 虚拟/现实进度条
    VirtualProgress       float64 // 虚拟进度条值 (可超过1.0)
    RealProgress          float64 // 现实进度条值 (0.0-1.0, 平滑追踪)

    // 游戏时钟（厘秒计数器）
    GameTickCS            int     // 游戏时钟 (centiseconds, 每0.01秒+1)

    // === 废弃字段（保留向后兼容）===
    TotalZombies    int     // @Deprecated: 使用波次级别追踪替代
    KilledZombies   int     // @Deprecated: 使用血量削减替代
    ProgressPercent float64 // @Deprecated: 使用 RealProgress 替代
}
```

#### 核心算法设计

```go
// 计算虚拟进度条值
func calculateVirtualProgress(pb *LevelProgressBarComponent) float64 {
    // 第一部分：红字波段 (每波立即+12)
    flagProgress := float64(pb.FlagWaveCount * pb.FlagSegmentLength)

    // 第二部分：普通波段
    if pb.TotalWaves <= 1 {
        return flagProgress / float64(pb.TotalProgressLength)
    }

    // 计算当前波的左端点和右端点
    leftEndpoint := float64((pb.CurrentWaveNum-1) * pb.NormalSegmentBase / (pb.TotalWaves-1))
    rightEndpoint := float64(pb.CurrentWaveNum * pb.NormalSegmentBase / (pb.TotalWaves-1))

    // 计算当前波进度 (时间进度 vs 血量削减取最大值)
    timeProgress := 0.0
    if pb.WaveInitialDelay > 0 {
        waveElapsed := currentLevelTime - pb.WaveStartTime
        timeProgress = waveElapsed / pb.WaveInitialDelay
    }

    damageProgress := 0.0
    if pb.WaveRequiredDamage > 0 {
        damageDealt := pb.WaveInitialHealth - pb.WaveCurrentHealth
        damageProgress = damageDealt / pb.WaveRequiredDamage
    }

    waveProgress := math.Max(timeProgress, damageProgress)

    // 当前波的实际数值 (可超过右端点)
    normalProgress := (rightEndpoint-leftEndpoint)*waveProgress + leftEndpoint

    // 总虚拟进度
    return (flagProgress + normalProgress) / float64(pb.TotalProgressLength)
}

// 更新现实进度条（平滑追踪虚拟进度条）
func updateRealProgress(pb *LevelProgressBarComponent) {
    diff := pb.VirtualProgress - pb.RealProgress
    if diff <= 0 {
        return // 现实进度不落后，不更新
    }

    // 转换为格数 (150格)
    diffInUnits := int(diff * float64(pb.TotalProgressLength))

    // 根据落后量决定更新频率
    if diffInUnits >= 7 {
        // 落后7格以上：每5cs前进一格
        if pb.GameTickCS % 5 == 0 {
            pb.RealProgress += 1.0 / float64(pb.TotalProgressLength)
        }
    } else if diffInUnits >= 1 {
        // 落后1-6格：每20cs前进一格
        if pb.GameTickCS % 20 == 0 {
            pb.RealProgress += 1.0 / float64(pb.TotalProgressLength)
        }
    }

    // 确保不超过虚拟进度
    if pb.RealProgress > pb.VirtualProgress {
        pb.RealProgress = pb.VirtualProgress
    }
}
```

---

## 7. Agent 交接计划

| 角色 | 职责 | 交接内容 |
|------|------|---------|
| **SM (当前)** | 创建提案、Story 文档 | 本提案、Story 11.5 模板 |
| **Dev Agent** | 实现 Story 11.5 | 任务分解、技术设计 |
| **QA Agent** | 验收测试 | 原版进度条行为验证 |

---

## 8. 最终审查

### Checklist 完成状态

- [x] **1. 理解触发器与上下文** - 已分析当前实现与原版需求的差距
- [x] **2. Epic 影响评估** - 确认在 Epic 11 中新增 Story 11.5
- [x] **3. 文档冲突分析** - 识别需要更新的文档和代码文件
- [x] **4. 前进路径评估** - 选择方案 1 (直接增强)
- [x] **5. Sprint Change Proposal 组件** - 本文档
- [ ] **6. 用户批准** - 待批准

### 预期结果

完成 Story 11.5 后：
- ✅ 进度条显示符合原版 PvZ 机制
- ✅ 支持红字波独立进度段
- ✅ 支持时间/血量双重进度计算
- ✅ 支持虚拟/现实双层平滑追踪
- ✅ 向后兼容现有关卡配置

---

## 附录

### A. 参考文档

- `.meta/data/progress.md` - 原版进度条机制规格
- `docs/stories/11.2.story.md` - 当前进度条实现
- `docs/prd/epic-11-level-ui-enhancement.md` - Epic 11 定义

### B. 相关代码文件

- `pkg/components/level_progress_bar_component.go`
- `pkg/systems/level_progress_bar_render_system.go`
- `pkg/systems/level_system.go`
- `pkg/config/level_progress_bar_config.go`
- `pkg/game/game_state.go`
