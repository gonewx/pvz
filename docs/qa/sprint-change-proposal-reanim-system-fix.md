# Sprint 变更提案：Reanim 动画系统修复

**日期**：2025-10-30
**提案人**：Sarah (Product Owner)
**触发原因**：测试时发现 Reanim 动画渲染不正确
**影响范围**：Epic 6, Epic 8, Epic 10
**优先级**：🔴 高优先级

---

## 📋 执行摘要

### 核心问题
在实现植物攻击动画功能时，测试发现 Reanim 动画系统的渲染存在严重问题。经过深入研究和数据分析（5 个 Reanim 文件，87 个轨道），发现之前对 Reanim 格式的理解存在**三个重大偏差**，导致动画无法正确渲染。

**问题表现**：
- ❌ 豌豆射手攻击时只显示头部，身体消失
- ❌ 头部不随身体摆动（僵硬）
- ❌ 向日葵等植物可能无法正确渲染（100% 混合轨道）
- ❌ 所有依赖 Reanim 的实体动画受影响

### 推荐方案
**采用"选项 1：直接调整/集成"**，按照修复指南分 5 个阶段修正现有实现，预计工作量 5-8 个工作日。此方案可以保留所有已完成的工作，彻底解决技术债务，为后续 Epic 铺平道路。

---

## 1️⃣ 问题详细分析

### 1.1 触发故事
- **触发时机**：在实现 Story 10.3（植物攻击动画）时发现
- **发现方式**：测试时发现渲染不正确
- **已完成 Story**：Epic 6（Story 6.1-6.3）、Epic 10（Story 10.2-10.3）

### 1.2 核心问题定义

经过对原版《植物大战僵尸》动画机制的深入研究，发现了三个关键误区：

#### ❌ **误区 1：f 值理解错误**

**之前的错误理解**：
- 所有轨道的 `f=-1` 都应该隐藏部件
- 实现：`render_system.go:377-387` 对所有 `f=-1` 进行跳过

**正确理解**（基于数据分析）：
- **混合轨道（76%）**：检查自己的 f 值（f=0 显示，f=-1 隐藏）
- **动画定义轨道（23%）**：控制时间窗口（影响纯视觉轨道）
- **纯视觉轨道（<1%）**：依赖动画定义轨道的时间窗口

**数据支持**：
- 分析了 5 个 Reanim 文件（SunFlower, Wallnut, Squash, Zombie, PeaShooter）
- 发现 87 个轨道中，66 个（76%）是混合轨道
- SunFlower 100% 使用混合轨道（无动画定义轨道）

#### ❌ **误区 2：缺少双动画叠加**

**之前的错误实现**：
- 攻击时只播放 `anim_shooting`
- 导致身体静止，只有头部在动

**正确实现**：
- 同时播放 `anim_idle`（身体摆动）+ `anim_shooting`（头部射击）
- 身体部件使用 `anim_idle` 的物理帧
- 头部部件使用 `anim_shooting` 的物理帧

#### ❌ **误区 3：忽略父子层级**

**之前的错误实现**：
- 头部位置固定，不随身体摆动

**正确实现**：
- 头部继承 `anim_stem`（茎干挂载点）的偏移
- 头部最终位置 = 头部自身位置 + anim_stem 偏移
- 实现"头随身体摆动"的效果

### 1.3 问题类型
- ✅ 技术限制/死胡同（当前实现无法正确渲染）
- ✅ 基本误解现有需求（对 Reanim 格式理解错误）

### 1.4 证据材料
- ✅ **研究文档**（3 个）：
  - `docs/reanim/reanim-format-guide.md`（正确理解）
  - `docs/reanim/reanim-hybrid-track-discovery.md`（混合轨道发现）
  - `docs/reanim/reanim-fix-guide.md`（修复指南）
- ✅ **测试程序**：`cmd/render_animation_comparison/main.go`（三种渲染模式对比）
- ✅ **数据分析**：5 个 reanim 文件，87 个轨道，76% 混合轨道

---

## 2️⃣ Epic 影响评估

### 2.1 当前 Epic 6（动画系统迁移）

| Story | 状态 | 影响程度 | 需要修改？ |
|-------|------|---------|----------|
| **6.1** | ✅ Done | 🟢 轻微 | ❌ 解析器正确，无需修改 |
| **6.2** | ✅ Done | 🔴 严重 | ✅ 帧继承、渲染判断需修复 |
| **6.3** | ✅ Done | 🔴 严重 | ✅ f 值判断、渲染逻辑需修复 |
| **6.4** | ⚠️ Deprecated | 🟡 中等 | ✅ 需要新方法实现双动画 |

**结论**：
- ❌ 当前 Epic 无法以现有实现完成
- ✅ 但可以通过修正实现达成目标

### 2.2 未来 Epic 依赖分析

| Epic | 依赖程度 | 影响 | 说明 |
|------|---------|------|------|
| **Epic 7** (粒子系统) | 🟡 间接 | 🟢 轻微 | 粒子与动画协同，但独立系统 |
| **Epic 8** (第一章关卡) | 🔴 强依赖 | 🔴 严重 | 所有关卡需要正确的动画 |
| **Epic 10** (体验完善) | 🔴 强依赖 | 🔴 严重 | 明确包含"植物攻击动画" |
| **Epic 11** (UI 增强) | 🟡 可能 | 🟢 轻微 | 部分 UI 动画可能使用 Reanim |

**依赖关系图**：
```
Epic 6 (Reanim 基础) ──┬──> Epic 8 (关卡实现) 🔴 阻塞
                       ├──> Epic 10 (体验完善) 🔴 阻塞
                       └──> Epic 11 (UI 增强) 🟡 部分影响
```

**结论**：
- 🔴 Epic 8 和 Epic 10 被阻塞
- ✅ 修复后可以顺利进行后续 Epic

### 2.3 Epic 影响总结
- ✅ Epic 6 可以完成，但需要修正实现
- 🔴 Epic 8 和 Epic 10 依赖正确的 Reanim 系统
- 🔴 修复优先级：高优先级（阻塞后续进度）

---

## 3️⃣ 制品影响分析

### 3.1 需要更新的制品

| 制品 | 文件 | 状态 | 更新内容 | 优先级 |
|------|------|------|---------|--------|
| **PRD** | `docs/prd/epic-6-*.md` | 🟢 无冲突 | 无需更新 | - |
| **Architecture** | `docs/architecture/core-systems.md` | 🟡 过时 | 更新 AnimationSystem → ReanimSystem | 🟡 中 |
| **CLAUDE.md** | `CLAUDE.md` | 🟡 过时 | 更新系统层级图，添加 Reanim 说明 | 🟢 低 |
| **代码** | `pkg/systems/render_system.go` | 🔴 错误 | 修复 f 值判断逻辑 | 🔴 高 |
| **代码** | `pkg/systems/reanim_system.go` | 🔴 缺失 | 实现双动画叠加机制 | 🔴 高 |
| **代码** | `pkg/components/reanim_component.go` | 🔴 缺失 | 添加双动画支持字段 | 🔴 高 |

### 3.2 制品冲突详情

#### ✅ PRD 文档
- **状态**：无冲突
- **原因**：PRD 只描述高层需求，未涉及实现细节

#### ⚠️ Architecture Document
- **文件**：`docs/architecture/core-systems.md:41`
- **问题**：仍然描述旧的 `AnimationSystem`
- **需要**：更新为 `ReanimSystem` 说明

#### ⚠️ CLAUDE.md
- **文件**：`CLAUDE.md:93`
- **问题**：系统层级图中显示 `AnimationSystem`
- **需要**：更新层级图，添加 Reanim 使用指南

---

## 4️⃣ 前进路径评估

### 4.1 选项对比

| 选项 | 工作量 | 风险 | 达成目标 | 推荐度 |
|------|--------|------|---------|--------|
| **1. 直接调整** | 5-8 天 | 🟡 中等 | ✅ 是 | ✅ **强烈推荐** |
| **2. 回滚** | 0.5 天 + 10-15 天 | 🔴 高（长期） | ❌ 否 | ❌ 不推荐 |
| **3. 简化** | 3-4 天 + 5-8 天 | 🟡 中等 | ⚠️ 部分 | ⚠️ 谨慎考虑 |

### 4.2 推荐路径：选项 1（直接调整/集成）

#### 优势
1. ✅ **无需回滚**：保留所有已完成的工作
2. ✅ **影响可控**：只需修改 3-4 个核心文件
3. ✅ **风险较低**：有详细的修复指南和测试工具
4. ✅ **彻底解决**：消除技术债务

#### 劣势
1. ❌ **需要深度重构**：渲染逻辑需要重新设计
2. ❌ **测试成本**：需要验证所有实体

#### 工作量评估
- **代码修改**：5 个核心文件
- **实现时间**：3-5 个工作日
- **测试工作**：2-3 个工作日
- **总计**：5-8 个工作日

---

## 5️⃣ 具体修改方案

### 5.1 分阶段修复计划

基于 `docs/reanim/reanim-fix-guide.md` 的指导：

#### **阶段 1：修复帧继承机制**（1 天）
- **文件**：`pkg/systems/reanim_system.go`
- **任务**：实现 `buildMergedTracks` 函数
- **难度**：🟢 简单
- **验收**：所有物理帧都有完整的变换数据

#### **阶段 2：修复 f 值判断逻辑**（1-2 天）🔥 关键
- **文件**：`pkg/systems/render_system.go`
- **任务**：
  1. 识别轨道类型（混合/定义/视觉/逻辑）
  2. 构建时间窗口映射
  3. 修改渲染判断逻辑（区分混合轨道和纯视觉轨道）
- **难度**：🔴 关键
- **验收**：身体部件在攻击时可见

#### **阶段 3：实现双动画叠加**（1-2 天）🔥 关键
- **文件**：
  - `pkg/components/reanim_component.go`（添加字段）
  - `pkg/systems/reanim_system.go`（修改 PlayAnimation）
  - `pkg/systems/render_system.go`（实现 drawBlendedAnimation）
- **任务**：
  1. 添加 `IsBlending`, `PrimaryAnimation`, `SecondaryAnimation` 字段
  2. 定义头部轨道归属
  3. 实现双动画渲染逻辑
- **难度**：🟡 中等
- **验收**：攻击时身体继续摆动

#### **阶段 4：实现 anim_stem 父子层级**（1 天）🔥 关键
- **文件**：`pkg/systems/render_system.go`
- **任务**：
  1. 获取 anim_stem 偏移
  2. 应用偏移到头部部件
- **难度**：🟡 中等
- **验收**：头部随身体摆动

#### **阶段 5：清理和优化**（0.5 天）
- **任务**：
  1. 移除 VisibleTracks 白名单机制
  2. 添加配置常量
  3. 添加调试日志
- **难度**：🟢 简单

#### **测试验证**（2-3 天）
- **任务**：
  1. 单元测试：各阶段功能
  2. 集成测试：所有植物和僵尸
  3. 回归测试：游戏流程
  4. 性能测试：确保 60 FPS
  5. 对比测试：使用测试程序验证

### 5.2 修改文件清单

| 文件 | 修改内容 | 预估行数 | 风险 |
|------|---------|---------|------|
| `pkg/systems/reanim_system.go` | 实现帧继承、双动画逻辑 | +150 | 🟡 中 |
| `pkg/systems/render_system.go` | 修复 f 值判断、父子层级 | ~200 | 🔴 高 |
| `pkg/components/reanim_component.go` | 添加双动画字段 | +20 | 🟢 低 |
| `pkg/config/constants.go` | 添加配置常量 | +30 | 🟢 低 |
| `docs/architecture/core-systems.md` | 更新系统说明 | ~50 | 🟢 低 |
| `CLAUDE.md` | 更新层级图和指南 | ~100 | 🟢 低 |

### 5.3 验收标准

- [ ] 豌豆射手攻击时显示完整身体（不再只有头部）
- [ ] 豌豆射手头部随身体一起摆动（不僵硬）
- [ ] 向日葵正确渲染（100% 混合轨道验证）
- [ ] 除草车动画正常
- [ ] 所有植物和僵尸动画流畅
- [ ] 性能无明显下降（稳定 60 FPS）
- [ ] 通过对比测试程序验证（右侧画布效果）
- [ ] 所有单元测试通过
- [ ] 代码符合编码规范（gofmt, golangci-lint）

---

## 6️⃣ PRD MVP 影响

### 6.1 MVP 范围变化
- ❌ **无变化** - MVP 范围保持不变
- ✅ **质量提升** - 动画效果将达到原版标准

### 6.2 Epic 6 目标
- **原目标**："100% 还原原版动画效果"
- **现状**：基于错误理解，未达成目标
- **修复后**：可以达成 100% 还原目标

---

## 7️⃣ 高层次行动计划

### 7.1 立即行动（本周）
1. ✅ **获得用户批准**：确认采用"选项 1：直接调整/集成"
2. 📝 **创建修复任务**：
   - 创建 Story 6.5: Reanim 渲染系统修复
   - 或创建 Technical Debt Story

### 7.2 实施阶段（下周）
1. 🔨 **阶段 1-2**：修复帧继承和 f 值判断（2-3 天）
2. 🔨 **阶段 3-4**：实现双动画和父子层级（2-3 天）
3. 🔨 **阶段 5**：清理和优化（0.5 天）

### 7.3 验证阶段（再下周）
1. 🧪 **测试验证**：单元、集成、回归测试（2-3 天）
2. 📚 **文档更新**：Architecture、CLAUDE.md（0.5 天）
3. ✅ **验收完成**：确认所有验收标准通过

### 7.4 后续工作
- ✅ 继续 Epic 8（第一章关卡实现）
- ✅ 继续 Epic 10（游戏体验完善）

---

## 8️⃣ Agent 交接计划

### 8.1 角色分工

| 角色 | 职责 | 负责人 |
|------|------|--------|
| **PO (Sarah)** | 变更管理、验收标准 | 当前 Agent |
| **Dev** | 代码实现、单元测试 | 移交给 Dev Agent |
| **QA** | 集成测试、回归测试 | 可选（或 Dev 自测） |
| **Architect** | 架构文档更新 | 可选（或 Dev 更新） |

### 8.2 移交清单

**移交给 Dev Agent**：
- ✅ Sprint 变更提案（本文档）
- ✅ 修复指南：`docs/reanim/reanim-fix-guide.md`
- ✅ 格式指南：`docs/reanim/reanim-format-guide.md`
- ✅ 测试程序：`cmd/render_animation_comparison/main.go`
- ✅ 受影响文件清单（见 5.2 节）

**Dev Agent 需要**：
1. 阅读修复指南（`docs/reanim/reanim-fix-guide.md`）
2. 按 5 个阶段顺序实施
3. 每个阶段完成后运行测试程序验证
4. 完成后进行回归测试

---

## 9️⃣ 风险与缓解

### 9.1 主要风险

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|---------|
| **核心渲染逻辑修改引入新 Bug** | 🟡 中 | 🔴 高 | 分阶段修复，每阶段验证；使用测试程序对比 |
| **性能下降** | 🟢 低 | 🟡 中 | 性能测试；优化建议在修复指南中 |
| **测试覆盖不全** | 🟡 中 | 🟡 中 | 回归测试所有植物和僵尸；使用测试程序 |
| **修复时间超出预期** | 🟢 低 | 🟡 中 | 已有详细指南；可分阶段交付 |

### 9.2 回滚计划
- **回滚点**：每个阶段完成后创建 git tag
- **回滚时间**：< 5 分钟（git 操作）
- **触发条件**：如果某阶段导致严重 Bug 且无法快速修复

---

## 🔟 成功标准

### 10.1 技术标准
- [ ] 所有验收标准通过（见 5.3 节）
- [ ] 代码质量：通过 gofmt, golangci-lint
- [ ] 测试覆盖率：≥ 80%
- [ ] 性能：稳定 60 FPS

### 10.2 业务标准
- [ ] Epic 6 完成度：达成"100% 还原原版动画效果"
- [ ] 技术债务清理：消除理解偏差
- [ ] 后续 Epic 解锁：Epic 8 和 Epic 10 可以继续

### 10.3 文档标准
- [ ] Architecture Document 更新
- [ ] CLAUDE.md 更新
- [ ] 代码注释完整

---

## 1️⃣1️⃣ 附录

### A. 参考资料
- **研究文档**：
  - `docs/reanim/reanim-format-guide.md`
  - `docs/reanim/reanim-hybrid-track-discovery.md`
  - `docs/reanim/reanim-fix-guide.md`
- **测试程序**：`cmd/render_animation_comparison/main.go`
- **Epic 定义**：`docs/prd/epic-6-animation-system-migration.md`

### B. 关键数据
- **分析文件数**：5 个 Reanim 文件
- **分析轨道数**：87 个轨道
- **混合轨道占比**：76%（66 个）
- **预估工作量**：5-8 个工作日

### C. 决策记录
- **变更类型**：技术修复（非需求变更）
- **影响范围**：Epic 6, Epic 8, Epic 10
- **推荐路径**：选项 1（直接调整/集成）
- **优先级**：🔴 高优先级

---

**提案状态**：✅ 准备就绪，等待用户批准
**下一步**：获得用户批准后，创建 Story 6.5 并移交给 Dev Agent

---

**文档版本**：v1.0
**创建日期**：2025-10-30
**创建人**：Sarah (PO Agent)
