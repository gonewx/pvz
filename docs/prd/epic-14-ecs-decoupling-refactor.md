# Epic 14: ECS ç³»ç»Ÿè€¦åˆè§£é™¤é‡æ„ (ECS System Decoupling Refactor)

## Epic Goal (å²è¯—ç›®æ ‡)

è§£é™¤ Reanim åŠ¨ç”»ç³»ç»Ÿä¸å…¶ä»–æ¸¸æˆç³»ç»Ÿä¹‹é—´çš„ç›´æ¥è€¦åˆï¼Œé€šè¿‡å¼•å…¥ç»„ä»¶é©±åŠ¨çš„åŠ¨ç”»æ§åˆ¶æœºåˆ¶ï¼ˆAnimationCommandï¼‰ï¼Œä½¿ç³»ç»Ÿé—´é€šä¿¡å®Œå…¨ç¬¦åˆ ECS æ¶æ„çš„é›¶è€¦åˆåŸåˆ™ï¼Œæå‡ä»£ç å¯ç»´æŠ¤æ€§ã€å¯æµ‹è¯•æ€§å’Œæ¶æ„ä¸€è‡´æ€§ã€‚

---

## Epic Metadata

| å±æ€§ | å€¼ |
|------|-----|
| **Epic ID** | Epic-14 |
| **ä¼˜å…ˆçº§** | P0 (Critical - æ¶æ„åˆè§„æ€§) |
| **çŠ¶æ€** | ğŸ“‹ å¾…å¯åŠ¨ (Planned) |
| **é¢„ä¼°å·¥ä½œé‡** | 2-3 å¤© (16-24 å°æ—¶) |
| **ä¾èµ–é¡¹** | Epic 13 (Reanim ç°ä»£åŒ–é‡æ„) |
| **å½±å“èŒƒå›´** | 9 ä¸ªç³»ç»Ÿï¼Œ15 å¤„ä»£ç ä¿®æ”¹ |
| **æŠ€æœ¯è´Ÿå€ºæ¸…ç†** | æ˜¯ |

---

## Epic Description (å²è¯—æè¿°)

### èƒŒæ™¯ (Background)

åœ¨ Epic 13 å®Œæˆåï¼ŒReanim åŠ¨ç”»ç³»ç»Ÿçš„å†…éƒ¨å®ç°å·²ç»ç°ä»£åŒ–ï¼Œä½†åœ¨æ¶æ„å±‚é¢ä»å­˜åœ¨ä¸€ä¸ª**å…³é”®è¿è§„é—®é¢˜**ï¼š

**å½“å‰çŠ¶æ€** (âŒ è¿è§„)ï¼š
```go
// 9 ä¸ªç³»ç»Ÿç›´æ¥è°ƒç”¨ ReanimSystem æ–¹æ³•
type BehaviorSystem struct {
    reanimSystem *ReanimSystem  // âŒ ç›´æ¥ä¾èµ–
}

func (s *BehaviorSystem) killZombie(entityID ecs.EntityID) {
    // âŒ ç›´æ¥è°ƒç”¨å…¶ä»–ç³»ç»Ÿçš„æ–¹æ³•
    s.reanimSystem.PlayCombo(entityID, "zombie", "death")
}
```

**æ¶æ„åŸåˆ™** (æ ¹æ® `docs/architecture.md` ç¬¬ 7 èŠ‚)ï¼š
> **é›¶è€¦åˆåŸåˆ™:** System ç»ä¸èƒ½ç›´æ¥ç›¸äº’è°ƒç”¨ã€‚æ‰€æœ‰è·¨ç³»ç»Ÿçš„é€šä¿¡å¿…é¡»é€šè¿‡æŸ¥è¯¢ EntityManager æˆ–é€šè¿‡ EventBus è¿›è¡Œã€‚

**å½±å“ç»Ÿè®¡**ï¼š
- **è¿è§„ç³»ç»Ÿæ•°é‡**: 9 ä¸ª
- **ç›´æ¥è°ƒç”¨æ¬¡æ•°**: 15 å¤„
- **è¿è§„æ–¹æ³•**: `PlayCombo()`, `PlayAnimation()`, `GetRenderData()`

---

### é—®é¢˜åˆ†æ (Problem Analysis)

#### è¿è§„è¯¦æƒ…è¡¨

| ç³»ç»Ÿåç§° | è¿è§„è°ƒç”¨ | æ–‡ä»¶ä½ç½® | æ¬¡æ•° |
|---------|---------|---------|-----|
| **BehaviorSystem** | `PlayCombo()` | `behavior_system.go:426,520,778,803,1638` | 5 |
| **RenderSystem** | `GetRenderData()` | `render_system.go:353` | 1 |
| **WaveSpawnSystem** | `PlayCombo()` | `wave_spawn_system.go:216,332` | 2 |
| **TutorialSystem** | `PlayCombo()`, `PlayAnimation()` | `tutorial_system.go:659,797` | 2 |
| **SoddingSystem** | `PlayCombo()` | `sodding_system.go:228` | 1 |
| **SunSpawnSystem** | `PlayCombo()` | `sun_spawn_system.go:131` | 1 |
| **OpeningAnimationSystem** | `PlayCombo()` | `opening_animation_system.go:251` | 1 |
| **LawnmowerSystem** | `PlayCombo()` | `lawnmower_system.go:339` | 1 |
| **LevelSystem** | `PlayAnimation()` | `level_system.go:502` | 1 |

**æ€»è®¡**: 9 ä¸ªç³»ç»Ÿï¼Œ15 å¤„è¿è§„

---

#### é—®é¢˜æ ¹æºåˆ†æ

**ä¸ºä»€ä¹ˆä¼šäº§ç”Ÿè¿™ä¸ªé—®é¢˜ï¼Ÿ**

1. **å†å²åŸå› **: Reanim ç³»ç»Ÿæœ€åˆè®¾è®¡æ—¶ï¼ŒECS æ¶æ„å°šæœªå®Œå…¨æˆç†Ÿ
2. **ä¾¿åˆ©æ€§è¯±æƒ‘**: ç›´æ¥è°ƒç”¨ API æ¯”ç»„ä»¶é©±åŠ¨æ›´ç›´è§‚ã€æ›´å¿«é€Ÿ
3. **ç¼ºå°‘æ¶æ„å®ˆæŠ¤**: æ²¡æœ‰è‡ªåŠ¨åŒ–æ£€æŸ¥å·¥å…·é˜²æ­¢è¿è§„å¼•å…¥
4. **æ–‡æ¡£ä¸è¶³**: ç¼ºå°‘æ˜ç¡®çš„"å¦‚ä½•æ­£ç¡®è§¦å‘åŠ¨ç”»"æŒ‡å—

**ä¸ºä»€ä¹ˆç°åœ¨å¿…é¡»ä¿®å¤ï¼Ÿ**

1. **æ¶æ„ä¸€è‡´æ€§**: Epic 13 å·²ç»æ¸…ç†äº†å†…éƒ¨æŠ€æœ¯å€ºåŠ¡ï¼Œç°åœ¨éœ€è¦æ¸…ç†å¤–éƒ¨ä¾èµ–
2. **å¯æµ‹è¯•æ€§**: ç³»ç»Ÿé—´å¼ºè€¦åˆä½¿å•å…ƒæµ‹è¯•å›°éš¾ï¼ˆéœ€è¦ mock 9 ä¸ªç³»ç»Ÿï¼‰
3. **å¯ç»´æŠ¤æ€§**: æœªæ¥æ·»åŠ æ–°ç³»ç»Ÿæ—¶å®¹æ˜“é‡å¤è¿è§„
4. **é‡æ„é£é™©**: ä¿®æ”¹ ReanimSystem æ¥å£ä¼šå½±å“ 9 ä¸ªç³»ç»Ÿ

---

### è§£å†³æ–¹æ¡ˆ (Solution)

#### æ ¸å¿ƒè®¾è®¡ï¼šç»„ä»¶é©±åŠ¨çš„åŠ¨ç”»æ§åˆ¶

**è®¾è®¡æ€æƒ³**ï¼š
- å…¶ä»–ç³»ç»Ÿä¸å†ç›´æ¥è°ƒç”¨ ReanimSystem
- æ”¹ä¸ºæ·»åŠ  `AnimationCommandComponent` ç»„ä»¶åˆ°å®ä½“
- ReanimSystem åœ¨ Update() ä¸­æŸ¥è¯¢å¹¶å¤„ç†è¿™äº›å‘½ä»¤ç»„ä»¶
- ç¬¦åˆ ECS "æ•°æ®é©±åŠ¨" çš„æ ¸å¿ƒå“²å­¦

**æ¶æ„å¯¹æ¯”**ï¼š

```
âŒ ä¿®æ”¹å‰ï¼ˆè¿è§„ï¼‰
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BehaviorSystem  â”‚â”€â”€â”€â”€â”
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
                       â”œâ”€â”€â–º ReanimSystem.PlayCombo()
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚ WaveSpawnSystem â”‚â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

âœ… ä¿®æ”¹åï¼ˆåˆè§„ï¼‰
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BehaviorSystem  â”‚â”€â”€â”€â”€â”    â”‚  EntityManager       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚    â”‚  (Components Store)  â”‚
                       â”œâ”€â”€â”€â–ºâ”‚                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚    â”‚ AnimationCommand     â”‚
â”‚ WaveSpawnSystem â”‚â”€â”€â”€â”€â”˜    â”‚ Component Pool       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       â–¼
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚   ReanimSystem      â”‚
                            â”‚   .Update()         â”‚
                            â”‚   - Query commands  â”‚
                            â”‚   - Execute combos  â”‚
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

#### æŠ€æœ¯å®ç°æ–¹æ¡ˆ

**1. æ–°å¢ç»„ä»¶** (`pkg/components/animation_command.go`)

```go
// AnimationCommandComponent åŠ¨ç”»æ’­æ”¾å‘½ä»¤ç»„ä»¶ï¼ˆçº¯æ•°æ®ï¼‰
// å…¶ä»–ç³»ç»Ÿé€šè¿‡æ·»åŠ æ­¤ç»„ä»¶æ¥è¯·æ±‚æ’­æ”¾åŠ¨ç”»ï¼Œè€Œä¸æ˜¯ç›´æ¥è°ƒç”¨ ReanimSystem
//
// è®¾è®¡åŸåˆ™ï¼š
// - å®Œå…¨ç¬¦åˆ ECS æ•°æ®-è¡Œä¸ºåˆ†ç¦»åŸåˆ™
// - ç»„ä»¶åªåŒ…å«æ•°æ®ï¼Œä¸åŒ…å«æ–¹æ³•
// - ReanimSystem è´Ÿè´£è¯»å–å’Œå¤„ç†å‘½ä»¤
//
// ä½¿ç”¨ç¤ºä¾‹ï¼š
//   // âŒ ä¿®æ”¹å‰ï¼ˆè¿è§„ï¼‰
//   s.reanimSystem.PlayCombo(entityID, "zombie", "death")
//
//   // âœ… ä¿®æ”¹åï¼ˆåˆè§„ï¼‰
//   ecs.AddComponent(s.entityManager, entityID, &components.AnimationCommandComponent{
//       UnitID:    "zombie",
//       ComboName: "death",
//       Processed: false,
//   })
type AnimationCommandComponent struct {
    // UnitID å•ä½ IDï¼ˆå¦‚ "peashooter", "zombie", "sun"ï¼‰
    // å¯¹åº” reanim_config.yaml ä¸­çš„å•ä½é…ç½®
    UnitID string

    // ComboName ç»„åˆåç§°ï¼ˆå¦‚ "attack", "death", "idle"ï¼‰
    // å¯¹åº” animation_combos é…ç½®ä¸­çš„ combo.name
    // å¦‚æœä¸ºç©ºï¼Œä½¿ç”¨å•ä½çš„ç¬¬ä¸€ä¸ª combo
    ComboName string

    // AnimationName å•ä¸ªåŠ¨ç”»åç§°ï¼ˆå¯é€‰ï¼Œç”¨äº PlayAnimation åœºæ™¯ï¼‰
    // å¦‚æœæŒ‡å®šï¼Œå¿½ç•¥ UnitID å’Œ ComboNameï¼Œç›´æ¥æ’­æ”¾æ­¤åŠ¨ç”»
    // ç¤ºä¾‹ï¼š"FinalWave", "anim_idle"
    AnimationName string

    // Processed æ˜¯å¦å·²è¢« ReanimSystem å¤„ç†
    // ReanimSystem å¤„ç†åä¼šè®¾ç½®ä¸º true
    // å¯ç”¨äºè°ƒè¯•æˆ–ä¿ç•™å‘½ä»¤å†å²
    Processed bool

    // Timestamp å‘½ä»¤åˆ›å»ºæ—¶é—´ï¼ˆå¯é€‰ï¼Œç”¨äºè°ƒè¯•ï¼‰
    Timestamp float64
}
```

**2. ReanimSystem ä¿®æ”¹**

```go
// Update æ›´æ–°æ‰€æœ‰ Reanim ç»„ä»¶çš„åŠ¨ç”»å¸§
func (s *ReanimSystem) Update(deltaTime float64) {
    // 1. å¤„ç†åŠ¨ç”»æ’­æ”¾å‘½ä»¤ï¼ˆæ–°å¢ï¼‰
    s.processAnimationCommands()

    // 2. æ›´æ–°æ‰€æœ‰åŠ¨ç”»å¸§ï¼ˆç°æœ‰é€»è¾‘ï¼‰
    entities := ecs.GetEntitiesWith1[*components.ReanimComponent](s.entityManager)
    for _, id := range entities {
        // ... ç°æœ‰çš„å¸§æ¨è¿›é€»è¾‘ ...
    }
}

// processAnimationCommands å¤„ç†æ‰€æœ‰å¾…æ‰§è¡Œçš„åŠ¨ç”»å‘½ä»¤
func (s *ReanimSystem) processAnimationCommands() {
    entities := ecs.GetEntitiesWith1[*components.AnimationCommandComponent](s.entityManager)

    for _, id := range entities {
        cmd, ok := ecs.GetComponent[*components.AnimationCommandComponent](s.entityManager, id)
        if !ok || cmd.Processed {
            continue
        }

        // æ‰§è¡Œå‘½ä»¤
        var err error
        if cmd.AnimationName != "" {
            // å•ä¸ªåŠ¨ç”»æ¨¡å¼
            err = s.PlayAnimation(id, cmd.AnimationName)
        } else {
            // ç»„åˆæ¨¡å¼
            err = s.PlayCombo(id, cmd.UnitID, cmd.ComboName)
        }

        if err != nil {
            log.Printf("[ReanimSystem] æ‰§è¡ŒåŠ¨ç”»å‘½ä»¤å¤±è´¥: entity=%d, unit=%s, combo=%s, anim=%s, err=%v",
                id, cmd.UnitID, cmd.ComboName, cmd.AnimationName, err)
        }

        // æ ‡è®°ä¸ºå·²å¤„ç†
        cmd.Processed = true

        // å¯é€‰ï¼šç§»é™¤ç»„ä»¶ä»¥é¿å…ç´¯ç§¯ï¼ˆå–å†³äºæ˜¯å¦éœ€è¦ä¿ç•™å†å²ï¼‰
        // s.entityManager.RemoveComponent(id, reflect.TypeOf(&components.AnimationCommandComponent{}))
    }
}
```

**3. å…¶ä»–ç³»ç»Ÿä¿®æ”¹ç¤ºä¾‹**

```go
// BehaviorSystem (ä¿®æ”¹å‰)
type BehaviorSystem struct {
    entityManager *ecs.EntityManager
    reanimSystem  *ReanimSystem  // âŒ åˆ é™¤
}

func (s *BehaviorSystem) killZombie(entityID ecs.EntityID) {
    // âŒ åˆ é™¤
    s.reanimSystem.PlayCombo(entityID, "zombie", "death")
}

// BehaviorSystem (ä¿®æ”¹å)
type BehaviorSystem struct {
    entityManager *ecs.EntityManager
    // âœ… ä¸å†ä¾èµ– ReanimSystem
}

func (s *BehaviorSystem) killZombie(entityID ecs.EntityID) {
    // âœ… é€šè¿‡ç»„ä»¶å‘é€å‘½ä»¤
    ecs.AddComponent(s.entityManager, entityID, &components.AnimationCommandComponent{
        UnitID:    "zombie",
        ComboName: "death",
        Processed: false,
    })
}
```

**4. RenderSystem ç‰¹æ®Šå¤„ç†**

RenderSystem éœ€è¦å®æ—¶æ¸²æŸ“æ•°æ®ï¼Œä¸èƒ½ç­‰åˆ°ä¸‹ä¸€å¸§ã€‚è§£å†³æ–¹æ¡ˆï¼š

```go
// render_system.go (ä¿®æ”¹å‰)
func (s *RenderSystem) drawEntity(screen *ebiten.Image, id ecs.EntityID, cameraX float64) {
    // âŒ ç›´æ¥è°ƒç”¨
    renderData := s.reanimSystem.GetRenderData(id)
}

// render_system.go (ä¿®æ”¹å)
func (s *RenderSystem) drawEntity(screen *ebiten.Image, id ecs.EntityID, cameraX float64) {
    reanim, ok := ecs.GetComponent[*components.ReanimComponent](s.entityManager, id)
    if !ok {
        return
    }

    // âœ… ç›´æ¥è¯»å–ç»„ä»¶ä¸­çš„ç¼“å­˜æ•°æ®
    // ReanimSystem åœ¨ Update() ä¸­å·²ç»å¡«å……äº† CachedRenderData
    renderData := reanim.CachedRenderData

    // ... æ¸²æŸ“é€»è¾‘ ...
}
```

---

### éªŒæ”¶æ ‡å‡† (Acceptance Criteria)

**åŠŸèƒ½éªŒæ”¶**ï¼š
- âœ… æ‰€æœ‰åŸæœ‰åŠ¨ç”»åŠŸèƒ½æ­£å¸¸å·¥ä½œï¼ˆæ­»äº¡åŠ¨ç”»ã€æ”»å‡»åŠ¨ç”»ç­‰ï¼‰
- âœ… æ— ä»»ä½•ç³»ç»Ÿç›´æ¥è°ƒç”¨ ReanimSystem æ–¹æ³•
- âœ… æ‰€æœ‰ç³»ç»Ÿé—´é€šä¿¡é€šè¿‡ EntityManager (ç»„ä»¶)

**æ€§èƒ½éªŒæ”¶**ï¼š
- âœ… åŠ¨ç”»æ’­æ”¾å»¶è¿Ÿ â‰¤ 1 å¸§ (16.67ms @ 60fps)
- âœ… æ— æ˜æ˜¾æ€§èƒ½ä¸‹é™ï¼ˆ< 5% å¸§æ—¶é—´å¢åŠ ï¼‰

**æ¶æ„éªŒæ”¶**ï¼š
- âœ… é€šè¿‡æ¶æ„åˆè§„æ€§æ£€æŸ¥ï¼ˆæ–°å¢çš„é™æ€åˆ†æå·¥å…·ï¼‰
- âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼ˆå•å…ƒæµ‹è¯• + é›†æˆæµ‹è¯•ï¼‰
- âœ… ä»£ç å®¡æŸ¥é€šè¿‡ï¼ˆç¬¦åˆ ECS åŸåˆ™ï¼‰

---

## Story Breakdown (æ•…äº‹åˆ†è§£)

### Story 14.1: åˆ›å»º AnimationCommand ç»„ä»¶ â­ **Foundation**

**ç›®æ ‡**: åˆ›å»ºæ ¸å¿ƒçš„ `AnimationCommandComponent` ç»„ä»¶å’Œæ”¯æŒåŸºç¡€è®¾æ–½

**ä»»åŠ¡**:
1. åˆ›å»º `pkg/components/animation_command.go`
2. å®šä¹‰ç»„ä»¶ç»“æ„ï¼ˆUnitID, ComboName, AnimationName, Processedï¼‰
3. æ·»åŠ è¯¦ç»†çš„æ–‡æ¡£æ³¨é‡Šå’Œä½¿ç”¨ç¤ºä¾‹
4. ç¼–å†™å•å…ƒæµ‹è¯•éªŒè¯ç»„ä»¶ç»“æ„

**éªŒæ”¶æ ‡å‡†**:
- âœ… ç»„ä»¶å®šä¹‰å®Œæ•´ï¼Œå­—æ®µç±»å‹æ­£ç¡®
- âœ… æ–‡æ¡£æ³¨é‡Šæ¸…æ™°ï¼ŒåŒ…å«ä½¿ç”¨ç¤ºä¾‹
- âœ… æµ‹è¯•è¦†ç›–ç‡ 100%

**é¢„ä¼°å·¥ä½œé‡**: 2 å°æ—¶

**ä¼˜å…ˆçº§**: P0

---

### Story 14.2: é‡æ„ ReanimSystem äº‹ä»¶å¤„ç† â­ **Core**

**ç›®æ ‡**: ä¿®æ”¹ ReanimSystem ä»¥æ”¯æŒç»„ä»¶é©±åŠ¨çš„å‘½ä»¤å¤„ç†

**ä»»åŠ¡**:
1. å®ç° `processAnimationCommands()` æ–¹æ³•
2. åœ¨ `Update()` ä¸­é›†æˆå‘½ä»¤å¤„ç†é€»è¾‘
3. æ·»åŠ é”™è¯¯å¤„ç†å’Œæ—¥å¿—
4. ç¼–å†™å•å…ƒæµ‹è¯•éªŒè¯å‘½ä»¤å¤„ç†æµç¨‹
5. æ€§èƒ½æµ‹è¯•ï¼ˆç¡®ä¿æ— æ˜æ˜¾å¼€é”€ï¼‰

**éªŒæ”¶æ ‡å‡†**:
- âœ… å‘½ä»¤å¤„ç†é€»è¾‘æ­£ç¡®
- âœ… æ”¯æŒ PlayCombo å’Œ PlayAnimation ä¸¤ç§æ¨¡å¼
- âœ… é”™è¯¯å¤„ç†å®Œå–„
- âœ… æµ‹è¯•è¦†ç›–æ ¸å¿ƒåœºæ™¯

**é¢„ä¼°å·¥ä½œé‡**: 4 å°æ—¶

**ä¼˜å…ˆçº§**: P0

**ä¾èµ–**: Story 14.1

---

### Story 14.3: é‡æ„æ ¸å¿ƒç³»ç»Ÿï¼ˆç¬¬ä¸€æ‰¹ï¼‰ â­ **Migration**

**ç›®æ ‡**: é‡æ„ BehaviorSystem, WaveSpawnSystem, LevelSystem

**ä»»åŠ¡**:
1. **BehaviorSystem** (5 å¤„è¿è§„)
   - ç§»é™¤ `reanimSystem` å­—æ®µ
   - æ›¿æ¢æ‰€æœ‰ `PlayCombo` è°ƒç”¨ä¸ºç»„ä»¶æ·»åŠ 
   - æ›´æ–°æ„é€ å‡½æ•°
   - éªŒè¯æ­»äº¡åŠ¨ç”»ã€æ”»å‡»åŠ¨ç”»åŠŸèƒ½

2. **WaveSpawnSystem** (2 å¤„è¿è§„)
   - ç§»é™¤ `reanimSystem` å­—æ®µ
   - æ›¿æ¢åƒµå°¸ç”Ÿæˆæ—¶çš„åŠ¨ç”»è°ƒç”¨
   - éªŒè¯åƒµå°¸å‡ºç°åŠ¨ç”»

3. **LevelSystem** (1 å¤„è¿è§„)
   - æ›¿æ¢ FinalWave è­¦å‘ŠåŠ¨ç”»è°ƒç”¨
   - éªŒè¯è­¦å‘Šæ•ˆæœ

**éªŒæ”¶æ ‡å‡†**:
- âœ… ç¼–è¯‘é€šè¿‡ï¼Œæ— è¯­æ³•é”™è¯¯
- âœ… æ‰€æœ‰åŠŸèƒ½æµ‹è¯•é€šè¿‡
- âœ… æ¸¸æˆå¯æ­£å¸¸å¯åŠ¨å’Œè¿è¡Œ
- âœ… åŠ¨ç”»æ’­æ”¾æ­£ç¡®

**é¢„ä¼°å·¥ä½œé‡**: 4 å°æ—¶

**ä¼˜å…ˆçº§**: P0

**ä¾èµ–**: Story 14.2

---

### Story 14.4: é‡æ„æ ¸å¿ƒç³»ç»Ÿï¼ˆç¬¬äºŒæ‰¹ï¼‰ â­ **Migration**

**ç›®æ ‡**: é‡æ„ TutorialSystem, SoddingSystem, SunSpawnSystem

**ä»»åŠ¡**:
1. **TutorialSystem** (2 å¤„è¿è§„)
   - æ›¿æ¢é˜³å…‰å’Œè­¦å‘ŠåŠ¨ç”»è°ƒç”¨
   - éªŒè¯æ•™ç¨‹åŠ¨ç”»æ•ˆæœ

2. **SoddingSystem** (1 å¤„è¿è§„)
   - æ›¿æ¢è‰çš®å·åŠ¨ç”»è°ƒç”¨
   - éªŒè¯è‰çš®é“ºè®¾æ•ˆæœ

3. **SunSpawnSystem** (1 å¤„è¿è§„)
   - æ›¿æ¢é˜³å…‰ç”ŸæˆåŠ¨ç”»è°ƒç”¨
   - éªŒè¯é˜³å…‰åŠ¨ç”»

**éªŒæ”¶æ ‡å‡†**:
- âœ… æ‰€æœ‰åŠŸèƒ½æ­£å¸¸
- âœ… æ— å›å½’é—®é¢˜
- âœ… åŠ¨ç”»æ•ˆæœæ­£ç¡®

**é¢„ä¼°å·¥ä½œé‡**: 3 å°æ—¶

**ä¼˜å…ˆçº§**: P0

**ä¾èµ–**: Story 14.2

---

### Story 14.5: é‡æ„æ ¸å¿ƒç³»ç»Ÿï¼ˆç¬¬ä¸‰æ‰¹ï¼‰ â­ **Migration**

**ç›®æ ‡**: é‡æ„ OpeningAnimationSystem, LawnmowerSystem

**ä»»åŠ¡**:
1. **OpeningAnimationSystem** (1 å¤„è¿è§„)
   - æ›¿æ¢å¼€åœºåƒµå°¸åŠ¨ç”»è°ƒç”¨
   - éªŒè¯å¼€åœºåŠ¨ç”»åºåˆ—

2. **LawnmowerSystem** (1 å¤„è¿è§„)
   - æ›¿æ¢å‰²è‰æœºæ€æ•ŒåŠ¨ç”»è°ƒç”¨
   - éªŒè¯å‰²è‰æœºæ•ˆæœ

**éªŒæ”¶æ ‡å‡†**:
- âœ… å¼€åœºåŠ¨ç”»æµç•…
- âœ… å‰²è‰æœºåŠŸèƒ½æ­£å¸¸
- âœ… æ— æ€§èƒ½é—®é¢˜

**é¢„ä¼°å·¥ä½œé‡**: 2 å°æ—¶

**ä¼˜å…ˆçº§**: P0

**ä¾èµ–**: Story 14.2

---

### Story 14.6: é‡æ„ RenderSystemï¼ˆç‰¹æ®Šå¤„ç†ï¼‰ â­ **Special Case**

**ç›®æ ‡**: è§£é™¤ RenderSystem å¯¹ ReanimSystem çš„ä¾èµ–

**ä»»åŠ¡**:
1. ç§»é™¤ `reanimSystem` å­—æ®µ
2. ä¿®æ”¹ `drawEntity()` ç›´æ¥è¯»å– `CachedRenderData`
3. éªŒè¯ ReanimSystem å·²æ­£ç¡®å¡«å……ç¼“å­˜
4. æ€§èƒ½æµ‹è¯•ï¼ˆç¡®ä¿æ— é¢å¤–å¼€é”€ï¼‰
5. æ¸²æŸ“æ­£ç¡®æ€§éªŒè¯

**éªŒæ”¶æ ‡å‡†**:
- âœ… æ¸²æŸ“é€»è¾‘æ­£ç¡®
- âœ… æ— æ€§èƒ½ä¸‹é™
- âœ… æ‰€æœ‰å®ä½“æ­£ç¡®æ˜¾ç¤º

**é¢„ä¼°å·¥ä½œé‡**: 3 å°æ—¶

**ä¼˜å…ˆçº§**: P0

**ä¾èµ–**: Story 14.2

---

### Story 14.7: é›†æˆæµ‹è¯•å’Œå›å½’æµ‹è¯• â­ **Quality Assurance**

**ç›®æ ‡**: å…¨é¢éªŒè¯é‡æ„åçš„ç³»ç»ŸåŠŸèƒ½å’Œæ€§èƒ½

**ä»»åŠ¡**:
1. **åŠŸèƒ½æµ‹è¯•**
   - å®Œæ•´æ¸¸æˆæµç¨‹æµ‹è¯•ï¼ˆä¸»èœå• â†’ å…³å¡ â†’ èƒœåˆ©/å¤±è´¥ï¼‰
   - æ‰€æœ‰æ¤ç‰©åŠ¨ç”»éªŒè¯
   - æ‰€æœ‰åƒµå°¸åŠ¨ç”»éªŒè¯
   - UI åŠ¨ç”»éªŒè¯

2. **æ€§èƒ½æµ‹è¯•**
   - å¸§ç‡æµ‹è¯•ï¼ˆç›®æ ‡ï¼š60 fps ç¨³å®šï¼‰
   - å†…å­˜å ç”¨æµ‹è¯•
   - åŠ¨ç”»å“åº”å»¶è¿Ÿæµ‹è¯•

3. **å›å½’æµ‹è¯•**
   - è¿è¡Œæ‰€æœ‰ç°æœ‰å•å…ƒæµ‹è¯•
   - è¿è¡Œæ‰€æœ‰é›†æˆæµ‹è¯•
   - æ£€æŸ¥æ— ç ´åæ€§å˜æ›´

**éªŒæ”¶æ ‡å‡†**:
- âœ… æ‰€æœ‰åŠŸèƒ½æµ‹è¯•é€šè¿‡
- âœ… æ€§èƒ½æŒ‡æ ‡è¾¾æ ‡
- âœ… æ— å›å½’é—®é¢˜

**é¢„ä¼°å·¥ä½œé‡**: 4 å°æ—¶

**ä¼˜å…ˆçº§**: P0

**ä¾èµ–**: Story 14.3, 14.4, 14.5, 14.6

---

### Story 14.8: æ¶æ„åˆè§„æ€§å·¥å…·å’Œæ–‡æ¡£ â­ **Prevention**

**ç›®æ ‡**: åˆ›å»ºå·¥å…·å’Œæ–‡æ¡£é˜²æ­¢æœªæ¥è¿è§„

**ä»»åŠ¡**:
1. **é™æ€åˆ†æå·¥å…·**
   - ç¼–å†™è„šæœ¬æ£€æµ‹ç³»ç»Ÿé—´ç›´æ¥è°ƒç”¨
   - é›†æˆåˆ° CI/CD æµç¨‹
   - æä¾›æ¸…æ™°çš„é”™è¯¯æç¤º

2. **å¼€å‘è€…æŒ‡å—**
   - æ›´æ–° CLAUDE.md æ·»åŠ  "å¦‚ä½•æ­£ç¡®è§¦å‘åŠ¨ç”»" ç« èŠ‚
   - æ·»åŠ ä»£ç ç¤ºä¾‹ï¼ˆæ­£ç¡® vs é”™è¯¯ï¼‰
   - æ›´æ–°æ¶æ„æ–‡æ¡£

3. **Code Review Checklist**
   - æ·»åŠ  ECS æ¶æ„æ£€æŸ¥é¡¹
   - æ›´æ–° PR æ¨¡æ¿

**éªŒæ”¶æ ‡å‡†**:
- âœ… é™æ€åˆ†æå·¥å…·å¯æ£€æµ‹è¿è§„
- âœ… æ–‡æ¡£æ¸…æ™°å®Œæ•´
- âœ… Checklist å®ç”¨

**é¢„ä¼°å·¥ä½œé‡**: 3 å°æ—¶

**ä¼˜å…ˆçº§**: P1

**ä¾èµ–**: Story 14.7

---

## å·¥ä½œé‡ä¼°ç®— (Effort Estimation)

| Story | é¢„ä¼°å·¥ä½œé‡ | ä¼˜å…ˆçº§ | ä¾èµ– |
|-------|----------|--------|------|
| 14.1 | 2 å°æ—¶ | P0 | æ—  |
| 14.2 | 4 å°æ—¶ | P0 | 14.1 |
| 14.3 | 4 å°æ—¶ | P0 | 14.2 |
| 14.4 | 3 å°æ—¶ | P0 | 14.2 |
| 14.5 | 2 å°æ—¶ | P0 | 14.2 |
| 14.6 | 3 å°æ—¶ | P0 | 14.2 |
| 14.7 | 4 å°æ—¶ | P0 | 14.3-14.6 |
| 14.8 | 3 å°æ—¶ | P1 | 14.7 |
| **æ€»è®¡** | **25 å°æ—¶** | - | - |

**é¢„ä¼°æ€»æ—¶é•¿**: 2-3 ä¸ªå·¥ä½œæ—¥ï¼ˆè€ƒè™‘æµ‹è¯•å’Œè°ƒè¯•æ—¶é—´ï¼‰

---

## é£é™©ä¸ç¼“è§£æªæ–½ (Risks & Mitigation)

### é£é™© 1: åŠ¨ç”»æ’­æ”¾å»¶è¿Ÿ

**æè¿°**: ç»„ä»¶é©±åŠ¨æ¨¡å¼å¯èƒ½å¼•å…¥ä¸€å¸§å»¶è¿Ÿ

**å½±å“**: ä¸­ç­‰ï¼ˆç”¨æˆ·å¯èƒ½æ„ŸçŸ¥åˆ°è½»å¾®å»¶è¿Ÿï¼‰

**ç¼“è§£æªæ–½**:
- åœ¨å…³é”®è·¯å¾„ï¼ˆå¦‚æ­»äº¡åŠ¨ç”»ï¼‰ä¸­æµ‹è¯•å»¶è¿Ÿ
- å¦‚æœå»¶è¿Ÿæ˜æ˜¾ï¼Œè€ƒè™‘åœ¨ ReanimSystem.Update() å¼€å¤´å¤„ç†å‘½ä»¤
- æ·»åŠ æ€§èƒ½ç›‘æ§

**æ¦‚ç‡**: ä½

---

### é£é™© 2: å›å½’é—®é¢˜

**æè¿°**: é‡æ„å¯èƒ½å¼•å…¥åŠŸèƒ½ç¼ºé™·

**å½±å“**: é«˜ï¼ˆå½±å“æ¸¸æˆå¯ç©æ€§ï¼‰

**ç¼“è§£æªæ–½**:
- é€ç³»ç»Ÿé‡æ„ï¼Œæ¯æ¬¡é‡æ„åå®Œæ•´æµ‹è¯•
- ä¿ç•™ç°æœ‰æµ‹è¯•ç”¨ä¾‹
- æ·»åŠ æ–°çš„é›†æˆæµ‹è¯•
- ä½¿ç”¨ feature flag æ§åˆ¶æ–°æ—§å®ç°åˆ‡æ¢

**æ¦‚ç‡**: ä¸­ç­‰

---

### é£é™© 3: æ€§èƒ½ä¸‹é™

**æè¿°**: ç»„ä»¶æŸ¥è¯¢å¯èƒ½å¢åŠ å¼€é”€

**å½±å“**: ä¸­ç­‰ï¼ˆå½±å“å¸§ç‡ï¼‰

**ç¼“è§£æªæ–½**:
- æ€§èƒ½åŸºå‡†æµ‹è¯•ï¼ˆé‡æ„å‰åå¯¹æ¯”ï¼‰
- ä¼˜åŒ–æŸ¥è¯¢é€»è¾‘ï¼ˆç¼“å­˜å®ä½“åˆ—è¡¨ï¼‰
- å®šæœŸæ¸…ç†å·²å¤„ç†çš„å‘½ä»¤ç»„ä»¶

**æ¦‚ç‡**: ä½

---

## æˆåŠŸæŒ‡æ ‡ (Success Metrics)

### æ¶æ„æŒ‡æ ‡

- âœ… ç³»ç»Ÿé—´ç›´æ¥è°ƒç”¨æ•°é‡ï¼šä» 15 é™è‡³ **0**
- âœ… æ¶æ„åˆè§„æ€§ï¼šä» C çº§æå‡è‡³ **A çº§**
- âœ… ä»£ç è€¦åˆåº¦ï¼šé™ä½ **90%**

### åŠŸèƒ½æŒ‡æ ‡

- âœ… æ‰€æœ‰åŠ¨ç”»åŠŸèƒ½æ­£å¸¸ï¼š**100% é€šè¿‡**
- âœ… æµ‹è¯•é€šè¿‡ç‡ï¼š**100%**
- âœ… æ— å›å½’é—®é¢˜ï¼š**0 ä¸ª bug**

### æ€§èƒ½æŒ‡æ ‡

- âœ… å¸§ç‡å½±å“ï¼š**< 5%**
- âœ… åŠ¨ç”»å»¶è¿Ÿï¼š**â‰¤ 1 å¸§ (16.67ms)**
- âœ… å†…å­˜å ç”¨å¢åŠ ï¼š**< 1MB**

---

## å‚è€ƒèµ„æ–™ (References)

1. **æ¶æ„æ–‡æ¡£**: `docs/architecture.md` (ç¬¬ 7 èŠ‚ - é›¶è€¦åˆåŸåˆ™)
2. **Epic 13**: `docs/prd/epic-13-reanim-modernization.md`
3. **ECS æ³›å‹é‡æ„**: `docs/prd/epic-9-ecs-generics-refactor.md`
4. **ç°æœ‰ç³»ç»Ÿä»£ç **:
   - `pkg/systems/reanim_system.go`
   - `pkg/systems/behavior_system.go`
   - `pkg/systems/render_system.go`

---

## é™„å½•ï¼šä¿®æ”¹æ¸…å• (Change Checklist)

### æ–°å¢æ–‡ä»¶

- [ ] `pkg/components/animation_command.go`
- [ ] `pkg/components/animation_command_test.go`
- [ ] `tools/check_ecs_compliance.sh` (æ¶æ„æ£€æŸ¥è„šæœ¬)

### ä¿®æ”¹æ–‡ä»¶

#### ç»„ä»¶å’Œç³»ç»Ÿ
- [ ] `pkg/systems/reanim_system.go` (+50 è¡Œ)
- [ ] `pkg/systems/behavior_system.go` (-1 å­—æ®µ, 5 å¤„æ›¿æ¢)
- [ ] `pkg/systems/render_system.go` (-1 å­—æ®µ, 1 å¤„æ›¿æ¢)
- [ ] `pkg/systems/wave_spawn_system.go` (-1 å­—æ®µ, 2 å¤„æ›¿æ¢)
- [ ] `pkg/systems/tutorial_system.go` (-1 å­—æ®µ, 2 å¤„æ›¿æ¢)
- [ ] `pkg/systems/sodding_system.go` (-1 å­—æ®µ, 1 å¤„æ›¿æ¢)
- [ ] `pkg/systems/sun_spawn_system.go` (-1 å­—æ®µ, 1 å¤„æ›¿æ¢)
- [ ] `pkg/systems/opening_animation_system.go` (-1 å­—æ®µ, 1 å¤„æ›¿æ¢)
- [ ] `pkg/systems/lawnmower_system.go` (-1 å­—æ®µ, 1 å¤„æ›¿æ¢)
- [ ] `pkg/systems/level_system.go` (-1 å­—æ®µ, 1 å¤„æ›¿æ¢)

#### æµ‹è¯•æ–‡ä»¶
- [ ] `pkg/systems/reanim_system_test.go` (æ–°å¢æµ‹è¯•ç”¨ä¾‹)
- [ ] `pkg/systems/behavior_system_test.go` (æ›´æ–°æµ‹è¯•)
- [ ] å…¶ä»–ç³»ç»Ÿæµ‹è¯•æ–‡ä»¶ï¼ˆæŒ‰éœ€æ›´æ–°ï¼‰

#### æ–‡æ¡£
- [ ] `CLAUDE.md` (æ·»åŠ åŠ¨ç”»è§¦å‘æŒ‡å—)
- [ ] `docs/architecture.md` (æ·»åŠ æˆåŠŸæ¡ˆä¾‹)
- [ ] `docs/development.md` (æ›´æ–°å¼€å‘æŒ‡å—)

---

**Epic Owner**: Architecture Team
**Created**: 2025-11-12
**Last Updated**: 2025-11-12
**Status**: ğŸ“‹ å¾…å¯åŠ¨ (Planned)
