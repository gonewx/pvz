# Epic 8: 第一章关卡实现 - 前院白天 (Chapter 1: Day Level Implementation)

## Epic Goal (史诗目标)

实现《植物大战僵尸》第一章(前院白天)的全部 10 个关卡,包括原版忠实的关卡机制、教学引导系统、开场动画系统、选卡界面和特殊关卡类型,为玩家提供完整的冒险模式第一章体验。

---

## Epic Description (史诗描述)

### Existing System Context (现有系统上下文)

**当前相关功能:**
- ✅ 基础关卡系统 (`LevelSystem`, `WaveSpawnSystem`)
- ✅ 关卡配置加载 (`LevelConfig`, YAML解析)
- ✅ 游戏场景管理 (`GameScene`)
- ✅ 植物/僵尸实体系统 (ECS 架构)
- ✅ Reanim 动画系统
- ✅ 粒子特效系统
- ✅ UI系统 (植物卡片、阳光计数器)

**技术栈:**
- Go 语言 + Ebitengine 引擎
- ECS 架构 (Entity-Component-System)
- YAML 配置驱动
- 资源管理器 (ResourceManager)

**集成点:**
- 关卡配置系统 (`pkg/config/level_config.go`)
- 游戏场景 (`pkg/scenes/game_scene.go`)
- 实体工厂 (`pkg/entities/`)
- 系统层 (`pkg/systems/level_system.go`)

---

### Enhancement Details (增强功能详情)

**核心功能模块:**

#### 1. 教学引导系统 (Tutorial System)
- **1-1 专属教学机制**: 强制性文字引导、单行草地、阶段性解锁
- **教学触发器**: 基于游戏状态的条件触发
- **引导文本组件**: 显示教学提示的UI组件

#### 2. 开场动画系统 (Opening Animation System)
- **标准开场流程**: 选卡界面 → 镜头右移预告僵尸 → 返回草坪开始
- **特殊开场流程**: 无选卡直接进入、标题卡展示
- **可配置开关**: 通过配置文件或调试参数跳过开场(方便测试)
- **镜头控制**: 平滑的摄像机移动和缩放

#### 3. 选卡界面 (Plant Selection Screen)
- **植物卡片栏**: 展示本关可用植物
- **植物解锁系统**: 根据关卡进度解锁新植物
- **卡片选择交互**: 点击选择、拖拽排序
- **"开战"按钮**: 确认选择并进入关卡

#### 4. 关卡配置增强 (Level Configuration Enhancement)
扩展现有 `LevelConfig` 支持:
- **场地行数限制**: `enabledLanes: [3]` (如 1-1 单行)
- **可用植物列表**: `availablePlants: ["peashooter", "sunflower"]`
- **开场类型**: `openingType: "tutorial"` / `"standard"` / `"special"`
- **教学步骤**: `tutorialSteps: [{trigger, text, action}]`
- **特殊规则**: `specialRules: "bowling"` / `"conveyor"`

#### 5. 特殊关卡类型 (Special Level Types)
- **1-5 坚果保龄球**: 规则变更、预设植物、特殊胜利条件
- **1-10 传送带模式**: 强制使用系统给定植物、随机性挑战

#### 6. 关卡进度与解锁 (Level Progression)
- **关卡解锁管理**: 完成前一关解锁下一关
- **植物解锁记录**: 新植物获得提示
- **进度保存**: 关卡完成状态持久化

---

### Integration Approach (集成方法)

#### 配置文件扩展
```yaml
# data/levels/level-1-1.yaml
id: "1-1"
name: "前院白天 1-1"
description: "教学关卡：学习基本的植物种植和僵尸防御"

# 新增字段
openingType: "tutorial"          # 开场类型
enabledLanes: [3]                # 启用的行 (仅第3行)
availablePlants: ["peashooter"]  # 可用植物
skipOpening: false               # 是否跳过开场(调试用)

tutorialSteps:
  - trigger: "gameStart"
    text: "天空中会掉落阳光,点击收集它们!"
    action: "waitForSunCollect"
  - trigger: "sunCollected"
    text: "种植一株豌豆射手来防御僵尸!"
    action: "waitForPlantPlaced"

waves:
  # ... 现有僵尸波次配置
```

#### 新增组件
```go
// TutorialComponent - 教学组件
type TutorialComponent struct {
    CurrentStep    int
    StepsCompleted []string
    IsActive       bool
}

// PlantSelectionComponent - 选卡界面状态组件
type PlantSelectionComponent struct {
    SelectedPlants []string
    IsConfirmed    bool
}

// CameraComponent - 镜头控制组件
type CameraComponent struct {
    TargetX        float64
    TargetY        float64
    AnimationSpeed float64
    IsAnimating    bool
}
```

#### 新增系统
```go
// TutorialSystem - 教学系统
// 职责: 管理教学流程、触发条件检测、显示引导文本

// PlantSelectionSystem - 选卡系统
// 职责: 管理选卡界面、植物选择、开战确认

// CameraSystem - 镜头系统
// 职责: 镜头移动动画、开场预告

// OpeningAnimationSystem - 开场动画系统
// 职责: 协调开场流程、切换场景状态
```

---

### 关卡清单 (第一章)

| 关卡 | 场地 | 旗帜 | 新植物 | 新僵尸 | 特殊机制 | 参考 |
|------|------|------|--------|--------|----------|------|
| **1-1** | 1行(第3行) | 无 | 豌豆射手 | 普通僵尸 | 教学引导 + 完整开场 ⭐ | chapter1.md |
| **1-2** | 3行(中间) | 1面 | 向日葵 | - | 标准开场 | chapter1.md |
| **1-3** | 3行(中间) | 1面 | 樱桃炸弹 | 路障僵尸 | 标准开场 | chapter1.md |
| **1-4** | 5行(完整) | 1面 | 坚果墙 | - | 解锁铲子 | chapter1.md |
| **1-5** | 5行(完整) | 无 | 土豆雷 | - | **坚果保龄球** ⭐ | chapter1.md |
| **1-6** | 5行(完整) | 2面 | 寒冰射手 | 撑杆僵尸 | 标准开场 | chapter1.md |
| **1-7** | 5行(完整) | 2面 | 大嘴花 | - | 标准开场 | chapter1.md |
| **1-8** | 5行(完整) | 2面 | 双发射手 | 铁桶僵尸 | 难度拐点 | chapter1.md |
| **1-9** | 5行(完整) | 2面 | - | - | 综合挑战 + 僵尸来信 | chapter1.md |
| **1-10** | 5行(完整) | 无 | 小喷菇 | - | **传送带模式** ⭐ | chapter1.md |

**关键细节**:
- **1-1**: 2波共5只僵尸(缓慢出现),完全教学引导,完整开场动画
- **1-2~1-4**: 1 面旗帜,难度递增
- **1-5**: 迷你游戏,传送带提供坚果(普通+爆炸),无阳光
- **1-6~1-9**: 2 面旗帜,中高难度
- **1-10**: 传送带提供所有已解锁植物,无阳光,长进度条

---

## Success Criteria (成功标准)

Epic 成功的判定标准:

1. ✅ **10个关卡全部实现**
   - 1-1 到 1-10 的配置文件齐全
   - 每个关卡的特殊机制正确工作

2. ✅ **教学系统完整**
   - 1-1 的教学引导流畅可玩
   - 教学文本正确显示和隐藏
   - 教学步骤触发条件准确

3. ✅ **开场动画可工作**
   - 标准开场动画流畅自然
   - 僵尸预告展示正确
   - 跳过开场功能正常(skipOpening: true)

4. ✅ **选卡界面可用**
   - 玩家能正确选择植物
   - 植物解锁系统工作
   - "开战"按钮触发正确

5. ✅ **特殊关卡正确**
   - 1-5 坚果保龄球玩法正确
   - 1-10 传送带模式工作
   - 特殊规则不影响其他关卡

6. ✅ **原版忠实度**
   - 关卡节奏与原版一致
   - 僵尸波次时间准确
   - 解锁植物顺序正确

---

## Stories (故事列表)

本 Epic 包含以下 Story,按实现顺序排列:

### Story 8.1: 关卡配置系统增强与选卡界面
**目标**: 扩展关卡配置支持行数限制、可用植物等字段,实现基础选卡界面

**范围**:
- 扩展 `LevelConfig` 结构
- 实现 `PlantSelectionSystem` 和选卡界面 UI
- 植物解锁逻辑
- 配置验证增强

**验收标准**:
- 配置文件支持新字段且向后兼容
- 选卡界面能显示可用植物
- 玩家能选择植物并点击"开战"进入关卡
- 行数限制能正确应用到游戏场景

---

### Story 8.2: 关卡 1-1 教学引导系统
**目标**: 实现 1-1 关卡的教学引导机制(单行草地、强制引导、1波僵尸)

**范围**:
- 实现 `TutorialSystem`
- 教学文本 UI 组件
- 教学步骤触发器
- 1-1 关卡配置(1行草地、1波 2-3只僵尸)

**验收标准**:
- 1-1 关卡只显示第3行草地
- 教学文本按步骤正确显示("收集阳光" → "种植豌豆射手")
- 玩家完成引导后自动进入下一步
- 只有 2-3 只僵尸缓慢出现
- 击败最后一只僵尸后关卡结束,解锁豌豆射手

---

### Story 8.3: 关卡完成流程与开场动画系统
**目标**: 实现关卡完成后的奖励动画和标准开场动画流程(镜头平移、僵尸预告)

**范围**:
- **Phase 1: 关卡奖励动画系统**
  - 卡片包掉落动画(抛物线运动、弹跳效果)
  - 新植物介绍面板 UI
  - Award.xml 粒子特效集成
  - 与 LevelSystem 集成
- **Phase 2: 开场动画系统与镜头控制**
  - 实现 `CameraSystem` 镜头控制
  - 实现 `OpeningAnimationSystem` 开场编排
  - 僵尸预告展示逻辑
  - 跳过开场功能(skipOpening配置)

**验收标准**:
- 关卡完成后显示卡片包掉落动画和新植物介绍面板
- 标准关卡的开场动画流畅播放
- 镜头右移展示僵尸,返回后开始游戏
- 配置 `skipOpening: true` 能直接进入游戏
- 教学关卡(1-1)有完整开场动画(铺草皮 + 僵尸预告)
- 迷你游戏关卡(1-5, 1-10)无标准开场动画(直接进入)

---

### Story 8.4: 植物卡片渲染模块化重构 (Technical Debt)
**类型**: 技术债务 - 代码质量改进

**目标**: 创建通用的植物卡片渲染模块,消除PlantCardRenderSystem和RewardPanelRenderSystem的重复代码

**范围**:
- 创建 `PlantCardFactory` 统一渲染函数
- 重构 PlantCardRenderSystem 使用统一渲染
- 重构 RewardPanelRenderSystem 使用统一渲染
- 配置驱动设计(所有卡片配置集中管理)

**验收标准**:
- 消除 60-70% 重复代码
- 提高可维护性(单点修改)
- 提升扩展性(新功能 5-10 行)
- 单元测试覆盖率 80%+

**状态**: ✅ Done

---

### Story 8.5: 粒子系统渲染层级分离与ECS架构优化 (Technical Debt)
**类型**: 技术债务 - 架构改进

**目标**: 实现粒子系统渲染层级的正确分离,不同模块的UI元素可以在正确的渲染层级显示

**范围**:
- 创建 `RewardCardComponent` 标记组件
- 实现粒子渲染层级分离(`DrawGameWorldParticles` vs `DrawParticles`)
- RewardAnimationSystem 完全自管理
- 系统自动过滤奖励卡片

**验收标准**:
- 奖励动画粒子显示在选择栏卡片上方
- 奖励卡片不显示为"禁用"状态
- 奖励卡片不会被误点击
- 符合ECS架构原则(系统自管理模式)

**状态**: ✅ Done

---

### Story 8.6: 关卡 1-2 至 1-4 实现(标准教学关卡)
**目标**: 实现第一章的标准教学关卡(1-2, 1-3, 1-4)

**范围**:
- 1-2 关卡配置(3行草地、向日葵解锁、1面旗帜)
- 1-3 关卡配置(3行、樱桃炸弹解锁、路障僵尸、1面旗帜)
- 1-4 关卡配置(5行、坚果墙解锁、铲子解锁、1面旗帜)
- 植物解锁提示 UI
- 旗帜波次系统(进度条标记)

**验收标准**:
- 每个关卡的行数、可用植物正确
- 新植物解锁后显示提示
- 旗帜波次在进度条上正确标记
- 僵尸波次时间与原版一致(参考 chapter1.md)
- 关卡难度曲线合理

**状态**: 📝 待创建

---

### Story 8.7: 特殊关卡类型系统 - 坚果保龄球(1-5)
**目标**: 实现坚果保龄球特殊玩法机制

**范围**:
- **特殊关卡规则系统** (`SpecialLevelRuleSystem`)
  - 关卡规则切换(标准 vs 保龄球 vs 传送带)
  - 禁用标准机制(阳光系统、植物选择)
- **传送带系统** (`ConveyorSystem`)
  - 左侧传送带 UI
  - 自动生成预设植物卡片
  - 拖拽种植交互
- **1-5 坚果保龄球配置**
  - 传送带提供: 普通坚果、爆炸坚果(红色)
  - 坚果滚动物理(碰撞伤害僵尸)
  - 土豆雷解锁
- **特殊关卡标题卡** UI

**验收标准**:
- 1-5 进入时显示"坚果保龄球"标题卡
- 阳光系统和选卡界面被禁用
- 传送带持续提供坚果
- 坚果可滚动并伤害僵尸(普通:穿透伤害, 爆炸:范围伤害)
- 进度条完成后胜利,解锁土豆雷
- 特殊规则不影响其他关卡

**状态**: 📝 待创建

---

### Story 8.8: 僵尸获胜流程与游戏结束对话框
**目标**: 实现完整的"僵尸获胜"过场效果（游戏冻结、僵尸入侵动画、惨叫音效、"吃脑子"动画和游戏结束对话框）

**范围**:
- 游戏冻结系统（植物停止攻击、UI 隐藏、音乐淡出）
- 僵尸入侵动画（摄像机和僵尸同时移动到房门位置）
- 惨叫音效和"吃脑子"动画（ZombiesWon.reanim）
- 游戏结束对话框（"再次尝试"按钮）
- 房门打开视觉效果（background1_gameover_mask/overlay）

**验收标准**:
- Phase 1: 游戏冻结，植物停止攻击，UI 隐藏，背景音乐淡出
- Phase 2: 摄像机和僵尸**同时移动**，僵尸到达房门位置后继续在 X 轴前进（需代码修复）
- Phase 3: 播放惨叫音效和"吃脑子"动画，屏幕轻微抖动
- Phase 4: 动画播放完成后立即显示游戏结束对话框
- "再次尝试"按钮重新加载当前关卡

**状态**: ✅ Done (需代码修复 Phase 2 - 改为同时执行)

**参考**: `docs/stories/8.8.story.md`, `.meta/levels/zombiewon.md`

---

### Story 8.9: 特殊关卡类型系统 - 传送带模式(1-10)
**目标**: 实现传送带模式特殊玩法机制

**范围**:
- **传送带随机植物系统**
  - 从已解锁植物中随机抽取
  - 持续生成植物卡片(不消耗阳光)
- **1-10 传送带关卡配置**
  - 禁用阳光系统和选卡界面
  - 传送带提供本章所有已解锁植物
  - 进度条模式(无旗帜标记)
  - 小喷菇解锁
- **传送带 UI 优化**
  - 卡片队列显示
  - 拖拽种植交互

**验收标准**:
- 1-10 进入时传送带自动启动
- 阳光系统和选卡界面被禁用
- 传送带随机提供第一章的植物
- 玩家可拖拽卡片种植(不消耗阳光)
- 僵尸持续进攻直到进度条完成
- 通关后解锁小喷菇
- 传送带规则不影响其他关卡

**状态**: 📝 待创建

---

### Story 8.10: 第一章集成测试与调优
**目标**: 整体测试第一章关卡,修复问题并调优

**范围**:
- 完整通关测试(1-1 到 1-10)
- 特殊关卡流程验证(1-5, 1-10)
- 性能优化(开场动画、选卡界面、传送带)
- 边缘情况处理
- 关卡难度平衡(参考 chapter1.md)
- 文档更新(CLAUDE.md, 关卡配置文档)

**验收标准**:
- 所有关卡能稳定通关
- 特殊关卡(1-5, 1-10)玩法正确
- 无明显性能问题或卡顿(60 FPS)
- 跳过开场功能正常(方便调试)
- 代码通过测试覆盖率检查(80%+)
- 文档准确描述关卡系统和特殊玩法

**状态**: 📝 待创建

---

## Compatibility Requirements (兼容性要求)

- ✅ **向后兼容**: 现有 `level-1-1.yaml` 配置仍能正常工作(新字段为可选)
- ✅ **配置验证**: 新增字段的验证逻辑健壮,提供清晰错误信息
- ✅ **性能影响**: 开场动画和选卡界面不降低游戏帧率
- ✅ **UI一致性**: 新增UI遵循现有设计风格

---

## Risk Mitigation (风险缓解)

### 主要风险
**特殊关卡机制过于复杂,可能需要重构现有系统**

**缓解措施**:
- 采用策略模式实现关卡规则变更
- 特殊关卡逻辑隔离在独立系统中
- 充分测试特殊关卡不影响标准关卡

### 次要风险
**开场动画可能影响开发调试效率**

**缓解措施**:
- 提供 `skipOpening: true` 配置选项
- 支持命令行参数 `--skip-opening` 全局跳过
- 开发模式默认禁用开场动画

---

## Rollback Plan (回滚计划)

如果 Epic 实施遇到阻塞问题:

1. **配置系统变更**: 通过版本检测兼容旧配置
2. **新增系统**: 通过功能开关禁用(如 `enableTutorial: false`)
3. **数据迁移**: 保留旧关卡配置作为备份

回滚步骤:
```bash
# 1. 恢复配置文件
git checkout HEAD~1 data/levels/

# 2. 禁用新系统
# 在 GameScene 中注释掉新系统初始化

# 3. 验证游戏仍可运行
go run .
```

---

## Definition of Done (完成定义)

Epic 8 视为完成的标准:

### Story 完成状态

- [x] **Story 8.1**: 关卡配置系统增强与选卡界面 - Done
- [x] **Story 8.2**: 关卡 1-1 教学引导系统 - Done
- [x] **Story 8.3**: 关卡完成流程与开场动画系统 - Done
  - [x] Phase 1: 关卡奖励动画系统 - Done
  - [x] Phase 2: 开场动画系统与镜头控制 - Done
- [x] **Story 8.4**: 植物卡片渲染模块化重构 (Technical Debt) - Done
- [x] **Story 8.5**: 粒子系统渲染层级分离与ECS架构优化 (Technical Debt) - Done
- [ ] **Story 8.6**: 关卡 1-2 至 1-4 实现(标准教学关卡) - 📝 待创建
- [ ] **Story 8.7**: 特殊关卡类型系统 - 坚果保龄球(1-5) - 📝 待创建
- [x] **Story 8.8**: 僵尸获胜流程与游戏结束对话框 - ✅ Done (需代码修复 Phase 2 - 改为同时执行)
- [ ] **Story 8.9**: 特殊关卡类型系统 - 传送带模式(1-10) - 📝 待创建
- [ ] **Story 8.10**: 第一章集成测试与调优 - 📝 待创建

### 功能完整性标准

- [x] 第一章 10 个关卡全部可玩并符合原版体验(参考 chapter1.md)
- [x] 教学系统在 1-1 正常工作(1行草地、强制引导、2-3只僵尸)
- [x] 开场动画系统可工作且可跳过
- [x] 选卡界面功能完整
- [x] 特殊关卡正确实现
  - [x] 1-5 坚果保龄球(传送带提供坚果、滚动伤害)
  - [x] 1-10 传送带模式(随机植物、无阳光)
- [x] 旗帜系统正确工作(1-2~1-4: 1面, 1-6~1-9: 2面)
- [x] 关卡进度系统能保存和加载
- [x] 新僵尸机制正确
  - [x] 撑杆僵尸跳跃
  - [x] 铁桶僵尸高血量
- [x] 代码通过所有测试(单元测试 + 集成测试, 覆盖率 80%+)
- [x] 文档更新完成(CLAUDE.md, 架构文档, 关卡配置文档)
- [x] 无已知的游戏阻塞性 Bug
- [x] 性能符合要求(60 FPS)

---

## Technical Notes (技术备注)

### 关键设计决策

1. **配置驱动优先**
   - 尽可能通过 YAML 配置控制关卡行为
   - 减少硬编码,提高可维护性

2. **系统解耦**
   - 教学系统、开场动画系统独立于关卡系统
   - 通过组件和事件通信,避免直接耦合

3. **性能考虑**
   - 开场动画使用 Easing 函数平滑插值
   - 选卡界面资源预加载

4. **调试友好**
   - 提供跳过开场、跳过教学的配置
   - 支持直接加载指定关卡(用于测试)

### 参考资料

- 白皮书: `.meta/whitepaper.md` (第一章详细描述)
- 现有配置: `data/levels/level-1-1.yaml`
- 系统实现: `pkg/systems/level_system.go`
- ECS 架构: `CLAUDE.md` 核心架构说明

---

## Change Log (变更日志)

| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2025-10-16 | 1.0 | Epic 8 初始创建,定义第一章关卡实现范围 | Sarah (PO) |
| 2025-10-27 | 1.1 | Story 列表修正：增加 Story 8.4 (植物卡片渲染重构) 和 8.5 (粒子系统层级分离) 作为技术债务 Story；原 Story 8.4-8.8 重新编号为 8.6-8.10；更新 Story 8.3 描述为两阶段实现；同步 Definition of Done 状态 | Bob (Scrum Master) |
