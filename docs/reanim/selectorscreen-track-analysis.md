# SelectorScreen.reanim 轨道分析报告

**生成时间**: 2025-11-03（自动生成）
**总轨道数**: 48
**总帧数**: 706 帧 @ 20 FPS = 35.3 秒

---

## 1. 轨道类型统计

- **动画定义轨道**: 14 个（控制时间窗口，只有 f 值）
- **混合轨道**: 33 个（有图片+位置+f值）
- **图片轨道**: 1 个（只有图片）
- **逻辑轨道**: 0 个（只有位置）

---

## 2. 动画定义轨道（时间线）

这些轨道定义了不同元素的显示时间窗口。

| 轨道名 | 可见窗口 | 持续时间 | 用途推测 |
|--------|---------|---------|---------|
| anim_open | 0-12 | 0.65秒 | 开场阶段定义（墓碑通过按钮Y坐标变化升起） |
| anim_sign | 13-40 | 1.4秒 | 木牌显示控制 |
| anim_idle | 41-77 | 1.9秒 | ❓ 疑似原版"等待"状态？ |
| anim_grass | 78-102 | 1.2秒 | 草丛晃动控制 |
| anim_flower2 | 103-160 | 2.9秒 | 花朵2晃动控制 |
| anim_flower1 | 161-178 | 0.9秒 | 花朵1晃动控制 |
| anim_flower3 | 179-197 | 0.9秒 | 花朵3晃动控制 |
| anim_start | 全隐藏 | 0秒 | ❓ 开始过渡？（未使用） |
| anim_cloud1 | 198-335 | 6.9秒 | 云朵1飘动控制 |
| anim_cloud7 | 336-421 | 4.3秒 | 云朵7飘动控制 |
| anim_cloud2 | 422-502 | 4.0秒 | 云朵2飘动控制 |
| anim_cloud4 | 503-705 | 10.2秒 | 云朵4飘动控制 |
| anim_cloud6 | 569-638 | 3.5秒 | 云朵6飘动控制 |
| anim_cloud5 | 639-705 | 3.4秒 | 云朵5飘动控制 |

---

## 3. 混合轨道（可见元素）

这些轨道包含实际渲染的图片和动画数据。

### 3.1 云朵（周期性飘动）

| 轨道名 | 可见窗口 | 持续时间 | 出现时刻 |
|--------|---------|---------|---------|
| Cloud1 | 198-335 | 6.9秒 | 9.9秒 |
| Cloud7 | 336-421 | 4.3秒 | 16.8秒 |
| Cloud2 | 422-502 | 4.0秒 | 21.1秒 |
| Cloud4 | 503-568 | 3.3秒 | 25.2秒 |
| Cloud6 | 569-638 | 3.5秒 | 28.5秒 |
| Cloud5 | 639-705 | 3.4秒 | 32.0秒 |

**特点**：
- 云朵在各自的时间窗口内从右向左飘动
- 移动速度约 189 像素/秒（1320 像素 / 7 秒）
- 每个循环周期（35.3秒）所有云朵依次出现

### 3.2 树叶（周期性晃动）

| 轨道名 | 可见窗口 | 持续时间 |
|--------|---------|---------|
| leaf1-5, leaf22, leaf_SelectorScreen_Leaves | 78-102 | 1.2秒 |

**特点**：
- 所有树叶轨道同时显示
- 在帧 78-102 短暂晃动
- 每个循环周期出现一次

### 3.3 花朵（周期性晃动）

| 轨道名 | 可见窗口 | 持续时间 |
|--------|---------|---------|
| flower2 | 103-160 | 2.9秒 |
| flower3 | 161-178 | 0.9秒 |
| flower1 | 179-197 | 0.9秒 |

**特点**：
- 三朵花依次出现
- 每朵花短暂晃动后消失
- 每个循环周期出现一次

### 3.4 木牌（与墓碑同步）

| 轨道名 | 可见窗口 | 持续时间 |
|--------|---------|---------|
| woodsign1-3 | 13-77 | 3.2秒 |

**特点**：
- 与 anim_sign 同步
- 墓碑升起后显示，anim_idle 结束后消失

### 3.5 背景和按钮（一直显示）

| 轨道名 | 可见窗口 | 类型 |
|--------|---------|------|
| SelectorScreen_BG_Center/Left/Right | 全程 | 背景 |
| SelectorScreen_*_button | 全程 | 按钮（正常态） |
| SelectorScreen_*_shadow | 全程 | 按钮（阴影/锁定态） |
| almanac_key_shadow | 全程 | 装饰 |

---

## 4. 关键发现

### 4.1 anim_idle 的问题 ⚠️

**现状**：
- anim_idle 可见窗口：帧 41-77（共 38 帧，约 1.9 秒）
- 这个窗口太短，无法覆盖所有装饰元素：
  - 云朵最早在帧 198 出现（9.9秒后）
  - 草丛在帧 78-103 出现（3.9-5.2秒）
  - 花朵在帧 103-198 出现（5.2-9.9秒）

**推测**：
- anim_idle 可能不是"主循环动画"
- 可能是墓碑升起后的"短暂等待状态"（1.9秒）
- 原版可能有其他机制来播放完整的 706 帧

**当前实现**：
- 播放所有 706 帧作为主循环
- 从第 20 帧开始（跳过墓碑升起的帧 0-16）
- 循环到第 706 帧后回到第 20 帧

### 4.2 时间轴总览

```
帧数   0 ---- 13 -- 20 -- 41 -- 78 -- 103 - 161 - 179 - 198 -------- 336 -- 422 --- 503 -- 569 --- 639 --- 706
       |      |     |     |     |     |     |     |     |            |      |       |      |        |       |
事件   墓碑   木牌  主    anim  草丛  花2   花3   花1   云1飘动----+  云7-+ 云2--+ 云4--+ 云6---+ 云5--+
       升起   开始  循环  idle  晃动
                    开始  窗口

- 墓碑升起：一次性（不循环）
- 主循环：帧 20-706，周期 34.3 秒
- 云朵/草丛/花朵：在各自窗口内周期性出现
```

---

## 5. 实现建议

### 5.1 当前实现 ✅

```go
// 墓碑升起（anim_open）：只播放一次
PlayAnimationNoLoop(entity, "anim_open")

// 主循环：播放帧 20-706
if anim_open.IsFinished {
    PlayAnimation(entity, "anim_idle")  // 构建 MergedTracks
    reanimComp.VisibleFrameCount = 706   // 覆盖为全帧
    reanimComp.CurrentFrame = 20         // 从第 20 帧开始

    // 循环检查：防止回到第 0 帧
    if reanimComp.CurrentFrame < 20 {
        reanimComp.CurrentFrame = 20
    }
}
```

### 5.2 VisibleTracks 白名单

**需要加入白名单的轨道**（一直显示）：
- `SelectorScreen_BG*` - 背景
- `SelectorScreen_*_button` - 按钮（根据解锁状态）
- `SelectorScreen_*_shadow` - 按钮阴影（根据解锁状态）
- `Cloud1-7` 和 `anim_cloud1-7` - 云朵
- `leaf*` - 树叶（如果需要一直显示）
- `woodsign*` - 木牌（如果需要一直显示）

**不加入白名单的轨道**（根据 f 值周期性显示）：
- `anim_grass` - 草丛（在帧 78-102 自动显示）
- `flower1-3` - 花朵（触发显示，暂未实现）

---

## 6. 未解之谜 ❓

1. **anim_idle 的真实用途**：
   - 为什么只有 38 帧？
   - 原版游戏如何处理主循环？
   - 是否有其他机制控制完整的 706 帧播放？

2. **anim_start 的用途**：
   - 全程隐藏，可能未使用
   - 或者用于点击"开始"按钮后的过渡效果

3. **anim_open 的实现机制**：
   - anim_open 轨道在帧 0-12 可见（f=0 默认值），帧 13 开始隐藏（f=-1）
   - 墓碑升起动画通过按钮轨道的 Y 坐标变化实现（帧 0: y=638.6 → 帧 12: y=79.7）
   - anim_open 只是时间窗口定义，不直接控制位置

---

## 附录：完整轨道列表

| 序号 | 轨道名 | 类型 | 可见窗口 |
|------|--------|------|---------|
| 1 | anim_open | 动画定义 | 0-12 |
| 2 | anim_sign | 动画定义 | 13-40 |
| 3 | anim_idle | 动画定义 | 41-77 |
| 4 | anim_grass | 动画定义 | 78-102 |
| 5 | anim_flower2 | 动画定义 | 103-160 |
| 6 | anim_flower1 | 动画定义 | 161-178 |
| 7 | anim_flower3 | 动画定义 | 179-197 |
| 8 | anim_start | 动画定义 | 全隐藏 |
| 9-14 | anim_cloud1/2/4/5/6/7 | 动画定义 | 各自窗口 |
| 15 | SelectorScreen_BG | 图片轨道 | 全程 |
| 16-48 | 其他混合轨道 | 混合轨道 | 见上文 |

---

**文档生成**: 自动化脚本
**数据来源**: `assets/effect/reanim/SelectorScreen.reanim`
**版本**: v1.0
